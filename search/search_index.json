{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Administrez votre r\u00e9seau virtuel !","text":""},{"location":"#bienvenue","title":"Bienvenue","text":"<p>  Apprenez comment simuler un r\u00e9seau informatique local. </p> <p>La maquette propos\u00e9e ci-dessous inclut deux serveurs Debian (zones LAN et DMZ) ainsi qu'un serveur IPFire assurant le r\u00f4le de pare-feu pour le r\u00e9seau (zone WAN).</p> <p>Les postes de travail de la zone LAN reposent sur des machines virtuelles ou des conteneurs exploitant l'OS Debian.</p> <p>Un commutateur virtuel de nom Open vSwitch et tournant sous Debian est \u00e9galement pr\u00e9sent.</p> <p>La construction de la maquette est issue de l'hyperviseur de type 2 VirtualBox.</p> <p>Maquette de base du r\u00e9seau virtuel :</p> <p> </p> R\u00e9seau virtuel : Flux ICMP (ping)) <p>VirtualBox permet de cr\u00e9er une maquette r\u00e9aliste d'un petit r\u00e9seau informatique local, celle-ci s'av\u00e9rant pratique pour s'initier \u00e0 l'administration r\u00e9seau.</p> <p>S'il vous arrive de casser l'un des \u00e9l\u00e9ments du r\u00e9seau, r\u00e9installez votre sauvegarde cr\u00e9\u00e9e \u00e0 l'aide de la fonction \"Exporter un appareil virtuel\" de VirtualBox et continuez de vous amuser.</p> <p>La virtualisation est un bon champ d'exp\u00e9rimentation pour apprendre, je consomme avec beaucoup de satisfaction et ne m'en lasse pas.</p> <p>J'exploite, en particulier, les outils de virtualisation que sont VirtualBox, Proxmox et EVE-NG.</p> **- Sur ce site vous trouverez comment :** Cr\u00e9er le r\u00e9seau sous VirtualBox (serveurs et clients). Relier correctement les \u00e9l\u00e9ments entre eux. Installer des services r\u00e9seau tels DNS, DHCP, etc\u2026 V\u00e9rifier le bon fonctionnement de l'ensemble. <p>Si ce travail peut servir \u00e0 d'autres qu'\u00e0 moi-m\u00eame, j'en serai particuli\u00e8rement heureux.</p> **- Remarques g\u00e9n\u00e9rales sur la maquette :** <p>1 ) VM et conteneurs sont initialis\u00e9s avec systemd.</p> <p>2 ) Le serveur IPFire offre les services suivants : - Firewall (utilis\u00e9 par le r\u00e9seau virtuel) - Serveur Proxy - Syst\u00e8me de d\u00e9tection d'intrusion - Serveur DHCP - Serveur NTP (utilis\u00e9 par le r\u00e9seau virtuel ) - Etc ...</p> <p>R\u00f4le : S\u00e9curiser l'architecture d'un r\u00e9seau informatique.</p> <p>3 ) Commutateur virtuel Open vSwitch : - Install\u00e9 sur une VM Debian et non sur le PC h\u00f4te.</p> <p>4 ) 8 Go de RAM minimum, m\u00e9moire du PC h\u00f4te incluse.</p> <p>5 ) Environnement graphique : - Certaines VM disposent du bureau l\u00e9ger Xfce4.</p> **- Int\u00e9r\u00eat du r\u00e9seau virtuel ?** <p>D\u00e9couvrir comment cr\u00e9er, configurer et relier des VM et conteneurs avec VirtualBox.</p> <p>Installer, configurer et tester les principaux services utilis\u00e9s sur un r\u00e9seau informatique.</p> <p>Exploiter des outils d'administration et de supervision r\u00e9seau tels Cockpit et Centreon IT-100.</p> <p>R\u00e9aliser d'\u00e9ventuels tests de p\u00e9n\u00e9tration de r\u00e9seau ou de d\u00e9tection d'intrusion.</p> <p>Etc...</p>"},{"location":"page-construction-reseau-virtuel-debian/","title":"Construction du r\u00e9seau","text":""},{"location":"page-construction-reseau-virtuel-debian/#vm-et-services-reseau","title":"VM et services r\u00e9seau","text":"<p>  4 ETAPES LOGIQUES </p> <p>La construction suit les \u00e9tapes titr\u00e9es ci-dessous. Les 3 premi\u00e8res concernent la cr\u00e9ation des diff\u00e9rentes machines virtuelles (VM) et la quatri\u00e8me l'installation des services r\u00e9seau.</p>"},{"location":"page-construction-reseau-virtuel-debian/#installation-de-virtualbox","title":"Installation de VirtualBox","text":"<p>Commencez par installer le logiciel VirtualBox.</p> <p>\u261b M\u00e9mento VirtualBox</p>"},{"location":"page-construction-reseau-virtuel-debian/#creation-des-serveurs-virtuels","title":"Cr\u00e9ation des serveurs virtuels","text":"<p>Puis cr\u00e9ez, comme le montre la maquette, les serveurs des zones LAN, WAN et DMZ.</p> <p>\u261b M\u00e9mentos srvlan / srvsec / srvdmz</p>"},{"location":"page-construction-reseau-virtuel-debian/#creation-des-clients-virtuels","title":"Cr\u00e9ation des clients virtuels","text":"<p>L'ensemble comprend 2 VM Debian et 1 VM Open vSwitch incluant 2 conteneurs LXC.</p> <p>\u261b M\u00e9mentos Clients / Open vSwitch</p>"},{"location":"page-construction-reseau-virtuel-debian/#installation-des-services-reseau","title":"Installation des services r\u00e9seau","text":"<p>Suivez, dans l'ordre, la liste des m\u00e9mentos du blog pour au final pouvoir exploiter un petit r\u00e9seau local virtuel.</p> <p>\u261b Liste des m\u00e9mentos</p>  . . . . . .  <p>L'id\u00e9al pour r\u00e9aliser tout ceci est de disposer d'un petit serveur basse consommation avec suffisamment de m\u00e9moire pour supporter la construction du r\u00e9seau.</p> <p>Ceci vous \u00e9vitera de relancer vos VM chaque fois que vous souhaiterez travailler sur le r\u00e9seau.</p> <p>Le m\u00e9mento Contr\u00f4le \u00e0 distance est l\u00e0 pour que vous puissiez piloter vos VM depuis un PC situ\u00e9 sur le m\u00eame r\u00e9seau local que le serveur ou PC h\u00f4te de VirtualBox.</p> <p>Ce r\u00e9seau virtuel est l\u00e0 pour aider tout d\u00e9butant souhaitant disposer d'un outil lui permettant d'aborder l'administration r\u00e9seau.</p> <p>Bon courage !</p>"},{"location":"page-elements-reseau-virtuel/","title":"El\u00e9ments du r\u00e9seau virtuel","text":""},{"location":"page-elements-reseau-virtuel/#vbox-serveurs-clients-switch","title":"VBox - Serveurs - Clients - Switch","text":"<p>Le PC ou serveur, h\u00f4te de l'hyperviseur VirtualBox, peut tourner sous Windows ou Linux.</p> <p>Toutes les VM cr\u00e9\u00e9es avec VirtualBox, hormis la VM pare-feu, supportent un OS Debian Linux. </p> <p></p> Syst\u00e8me de virtualisation : Hyperviseur de type 2 VirtualBox Derni\u00e8re version <p></p> Serveurs LAN et DMZ : RAM min : VM srvlan et srvdmz 2 x 1024 Mo Bureau Xfce4 <p></p> Serveur WAN : RAM min : VM srvsec \u00a0 (Pare-feu) 1 x 512 Mo OS LFS IPFire <p></p> Clients LAN : RAM min : VM debian..-vm1 et vm2 2 x 1024 Mo VM ovs 1 x 1024 Mo <p></p> Clients LAN l\u00e9gers : RAM VM osv Conteneurs ctn1 et ctn2 sur la VM ovs <p></p> Switch virtuel : RAM VM osv Logiciel Open vSwitch sur la VM ovs <p></p> RAM minimum requise pour exploiter   le r\u00e9seau correctement, environ **6 Go**."},{"location":"page-liste-des-mementos/","title":"Liste des m\u00e9mentos","text":""},{"location":"page-liste-des-mementos/#reseau-virtuel-virtualbox-debian","title":"R\u00e9seau virtuel VirtualBox / Debian","text":"<p>  Ex\u00e9cutez la liste dans l'ordre pour au final pouvoir exploiter un petit r\u00e9seau local virtuel. </p> 0 - Hyperviseur VirtualBox <ul> <li> VirtualBox \u2013 Installation</li> <li> VirtualBox \u2013 Acc\u00e8s r\u00e9seau par pont</li> <li> VirtualBox \u2013 Start auto des VM</li> </ul> 1 - Serveur LAN Debian : srvlan <ul> <li> 1.1 srvlan \u2013 VBox/Deb12</li> </ul> 2 - Serveur WAN IPFire : srvsec <ul> <li> 2.1 srvsec \u2013 VBox/IPFire</li> </ul> 3 - Serveur DMZ Debian : srvdmz <ul> <li> 3.1 srvdmz - VBox/Deb12</li> </ul> 4 - Clients LAN Debian : vm1 et 2 <ul> <li> 4.1 vm1 et 2 - VBox/Deb12</li> </ul> 5 - Open vSwitch + Conteneurs <ul> <li> 5.1 Open vSwitch - VBox/Deb12</li> <li> 5.2 Podman - VBox/Deb12: 1/2</li> <li> 5.2 Podman - VBox/Deb12: 2/2</li> </ul> 6 - Acc\u00e8s distants : Protocoles RDP, VNC, SSH <ul> <li> 6.1 Contr\u00f4le \u00e0 distance - VBox/Deb12</li> </ul> 7 - DNS - DHCP - DNS dynamique <ul> <li> 7.1 DNS statique - VBox/Deb12</li> <li> 7.2 DHCP Kea - VBox/Deb12</li> <li> 7.3 DNS dynamique - VBox/Deb12</li> </ul> 8 - LAMP - HTTPS - CMS <ul> <li> 8.1 LAMP HTTPS CMS - VBox/Deb12 1/2</li> <li> 8.1 LAMP HTTPS CMS - VBox/Deb12 2/2</li> </ul> 9 - SFTP acc\u00e8s CMS - FTPS <ul> <li> 9.1 SFTP et Dotclear - VBox/Deb12</li> <li> 9.2 FTPS avec VsFTPd - VBox/Deb12</li> </ul> 10 - DNS split et Proxy inverse <ul> <li> 10.1 DNS split - VBox/Deb12</li> </ul> 11 - Serveur de courrier <ul> <li> 11.1 E-mail - VBox/Deb12 1/3</li> <li> 11.2 E-mail - VBox/Deb12 2/3</li> <li> 11.3 E-mail - VBox/Deb12 3/3</li> </ul> *---------------------------------------------------------------* <p></p> <p>  Amusez-vous bien !</p>"},{"location":"page-prerequis/","title":"Pr\u00e9requis","text":""},{"location":"page-prerequis/#configuration-materielle-etc","title":"Configuration mat\u00e9rielle, etc...","text":"<p>  Vous devez disposer d'un PC supportant un OS Windows ou Linux. </p> <p>Ce PC qui sera l'h\u00f4te du r\u00e9seau virtuel doit avoir environ 100 Go d'espace disque de libre et de pr\u00e9f\u00e9rence \u00eatre \u00e9quip\u00e9 des \u00e9l\u00e9ments suivants :</p> 1 Processeur assez puissant type Intel i5 ou Ryzen 5 8 Go de RAM (6 Go sont \u00e0 d\u00e9dier au r\u00e9seau virtuel) <p>Vous pourrez ainsi, la virtualisation consommant de la ressource processeur et m\u00e9moire vive, profiter d'une exploitation confortable, ce qui n'est pas n\u00e9gligeable.</p> <p>4 Go de RAM sont requis pour utiliser simultan\u00e9ment :</p> Les 3 serveurs srvsec, srvlan et srvdmz Le switch OpenvSwitch (sur VM ovs) L'une des 2 VM debian..-vm* L'un des 2 conteneurs ctn* <p>Une configuration de 16 Go de RAM est parfaite.</p> <p>Conna\u00eetre les commandes du syst\u00e8me d'exploitation Linux est un plus mais pas indispensable pour arriver \u00e0 construire le r\u00e9seau. Tout est d\u00e9taill\u00e9 dans les m\u00e9mentos du site.</p> <p>Suivez, dans l'ordre, la liste ci-dessous pour au final jouer avec votre propre r\u00e9seau local virtuel.</p> -- [LISTE DES MEMENTOS](page-liste-des-mementos.md) --"},{"location":"blog/","title":"Index de tous les articles","text":""},{"location":"blog/#index-de-tous-les-articles","title":"Index de tous les articles","text":""},{"location":"blog/clamav---addendumdeb12/","title":"ClamAV - Addendum/Deb12","text":""},{"location":"blog/clamav---addendumdeb12/#bdd-de-securiteinfo","title":"Bdd de SecuriteInfo","text":""},{"location":"blog/clamav---addendumdeb12/#paquet-clamav-unofficial-sigs","title":"Paquet clamav-unofficial-sigs","text":"<p>Des courriers pour le compte clamav@srvdmz, re\u00e7us sur l'alias postmaster@loupvirtuel.fr, peuvent signaler les 2 incidents suivants :</p> <p>- curl: (6) Could not resolve host: clamav.securiteinfo... - Clamscan ... MalwarePatrol mbl.ndb ... BAD - SKIP...</p> <p>Ceux-ci traduisent un \u00e9chec de MAJ de bases de donn\u00e9es de signatures d\u00e9clar\u00e9es dans le fichier /usr/share/clamav-unofficial-sigs/conf.d/00-clamav-unofficial-sigs.conf.</p> <p>Le fichier cron d\u00e9clenchant les mises \u00e0 jour se situe dans le dossier /etc/cron.d/.</p> <p>Le paquet clamav-unofficial-sigs fourni par Debian semble \u00eatre \u00e0 l'origine de ces incidents.</p> <p>Pour r\u00e9gler le probl\u00e8me, proc\u00e9dez ainsi :</p> <pre><code>[srvdmz@srvdmz:~$] cd /usr/share/clamav-unofficial-sigs/\n[srvdmz@srvdmz:~$] cd conf.d\n[srvdmz@srvdmz:~$] sudo nano 00-clamav-unofficial-sigs.conf \n</code></pre> <p>Commentez les lignes d\u00e9di\u00e9es aux Bdd SecuriteInfo :</p> <pre><code>#si_dbs=\"\n#   honeynet.hdb\n#   securiteinfo.hdb\n#   securiteinfobat.hdb\n#   securiteinfodos.hdb\n#   securiteinfoelf.hdb\n#   securiteinfohtml.hdb\n#   securiteinfooffice.hdb\n#   securiteinfopdf.hdb\n#   securiteinfosh.hdb\n#\"\n\n#si_update_hours=\"4\"\n</code></pre> <p>ainsi que celles d\u00e9di\u00e9es \u00e0 la Bdd MalwarePatrol :</p> <pre><code>#mbl_dbs=\"\n#   mbl.ndb\n#\"\n\n#mbl_update_hours=\"6\"\n</code></pre> <p>Puis, red\u00e9marrez les services suivants :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart clamav-daemon\n[srvdmz@srvdmz:~$] sudo systemctl restart clamav-freshclam\n</code></pre> <p>Nota</p> <p>Les Bdd SaneSecurity d\u00e9clar\u00e9es dans 00-clamav-unofficial-sigs.conf continueront d'\u00eatre mises \u00e0 jour dans le dossier /var/cache/clamav-unofficial-sigs/ss-dbs/.</p>"},{"location":"blog/clamav---addendumdeb12/#recuperation-bdd-securiteinfo","title":"R\u00e9cup\u00e9ration Bdd SecuriteInfo","text":"<p>Il est possible de s'inscrire gratuitement sur le site SecuriteInfo.com qui dans son offre Basic malwares de 2012 jusqu'au mois dernier permet de t\u00e9l\u00e9charger les signatures additionnelles pour ClamAV.</p> <p>Utilisez le lien Booster l'antivirus ClamaV pr\u00e9sent sur la page d'accueil du site pour acc\u00e9der \u00e0 l'inscription.</p> <p>Une fois fait, t\u00e9l\u00e9chargez comme propos\u00e9 la liste des signatures et ajoutez celle-ci en fin du fichier /etc/clamav/freshclam.conf :</p> <pre><code># Bases de donn\u00e9es de securiteinfo.com\nDatabaseCustomURL https://www.securiteinfo.com/get/signatures/137ab3b.../securiteinfo.hdb\n\nDatabaseCustomURL https://www.securiteinfo.com/get/signatures/137ab3d.../securiteinfo.ign2\n\nEtc...\n</code></pre> <p>Red\u00e9marrez ensuite les services ci-dessous :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart clamav-daemon\n[srvdmz@srvdmz:~$] sudo systemctl restart clamav-freshclam\n</code></pre> <p>Attendez quelque temps, MAJ effectu\u00e9e 2 fois par jour, puis v\u00e9rifiez le r\u00e9sultat :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl status clamav-freshclam\n</code></pre> <p>Retour :</p> <pre><code>\u25cf clamav-freshclam.service - ClamAV virus database upd...\n     Loaded: loaded (/lib/systemd/system/clamav-fresh...\n     Active: active (running) since Mon 2024-10-... ago\n       Docs: man:freshclam(1)\n             man:freshclam.conf(5)\n             https://docs.clamav.net/\n   Main PID: 33880 (freshclam)\n      Tasks: 1 (limit: 5824)\n     Memory: 7.1M\n        CPU: 700ms\n     CGroup: /system.slice/clamav-freshclam.service\n             \u2514\u250033880 /usr/bin/freshclam -d --foregrou...\n\n... freshclam... -&gt; bytecode.cvd database is up-to-date\n... freshclam... -&gt; securiteinfo.hdb is up-to-date\n... freshclam... -&gt; securiteinfo.ign2 is up-to-date\n... freshclam... -&gt; javascript.ndb is up-to-date\n... freshclam... -&gt; spam_marketing.ndb is up-to-date\n... freshclam... -&gt; securiteinfohtml.hdb is up-to-date\n... freshclam... -&gt; securiteinfoascii.hdb is up-to-date\n... freshclam... -&gt; securiteinfoandroid.hdb is up-to-date\n... freshclam... -&gt; securiteinfoold.hdb is up-to-date\n... freshclam... -&gt; securiteinfopdf.hdb is up-to-date\n</code></pre> <p>Vous pouvez observer la MAJ des Bdd SecuriteInfo.</p> ---------- Fin ----------"},{"location":"blog/vm1-et-2---vboxdeb12/","title":"vm1 et 2 - VBox/Deb12","text":""},{"location":"blog/vm1-et-2---vboxdeb12/#memento-41-clients-vm1-vm2","title":"M\u00e9mento 4.1 - Clients vm1 vm2","text":"<p>A pr\u00e9sent, vous allez compl\u00e9ter le r\u00e9seau virtuel avec 2 clients Linux reposant sur Debian 12.</p> <p>L'environnement graphique propos\u00e9 sera le m\u00eame que pour srvlan et srvdmz soit le bureau Xfce.  </p> <p>Le premier client sera clon\u00e9 pour g\u00e9n\u00e9rer le second dont vous ne modifierez que le nom d'h\u00f4te et l'adresse IP.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#construction-de-la-vm-vm1","title":"Construction de la VM vm1","text":"<p>L'utilisation de VirtualBox est consid\u00e9r\u00e9e acquise.  </p> <p>A d\u00e9faut, r\u00e9f\u00e9rez-vous aux m\u00e9mentos suivants : VirtualBox - Installation VirtualBox - Mode d\u2019acc\u00e8s r\u00e9seau par pont</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-creation-et-configuration","title":"- Cr\u00e9ation et configuration","text":"<p>Le PC h\u00f4te doit \u00eatre un PC 64 bits, courant de nos jours.  </p> <p>T\u00e9l\u00e9chargez l'ISO debian-12.x.y-amd64-netinst.iso : https://cdimage.debian.org/.../current/amd64/iso-cd/</p> <p>- D\u00e9marrez ensuite l'application VirtualBox 7.x, puis : - - Menu de VirtualBox &gt; Machine &gt; Nouvelle... -&gt; Nom : debian12-vm1 -&gt; Folder : S\u00e9lectionnez le dossier de stockage des VM -&gt; ISO Image : S\u00e9lectionnez l'ISO t\u00e9l\u00e9charg\u00e9e ci-dessus -&gt; Type : Linux -&gt; Version : Debian (64-bit) -&gt; Cochez Skip Unattended Installation (important) -&gt; Bouton Suivant</p> <p>-&gt; M\u00e9moire vive : 1024 MB -&gt; Processors : 2 CPU si possible -&gt; Bouton Suivant</p> <p>-&gt; Create a Virtual Hard Disk Now : Ajustez \u00e0 12 Go -&gt; Bouton Suivant</p> <p>-&gt; V\u00e9rifiez le R\u00e9capitulatif -&gt; Bouton Finish</p> <p>La VM s'affiche dans le panneau gauche de VirtualBox.</p> <p>S\u00e9lectionnez maintenant la nouvelle VM, puis : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet G\u00e9n\u00e9ral -&gt; Avanc\u00e9 &gt; Presse-papier partag\u00e9 &gt; Bidirectionnel</p> <p>- - - Onglet Syst\u00e8me -&gt; Carte m\u00e8re &gt; Ordre d'amor\u00e7age &gt; D\u00e9cochez Disquette -&gt; Processeur &gt; Cochez Activer PAE/NX</p> <p>Facultatif, acc\u00e8s au dossier partag\u00e9 par le PC h\u00f4te : - - - Onglet Dossiers partag\u00e9s -&gt; Cliquez sur l'ic\u00f4ne + (Ajoute un ... dossier partag\u00e9.) -&gt; Chemin du dossier &gt; S\u00e9lectionnez Autre... -&gt; Acc\u00e9dez \u00e0 votre dossier &gt; Ex : C:\\Partage-Windows -&gt; S\u00e9lectionner un dossier ou Ouvrir &gt; OK &gt; OK</p> <p>Les autres param\u00e8tres peuvent rester inchang\u00e9s.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-installation-de-debian-12","title":"- Installation de Debian 12","text":"<p>Conseil pratique avant de d\u00e9marrer la nouvelle VM : Si le curseur de la souris dispara\u00eet lors d'un clic dans la fen\u00eatre de la VM, celui-ci peut \u00eatre r\u00e9cup\u00e9r\u00e9 par le PC h\u00f4te \u00e0 l'aide de la touche CTRL situ\u00e9e \u00e0 droite de la barre d'espace du clavier.</p> <p>- - Menu de VirtualBox  &gt; Machine &gt; D\u00e9marrer -&gt; D\u00e9marrage normal (La VM s'ex\u00e9cute) </p> <p>S\u00e9lectionnez Graphical Install et appliquez ce qui suit : - Language &gt; Fran\u00e7ais - Pays (territoire ou r\u00e9gion) &gt; France - Disposition de clavier \u00e0 utiliser &gt; Fran\u00e7ais - Nom de machine &gt; debian12-vm1 - Domaine &gt; Laissez le champ vide - MDP du super utilisateur root &gt; MDP pour root - Confirmation du MDP &gt; MDP pour root - Nom complet du nouvel utilisateur &gt; Ex: client-linux - Identifiant pour le compte utilisateur &gt; client-linux - MDP pour le nouvel utilisateur &gt; MDP pour client-linux - Confirmation du MDP &gt; MDP pour client-linux - M\u00e9thode de partitionnement &gt; Assist\u00e9 - utili... entier - Disque \u00e0 partitionner &gt; Celui propos\u00e9 de 12 Go - Sch\u00e9ma de partitionnement &gt; Tout ... seule partition - Table des partitions &gt; Terminer le partitionnement ... - Faut-il appliquer les changements \u2026 disques ? &gt; Oui  </p> <p>L'installation commence : - Faut-il analyser d'autres supports ... ? &gt; Non - Pays du miroir de l'archive Debian &gt; France - Miroir de l'archive Debian &gt; deb.debian.org - Mandataire HTTP (lais...) &gt; Laissez vide  </p> <p>L'installation continue : - Souhaitez-vous participer \u00e0 l'\u00e9tude statistique ... &gt; Non - Logiciels \u00e0 installer -&gt; D\u00e9cochez environnement de bureau Debian -&gt; D\u00e9cochez ... GNOME -&gt; S\u00e9lectionnez ... Xfce -&gt; Conservez utilitaires usuels du syst\u00e8me  </p> <p>L'installation se termine : - Installer ... de d\u00e9marrage GRUB sur le secteur ... &gt; Oui - P\u00e9riph\u00e9rique ... programme de d\u00e9marrage &gt; /dev/sda - Installation termin\u00e9e &gt; Continuer (sans retrait du CD) </p> <p>Le syst\u00e8me reboot et une fen\u00eatre de connexion s'ouvre :</p> <p> </p> Fen\u00eatre de connexion Xfce <p>-&gt; Premier champ : client-linux -&gt; Second champ : MDP de l'utilisateur client-linux -&gt; Bouton Se connecter  </p> <p>Le bureau Xfce s'ouvre :</p> <p> </p> Bureau Xfce <p>Ouvrez le terminal de Cdes en cliquant sur son ic\u00f4ne situ\u00e9e en bas \u00e0 l'int\u00e9rieur du dock.  </p> <p>Autorisez l'usage de sudo \u00e0 l'utilisateur client-linux :</p> <pre><code>[client-linux@debian12-vm1:~$] su root\nMot de passe : Votre MDP root\n[root@debian12-vm1:~#] sudo usermod -aG sudo client-linux\n[root@debian12-vm1:~#] exit\n</code></pre> <p>et red\u00e9marrez la VM : - - Menu Applications de Xfce situ\u00e9 en haut \u00e0 gauche -&gt; D\u00e9connexion (Une fen\u00eatre s'ouvre) -&gt; Bouton Red\u00e9marrer  </p> <p>Reconnectez-vous ensuite en tant qu'utilisateur client-linux et rouvrez le terminal de Cdes.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-utilitaires-virtualbox","title":"- Utilitaires VirtualBox","text":"<p>Ils permettront entre autres le copier/coller et l'acc\u00e8s au dossier partag\u00e9 par le PC h\u00f4te.</p> <p>Notez par curiosit\u00e9 la version courante du noyau linux :</p> <pre><code>[client-linux@debian12-vm1:~$] uname -r\n</code></pre> <p>Exemple de retour :</p> <pre><code>6.1.0-11-amd64\n</code></pre> <p>Installez ensuite les 2 paquets Linux suivants :</p> <pre><code>[client-linux@debian12-vm1:~$] sudo apt install dkms build-essential\n</code></pre> <p>Debian installera automatiquement la d\u00e9pendance linux-headers-6.1.0-11-amd64.  </p> <p>Acc\u00e9dez ensuite au menu VirtualBox de la fen\u00eatre VM : -&gt; P\u00e9riph\u00e9riques &gt; Ins\u00e9rer l'image CD des Additions inv...  </p> <p>Montez l'image CD, installez les utilitaires et rebootez :</p> <pre><code>[client-linux@deb...] sudo mount /dev/cdrom /media/cdrom\n[client-linux@deb...] cd /media/cdrom/\n[client-linux@deb...] sudo ./VBoxLinuxAdditions.run\n[client-linux@deb...] sudo reboot\n</code></pre> <p>Reconnectez-vous, la fen\u00eatre de la VM peut \u00e0 pr\u00e9sent \u00eatre redimensionn\u00e9e avec la souris. Sa nouvelle taille sera enregistr\u00e9e au sein de debian12-vm1.</p> <p>Le copier/coller entre le PC h\u00f4te et debian12-vm1 doit maintenant fonctionner dans les 2 sens.  </p> <p>Sans fermer la VM, retirez l'image CD du lecteur virtuel : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet Stockage -&gt; Zone Unit\u00e9s de stockage &gt; S\u00e9lectionnez VBoxGuest... -&gt; Zone Attributs &gt; Cliquez sur l'ic\u00f4ne CD -&gt; Retirer le disque du lecteur virtuel &gt; OK</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-locale-fr_fr-de-libreoffice","title":"- Locale fr_FR de LibreOffice","text":"<p>Installez les paquets suivants :</p> <pre><code>[client-linux@debian12...] sudo apt install libreoffice-l10n-fr\n[client-linux@debian12...] sudo apt install libreoffice-help-fr\n</code></pre> <p>La configuration de base est presque termin\u00e9e :</p> <p> </p> Debian 12 : Bureau Xfce personnalis\u00e9 <p>Pour un m\u00eame fond d'\u00e9cran sur la fen\u00eatre de login Lightdm et le bureau Xfce, proc\u00e9dez ainsi :</p> <pre><code>[client-linux@deb...] cd /chemin-de-votre-fond-ecran\n[client-linux@deb...] sudo cp fond.jpg /usr/share/backgrounds/\n[client-linux@deb...] cd /etc/lightdm\n[client-linux@deb...] sudo nano lightdm-gtk-greeter.conf\n</code></pre> <p>Remplacez la ligne #background= par celle-ci :</p> <pre><code>background=/usr/share/backgrounds/fond.jpg\n</code></pre>"},{"location":"blog/vm1-et-2---vboxdeb12/#-dossier-partage-par-lhote","title":"- Dossier partag\u00e9 par l'h\u00f4te","text":"<p>Le trait d'union de l'utilisateur client-linux impose sous systemd de prendre des pr\u00e9cautions concernant le nom \u00e0 donner au service de montage du dossier partag\u00e9.  </p> <p>Pour savoir quel nom utiliser, entrez cette Cde :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo systemd-escape -p \\\n--suffix=mount \"/home/client-linux/Partage/\" \n</code></pre> <p>Le caract\u00e8re\u00a0\\\u00a0indique d'\u00e9crire la Cde sur une seule ligne.</p> <p>Retour :</p> <pre><code>home-client\\x2dlinux-Partage.mount\n</code></pre> <p>Le bloc \\x2d repr\u00e9sente le trait d'union de client-linux.  </p> <p>Sachant cela, cr\u00e9ez maintenant le fichier de service :</p> <pre><code>[client-linux@debian12-vm1:~#] cd /etc/systemd/system\n\n[client-linux@debian12-vm1:~#] sudo touch home-client\\x2dlinux-Partage.mount\n</code></pre> <p>Editez celui-ci en omettant le caract\u00e8re  dans le nom :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo nano home-clientx2dlinux-Partage.mount \n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription = Montage dossier partag\u00e9 fourni par VirtualBox\n\n[Mount]\nWhat = _Entrez le nom du dossier partag\u00e9 par le PC h\u00f4te_\nWhere = home-client\\x2dlinux-Partage\nType = vboxsf\nOptions=rw,uid=client-linux,gid=client-linux\n\n[Install]\nWantedBy = multi-user.target\n</code></pre> <p>Exemple pour What : What = Partage-Alfred  </p> <p>Int\u00e9grez le service dans la configuration de systemd :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo systemctl daemon-reload \n</code></pre> <p>et d\u00e9marrez celui-ci :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo systemctl start home-clientx2dlinux-Partage.mount \n</code></pre> <p>V\u00e9rifiez ensuite son statut :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo systemctl status home-clientx2dlinux-Partage.mount \n</code></pre> <p>Touche q pour quitter le r\u00e9sultat affich\u00e9.</p> <p>Si statut = active, autorisez le service au boot de la VM :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo systemctl enable home-clientx2dlinux-Partage.mount \n</code></pre> <p>Un lien symbolique vers le service est cr\u00e9\u00e9.  </p> <p>Pour finir, ouvrez le gestionnaire de fichiers : - - Menu Applications de Xfce situ\u00e9 en haut \u00e0 gauche -&gt; Syst\u00e8me &gt; Gestionnaire de fichiers Thunar  </p> <p>et observez le contenu partag\u00e9 par le PC h\u00f4te dans : /home/clientx2dlinux/Partage</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-configuration-reseau-de-vm1","title":"- Configuration r\u00e9seau de vm1","text":"<p>Avant, v\u00e9rifiez l'IP courante avec la Cde ip address :</p> <pre><code>[client-linux@debian12-vm1:~$] ip address\n</code></pre> <p>R\u00e9sultat, IP 10.0.2.15, IP fournie par VirtualBox :</p> <p> </p> R\u00e9sultat de la Cde ip address <p>La VM debian12-vm1 \u00e9tant pr\u00e9vue en zone LAN, il faut changer le mode d'acc\u00e8s r\u00e9seau de sa carte enp0s3.</p> <p>Pour cela, s\u00e9lectionnez la VM dans VirtualBox : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet R\u00e9seau -&gt; Adapter 1 &gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Name &gt; Remplacez intnet par switch_interne &gt; OK  </p> <p>Configurez \u00e0 pr\u00e9sent une IP fixe sur la carte enp0s3 : - - Bureau Xfce, barre du haut -&gt; Clic droit sur l'ic\u00f4ne R\u00e9seau situ\u00e9e \u00e0 droite -&gt; S\u00e9lectionnez Modifier les connexions...  </p> <p>Une fen\u00eatre Connexions r\u00e9seau s'ouvre : -&gt; S\u00e9lectionnez la connexion Wired connection 1 -&gt; Cliquez sur l'ic\u00f4ne roue dent\u00e9e de la fen\u00eatre</p> <p>Une fen\u00eatre Modification de ... s'ouvre : -&gt; Nom de la connexion &gt; Entrez Connexion carte 1  </p> <p>- - - Onglet Ethernet -&gt; P\u00e9riph\u00e9rique &gt; S\u00e9lectionnez enp0s3  </p> <p>- - - Onglet Param\u00e8tres IPv4 -&gt; M\u00e9thode &gt; S\u00e9lectionnez Manuel &gt; Bouton Ajouter -&gt; Champ Adresse : Entrez 192.168.3.2 -&gt; Champ Masque de r\u00e9seau : Entrez 255.255.255.0 -&gt; Champ Passerelle : Entrez 192.168.3.1 -&gt; Serveurs DNS &gt; Entrez l'IP locale de votre Box Internet -&gt; Bouton Enregistrer  </p> <p>Fermez ensuite la fen\u00eatre Connexions r\u00e9seau. Le service r\u00e9seau red\u00e9marre automatiquement.  </p> <p>V\u00e9rifiez par prudence la bonne configuration du r\u00e9seau :</p> <pre><code>[client-linux@debian12-vm1:~#] ip address\n[client-linux@debian12-vm1:~#] nmcli  # Cde NetworkManager\n</code></pre> <p> </p> R\u00e9sultat de la Cde nmcli <p>Les fichiers configur\u00e9s avec NetworkManager sont ici : /etc/NetworkManager/system-connections/  </p> <p>Le service r\u00e9seau peut \u00eatre red\u00e9marr\u00e9 avec cette Cde :</p> <pre><code>[client-linux@debian12-vm1:~#] sudo systemctl restart NetworkManager\n</code></pre> <p>Par curiosit\u00e9, lisez la table de routage avec la Cde ip r :</p> <p> </p> Table de routage de debian12-vm1 <p>Pour finir, s\u00e9lectionnez la VM srvlan dans VirtualBox : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet R\u00e9seau -&gt; Adapter 2 &gt; Mode d'acc\u00e8s r\u00e9seau = R\u00e9seau interne -&gt; Name &gt; Remplacez intnet par switch_interne &gt; OK  </p> <p>Les clients Linux seront ainsi raccord\u00e9s correctement \u00e0 srvlan au travers des liaisons nomm\u00e9es switch_interne.</p> <p>Nota</p> <p>La VM debian12-vm1 acc\u00e8de \u00e0 Internet si les VM srvsec et srvlan sont d\u00e9marr\u00e9es.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#construction-de-la-vm-vm2","title":"Construction de la VM vm2","text":""},{"location":"blog/vm1-et-2---vboxdeb12/#-clonage-de-vm1","title":"- Clonage de vm1","text":"<p>Comme indiqu\u00e9 au d\u00e9but du m\u00e9mento, vous allez commencer par cloner la VM debian12-vm1.</p> <p>Stoppez la VM, ensuite : -&gt; Panneau gauche de VirtualBox &gt; S\u00e9lectionnez celle-ci -&gt; Effectuez un clic droit sur la s\u00e9lection &gt; Cloner...  </p> <p>Une fen\u00eatre Cloner la machine virtuelle s'ouvre : - Nom de la nouvelle machine et chemin -&gt; Name &gt; Entrez debian12-vm2 -&gt; MAC Address Policy &gt; G\u00e9n\u00e9rer de nouvelles ... -&gt; Bouton Suivant  </p> <p>- Type de clone -&gt; S\u00e9lectionnez Clone int\u00e9gral -&gt; Bouton Finish</p> <p>Le clonage s'ex\u00e9cute.</p> <p>D\u00e9marrez la nouvelle VM une fois le clonage termin\u00e9 et connectez-vous sur celle-ci avec les login et MDP de l'h\u00f4te debian12-vm1.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-changement-du-nom-dhote","title":"- Changement du nom d'h\u00f4te","text":"<p>Ouvrez le terminal et modifiez le nom d'h\u00f4te :</p> <pre><code>[client-linux@debian12-vm1:~$] sudo hostnamectl set-hostname debian12-vm2\n</code></pre> <p>Editez ensuite le fichier DNS hosts :</p> <pre><code>[client-linux@debian12-vm1:~$] sudo nano /etc/hosts\n</code></pre> <p>et remplacez debian12-vm1 par debian12-vm2.</p> <p>Un message d'alerte appara\u00eetra, n'en tenez pas compte.  </p> <p>Red\u00e9marrez la VM, connectez-vous avec les m\u00eames login et MDP que pr\u00e9c\u00e9demment et ouvrez le terminal pour v\u00e9rifier que le prompt montre bien debian12-vm2.</p> <p>Pour finir, observez le r\u00e9sultat de la Cde hostnamectl :</p> <pre><code>[client-linux@debian11-vm2:~$] hostnamectl \n</code></pre> <p>Retour :</p> <pre><code>Static hostname: debian12-vm2\n       Icon name: computer-vm\n         Chassis: vm\n      Machine ID: ea1ed91bc3854862b45b2c3f80c009e6\n         Boot ID: 9e8fc772ba124dcca6cf7c56466fe4b5\n  Virtualization: oracle\nOperating System: Debian GNU/Linux 12 (bookworm)  \n          Kernel: Linux 6.1.0-11-amd64\n    Architecture: x86-64\n</code></pre>"},{"location":"blog/vm1-et-2---vboxdeb12/#-changement-de-ladresse-ip","title":"- Changement de l'adresse IP","text":"<p>Effectuez les op\u00e9rations suivantes : - - Bureau Xfce, barre du haut -&gt; Clic droit sur l'ic\u00f4ne R\u00e9seau situ\u00e9e \u00e0 droite -&gt; S\u00e9lectionnez Modifier les connexions...  </p> <p>Une fen\u00eatre Connexions r\u00e9seau s'ouvre : Supprimez la ou les connexions affich\u00e9es en cliquant sur l'ic\u00f4ne - situ\u00e9e en bas de la fen\u00eatre.  </p> <p>Ensuite, cliquez sur l'ic\u00f4ne + pour cr\u00e9er une connexion.  </p> <p>Une fen\u00eatre S\u00e9lectionner un type de connexion s'ouvre : -&gt; S\u00e9lectionnez Ethernet &gt; Bouton Cr\u00e9er...  </p> <p>Une fen\u00eatre Modification de ... s'ouvre : -&gt; Nom de la connexion &gt; Connexion carte 1  </p> <p>- - - Onglet Ethernet -&gt; P\u00e9riph\u00e9rique &gt; S\u00e9lectionnez enp0s3  </p> <p>- - - Onglet Param\u00e8tres IPv4 -&gt; M\u00e9thode &gt; S\u00e9lectionnez Manuel &gt; Bouton Ajouter -&gt; Champ Adresse : Entrez 192.168.3.4 -&gt; Champ Masque de r\u00e9seau : Entrez 255.255.255.0 -&gt; Champ Passerelle : Entrez 192.168.3.1 -&gt; Serveurs DNS &gt; Entrez l'IP locale de votre Box Internet -&gt; Bouton Enregistrer  </p> <p>Fermez ensuite la fen\u00eatre Connexions r\u00e9seau.  </p> <p>Le service r\u00e9seau red\u00e9marre automatiquement, sinon :</p> <pre><code>[client-linux@debian12-vm2:~$] sudo systemctl restart NetworkManager \n</code></pre> <p>V\u00e9rifiez la configuration avec la Cde ip address.  </p> <p>Nota</p> <p>Si probl\u00e8me d'IP, rebootez la VM et rev\u00e9rifiez.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#recapitulatif-et-tests-divers","title":"R\u00e9capitulatif et tests divers","text":""},{"location":"blog/vm1-et-2---vboxdeb12/#-recapitulatif","title":"- R\u00e9capitulatif","text":"<p>Voil\u00e0, le r\u00e9seau virtuel comprend d\u00e9j\u00e0 : - 1 PC h\u00f4te (Windows ou Linux) - 3 serveurs virtuels : srvlan, srvsec et srvdmz - 2 clients virtuels : debian12-vm1 et debian12-vm2  </p> <p>- Le switch virtuel Open vSwitch reste \u00e0 construire.  </p> <p>Retrouvez ceux-ci sur la maquette finale :</p> <p> </p> Configuration de base - Flux ICMP (ping)"},{"location":"blog/vm1-et-2---vboxdeb12/#-preparation-du-test","title":"- Pr\u00e9paration du test","text":"<p>Le test impose d'ajouter 3 routes statiques dans la table de routage du PC h\u00f4te.  </p> <p>Les Cdes ci-dessous concernent Windows, celles-ci sont diff\u00e9rentes sous OS X ou Linux.  </p> <p>Ouvrez \u00e0 pr\u00e9sent le Windows PowerShell (admin) et observez le contenu de la table de routage :</p> <pre><code>[C:\\~] route print\n</code></pre> <p>Ajoutez ensuite les 3 nouvelles routes comme suit :</p> <pre><code>[C:\\~] route add -p 192.168.2.0 mask 255.255.255.0 192.168.x.w\n\n[C:\\~] route add -p 192.168.3.0 mask 255.255.255.0 192.168.x.w\n\n[C:\\~] route add -p 192.168.4.0 mask 255.255.255.0 192.168.x.w\n</code></pre> <p>- Le commutateur -p rend la route cr\u00e9\u00e9e permanente. - L'adresse 192.168.x.w = IP de la carte RED d'IPFire.</p> <p>V\u00e9rifiez le r\u00e9sultat en r\u00e9affichant la table de routage :</p> <pre><code>[C:\\~] route print \n</code></pre> <p>Ces routes permettront entre autres le ping depuis le PC h\u00f4te vers les VM du r\u00e9seau local virtuel.</p> <p>Pour supprimer une route caduque, utilisez cette Cde :</p> <pre><code>[C:\\~] route delete 192.168.x.0 mask 255.255.255.0\n</code></pre>"},{"location":"blog/vm1-et-2---vboxdeb12/#-controle-du-serveur-dns","title":"- Contr\u00f4le du serveur DNS","text":"<p>Hormis IPFire, v\u00e9rifiez dans les fichiers /etc/resolv.conf des VM la pr\u00e9sence de :</p> <pre><code>nameserver 192.16...     # adresse IP de votre box Internet\n</code></pre> <p>A d\u00e9faut, corrigez ou ajoutez cette ligne manuellement.</p>"},{"location":"blog/vm1-et-2---vboxdeb12/#-test-du-reseau-local-virtuel","title":"- Test du r\u00e9seau local virtuel","text":"<p>Effectuez \u00e0 pr\u00e9sent le test de bon fonctionnement du r\u00e9seau \u00e0 l'aide de la Cde ping, ceci en v\u00e9rifiant la conformit\u00e9 des r\u00e9sultats avec ceux indiqu\u00e9s sur la maquette r\u00e9seau local virtuel.  </p> <p>Tout doit \u00eatre correct pour pouvoir continuer.</p> <p></p> <p>  Bravo pour \u00eatre arriv\u00e9 jusqu'ici ! Le m\u00e9mento 5.1 vous attend pour l'int\u00e9gration d'un switch virtuel Open vSwitch.</p> <p>M\u00e9mento 5.1</p>"},{"location":"blog/cockpit---vboxdeb12/","title":"Cockpit - VBox/Deb12","text":""},{"location":"blog/cockpit---vboxdeb12/#memento-121-cockpit","title":"M\u00e9mento 12.1 - Cockpit","text":"<p>Cockpit permettra de g\u00e9rer \u00e0 distance les syst\u00e8mes Linux des VM du r\u00e9seau virtuel, ceci au travers d'une interface Web en utilisant le nom de domaine <code>loupvirtuel.fr</code>.</p> <p>La gestion des VM sera centralis\u00e9e depuis un serveur Cockpit primaire install\u00e9 sur <code>srvdmz</code>.</p>"},{"location":"blog/cockpit---vboxdeb12/#acces-sur-le-reseau-virtuel","title":"Acc\u00e8s sur le r\u00e9seau virtuel","text":"<p>Le domaine <code>loupvirtuel.fr</code> n'\u00e9tant pas public, vous ne pouvez pas acc\u00e9der au site Web du r\u00e9seau virtuel depuis Internet en tapant son URL dans le champ adresse d'un navigateur Web.</p> <p>En revanche, vous pouvez simuler cet acc\u00e8s Internet depuis un PC situ\u00e9 sur votre r\u00e9seau local.</p> <p>Par exemple, pour un PC Windows :</p> <p>- Etape 1 Entrez sur ce PC, comme dans le m\u00e9mento Contr\u00f4le \u00e0 distance - VBox/Deb12, les 3 routes statiques permettant de joindre les VM du r\u00e9seau local virtuel.</p> <pre><code>[C:\\~] route add -p 192.168.2.0 mask 255.255.255.0 192.168.x.w\n\n[C:\\~] route add -p 192.168.3.0 mask 255.255.255.0 192.168.x.w\n\n[C:\\~] route add -p 192.168.4.0 mask 255.255.255.0 192.168.x.w\n</code></pre> <p>192.168.x.w est l'IP de la carte r\u00e9seau RED d'IPFire. Le -p d\u00e9clare les routes comme \u00e9tant permanentes.</p> <p>- Etape 2 Ajoutez ensuite ces 2 lignes au fichier DNS C:\\Windows\\System32\\drivers\\etc\\hosts :</p> <pre><code># loupvirtuel.fr\n192.168.4.2 loupvirtuel.fr\n</code></pre> <p>- Etape 3 Finissez en testant l'URL <code>https://loupvirtuel.fr</code> :</p> <p> </p> Site Web : Accueil du domaine loupvirtuel.fr <p>Voil\u00e0, vous \u00eates pr\u00eat pour installer et utiliser Cockpit.</p>"},{"location":"blog/cockpit---vboxdeb12/#cockpit-primaire-sur-srvdmz","title":"Cockpit primaire sur srvdmz","text":"<p>Cockpit permet l'administration de son syst\u00e8me Linux (Cockpit primaire) ainsi que l'administration centralis\u00e9e d'autres syst\u00e8mes Linux (Cockpits secondaires).</p> <p>Les onglets de son interface Web proposent de :</p> <p>-- Partie Syst\u00e8me --</p> <ul> <li>Visualiser l'\u00e9tat du mat\u00e9riel -&gt; Aper\u00e7u </li> <li>Lire les journaux syst\u00e8me -&gt; Journaux </li> <li>Visualiser les disques -&gt; Stockage </li> <li>Visualiser le trafic r\u00e9seau -&gt; R\u00e9seau </li> <li>G\u00e9rer les comptes utilisateurs -&gt; Comptes </li> <li>G\u00e9rer les services -&gt; Services</li> </ul> <p>-- Partie Outils --</p> <ul> <li>G\u00e9rer les applications -&gt; Applications </li> <li>G\u00e9rer les MAJ -&gt; Mises \u00e0 jour de logiciel </li> <li>Travailler avec un Terminal Web -&gt; Terminal</li> </ul> <p>Il est \u00e9galement possible, depuis cette interface, de :</p> <ul> <li>G\u00e9rer d'autres serveurs Linux (centralisation) </li> <li>G\u00e9rer, cr\u00e9er des VM (plugin cockpit-machines) </li> <li>G\u00e9rer des CTN Podman (plugin cockpit-podman) </li> <li>Etc\u2026</li> </ul> <p>Pour installer Cockpit sur <code>srvdmz</code>, entrez ces Cdes :</p> <p>-- Debian 11 --</p> <pre><code>[srvdmz@srvdmz:~$] su root\n\n[root@srvdmz:~$] cd /etc/apt/sources.list.d/\n\n[root@srvdmz:~$] echo \"deb http://deb.debian.org/debian bullseye-backports main\" &gt; backports.list\n\n[root@srvdmz:~$] exit\n\n[srvdmz@srvdmz:~$] sudo apt update\n\n[srvdmz@srvdmz:~$] sudo apt install -t bullseye-backports cockpit\n\n[srvdmz@srvdmz:~$] sudo apt install -t bullseye-backports cockpit-pcp\n\n[srvdmz@srvdmz:~$] sudo systemctl enable cockpit.socket\n\n[srvdmz@srvdmz:~$] sudo systemctl start cockpit\n</code></pre> <p>-- Debian 12 --</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install cockpit cockpit-pcp\n</code></pre>"},{"location":"blog/cockpit---vboxdeb12/#reglages-portpare-feussl","title":"R\u00e9glages Port/Pare-feu/SSL","text":""},{"location":"blog/cockpit---vboxdeb12/#-port-utilise-par-cockpit","title":"- Port utilis\u00e9 par Cockpit","text":"<p>Le num\u00e9ro de port par d\u00e9faut de Cockpit est le 9090. Vous allez, par s\u00e9curit\u00e9, modifier celui-ci.</p> <p>Commencez par cr\u00e9er un dossier cockpit.socket.d :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/systemd/system/\n[srvdmz@srvdmz:~$] sudo mkdir cockpit.socket.d\n</code></pre> <p>G\u00e9n\u00e9rez dans celui-ci un fichier listen.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd cockpit.socket.d\n[srvdmz@srvdmz:~$] sudo nano listen.conf \n</code></pre> <p>et entrez ceci pour d\u00e9clarer l'usage du port 9528 :</p> <pre><code>[Socket]\nListenStream=\nListenStream=9528\n</code></pre> <p>Pour finir, rechargez la nouvelle configuration systemd et relancez la partie r\u00e9seau de Cockpit :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl daemon-reload\n[srvdmz@srvdmz:~$] sudo systemctl restart cockpit.socket \n</code></pre> <p>Le Cockpit de <code>srvdmz</code> \u00e9coutera ainsi sur le port 9528.</p>"},{"location":"blog/cockpit---vboxdeb12/#-pare-feu-vm-ipfire","title":"- Pare-feu VM IPFire","text":"<p>Ouvrez le port 9528 au niveau de la VM IPFire (Ref: M\u00e9mento DNS split - VBox/Deb12) :</p> <p> </p> IPFire : Utilisation du port 9528 autoris\u00e9"},{"location":"blog/cockpit---vboxdeb12/#-ssl-domaine-loupvirtuelfr","title":"- SSL domaine loupvirtuel.fr","text":"<p>Cockpit fournit de base un certificat SSL auto-sign\u00e9 pour les connexions HTTPS entrantes, une alerte de s\u00e9curit\u00e9 est alors affich\u00e9e par les navigateurs Web.</p> <p>Vous allez, pour \u00e9viter cela, utiliser le certificat du domaine <code>loupvirtuel.fr</code> (Ref : M\u00e9mento LAMP - VBox/Deb12 2/2).</p> <p>Commencez par copier ces 2 fichiers SSL dans le dossier /etc/cockpit/ws-certs.d :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/ssl\n\n[srvdmz@srvdmz:~$] sudo cp loupvirtuel.crt /etc/cockpit/ws-certs.d \n\n[srvdmz@srvdmz:~$] sudo cp loupvirtuel.key /etc/cockpit/ws-certs.d\n</code></pre> <p>Renommez, si pr\u00e9sent dans le dossier ci-dessous, le certificat auto-sign\u00e9 de Cockpit :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/cockpit/ws-certs.d\n\n[srvdmz@srvdmz:~$] sudo mv 0-self-signed.cert 0-self-signed.cert-save\n</code></pre> <p>et modifiez les droits des 2 fichiers import\u00e9s :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chown root:cockpit-ws loupvirtuel.*\n</code></pre> <p>Red\u00e9marrez Cockpit :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart cockpit\n[srvdmz@srvdmz:~$] sudo systemctl status cockpit\n</code></pre> <p>Cockpit est maintenant accessible depuis l'URL : <code>https://loupvirtuel.fr:9528</code></p> <p>Nota</p> <p>L'ensemble des captures ci-dessous issu de Debian 11 est proche de Debian 12.</p> <p> </p> Cockpit : Fen\u00eatre de login <p>Connectez-vous en tant qu'utilisateur <code>srvdmz</code>.</p> <p>La page d'accueil de Cockpit doit s'afficher : -&gt; Bouton Activez l'acc\u00e8s administrateur</p> <p>Une fen\u00eatre Passer \u00e0 l\u2019acc\u00e8s administrateur s'ouvre : -&gt; Mot de passe de <code>srvdmz</code> : Entrez le MDP de <code>srvdmz</code> -&gt; Bouton S'authentifier</p> <p> </p> Cockpit : Accueil = Onglet Aper\u00e7u <p>Le contenu de la zone de notification, soit celui du fichier /etc/motd, peut maintenant \u00eatre modifi\u00e9 en cliquant sur l'ic\u00f4ne d'\u00e9dition situ\u00e9e dans la zone.</p> <p>Acc\u00e9dez maintenant au Widget Utilisation : -&gt; Voir les m\u00e9triques et l'historique</p> <p>Ceux-ci appara\u00eetront au bout de quelques instants.</p> <p>Nota</p> <p>Si vous disposez d'un nom de domaine rout\u00e9 par votre Box Internet sur l'un de vos serveurs, vous pouvez utiliser celui-ci pour joindre le Cockpit de la VM srvdmz, ceci en cr\u00e9ant une r\u00e8gle de proxy inverse appropri\u00e9e.</p>"},{"location":"blog/cockpit---vboxdeb12/#interface-web-de-cockpit","title":"Interface Web de Cockpit","text":"<p>Observez maintenant le contenu de chacun des modules de Cockpit, soit :</p> <p>-- Partie Syst\u00e8me --</p> <ul> <li>Journaux (Priorit\u00e9 = Erreur et au dessus)</li> </ul> <p> </p> Cockpit : Onglet Journaux <p>Contr\u00f4le des logs du syst\u00e8me, options de filtrage.</p> <ul> <li>Stockage</li> </ul> <p> </p> Cockpit : Onglet Stockage <p>Gestion du stockage, options de gestion RAID et NFS.</p> <ul> <li>R\u00e9seau</li> </ul> <p> </p> Cockpit : Onglet R\u00e9seau <p>Gestion du r\u00e9seau, options d'ajout de Lien/Pont/VLAN.</p> <ul> <li>Comptes</li> </ul> <p> </p> Cockpit : Onglet Comptes <p>Gestion des comptes, options de cr\u00e9ation Group/User.</p> <ul> <li>Services</li> </ul> <p> </p> Cockpit : Onglet Services <p>Gestion des statuts des services, options de filtrage.</p> <p>-- Partie Outils --</p> <ul> <li>Applications</li> </ul> <p> </p> Cockpit : Onglet Applications <p>Gestion des extensions utilis\u00e9es (plugins).</p> <ul> <li>Mises \u00e0 jour logicielles</li> </ul> <p> </p> Cockpit : Onglet Mises \u00e0 jour de logiciel <p>MAJ des paquets du syst\u00e8me, option de red\u00e9marrage.</p> <ul> <li>Terminal (tr\u00e8s pratique)</li> </ul> <p> </p> Cockpit : Onglet Terminal <p>Usage de la ligne de Cde pour administrer le syst\u00e8me.</p> <p>La d\u00e9connexion de Cockpit s'effectue depuis le menu Session situ\u00e9 en haut et \u00e0 droite de la page Web.</p>"},{"location":"blog/cockpit---vboxdeb12/#gestion-centralisee-du-reseau","title":"Gestion centralis\u00e9e du r\u00e9seau","text":"<p>Il est possible de g\u00e9rer, hormis les CTN LXC, l'ensemble des VM et CTN Podman du r\u00e9seau local virtuel depuis le Cockpit install\u00e9 sur la VM <code>srvdmz</code>.</p> <p>Pour cela, il faut rendre les VM \u00e0 g\u00e9rer accessibles en protocole SSH (Ref: M\u00e9mento Contr\u00f4le \u00e0 distance - VBox/Deb12) et installer Cockpit sur celles-ci.</p> <p>SSH ne propose pour l'instant que la lecture seule sur les VM distantes, il faudra toujours cliquer sur le bouton Activez l'acc\u00e8s administrateur de celles-ci pour les g\u00e9rer.</p> <p>SSH augmentera la s\u00e9curit\u00e9 entre les VM et \u00e9vitera d'avoir \u00e0 saisir les MDP de fa\u00e7on r\u00e9p\u00e9t\u00e9e.</p> <p>Les VM \u00e0 g\u00e9rer depuis le Cockpit de la VM <code>srvdmz</code> seront \u00e0 cr\u00e9er en tant que nouveaux h\u00f4tes.</p>"},{"location":"blog/cockpit---vboxdeb12/#-ajout-de-srvlan-nouvel-hote","title":"- Ajout de srvlan (nouvel h\u00f4te)","text":"<p>Commencez par installer un serveur SSH sur <code>srvlan</code> :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install openssh-server\n[srvlan@srvlan:~$] sudo systemctl status sshd\n</code></pre> <p>Editez ensuite le fichier de configuration de SSH :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/ssh/sshd_config\n</code></pre> <p>et remplacez la ligne #Port 22 par Port 222.</p> <p>Relancez le service SSH pour traiter la modification :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart sshd\n</code></pre> <p>et installez Cockpit sur la VM <code>srvlan</code> comme pratiqu\u00e9 sur la VM <code>srvdmz</code>.</p> <p>Connectez-vous ensuite sur le Cockpit de <code>srvdmz</code> et cliquez sur le menu d\u00e9roulant situ\u00e9 en haut et \u00e0 gauche de la page Web : -&gt; Bouton Ajouter un nouvel h\u00f4te</p> <p>Une fen\u00eatre Ajouter un nouvel h\u00f4te s'ouvre : -&gt; H\u00f4te : <code>srvlan.intra.loupvirtuel.fr</code>:222 -&gt; Nom d'utilisateur : <code>srvlan</code> -&gt; Couleur : Choisissez une couleur pour la VM -&gt; Bouton Ajouter</p> <p>Une fen\u00eatre Nouvel h\u00f4te s'ouvre : -&gt; Bouton Accepter la cl\u00e9 et se connecter</p> <p>Une fen\u00eatre Connectez-vous \u00e0 <code>srvlan</code>@... s'ouvre : -&gt; Mot de passe : MDP de <code>srvlan</code> -&gt; Cochez Cr\u00e9er une nouvelle cl\u00e9 SSH et l'autoriser</p> <p>Le fen\u00eatre ouverte s'\u00e9tend : -&gt; Mot de passe cl\u00e9 : MDP de <code>srvdmz</code> et non de <code>srvlan</code> -&gt; Confirmer ... de passe de la cl\u00e9 : MDP de <code>srvdmz</code> -&gt; Bouton Connexion</p> <p>L'h\u00f4te <code>srvlan</code>@... est ajout\u00e9 dans le menu d\u00e9roulant situ\u00e9 en haut et \u00e0 gauche de la page Web.</p> <p>Fermez la connexion <code>srvdmz</code>@... depuis le menu Session situ\u00e9 en haut et \u00e0 droite de la page Web.</p> <p>Remarques : - Un h\u00f4te <code>srvlan.intra.loup...</code> a \u00e9t\u00e9 ajout\u00e9 dans le fichier /home/srvdmz/.ssh/known_hosts.</p> <p>- 2 cl\u00e9s SSH id_rsa et id_rsa.pub ont \u00e9t\u00e9 cr\u00e9\u00e9es sur <code>srvdmz</code> dans /home/srvdmz/.ssh/.</p> <p>- La cl\u00e9 id_rsa.pub a \u00e9t\u00e9 copi\u00e9e comme authorized_keys sur <code>srvlan</code> dans /home/srvlan/.ssh/.</p> <p>Reconnectez-vous maintenant sur le Cockpit de la VM <code>srvdmz</code> et s\u00e9lectionnez ensuite l'h\u00f4te <code>srvlan</code>@..., la liaison sera directement \u00e9tablie sans demande de MDP.</p> <p> </p> Cockpit : Gestion de srvlan depuis srvdmz <p>Les connexions futures depuis le Cockpit de la VM <code>srvdmz</code> sur celui de la VM <code>srvlan</code> se feront sans demande de MDP, ceci gr\u00e2ce \u00e0 la configuration SSH.</p>"},{"location":"blog/cockpit---vboxdeb12/#-ajout-dovs-nouvel-hote","title":"- Ajout d'ovs (nouvel h\u00f4te)","text":"<p>Un serveur SSH \u00e9coute d\u00e9j\u00e0 sur le port 222.</p> <p>Installez seulement Cockpit avec les m\u00eames Cdes que celles utilis\u00e9es sur la VM <code>srvdmz</code>.</p> <p>Nota</p> <p>Pour Debian 12, ajoutez le paquet cockpit-podman qui permettra de g\u00e9rer les conteneurs.</p> <p>Connectez-vous ensuite sur le Cockpit de la VM <code>srvdmz</code> et cliquez sur le menu d\u00e9roulant situ\u00e9 en haut et \u00e0 gauche de la page Web : -&gt; Bouton Ajouter un nouvel h\u00f4te</p> <p>Une fen\u00eatre Ajouter un nouvel h\u00f4te s'ouvre : -&gt; H\u00f4te : <code>ovs.intra.loupvirtuel.fr</code>:222 -&gt; Nom d'utilisateur : <code>switch</code> -&gt; Couleur : Choisissez une couleur pour la VM -&gt; Bouton Ajouter</p> <p>Une fen\u00eatre Nouvel h\u00f4te s'ouvre : -&gt; Bouton Accepter la cl\u00e9 et se connecter</p> <p>L' h\u00f4te <code>ovs</code> est alors ajout\u00e9 dans le fichier : /home/srvdmz/.ssh/known_hosts</p> <p>Une fen\u00eatre Connectez-vous \u00e0 <code>switch</code>@... s'ouvre : -&gt; Mot de passe : MDP de <code>switch</code> -&gt; Cochez cette fois Autoriser la cl\u00e9 SSH -&gt; Bouton Connexion</p> <p>L'h\u00f4te <code>switch</code>@... a \u00e9t\u00e9 ajout\u00e9 dans le menu d\u00e9roulant situ\u00e9 en haut et \u00e0 gauche de la page Web.</p> <p>La cl\u00e9 SSH publique id_rsa.pub de <code>srvdmz</code> est alors copi\u00e9e comme authorized_keys sur <code>ovs</code>.</p> <p>Cliquez \u00e0 pr\u00e9sent l'h\u00f4te <code>switch</code>, la connexion doit s'\u00e9tablir directement sans demande de MDP.</p> <p>Nota</p> <p>Pour Debian 12, Cockpit affichera les conteneurs Podman en mode rootless et rootfull.</p>"},{"location":"blog/cockpit---vboxdeb12/#-acces-cockpit-secondaire","title":"- Acc\u00e8s Cockpit secondaire","text":"<p>Au pr\u00e9alable, ajoutez Cockpit et un serveur SSH sur les VM <code>debian**-vm*</code>.</p> <p>L'acc\u00e8s direct sur un Cockpit secondaire se fera au travers du Cockpit primaire de la VM <code>srvdmz</code>.</p> <p>Pour, par exemple, joindre le Cockpit de <code>debian12-vm1</code> : -&gt; Acc\u00e9dez \u00e0 la fen\u00eatre de login du Cockpit de <code>srvdmz</code> -&gt; Remplissez ensuite les champs comme ci-dessous</p> <p> </p> Cockpit : Liaison directe sur un Cockpit secondaire <p>-&gt; Cliquez sur le bouton Connexion</p> <p>Une fen\u00eatre Nouvel h\u00f4te s'ouvre : -&gt; Bouton Accepter la cl\u00e9 et se connecter</p> <p>La connexion est \u00e9tablie, l'acceptation de la cl\u00e9 SSH ne sera plus demand\u00e9e \u00e0 l'avenir.</p>"},{"location":"blog/cockpit---vboxdeb12/#bilan","title":"Bilan","text":"<p>Cockpit est l\u00e9ger, fiable, s\u00e9curis\u00e9 et son interface Web responsive permet d'administrer un syst\u00e8me Linux facilement y compris depuis un smartphone.</p> <p>La gestion centralis\u00e9e de plusieurs syst\u00e8mes Linux est un plus.</p> <p>Il propose aussi un peu de supervision, ceci en affichant quelques m\u00e9triques bien utiles sous forme graphique.</p> <p>Fin.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/","title":"Contr\u00f4le \u00e0 distance - VBox/Deb12","text":""},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#memento-61-rdp-vnc-ssh","title":"M\u00e9mento 6.1 - RDP, VNC, SSH","text":"<p>Il peut \u00eatre utile de pouvoir contr\u00f4ler \u00e0 distance les VM et les conteneurs LXC du r\u00e9seau, notamment depuis un PC situ\u00e9 sur le m\u00eame LAN que le PC h\u00f4te de VirtualBox. Des protocoles tels RDP, VNC ou SSH permettent cela.</p> <p>Etant sur le m\u00eame LAN, les connexions distantes seront valid\u00e9es simplement par login et MDP.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#rdp-via-virtualbox","title":"RDP via VirtualBox","text":"<p>Par d\u00e9faut, le serveur Remote Desktop Protocol fourni par VirtualBox utilise le port TCP 3389.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-acces-rdp-sur-srvlan","title":"- Acc\u00e8s RDP sur srvlan","text":"<p>Panneau gauche de VirtualBox, s\u00e9lectionnez la VM : - - Menu de VirtualBox &gt; Machine &gt; Configuration -&gt; Affichage &gt; Bureau \u00e0 distance -&gt; Cochez Activer le serveur -&gt; Port serveur &gt; Affectez un num\u00e9ro de port, Ex : 7002 -&gt; OK</p> <p> </p> VirtualBox : R\u00e9glages du bureau \u00e0 distance"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#windows-routes","title":"- Test de connexion","text":"<p>- - Depuis un PC distant sous Windows Cr\u00e9ez, sur celui-ci, les 3 routes statiques permanentes qui permettront de joindre les VM :</p> <pre><code>route add -p 192.168.2.0 mask 255.255.255.0 192.168.x.w\n\nroute add -p 192.168.3.0 mask 255.255.255.0 192.168.x.w\n\nroute add -p 192.168.4.0 mask 255.255.255.0 192.168.x.w \n</code></pre> <p>192.168.x.w est l'IP de la carte r\u00e9seau RED d'IPFire. Le param\u00e8tre -p rend la route statique permanente.</p> <p>Utilisez la Cde route print pour afficher la table de routage de Windows.</p> <p>Menu Windows : -&gt; Accessoires Windows ou Outils Windows -&gt; Connexion Bureau \u00e0 distance</p> <p>Activez la connexion RDP comme montr\u00e9 ci-dessous :</p> <p> </p> Bureau \u00e0 distance : IP PC h\u00f4te VM:port RDP srvlan <p> </p> Bureau \u00e0 distance : Login retourn\u00e9 par srvlan <p> </p> Bureau \u00e0 distance : Session RDP ouverte sur srvlan <p>- - Depuis un PC distant sous Linux Cr\u00e9ez les m\u00eames routes statiques comme ceci :</p> <pre><code>sudo ip route add 192.168.2.0/24 via 192.168.x.w proto static metric 100\n\nsudo ip route add 192.168.3.0/24 via 192.168.x.w proto static metric 100\n\nsudo ip route add 192.168.4.0/24 via 192.168.x.w proto static metric 100  \n</code></pre> <p>Pour rendre celles-ci permanentes, vous devez tenir compte du gestionnaire de r\u00e9seau actif.</p> <p>Si NetworkManager est utilis\u00e9, g\u00e9n\u00e9rez les routes statiques depuis son interface graphique et relancez le service r\u00e9seau :</p> <pre><code>sudo systemctl restart NetworkManager\n</code></pre> <p>Si c'est le fichier r\u00e9seau /etc/network/interfaces qui est utilis\u00e9, ajoutez les lignes suivantes en fin de fichier et relancez le service r\u00e9seau :</p> <pre><code>up ip route add 192.168.2.0/24 via 192.168.x.w dev enp0s3\nup ip route add 192.168.3.0/24 via 192.168.x.w dev enp0s3\nup ip route add 192.168.4.0/24 via 192.168.x.w dev enp0s3\n\nsudo systemctl restart networking\n</code></pre> <p>Adaptez en cons\u00e9quence le nom de l'interface r\u00e9seau.</p> <p>Pour finir, v\u00e9rifiez la prise en compte des routes :</p> <pre><code>ip route\n</code></pre> <p>Puis installez le client r\u00e9seau Remmina disponible sur bien des distributions et lancez celui-ci.</p> <p>192.168.x.y = IP du PC h\u00f4te des VM (Voir la maquette). 7002 est le num\u00e9ro de port RDP d\u00e9di\u00e9 \u00e0 la VM srvlan.</p> <p> </p> Remmina : Fen\u00eatre de connexion RDP <p>Appuyez sur la touche Entr\u00e9e pour lancer la connexion :</p> <p> </p> Remmina : Session RDP ouverte sur srvlan"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-remarques","title":"- Remarques","text":"<p>Vous devez, pour vous connecter sur les autres VM du r\u00e9seau, affecter \u00e0 chacune un num\u00e9ro de port RDP diff\u00e9rent, Ex : port 6017 pour la VM srvdmz.</p> <p>Le serveur RDP de VirtualBox autorise des connexions directes sur les VM, pas besoin par exemple de traverser le pare-feu IPFire pour joindre srvlan.</p> <p>Ceci permet notamment d'\u00e9viter un refus de connexion li\u00e9 \u00e0 des probl\u00e8mes de configuration de table de routage ou de r\u00e8gle de pare-feu sur le r\u00e9seau virtuel. Cela peut aider \u00e0 d\u00e9panner.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#rdp-via-ipfire","title":"RDP via IPFire","text":"<p>Cela ne concerne pas les VM non graphiques telles IPFire, OpenvSwitch et les conteneurs LXC.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-serveur-rdp-sur-srvlan","title":"- Serveur RDP sur srvlan","text":"<p>Installez le serveur RDP de nom xrdp :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install xrdp\n[srvlan@srvlan:~$] sudo adduser xrdp ssl-cert\n</code></pre> <p>Le serveur est lanc\u00e9 de suite et configur\u00e9 pour d\u00e9marrer automatiquement au boot de la VM.</p> <p>Compl\u00e9ment pour les curieux : Suivre les astuces facilitant l'exploitation du service xrdp.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-regle-de-pare-feu-rdp","title":"- R\u00e8gle de pare-feu RDP","text":"<p>L'acc\u00e8s distant ne fonctionnera cette fois que si vous ajoutez une r\u00e8gle de pare-feu dans IPFire autorisant les demandes de connexion sur le port 3389.</p> <p>Acc\u00e9dez \u00e0 l'interface graphique d'IPFire depuis le navigateur Web de srvlan : -&gt; Pare-feu &gt; R\u00e8gles de pare-feu &gt; Nouvelle r\u00e8gle</p> <p>- Zone Source -&gt; Cochez R\u00e9seaux standards &gt; S\u00e9lectionnez Tout</p> <p>- Zone Destination -&gt; Cochez R\u00e9seaux standards &gt; S\u00e9lectionnez Tout</p> <p>- Zone Protocole -&gt; S\u00e9lectionnez TCP &gt; Port de destination -&gt; Remplissez le champ vide avec le n\u00b0 de port 3389</p> <p>-&gt; Cochez ACCEPTER</p> <p>- Zone Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez Connexions RDP entrantes autoris\u00e9es</p> <p>-&gt; Ajouter &gt; Appliquer les changements</p> <p> </p> IPFire : R\u00e8gle de pare-feu RDP <p>Important</p> <p>Fermez ensuite votre session utilisateur srvlan, le serveur xrdp refusant par d\u00e9faut d'afficher le bureau d'un utilisateur ayant une session d\u00e9j\u00e0 ouverte.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-test-de-connexion-rdp","title":"- Test de connexion RDP","text":"<p>- - Depuis un PC distant sous Windows Menu Windows : -&gt; Accessoires Windows ou Outils Windows -&gt; Connexion Bureau \u00e0 distance</p> <p>Entrez l'IP de srvlan 192.168.2.2 dans le champ Ordinateur et cliquez sur le bouton Connexion.</p> <p>Une alerte Impossible de v\u00e9rifier l'identit\u00e9 ... &gt; Oui</p> <p>Connexion \u00e9tablie, la fen\u00eatre suivante s'affiche :</p> <p> </p> Fen\u00eatre de connexion du serveur xrdp <p>-&gt; Session : S\u00e9lectionnez Xorg -&gt; username : Entrez srvlan -&gt; password : Entrez le MDP de srvlan &gt; OK</p> <p>- - Depuis un PC distant sous Linux Utilisez de nouveau le logiciel Remmina : -&gt; Entrez l'IP de srvlan soit 192.168.2.2 -&gt; Touche Entr\u00e9e pour lancer la connexion</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#vnc-via-ipfire","title":"VNC via IPFire","text":"<p>Cela ne concerne pas les VM non graphiques telles IPFire, OpenvSwitch et les conteneurs LXC.</p> <p>Par d\u00e9faut, un serveur VNC (Virtual Network Computing) \u00e9coute sur le port TCP 5900+N\u00b0 Ecran.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#serveur-vnc","title":"- Serveur VNC sur srvlan","text":"<p>Installez le serveur tigervnc-standalone-server :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install tigervnc-standalone-server\n[srvlan@srvlan:~$] sudo apt install dbus-x11\n</code></pre> <p>Cr\u00e9ez son MDP :</p> <pre><code>[srvlan@srvlan:~$] vncpasswd\n</code></pre> <p>Retour :</p> <pre><code>Password &gt; Votre MDP VNC (Ex : vncMDPsrvlan)\nVerify &gt; Entrez de nouveau le MDP\nWould you like to enter a view-only ... (y/n) ? &gt; n\nA view-only password is not used\n</code></pre> <p>Cr\u00e9ez ensuite son fichier de configuration tigervnc.conf :</p> <pre><code>[srvlan@srvlan:~$] cd /home/srvlan\n[srvlan@srvlan:~$] nano .vnc/tigervnc.conf\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code># Configuration du serveur tigervncserver\n$localhost=\"no\";          # Connexion distante autoris\u00e9e\n$geometry=\"1360x768\";     # Taille de l'\u00e9cran\n$depth=\"24\";              # Profondeur des couleurs\n$AlwaysShared = \"yes\";    # Connexions simultan\u00e9es OK\n</code></pre> <p>Cr\u00e9ez un fichier xstartup pour le d\u00e9marrage sous Xfce4 :</p> <pre><code>[srvlan@srvlan:~$] nano .vnc/xstartup\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>#!/bin/sh\nunset SESSION_MANAGER\nunset DBUS_SESSION_BUS_ADDRESS\nexec /bin/sh /etc/xdg/xfce4/xinitrc\n</code></pre> <p>D\u00e9clarez le fichier comme \u00e9tant ex\u00e9cutable :</p> <pre><code>[srvlan@srvlan:~$] chmod +x .vnc/xstartup\n</code></pre> <p>Pour terminer, modifiez le fichier vncserver.users :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/tigervnc/vncserver.users\n</code></pre> <p>en ajoutant les lignes suivantes \u00e0 la fin de celui-ci :</p> <pre><code># Utilisateur srvlan d\u00e9sign\u00e9 pour l'\u00e9cran 1\n:1=srvlan\n</code></pre>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-lancement-auto-du-serveur","title":"- Lancement auto du serveur","text":"<p>Pour cela, cr\u00e9ez le service <code>tigervncserver@.service</code> :</p> <pre><code>[srvlan@srvlan:~$] cd /lib/systemd/system\n[srvlan@srvlan:~$] sudo cp tigervncserver@.service \\\n/etc/systemd/system\n</code></pre> <p>Le caract\u00e8re  indique d'\u00e9crire la Cde sur une seule ligne.</p> <p>Configurez son d\u00e9marrage automatique pour l'\u00e9cran 1 :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl start tigervncserver@:1\n[srvlan@srvlan:~$] sudo systemctl enable tigervncserver@:1\n</code></pre> <p>Pour finir, red\u00e9marrez srvlan :</p> <pre><code>[srvlan@srvlan:~$] sudo reboot\n</code></pre> <p>et v\u00e9rifiez le lancement automatique du serveur VNC :</p> <pre><code>[srvlan@srvlan:~$] vncserver -list\n</code></pre> <p> </p> Serveur VNC : Port par d\u00e9faut 5901 en \u00e9coute <p>Pour info, le serveur peut \u00eatre arr\u00eat\u00e9 comme suit :</p> <pre><code>[srvlan@srvlan:~$] vncserver -kill :1\n</code></pre>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-regle-de-pare-feu-vnc","title":"- R\u00e8gle de pare-feu VNC","text":"<p>Acc\u00e9dez \u00e0 l'interface graphique d'IPFire depuis le navigateur Web de srvlan : -&gt; Pare-feu &gt; R\u00e8gles de pare-feu &gt; Nouvelle r\u00e8gle</p> <p>- Zone Source -&gt; Cochez R\u00e9seaux standards &gt; S\u00e9lectionnez Tout</p> <p>- Zone Destination -&gt; Cochez R\u00e9seaux standards &gt; S\u00e9lectionnez Tout</p> <p>- Zone Protocole -&gt; S\u00e9lectionnez TCP &gt; Port de destination -&gt; Remplissez le champ vide avec le n\u00b0 de port 5901</p> <p>-&gt; Cochez ACCEPTER</p> <p>- Zone Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez Connexions VNC entrantes autoris\u00e9es</p> <p>-&gt; Ajouter &gt; Appliquer les changements</p> <p> </p> IPFire : R\u00e8gle de pare-feu VNC"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-test-de-connexion-vnc","title":"- Test de connexion VNC","text":"<p>- - Depuis un PC distant sous Windows T\u00e9l\u00e9chargez le client VNC Viewer de RealVNC.</p> <p>Effectuez son installation et d\u00e9marrez le logiciel.</p> <p>Configurez ensuite une connexion pour joindre srvlan : - Menu Fichier -&gt; Nouvelle connexion...</p> <p>- Une fen\u00eatre Propri\u00e9t\u00e9s s'ouvre. -&gt; Onglet G\u00e9n\u00e9ral Param\u00e9trez VNC Viewer comme ci-dessous :</p> <p> </p> VNC Viewer : Param\u00e8tres onglet G\u00e9n\u00e9ral <p>-&gt; Onglet Options Param\u00e9trez VNC Viewer comme ci-dessous :</p> <p> </p> VNC Viewer : Param\u00e8tres onglet Options <p>R\u00e9sultat, VNC Viewer montre la nouvelle connexion :</p> <p> </p> VNC Viewer : Connexion VNC cr\u00e9\u00e9e pour srvlan <p>Test de connexion : -&gt; Double-cliquez sur l'ic\u00f4ne srvlan</p> <p>Une fen\u00eatre Chiffrement s'ouvre : -&gt; Cochez Ne plus afficher cet avertissement -&gt; Continuer</p> <p>Une fen\u00eatre Authentification s'ouvre : -&gt; Entrez votre MDP VNC pour srvlan &gt; OK</p> <p>Connexion \u00e9tablie, la fen\u00eatre suivante s'affiche :</p> <p> </p> VNC Viewer : Session VNC ouverte sur srvlan <p>- - Depuis un PC distant sous Linux a) T\u00e9l\u00e9chargez le client VNC Viewer de votre version Linux. Effectuez son installation et d\u00e9marrez le logiciel. Proc\u00e9dez ensuite comme sous Windows.</p> <p>b) Remmina peut \u00e9galement exploiter le protocole VNC. Cliquez sur l'ic\u00f4ne + (profil) situ\u00e9e en haut \u00e0 gauche.</p> <p>Une fen\u00eatre Profil de connexion \u00e0 distance s'ouvre. Configurez la connexion VNC comme ci-dessous :</p> <p> </p> Remmina : Fen\u00eatre de configuration/connexion VNC <p>Le MDP de l'utilisateur = Votre MDP VNC ( Voir ci-dessus )</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#ssh-sur-srvsec-ipfire","title":"SSH sur srvsec (IPFire)","text":"<p>Par d\u00e9faut, un serveur SSH (Secure SHell) \u00e9coute sur le port TCP 22.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-activation-du-serveur-ssh","title":"- Activation du serveur SSH","text":"<p>Acc\u00e9dez \u00e0 l'interface graphique d'IPFire depuis le navigateur Web de srvlan : -&gt; Syst\u00e8me &gt; Acc\u00e8s SSH</p> <p>Une fen\u00eatre Acc\u00e8s distant s'ouvre : -&gt; Cochez Acc\u00e8s SSH -&gt; D\u00e9cochez D\u00e9finir le port SSH \u00e0 22 -&gt; Bouton Sauvegarder</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-regle-de-pare-feu-ssh","title":"- R\u00e8gle de pare-feu SSH","text":"<p>Acc\u00e9dez \u00e0 l'interface graphique d'IPFire depuis le navigateur Web de srvlan : -&gt; Pare-feu &gt; R\u00e8gles de pare-feu &gt; Nouvelle r\u00e8gle</p> <p>- Zone Source -&gt; Cochez R\u00e9seaux standards &gt; S\u00e9lectionnez Tout</p> <p>- Zone Destination -&gt; Cochez R\u00e9seaux standards &gt; S\u00e9lectionnez Tout</p> <p>- Zone Protocole -&gt; S\u00e9lectionnez TCP &gt; Port de destination -&gt; Remplissez le champ vide avec le n\u00b0 de port 222</p> <p>-&gt; Cochez ACCEPTER</p> <p>- Zone Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez Connexions SSH entrantes autoris\u00e9es</p> <p>-&gt; Ajouter &gt; Appliquer les changements</p> <p> </p> IPFire : R\u00e8gle de pare-feu SSH"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-test-de-connexion-ssh","title":"- Test de connexion SSH","text":"<p>- - Depuis un PC distant sous Windows T\u00e9l\u00e9chargez le client SSH Putty et installez celui-ci.</p> <p>Ensuite, d\u00e9marrez et configurez Putty comme suit :</p> <p> </p> Putty : Configuration SSH pour IPFire <p>La VM srvsec \u00e9tant de confiance, acceptez l'alerte de s\u00e9curit\u00e9 et lancez une seconde connexion.</p> <p>R\u00e9sultat :</p> <p> </p> Putty : Connexion SSH \u00e9tablie sur IPFire <p>Il n'y aura pas d'alerte de s\u00e9curit\u00e9 lors des connexions suivantes, utilisez la Cde exit pour quitter.</p> <p>- - Depuis un PC distant sous Linux a) Installez le paquet putty fourni par votre distribution. Proc\u00e9dez ensuite comme sous Windows.</p> <p>b) Remmina peut \u00e9galement exploiter le protocole SSH. Cliquez sur l'ic\u00f4ne + (profil) situ\u00e9e en haut \u00e0 gauche.</p> <p>Une fen\u00eatre Profil de connexion \u00e0 distance s'ouvre. Configurez la connexion SSH comme ci-dessous :</p> <p> </p> Remmina : Configuration SSH pour IPFire"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#ssh-ovs","title":"SSH sur ovs (OpenvSwitch)","text":""},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-serveur-ssh-sur-ovs","title":"- Serveur SSH sur ovs","text":"<p>Installez le serveur OpenSSH :</p> <pre><code>[switch@ovs:~$] sudo apt install openssh-server\n</code></pre> <p>et contr\u00f4lez l'activation du d\u00e9mon SSH :</p> <pre><code>[switch@ovs:~$] sudo systemctl status sshd\n</code></pre> <p>Le r\u00e9sultat de la Cde doit montrer active (running).</p> <p>Editez ensuite le fichier de configuration sshd_config :</p> <pre><code>[switch@ovs:~$] sudo nano /etc/ssh/sshd_config\n</code></pre> <p>et remplacez la ligne #Port 22 par Port 222.</p> <p>Red\u00e9marrez le serveur pour traiter la modification :</p> <pre><code>[switch@ovs:~$] sudo systemctl restart sshd\n</code></pre>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-test-de-connexion-sur-ovs","title":"- Test de connexion sur ovs","text":"<p>Effectuez une connexion \u00e0 l'aide de Putty :</p> <p> </p> Putty : Configuration SSH pour OpenvSwitch <p>R\u00e9sultat :</p> <p> </p> Putty : Connexion SSH \u00e9tablie sur OpenvSwitch"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#ssh-sur-les-conteneurs-lxc","title":"SSH sur les conteneurs LXC","text":""},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-conteneur-ctn1","title":"- Conteneur ctn1","text":"<p>Installez depuis l'h\u00f4te ovs un serveur SSH sur ctn1 :</p> <pre><code>[switch@ovs:~$] sudo podman exec -it ctn1 bash\n\n[root@..:~#] apt update &amp;&amp; apt upgrade\n[root@..:~#] apt install openssh-server\n</code></pre> <p>Editez ensuite son fichier de configuration sshd_config :</p> <pre><code>[root@..:~#] apt install nano\n[root@..:~#] nano /etc/ssh/sshd_config\n</code></pre> <p>et modifiez les 2 lignes suivantes comme ci-dessous : #Port 22 &gt; Port 222 #PermitRootLogin prohib...word &gt; PermitRootLogin yes</p> <p>Red\u00e9marrez le serveur SSH pour traiter la configuration :</p> <pre><code>[root@..:~#] /etc/init.d/ssh start\n[root@..:~#] /etc/init.d/ssh status     # normal = sshd is running\n</code></pre> <p>Attribuez un MDP \u00e0 l'utilisateur root du conteneur :</p> <pre><code>[root@..:~#] passwd\n</code></pre> <p>Editez le fichier .bashrc de l'utilisateur root :</p> <pre><code>[root@..:~#] nano /root/.bashrc\n</code></pre> <p>et entrez le contenu suivant en fin de fichier :</p> <pre><code># Lancement automatique du serveur ssh\n/etc/init.d/ssh start\n</code></pre> <p>Ensuite, d\u00e9connectez-vous du conteneur :</p> <pre><code>[root@...:~#] exit\n\n[switch@ovs:~$] \n</code></pre> <p>et listez les images Podman utilis\u00e9es en mode rootfull :</p> <pre><code>[switch@ovs:~$] sudo podman images\n</code></pre> <p>Retour :</p> <pre><code>switch@ovs:~$ sudo podman images\nREPOSITORY                      TAG         \nlocalhost/uptime-kuma           2           ...\nlocalhost/debian                1           ...\ndocker.io/louislam/uptime-kuma  1           ...\ndocker.io/library/debian        latest      ...\nswitch@ovs:~$\n</code></pre> <p>Cr\u00e9ez une nouvelle image de ctn1 incluant le SSH :</p> <pre><code>sudo podman commit ctn1 debian:2       # Cr\u00e9ation image tag 2\n</code></pre> <p>et recr\u00e9ez ctn1 depuis celle-ci :</p> <pre><code>sudo systemctl stop container-ctn1         # Suppression de ctn1\nsudo podman ps                          # V\u00e9rification de la suppression\n\nsudo podman run -dit --net ns:/var/run/netns/nsctn1 --name ctn1 debian:2         # Cr\u00e9ation ctn1 depuis image tag 2\n\ncd /etc/systemd/system\n\nsudo podman generate systemd --new --files --name ctn1\ncat container-ctn1.service                         # Lecture par curiosit\u00e9\n\nsudo systemctl daemon-reload\nsudo systemctl start container-ctn1\nsudo systemctl status container-ctn1\n</code></pre> <p>Red\u00e9marrez la VM ovs :</p> <pre><code>sudo reboot\n</code></pre> <p>et connectez-vous depuis Putty en proc\u00e9dant comme pour la VM ovs mais avec l'IP 192.168.3.6.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-conteneurs-ctn2-et-ctn3","title":"- Conteneurs ctn2 et ctn3","text":"<p>Les 2 conteneurs bas\u00e9s sur Debian supportent l'outil de surveillance r\u00e9seau Uptime Kuma dont la configuration s'effectue directement depuis son interface Web.</p> <p>Pour interagir avec Debian, utilisez l'acc\u00e8s SSH de la VM ovs et exploitez les 2 Cdes suivantes :</p> <pre><code>[switch@ovs:~$] sudo podman exec -it ctn2 bash\n\n[switch@ovs:~$] podman exec -it ctn3 bash\n</code></pre>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#vnc-via-un-tunnel-ssh","title":"VNC via un tunnel SSH","text":"<p>De base, une connexion VNC n'est pas s\u00e9curis\u00e9e mais il est possible de faire transiter celle-ci \u00e0 l'int\u00e9rieur d'un tunnel SSH pour r\u00e9gler ce probl\u00e8me.</p> <p>Ceci implique de configurer le serveur SSH d'IPFire afin qu'il accepte le transfert de ports TCP.</p> <p>Acc\u00e9dez \u00e0 l'interface graphique d'IPFire depuis le navigateur Web de srvlan : -&gt; Syst\u00e8me &gt; Acc\u00e8s SSH</p> <p>Une fen\u00eatre Acc\u00e8s distant s'ouvre : -&gt; Cochez Autoriser le transfert TCP -&gt; Bouton Sauvegarder</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-vncssh-depuis-windows","title":"- VNC/SSH depuis Windows","text":"<p>Configurez un tunnel SSH avec Putty en respectant la chronologie des 2 captures suivantes :</p> <p> </p> Putty : Configuration tunnel SSH pour VNC <p> </p> Putty : Configuration tunnel SSH pour VNC <p>Puis lancez, depuis le client VNC Viewer de RealVNC, une connexion VNC locale (127.0.0.1) :</p> <p> </p> RealVNC : Demande d'une connexion VNC locale <p>La demande locale d'acc\u00e8s au port TCP 5901 utilis\u00e9 par le protocole VNC sera automatiquement envoy\u00e9e \u00e0 l'int\u00e9rieur du tunnel SSH vers le serveur SSH d'IPFire qui transf\u00e8rera celle-ci vers le serveur VNC de srvlan.</p> <p>Pensez \u00e0 fermer, une fois votre communication VNC termin\u00e9e, la connexion SSH de Putty.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#-vncssh-depuis-linux","title":"- VNC/SSH depuis Linux","text":"<p>Le plus simple est d'utiliser de nouveau Remmina. Cliquez sur l'ic\u00f4ne + (profil) situ\u00e9e en haut \u00e0 gauche.</p> <p>Une fen\u00eatre Profil de connexion \u00e0 distance s'ouvre. Configurez la connexion VNC comme ci-dessous :</p> <p> </p> Remmina : Configuration VNC avec tunnel SSH <p> </p> Remmina : Configuration VNC avec tunnel SSH <p>La connexion SSH sera cette fois ferm\u00e9e automatiquement en fin de communication VNC.</p>"},{"location":"blog/contr%C3%B4le-%C3%A0-distance---vboxdeb12/#bilan","title":"Bilan","text":"<p>Les VM et conteneurs LXC sont joignables \u00e0 distance.</p> <p>La s\u00e9curit\u00e9 des acc\u00e8s reste n\u00e9anmoins perfectible : - En ne travaillant pas avec des n\u00b0 de port par d\u00e9faut. - En r\u00e9glant plus finement les sources dans IPFire. - En utilisant les cl\u00e9s publiques et priv\u00e9es de SSH. - Etc...</p> <p></p> <p>  Termin\u00e9 pour l'instant ! Le m\u00e9mento 7.1 vous attend pour l'installation d'un serveur DNS statique sur srvlan.</p> <p>M\u00e9mento 7.1</p>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/","title":"SSH \u2013 Cl\u00e9s publique et priv\u00e9e","text":""},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#authentification-par-cles","title":"Authentification par cl\u00e9s","text":"<p>L'authentification par cl\u00e9s, m\u00e9thode plus s\u00e9curis\u00e9e que celle faisant appel au MDP, repose sur une paire de cl\u00e9s cryptographiques publique et priv\u00e9e cr\u00e9\u00e9e sur le client.</p> <p>Le client identifiera le serveur \u00e0 l'aide de sa cl\u00e9 publique pr\u00e9alablement transf\u00e9r\u00e9e dans le fichier ~/.ssh/authorized_keys du compte utilisateur distant.</p> <p>Lors d'une demande de connexion, le serveur retournera un d\u00e9fi crypt\u00e9 \u00e0 l'aide de cette cl\u00e9 publique.</p> <p>Le client d\u00e9chiffrera le d\u00e9fi avec sa cl\u00e9 priv\u00e9e et renverra une r\u00e9ponse.</p> <p>Si la r\u00e9ponse convient, le serveur autorisera l'acc\u00e8s sur le compte utilisateur distant, sans demander de MDP.</p> <ol> <li> <ul> <li>Cr\u00e9ation des cl\u00e9s SSH</li> </ul> </li> <li> <ul> <li>Transfert de la cl\u00e9 publique</li> </ul> </li> <li> <ul> <li>Configuration c\u00f4t\u00e9 serveur</li> </ul> </li> <li> <ul> <li>Connexion sur le serveur</li> </ul> </li> <li> <ul> <li>Agent SSH (c\u00f4t\u00e9 client)</li> </ul> </li> <li> <ul> <li>Keychain (c\u00f4t\u00e9 client)</li> </ul> </li> </ol>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#creation-cles-ssh","title":"Cr\u00e9ation des cl\u00e9s SSH","text":"<p>Pour info, certains clients graphiques tels Putty et Xshell disposent d'un g\u00e9n\u00e9rateur de cl\u00e9s SSH.</p> <p>Sur Debian, OpenSSH fournit la Cde ssh-keygen qui par d\u00e9faut cr\u00e9e un dossier cach\u00e9 ~/.ssh et y g\u00e9n\u00e8re une paire de cl\u00e9s de noms id_rsa et id_rsa.pub.</p> <p>Sur votre ordinateur local (client SSH), g\u00e9n\u00e9rez la paire de cl\u00e9s comme suit :</p> <pre><code>cd /home/user\nssh-keygen\n</code></pre> <p>Retour :</p> <pre><code>Generating public/private rsa key pair.\nEnter file in which to save the key (/home/user/.ssh/id_rsa):\n</code></pre> <p>Validez le chemin propos\u00e9 par d\u00e9faut.</p> <p>Retour :</p> <pre><code>Created directory '/home/user/.ssh'.\nEnter passphrase (empty for no passphrase):\n</code></pre> <p>Entrez un MDP (passphrase) qui prot\u00e9gera notamment la cl\u00e9 priv\u00e9e en cas de vol de celle-ci.</p> <p>Retour :</p> <pre><code>Enter same passphrase again:\n</code></pre> <p>Entrez de nouveau le MDP.</p> <p>Retour :</p> <pre><code>Your identification ... saved in /home/user/.ssh/id_rsa\nYour public key ... saved in /home/user/.ssh/id_rsa.pub\nThe key fingerprint is:\nSHA256:K5jPkzROR40crm9vQacssDgqbq... user@hostname\nThe key's randomart image is:\n+---[RSA 3072]----+\n|                 |\n|        .        |\n|       o +       |\n|      . = o . .  |\n|     . =So o B   |\n|    oo.o.+ \u2026     |\n|   .o=o=o. oE\u2026.  |\n|oo= .++oo o . .  |\n|+*=B. oo.+.      |\n+----[SHA256]-----+\n</code></pre> <p>Pour finir, v\u00e9rifiez la pr\u00e9sence de la paire de cl\u00e9s dans le dossier /home/user/.ssh/.</p> <p>Nota : La passphrase est facultative mais celle-ci augmente la s\u00e9curit\u00e9 et est donc conseill\u00e9e.</p>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#transfert-cle-pub","title":"Transfert de la cl\u00e9 publique","text":"<p>La Cde ssh-copy-id incluse dans OpenSSH permet le transfert de la cl\u00e9 publique, mais l'usage de celle-ci n\u00e9cessite de d\u00e9j\u00e0 disposer d\u2019un acc\u00e8s SSH sur le serveur bas\u00e9 sur un MDP.</p> <p>Si OK, transf\u00e9rez la cl\u00e9 publique comme suit :</p> <pre><code>cd /home/user\nssh-copy-id user@ip-serveur-distant\n</code></pre> <p>Retour :</p> <pre><code>/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: \"/home/user/.ssh/id_rsa.pub\"\n\n/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed\n\n/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys\n\nuser@ip-serveur-distant's password:\n</code></pre> <p>Entrez le MDP d'acc\u00e8s au serveur SSH.</p> <p>Retour :</p> <pre><code>Number of key(s) added: 1\n\nNow try logging into the machine, with: \"ssh 'user@ip-serveur-distant'\"\nand check to make sure that only the key(s) you wanted were added.\n</code></pre> <p>Normalement, un dossier ~/.ssh a \u00e9t\u00e9 cr\u00e9\u00e9 sur le serveur incluant un fichier authorized_keys contenant la cl\u00e9 publique du client SSH.</p> <p>Les permissions doivent \u00eatre \u00e0 700 pour le dossier .ssh et 600 pour le fichier authorized_keys.</p> <p>A d\u00e9faut utilisez la Cde chmod pour ajuster celles-ci.</p> <p>Pour info, la cl\u00e9 publique aurait \u00e9galement pu \u00eatre copi\u00e9e, par exemple depuis un client SFTP ou autre moyen, directement dans un fichier ~/.ssh/authorized_keys pr\u00e9alablement cr\u00e9\u00e9 sur le serveur.</p>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#config-serveur-ssh","title":"Configuration c\u00f4t\u00e9 serveur","text":"<p>Depuis le serveur, \u00e9ditez la configuration SSH :</p> <pre><code>sudo nano /etc/ssh/sshd_config\n</code></pre> <p>et modifiez la valeur de ces 3 param\u00e8tres comme suit :</p> <pre><code>PasswordAuthentication no             #Auth MDP interdite\nPubkeyAuthentication yes         #Auth cl\u00e9s SSH autoris\u00e9e\nPermitRootLogin no     #Pas de connexion en tant que root\n</code></pre> <p>La s\u00e9curit\u00e9 du service SSH s'en trouvera ainsi am\u00e9lior\u00e9e.</p> <p>Apr\u00e8s modification, rechargez le service :</p> <pre><code>sudo systemctl reload sshd\n</code></pre>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#connexion-ssh","title":"Connexion sur le serveur","text":"<p>Lancez \u00e0 pr\u00e9sent la Cde suivante depuis le client SSH :</p> <pre><code>ssh -p 22 user@ip-serveur-distant\n</code></pre> <p>Modifiez le n\u00b0 de port si n\u00e9cessaire (22 par d\u00e9faut).</p> <p>Retour :</p> <pre><code>Enter passphrase for key '/home/user/.ssh/id_rsa':\n</code></pre> <p>Entrez la phrase secr\u00e8te de la cl\u00e9 priv\u00e9e.</p> <p>Si OK, vous \u00eates maintenant connect\u00e9, le prompt affich\u00e9 \u00e0 l'int\u00e9rieur de votre terminal a \u00e9t\u00e9 remplac\u00e9 par celui du serveur distant (Ex : user@hostname-distant).</p> <p>Quittez la connexion SSH avec la Cde exit :</p> <pre><code>user@hostname-distant:~$ exit\n</code></pre> <p>Retour :</p> <pre><code>d\u00e9connexion\nConnection to ip-serveur-distant closed.\n</code></pre> <p>Vous l'aurez remarqu\u00e9, la configuration actuelle impose pour des raisons de s\u00e9curit\u00e9 d'entrer la passphrase pour chacune des demandes de connexion SSH.</p> <p>Les outils agent-ssh ou keychain pr\u00e9sent\u00e9s ci-dessous \u00e9viteront en partie d'avoir \u00e0 entrer cette passphrase \u00e0 chaque demande de connexion.</p>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#agent-ssh","title":"Agent SSH (c\u00f4t\u00e9 client)","text":"<p>L'outil ssh-agent inclus dans le paquet openssh-client stockera en m\u00e9moire, ceci pour toute la dur\u00e9e d'une session terminal, la cl\u00e9 priv\u00e9e ainsi que la passphrase associ\u00e9e.</p> <p>La passphrase sera demand\u00e9e seulement lors de l'ajout de la cl\u00e9 priv\u00e9e \u00e0 l'agent et non plus \u00e0 chacune des demandes de connexion SSH.</p> <p>Entrez la Cde suivante pour d\u00e9marrez l'agent SSH :</p> <pre><code>eval \"$(ssh-agent -s)\"\n</code></pre> <p>L'agent est ainsi lanc\u00e9 en arri\u00e8re-plan et des variables SSH_AUTH_SOCK et SSH_AGENT_PID sont d\u00e9finies pour la session terminal courante.</p> <p>V\u00e9rifiez la cr\u00e9ation de ces 2 variables :</p> <pre><code>ssh-agent\n</code></pre> <p>Retour normal :</p> <pre><code>SSH_AUTH_SOCK=/tmp/ssh-6c83TA4ghRKH/agent.142369; export SSH_AUTH_SOCK;\nSSH_AGENT_PID=142370; export SSH_AGENT_PID;\necho Agent pid 142370;\n</code></pre> <p>Ajoutez enfin la cl\u00e9 priv\u00e9e rsa_id \u00e0 l'agent comme ceci :</p> <pre><code>ssh-add /home/user/.ssh/id_rsa\n</code></pre> <p>La passphrase vous sera demand\u00e9e \u00e0 ce moment-l\u00e0.</p> <p>Pour v\u00e9rifier que la cl\u00e9 est bien charg\u00e9e :</p> <pre><code>ssh-add -l\n</code></pre> <p>Retour normal :</p> <pre><code>user@hostname:~$ ssh-add -l\n3072 SHA256:K5jWkzAOv40crm9vQa... user@hostname (RSA)\nuser@hostname:~$\n</code></pre> <p>Maintenant, \u00e9ditez le fichier de configuration .bashrc :</p> <pre><code>cd /home/user\nnano .bashrc\n</code></pre> <p>et entrez le contenu suivant en fin de fichier :</p> <pre><code># D\u00e9marrage de l'agent SSH\neval \"$(ssh-agent -s)\n</code></pre> <p>L\u2019agent se lancera ainsi automatiquement \u00e0 chaque ouverture d'une session terminal.</p> <p>Il ne restera qu'\u00e0 ajouter la cl\u00e9 \u00e0 l'agent pour pouvoir vous connecter plusieurs fois sur le serveur SSH distant sans avoir \u00e0 fournir syst\u00e9matiquement la passphrase.</p> <p>En revanche, si vous fermez la session terminal et en ouvrez une autre, vous devrez de nouveau ajouter la cl\u00e9 \u00e0 l'agent SSH pour b\u00e9n\u00e9ficier du m\u00eame avantage.</p>"},{"location":"blog/ssh--cl%C3%A9s-publique-et-priv%C3%A9e/#keychain","title":"Keychain (c\u00f4t\u00e9 client)","text":"<p>Keychain est un gestionnaire pour ssh-agent qui permet d'utiliser un m\u00eame agent SSH entre plusieurs sessions terminal.</p> <p>Seules les variables SSH_AUTH_SOCK/SSH_AGENT_PID diff\u00e8reront d'une session terminal \u00e0 l'autre.</p> <p>Avec Keychain, la passphrase ne sera demand\u00e9e qu'une fois lors de l'ouverture d'une premi\u00e8re session terminal effectu\u00e9e apr\u00e8s le boot du syst\u00e8me.</p> <p>Pour commencer, installez keychain comme suit :</p> <pre><code>sudo apt install keychain\n</code></pre> <p>Puis, \u00e9ditez le fichier de configuration .bashrc :</p> <pre><code>cd /home/user\nnano .bashrc\n</code></pre> <p>et remplacez le contenu pr\u00e9c\u00e9demment entr\u00e9 :</p> <pre><code># D\u00e9marrage de l'agent SSH\neval \"$(ssh-agent -s)\n</code></pre> <p>par celui-ci :</p> <pre><code># D\u00e9marrage de keychain et chargement cl\u00e9 priv\u00e9e SSH\neval `keychain --eval --agents ssh id_rsa`\n</code></pre> <p>Red\u00e9marrez Debian, ouvrez un terminal et entrez la passphrase comme demand\u00e9e :</p> <p> </p> Keychain : Demande de la passphrase <p>Une fois fait, le terminal montre la cl\u00e9 priv\u00e9e ajout\u00e9e :</p> <p> </p> Keychain : Cl\u00e9 priv\u00e9e ajout\u00e9e \u00e0 l'agent SSH <p>Il est maintenant possible de se connecter sur le serveur SSH sans demande de passphrase, ceci m\u00eame si vous fermez la session terminal courante et en ouvrez une autre dans un terminal comme UXTerm ci-dessous :</p> <p> </p> Keychain : Cl\u00e9 priv\u00e9e d\u00e9clar\u00e9e connue de l'agent <p>Seule une d\u00e9connexion de la session utilisateur imposera de devoir entrer de nouveau la passphrase.</p> <p>Keychain rend ainsi l'exploitation des connexions SSH plus pratique.</p> ---------- Fin ----------"},{"location":"blog/xrdp--astuces/","title":"XRDP \u2013 Astuces","text":""},{"location":"blog/xrdp--astuces/#distributions-debian-11-et-12","title":"Distributions Debian 11 et 12","text":"<p>Astuces facilitant l'exploitation du service xrdp.</p> <ol> <li>Supprimer l'alerte \"P\u00e9riph\u00e9rique ... couleurs\"</li> <li>Modifier les connections de NetworkManager</li> <li>Autoriser le Reboot/Shutdown sous Xfce4</li> </ol>"},{"location":"blog/xrdp--astuces/#lien1","title":"P\u00e9riph\u00e9rique gestion couleurs","text":"<p>A l'ouverture des connexions sur le serveur xrdp, Debian renvoie syst\u00e9matiquement cette alerte :</p> <pre><code>Il est n\u00e9cessaire de s'authentifier pour cr\u00e9er un p\u00e9riph\u00e9rique avec gestion de couleurs\n</code></pre> <p>Il suffit alors de s'authentifier pour pouvoir continuer.</p> <p>Modifier les droits d'acc\u00e8s au d\u00e9mon colord \u00e0 l'aide de l'outil polkit supprimera cette alerte.</p> <p>Pour cela, cr\u00e9ez un fichier de nom 45-allow-colord.pkla :</p> <pre><code>cd /etc/polkit-1\n\nsudo nano localauthority/50-local.d/45-allow-colord.pkla\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Allow Colord all Users]\nIdentity=unix-user:*\nAction=org.freedesktop.color-manager.create-device;\\\norg.freedesktop.color-manager.create-profile;\\\norg.freedesktop.color-manager.delete-device;\\\norg.freedesktop.color-manager.delete-profile;\\\norg.freedesktop.color-manager.modify-device;\\\norg.freedesktop.color-manager.modify-profile\nResultAny=no\nResultInactive=no\nResultActive=yes\n</code></pre> <p>Le caract\u00e8re  indique d'\u00e9crire le tout sur une seule ligne.</p> <p>Relancez polkit pour prendre en compte le fichier .pkla :</p> <pre><code>sudo systemctl restart polkit\n</code></pre> <p>L'alerte ne devrait plus appara\u00eetre.</p>"},{"location":"blog/xrdp--astuces/#lien2","title":"Connexions Network Manager","text":"<p>Un utilisateur du groupe sudo connect\u00e9 au travers du serveur xrdp ne peut pas modifier les param\u00e8tres d'une connexion r\u00e9seau configur\u00e9e depuis NetworkManager.</p> <p>Comme pour l'astuce pr\u00e9c\u00e9dente, il suffit de cr\u00e9er les droits n\u00e9cessaires pour r\u00e9gler ce souci.</p> <p>Cr\u00e9ez le fichier 50-allow-network-manager.pkla :</p> <pre><code>cd /etc/polkit-1\n\nsudo nano localauthority/50-local.d/50-allow-network-manager.pkla\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Network Manager Utilisateurs sudo]\nIdentity=unix-group:sudo\nAction=org.freedesktop.NetworkManager.*\nResultAny=auth_admin\nResultInactive=auth_admin\nResultActive=auth_admin\n</code></pre> <p>Ajoutez optionnellement dans NetworkManager.conf :</p> <pre><code>sudo nano /etc/NetworkManager/NetworkManager.conf\n</code></pre> <p>le contenu suivant \u00e0 l'int\u00e9rieur de la section [main] :</p> <pre><code>[main] \nauth-polkit=true\n</code></pre> <p>Relancez polkit pour prendre en compte le fichier .pkla :</p> <pre><code>sudo systemctl restart polkit\n</code></pre> <p>et NetworkManager pour recharger sa configuration :</p> <pre><code>sudo systemctl restart NetworkManager\n</code></pre> <p>Modifier les connexions de NetworkManager sous xrdp devrait maintenant \u00eatre possible.</p>"},{"location":"blog/xrdp--astuces/#lien3","title":"Reboot/Shutdown sous Xfce4","text":"<p>Les menus Eteindre et D\u00e9connexion... du bureau Xfce4 sont gris\u00e9s sous xrdp, donc inactifs.</p> <p>Pour y rem\u00e9dier, cr\u00e9ez un fichier 55-allow-reboot.pkla :</p> <pre><code>cd /etc/polkit-1\n\nsudo nano localauthority/50-local.d/55-allow-reboot.pkla\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Autoriser le shutdown depuis XRDP]\nIdentity=unix-user:*\nAction=org.freedesktop.login1.power-off\nResultAny=yes\n\n[Autoriser le reboot depuis XRDP]\nIdentity=unix-user:*\nAction=org.freedesktop.login1.reboot\nResultAny=yes\n</code></pre> <p>Red\u00e9marrez le syst\u00e8me :</p> <pre><code>sudo reboot\n</code></pre> ---------- Fin ----------"},{"location":"blog/dhcp-kea---vboxdeb12/","title":"DHCP Kea - VBox/Deb12","text":""},{"location":"blog/dhcp-kea---vboxdeb12/#memento-72-kea-dhcp-server","title":"M\u00e9mento 7.2 - Kea DHCP Server","text":"<p>DHCP = Dynamic Host Configuration Protocol</p> <p>Le DHCP sera activ\u00e9 sur la VM srvlan pour la zone LAN.</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#preambule","title":"Pr\u00e9ambule","text":"<p>Il est aujourd'hui pr\u00e9conis\u00e9 d'utiliser Kea DHCP \u00e0 la place d'ISC DHCP qui n'est plus maintenu.</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#-role-du-serveur-dhcp","title":"- R\u00f4le du serveur DHCP","text":"<p>Il permet \u00e0 un h\u00f4te qui se connecte sur un r\u00e9seau local d'obtenir automatiquement sa configuration IP, ceci pour une dur\u00e9e d\u00e9termin\u00e9e appel\u00e9e bail DHCP.</p> <p>But, faciliter l'affectation des adresses IP sur un r\u00e9seau.</p> <p>Les h\u00f4tes enregistr\u00e9s via un serveur DHCP peuvent aussi \u00eatre ajout\u00e9s dynamiquement \u00e0 un serveur DNS.</p> <p>DHCP repr\u00e9sente donc une suite logique au DNS dans la construction du r\u00e9seau local virtuel.</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#-fonctionnement-global","title":"- Fonctionnement global","text":"<p>Le DHCP repose sur des requ\u00eates UDP \u00e9mises par les clients et trait\u00e9es par le serveur.</p> <p>Exemple d'un \u00e9change de requ\u00eates client/serveur :</p> <ul> <li>DHCPDISCOVER - Le client cherche un serveur  </li> <li>DHCPOFFER - le 1er trouv\u00e9 soumet une IP  </li> <li>DHCPREQUEST - Le client traite et valide l'IP  </li> <li>DHCPACK - Le serveur confirme la configuration  </li> </ul> <p>Les requ\u00eates UDP circulent sur les ports 67 et 68.</p> <p>Le client au final re\u00e7oit une confirmation de son IP temporaire (bail) ainsi que souvent en compl\u00e9ment l'IP de sa passerelle ainsi que les IP de ses serveurs DNS.</p> <p>Nota</p> <p>Si pas de serveur DHCP, le client s'attribue une adresse IP dans la plage 169.254.0.0/16.</p> <p>Le serveur DHCP Kea utilis\u00e9 ci-dessous est issu de l'organisme d\u00e9j\u00e0 cr\u00e9ateur du serveur DNS BIND 9 soit l'Internet Software Consortium (ISC).</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#installation-et-configuration","title":"Installation et configuration","text":""},{"location":"blog/dhcp-kea---vboxdeb12/#-installation-du-service-kea","title":"- Installation du service Kea","text":"<p>Installez ce paquet pour g\u00e9rer la zone LAN en IPv4 :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install kea-dhcp4-server \n</code></pre> <p>Les d\u00e9pendances suivantes ont \u00e9t\u00e9 ajout\u00e9es :</p> <ul> <li>kea-common</li> <li>liblog4cplus</li> <li>libmariadb3</li> <li>libpq5</li> <li>mariadb-common</li> <li>mysql-common</li> </ul> <p>V\u00e9rifiez le statut du service :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server\n</code></pre> <p>Retour normal :</p> <pre><code>\u25cf kea-dhcp4-server.service - Kea IPv4 DHCP daemon\n     Loaded: ...service; enabled; preset: enabled)\n     Active: active (running) since Tue 2024-...\n       Docs: man:kea-dhcp4(8)\n   Main PID: 2412 (kea-dhcp4)\n      Tasks: 5 (limit: 1077)\n     Memory: 4.6M\n        CPU: 53ms\n     CGroup: /system.slice/kea-dhcp4-server.service\n             \u2514\u25002412 /usr/sbin/kea-dhcp4 -c /etc...\n\n...\nf\u00e9vr.. srvlan kea-dhcp4[...]: INFO  DHCP4_STARTED\n</code></pre> <p>Le service est d\u00e9marr\u00e9 et activ\u00e9 par d\u00e9faut (enabled).</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#-configuration","title":"- Configuration","text":"<p>Le fichier de configuration kea-dhcp4.conf se trouve dans le dossier /etc/kea/.</p> <p>Sauvegardez celui-ci en le renommant ainsi :</p> <pre><code>[srvlant@srvlan:~$] cd /etc/kea\n\n[srvlant@srvlan:~$] sudo mv kea-dhcp4.conf kea-dhcp4.conf_save\n</code></pre> <p>Cr\u00e9ez ensuite un nouveau fichier kea-dhcp4.conf :</p> <pre><code>[srvlant@srvlan:~$] sudo nano kea-dhcp4.conf\n</code></pre> <p>et entrez ce qui suit en respectant le format JSON :</p> <pre><code>// Serveur DHCP Kea\n// Configuration de base IPv4\n\n{\n\"Dhcp4\": {\n    // Interface r\u00e9seau enp0s8 en \u00e9coute DHCP.\n    \"interfaces-config\": {\n        \"interfaces\": [\"enp0s8\"]\n    },\n\n    // Serveur en autorit\u00e9 DHCP pour la zone LAN.\n    \"authoritative\": true,\n\n    // Pas de MAJ dynamique du serveur DNS Bind9.\n    \"ddns-send-updates\" : false,\n\n    // Position du fichier contenant les baux DHCP.\n    \"lease-database\": {\n        \"type\": \"memfile\",\n        \"persist\": true,\n        \"name\": \"/var/lib/kea/kea-leases4.csv\",\n        \"lfc-interval\": 3600\n    },\n\n    // Bail (renew=50%,rebind=87.5%,valid=100%=8H).\n    \"renew-timer\": 14400,\n    \"rebind-timer\": 27720,\n    \"valid-lifetime\": 28800,\n\n    \"option-data\": [\n    // Serveur DNS propos\u00e9 aux clients DHCP.\n        {\n            \"name\": \"domain-name-servers\",\n            \"data\": \"192.168.3.1\"\n        },\n\n    // Domaine propos\u00e9 aux clients pour\n    // r\u00e9soudre les noms d'h\u00f4tes via le DNS.\n        {\n            \"name\": \"domain-search\",\n            \"data\": \"intra.loupipfire.fr\"\n        }\n    ],\n\n    // Plage d'adresses IP pour la zone LAN.\n    \"subnet4\": [\n        {\n            \"subnet\": \"192.168.3.0/24\",\n            \"pools\": [ { \"pool\": \"192.168.3.30 - 192.168.3.50\" } ],\n            \"option-data\": [\n                {\n                    \"name\": \"routers\",\n                    \"data\": \"192.168.3.1\"\n                }\n            ],\n\n            // IP r\u00e9serv\u00e9e pour le conteneur ctn1.\n            \"reservations\": [\n                {\n                    \"hw-address\": \"e2:f0:31:2a:b6:05\",\n                    \"ip-address\": \"192.168.3.20\"\n                }\n            ]\n        }\n    ]\n}\n}\n</code></pre> <p>Remarques :</p> <p>- La carte enp0s8, situ\u00e9e c\u00f4t\u00e9 LAN, sera surveill\u00e9e par le serveur DHCP.</p> <p>- A 50% de la dur\u00e9e du bail, la s\u00e9quence de prolongation/renouvellement de celui-ci d\u00e9butera.</p> <p>- L'IP fixe r\u00e9serv\u00e9e pour ctn1 se situe en dehors de la plage des IP d\u00e9di\u00e9e aux autres clients.</p> <p>- Attention, l'adresse MAC de ctn1 actuellement dynamique devra \u00eatre d\u00e9clar\u00e9e fixe ci-dessous.</p> <p>Red\u00e9marrez le service DHCP et v\u00e9rifiez son statut :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp4-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server \n</code></pre> <p>Retour du statut :</p> <pre><code>\u25cf kea-dhcp4-server.service - Kea IPv4 DHCP daemon\n     Loaded: ...service; enabled; preset: enabled)\n     Active: active (running) since Tue 2024-...\n       Docs: man:kea-dhcp4(8)\n   Main PID: 3638 (kea-dhcp4)\n      Tasks: 5 (limit: 1077)\n     Memory: 3.7M\n        CPU: 40ms\n     CGroup: /system.slice/kea-dhcp4-server.service\n             \u2514\u25003638 /usr/sbin/kea-dhcp4 -c /etc...\n\nf\u00e9vr.. DHCPSRV_CFGMGR...IFACE listening ... enp0s8\nf\u00e9vr.. DHCPSRV_CFGMGR_SOCKET_ ... socket type raw\nf\u00e9vr.. DHCPSRV_CFGMGR_NEW_SUBNET... 192.168.3.0 ...\nf\u00e9vr.. DHCP4_CONFIG_COMPLETE DHCP... DDNS: disabled\nf\u00e9vr.. DHCPSRV_MEMFILE_DB ...kea-leases4.csv ...\nf\u00e9vr.. DHCPSRV_MEMFILE_LEASE...kea-leases4.csv.2\nf\u00e9vr.. DHCPSRV_MEMFILE_LEASE...kea-leases4.csv\nf\u00e9vr.. DHCPSRV_MEMFILE_LFC... Cleanup ... 3600 sec\nf\u00e9vr.. DHCP4_MULTI_THREADING_INFO enabled: no, ...\nf\u00e9vr.. DHCP4_STARTED Kea DHCPv4 server ... started \n</code></pre> <p>Celui-ci ne montre pas d'erreur, le service DHCP sera lanc\u00e9 automatiquement au boot de srvlan.</p> <p>V\u00e9rifiez l'utilisation par le service du port UDP 67 :</p> <pre><code>[srvlan@srvlan:~$] sudo ss -anup | grep dhcp\n</code></pre> <p>Retour :</p> <pre><code>UN... 0  0  192.168.3.1:67  0.0.0.0:*  users:((\"kea-dhcp4\"...))\n</code></pre>"},{"location":"blog/dhcp-kea---vboxdeb12/#gestion-des-logs-dhcp","title":"Gestion des logs DHCP","text":""},{"location":"blog/dhcp-kea---vboxdeb12/#-creation-dun-fichier-de-logs","title":"- Cr\u00e9ation d'un fichier de logs","text":"<p>Editez le fichier de configuration kea-dhcp4-server :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/kea/kea-dhcp4.conf\n</code></pre> <p>et entrez ce qui suit sous la section subnet4 :</p> <pre><code>\"subnet4\": [\n        ...\n    ],\n    // Gestion des logs du serveur DHCP.\n    \"loggers\": [\n        {\n          \"name\": \"kea-dhcp4\",\n          \"output_options\": [\n            {\n              \"output\": \"/var/log/kea/kea-dhcp4.log\",\n              \"pattern\": \"%D{%Y-%m-%d %H:%M:%S.%q} %-5p %m\\n\"\n            }\n          ],\n          \"severity\": \"INFO\",\n          \"debuglevel\": 0\n        }\n      ]\n// Ci-dessous, accolades existantes\n}\n}\n</code></pre> <p>Ne pas oublier d'ajouter une virgule derri\u00e8re le crochet de fin de section subnet4.</p> <p>Red\u00e9marrez le serveur DHCP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp4-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server \n</code></pre> <p>et affichez le contenu du fichier kea-dhcp4.log qui a \u00e9t\u00e9 cr\u00e9\u00e9 dans le dossier /var/log/kea/.</p> <pre><code>[srvlan@srvlan:~$] sudo cat /var/log/kea/kea-dhcp4.log \n</code></pre>"},{"location":"blog/dhcp-kea---vboxdeb12/#modification-du-dns-statique","title":"Modification du DNS statique","text":"<p>Ouvrez le fichier DNS de zone directe intra.loupipfire.fr :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/bind\n[srvlan@srvlan:~$] sudo nano db.intra.loupipfire.fr.directe \n</code></pre> <p>et supprimez ou commentez (;) les 4 lignes suivantes :</p> <pre><code>debian12-vm1   IN   A   192.168.3.2\ndebian12-vm2   IN   A   192.168.3.4\nctn1           IN   A   192.168.3.6\nctn2           IN   A   192.168.3.8 \n</code></pre> <p>Ouvrez le fichier DNS de zone inverse intra.loupipfire.fr :</p> <pre><code>[srvlan@srvlan:~$] sudo nano db.intra.loupipfire.fr.inverse \n</code></pre> <p>et supprimez ou commentez (;) les 4 lignes suivantes :</p> <pre><code>2 IN PTR debian12-vm1.intra.loupipfire.fr. \n4 IN PTR debian12-vm2.intra.loupipfire.fr.\n6 IN PTR ctn1.intra.loupipfire.fr.\n8 IN PTR ctn2.intra.loupipfire.fr. \n</code></pre> <p>Relancez le service DNS :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart bind9 \n</code></pre> <p>Nota</p> <p>Ne modifiez pas les lignes des h\u00f4tes srvlan/ovs.</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#tests-du-service-kea","title":"Tests du service Kea","text":""},{"location":"blog/dhcp-kea---vboxdeb12/#-preparation","title":"- Pr\u00e9paration","text":"<p>Au pr\u00e9alable, \u00e9ditez le fichier apparmor suivant :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/apparmor.d\n[srvlan@srvlan:~$] sudo nano usr.sbin.kea-dhcp4 \n</code></pre> <p>et ajoutez ce contenu \u00e0 la fin de celui-ci :</p> <pre><code># Section ajout\u00e9e pour tracer les messages DHCP\n  owner /var/log/kea/kea-dhcp4.packets.log rw,\n  owner /var/log/kea/kea-dhcp4.packets.log.[0-9]* rw,\n  owner /var/log/kea/kea-dhcp4.packets.log.lock rwk,\n\n// Ci-dessous, accolade existante\n} \n</code></pre> <p>Ceci permettra de cr\u00e9er un fichier kea-dhcp4.packets.log qui stockera les messages DHCP clients &lt;- -&gt; serveur.</p> <p>Editez ensuite le fichier de configuration du serveur :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/kea/kea-dhcp4.conf \n</code></pre> <p>et ajoutez ce contenu \u00e0 l'int\u00e9rieur de la section loggers :</p> <pre><code>/ Gestion des logs du serveur DHCP.\n    \"loggers\": [\n        {\n          \"name\": \"kea-dhcp4\",\n          ...\n        },\n        {\n          \"name\": \"kea-dhcp4.packets\",\n          \"output_options\": [\n            {\n              \"output\": \"/var/log/kea/kea-dhcp4.packets.log\",\n              \"maxver\": 3\n            }\n          ],\n          \"severity\": \"DEBUG\",\n          \"debuglevel\": 99\n        }\n// Ci-dessous, crochet et accolades existants\n      ]\n}\n} \n</code></pre> <p>Ne pas oublier d'ajouter une virgule derri\u00e8re l'accolade de fin du name pr\u00e9c\u00e9dent.</p> <p>Red\u00e9marrez les services AppArmor et DHCP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart apparmor\n[srvlan@srvlan:~$] sudo systemctl status apparmor\n\n[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp4-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server  \n</code></pre> <p>Un fichier vide kea-dhcp4.packets.log a \u00e9t\u00e9 cr\u00e9\u00e9 dans le dossier /var/log/kea/.</p> <p>Ouvrez \u00e0 pr\u00e9sent un second terminal et connectez-vous en tant que root (Cde : su root).</p> <p>Entrez la Cde de tra\u00e7age qui permettra d'observer en temps r\u00e9el les messages DHCP \u00e9chang\u00e9s :</p> <pre><code>[root@srvlan:~#] tail -f /var/log/kea/kea-dhcp4.packets.log  \n</code></pre>"},{"location":"blog/dhcp-kea---vboxdeb12/#-test-depuis-debian12-vm","title":"- Test depuis debian12-vm*","text":"<p>R\u00e9f\u00e9rez-vous au M\u00e9mento 4.1 pour modifier les param\u00e8tres r\u00e9seau.</p> <p>- VM debian12-vm1</p> <p>Ajustez la M\u00e9thode de l'onglet Param\u00e8tres IPv4 sur Automatique (DHCP).</p> <p>Supprimez ensuite l'adresse IP statique et enregistrez.</p> <p>Red\u00e9marrez la VM Debian :</p> <pre><code>[client-linux@debian12-vm1:~$] sudo reboot  \n</code></pre> <p>et contr\u00f4lez l'affectation d'une nouvelle adresse IP :</p> <pre><code>[client-linux@debian12-vm1 :~$ ] ip address \n</code></pre> <p>qui doit faire partie de la plage DHCP du serveur DHCP.</p> <p>D\u00e9marrez Firefox et v\u00e9rifiez le bon acc\u00e8s \u00e0 Internet.</p> <p>- VM srvlan V\u00e9rifiez que le terminal de tra\u00e7age contient ces lignes :</p> <p> </p> Kea DHCP : S\u00e9quence d'affectation d'une IP <p>et que le fichier des baux /var/lib/kea/kea-leases4.csv contient celles-ci :</p> <p> </p> Kea DHCP : Format du fichier kea-leases4.csv <p>Le fichier /var/log/kea/kea-dhcp4.log du serveur doit \u00e9galement montrer ceci :</p> <p> </p> Kea DHCP : Bail allou\u00e9 \u00e0 la VM debian12-vm1 <p>- VM debian12-vm2</p> <p>Proc\u00e9dez de la m\u00eame mani\u00e8re que pour debian12-vm1.</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#-test-depuis-ctn1","title":"- Test depuis ctn1","text":"<p>Pour affecter \u00e0 ctn1 une adresse MAC fixe et le d\u00e9clarer client DHCP, \u00e9ditez ce script d'ovs :</p> <pre><code>[switch@ovs:~$] sudo nano /root/networknamespace.sh \n</code></pre> <p>et remplacez la ligne ci-dessous concernant ctn1 :</p> <pre><code>## Activation des extr\u00e9mit\u00e9s vctn1/2 et lo c\u00f4t\u00e9 nsctn1...\n...\n...\nip netns exec nsctn1 ip link set vctn1 up \n... \n</code></pre> <p>par celle-ci :</p> <pre><code>ip netns exec nsctn1 ip link set vctn1 address e2:f0:31:2a:b6:05 up\n</code></pre> <p>Nota</p> <p>L'adresse MAC doit \u00eatre celle entr\u00e9e ci-dessus dans le fichier kea-dhcp4.conf de srvlan.</p> <p>Commentez ensuite la ligne affectant une IP fixe \u00e0 ctn1 :</p> <pre><code>## Ajout adresses IP extr\u00e9mit\u00e9s vctn1/2 c\u00f4t\u00e9 nsctn1...\n#ip netns exec nsctn1 ip addr add 192.168.3.6/24 dev vctn1\n...\n</code></pre> <p>et ajoutez ceci \u00e0 la fin du fichier juste avant exit 0 :</p> <pre><code>## D\u00e9claration de l'interface vctn1 comme client DHCP.\nip netns exec nsctn1 dhclient -4 vctn1\n</code></pre> <p>Puis rebootez la VM ovs et contr\u00f4lez le r\u00e9sultat :</p> <pre><code>[switch@ovs:~$] sudo reboot\n\n[switch@ovs:~$] sudo podman exec -it ctn1 bash\n\nStarting OpenBSD Secure Shell server: sshd.\nroot@...:/# ip address\n</code></pre> <p>Le conteneur doit avoir re\u00e7ue l'adresse IP 192.168.3.20.</p>"},{"location":"blog/dhcp-kea---vboxdeb12/#bilan","title":"Bilan","text":"<p>Le DHCP remplit son r\u00f4le mais la r\u00e9solution DNS locale sur les VM <code>debian12-vm*</code> et les conteneurs <code>ctn*</code> est perdue suite aux modifications du DNS statique.</p> <p>Il est, pour corriger cela et disposer \u00e0 l'avenir d'une modification automatique des fichiers DNS, n\u00e9cessaire de mettre en place un DNS dynamique.</p> <p></p> <p>  Nouvelle \u00e9tape franchie. Le m\u00e9mento 7.3 vous attend \u00e0 pr\u00e9sent pour modifier le DNS statique en DNS dynamique.</p> <p>M\u00e9mento 7.3</p>"},{"location":"blog/dns-dynamique---vboxdeb12/","title":"DNS dynamique - VBox/Deb12","text":""},{"location":"blog/dns-dynamique---vboxdeb12/#memento-73-ddns-via-dhcp","title":"M\u00e9mento 7.3 - DDNS via DHCP","text":"<p>Migration du DNS statique install\u00e9 sur la VM <code>srvlan</code> en DNS dynamique via le service DHCP.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#preambule","title":"Pr\u00e9ambule","text":"<p>Toutes les VM doivent \u00eatre d\u00e9marr\u00e9es sauf <code>srvdmz</code> qui n'est pas concern\u00e9e par cet article.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#-role-du-dns-dynamique","title":"- R\u00f4le du DNS dynamique","text":"<p>Le r\u00f4le consiste \u00e0 modifier en temps r\u00e9el les fichiers de zones DNS via le service DHCP, ceci en utilisant les d\u00e9mons named de Bind et kea-dhcp-ddns de Kea.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#configuration","title":"Configuration","text":""},{"location":"blog/dns-dynamique---vboxdeb12/#-configuration-actuelle","title":"- Configuration actuelle","text":"<p>Vous avez, lors de la configuration DHCP (m\u00e9mento 7.2), supprim\u00e9 volontairement les enregistrements des VM <code>debian12-vm1/2</code> et conteneurs Podman <code>ctn1/2</code> dans les fichiers de zone DNS directe et inverse.</p> <p>La r\u00e9solution DNS interne est donc cass\u00e9e :</p> <pre><code>[srvlan@srvlan:~$] ping debian12-vm1 \n</code></pre> <p>Retour :</p> <pre><code>ping: debian12-vm1: \u00c9chec temporaire dans la r\u00e9solution ...\n</code></pre> <p>Idem avec l'h\u00f4te <code>ctn2</code> :</p> <pre><code>[srvlan@srvlan:~$] ping ctn2.intra.loupipfire.fr \n</code></pre> <p>Retour :</p> <pre><code>ping: ctn2.intra.loupipfire.fr: Nom ou service inconnu\n</code></pre> <p>Seule la r\u00e9solution DNS externe fonctionne :</p> <pre><code>[srvlan@srvlan:~$] ping lemonde.fr \n</code></pre> <p>Retour :</p> <pre><code>PING lemonde.fr (151.101.2.137) 56(84) bytes of d...\n64 bytes from 151.101.2.137 (151.101.2.137): icmp...\n64 bytes from 151.101.2.137 (151.101.2.137): icmp...\n--- lemonde.fr ping statistics ---\n2 packets transmitted, 2 received, 0% packet loss...\nrtt min/avg/max/mdev = 15.730/16.145/16.560/0.415 ms\n</code></pre>"},{"location":"blog/dns-dynamique---vboxdeb12/#-creation-dune-cle-tsig","title":"- Cr\u00e9ation d'une cl\u00e9 TSIG","text":"<p>TSIG (Transaction Signature) est un m\u00e9canisme permettant de s\u00e9curiser la communication avec un serveur DNS, ceci \u00e0 base d'une cl\u00e9 secr\u00e8te partag\u00e9e.</p> <p>Il peut \u00eatre utilis\u00e9 pour authentifier les \u00e9changes effectu\u00e9s lors d'une MAJ dynamique des fichiers de zones DNS via DHCP.</p> <p>TSIG requiert une bonne synchronisation du temps pour fonctionner correctement.</p> <p>C'est actuellement VirtualBox qui g\u00e8re par d\u00e9faut cette synchronisation du temps pour l'ensemble du r\u00e9seau virtuel.</p> <p>Cr\u00e9ez la cl\u00e9 secr\u00e8te partag\u00e9e comme suit :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/bind\n[srvlan@srvlan:~$] su root\n\n[root@srvlan:~#] sudo tsig-keygen -a HMAC-SHA256 tsig-kea-bind  &gt; tsig-kea-bind.key \n\n[root@srvlan:~#] chown root:bind tsig-kea-bind.key\n[root@srvlan:~#] chmod 640 tsig-kea-bind.key\n[root@srvlan:~#] exit \n</code></pre> <p>La Cde tsig-keygen est fournie avec le paquet bind9.</p> <p>V\u00e9rifiez ensuite le contenu du fichier tsig-kea-bind.key :</p> <pre><code>[srvlan@srvlan:~$] sudo cat tsig-kea-bind.key \n</code></pre> <p>Retour :</p> <pre><code>key \"tsig-kea-bind\" {\n     algorithm hmac-sha256;\n     secret \"z1iGvZ6fqgHtwlQVsltfMqvtBB24rxk2VpZ...\";\n}; \n</code></pre> <p>L'\u00e9l\u00e9ment secret contient la valeur de la cl\u00e9 TSIG.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#-configuration-serveur-dns","title":"- Configuration serveur DNS","text":"<p>Pour \u00e9viter de rencontrer par la suite des probl\u00e8mes de permission d'\u00e9criture, d\u00e9placez les fichiers actuels de zone DNS vers le dossier /var/lib/bind/ comme suit :</p> <pre><code>[srvlan@srvlan:~$] cd /var/lib/bind\n[srvlan@srvlan:~$] sudo mv /etc/bind/*.directe /var/lib/bind/\n[srvlan@srvlan:~$] sudo mv /etc/bind/*.inverse /var/lib/bind/ \n</code></pre> <p>Sous Debian, ce dossier est destin\u00e9 aux fichiers de zone et journaux mis \u00e0 jour dynamiquement.</p> <p>Cette configuration tient compte du profil de s\u00e9curit\u00e9 apparmor associ\u00e9 \u00e0 l'application bind et param\u00e9tr\u00e9 dans le fichier /etc/apparmor.d/usr.sbin.named.</p> <p>Editez ensuite le fichier named.conf.local :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/bind/named.conf.local\n</code></pre> <p>Modifiez la ligne \"# MAJ dynamique ...\" et ajoutez ce qui suit juste avant les lignes de configuration de la zone de recherche directe :</p> <pre><code># MAJ dynamique des fichiers de zones -&gt; update-policy\n\n# D\u00e9claration de la cl\u00e9 TSIG qui sera utilis\u00e9e pour\n# la mise \u00e0 jour dynamique du DNS\ninclude \"/etc/bind/tsig-kea-bind.key\";\n</code></pre> <p>puis modifiez la zone de recherche directe comme suit :</p> <pre><code>file \"/var/lib/bind/db.intra.loupipfire.fr.directe\";\nupdate-policy {\n    grant tsig-kea-bind wildcard *.intra.loupipfire.fr A DHCID;\n        };\n</code></pre> <p>et la zone de recherche inverse comme ci-dessous :</p> <pre><code>file \"/var/lib/bind/db.intra.loupipfire.fr.inverse\";\nupdate-policy {\n    grant tsig-kea-bind wildcard *.3.168.192.in-addr.arpa PTR DHCID;\n        };\n</code></pre> <p>Pour finir, v\u00e9rifiez la syntaxe du fichier modifi\u00e9 :</p> <pre><code>[srvlan@srvlan:~$] sudo named-checkconf\n</code></pre> <p>Si OK, pas de retour.</p> <p>Le param\u00e8tre update-policy permettra d'accepter les demandes de MAJ DNS si authentifi\u00e9es avec la cl\u00e9 TSIG tsig-kea-bind.key.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#-configuration-serveur-dhcp","title":"- Configuration serveur DHCP","text":"<p>Le service DHCP doit utiliser la m\u00eame valeur de cl\u00e9 TSIG que le service DNS.</p> <p>Pour commencer, installez le paquet suivant :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install kea-dhcp-ddns-server\n</code></pre> <p>Celui-ci inclut le d\u00e9mon /usr/sbin/kea-dhcp-ddns qui effectuera la MAJ dynamique du serveur DNS, ceci chaque fois que Kea DHCP assignera une adresse IP \u00e0 une VM ou \u00e0 un conteneur.</p> <p>V\u00e9rifiez ensuite le statut du service install\u00e9 :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl status kea-dhcp-ddns-server\n</code></pre> <p>Retour normal :</p> <pre><code>\u25cf kea-dhcp-ddns-server.service - Kea DDNS Service\n     Loaded: loaded (...kea-dhcp-ddns-server... enabled...)\n     Active: active (running) since Tue 2024-03-26 ... ago\n       Docs: man:kea-dhcp-ddns(8)\n   Main PID: 36442 (kea-dhcp-ddns)\n      Tasks: 5 (limit: 1077)\n     Memory: 3.4M\n        CPU: 26ms\n     CGroup: /system.slice/kea-dhcp-ddns-server.service\n             \u2514\u250036442 /usr/sbin/kea-dhcp-ddns -c ...conf\n... systemd[1]: Started kea-dhcp-ddns-server...\n... kea-dhcp-ddns... [kea-dhcp-ddns.dctl...] ... DhcpDdns starting...\n... kea-dhcp-ddns... INFO  COMMAN... Starting to accept ... to /run/kea/kea-ddns-ctrl-socket\n... kea-dhcp-ddns... INFO  DCTL... completed ... on 127.0.0.1, port 53001, using UDP\n... kea-dhcp-ddns... INFO  DHCP... Kea DHCP-DDNS server version 2.2.0 started\n</code></pre> <p>Puis cr\u00e9ez un fichier qui contiendra la cl\u00e9 TSIG d\u00e9clar\u00e9e ci-dessus sur le serveur DNS :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/kea\n[srvlan@srvlan:~$] sudo nano tsig-keys.json\n</code></pre> <p>et entrez le contenu suivant au format JSON :</p> <pre><code>\"tsig-keys\": [\n    {\n       \"name\": \"tsig-kea-bind\",\n       \"algorithm\": \"hmac-sha256\",\n       \"secret\": \"z1iGvZ6fqgHtwlQVsltfMqvtBB24rxk2VpZ...\"\n    }\n],\n</code></pre> <p>G\u00e9rez les permissions du fichier tsig-keys.json :</p> <pre><code>[srvlan@srvlan:~$] sudo chown _kea:root tsig-keys.json\n[srvlan@srvlan:~$] sudo chmod 640 tsig-keys.json \n</code></pre> <p>Puis cr\u00e9ez le fichier qui contiendra la configuration pour la MAJ dynamique du service DNS :</p> <pre><code>[srvlan@srvlan:~$] sudo mv kea-dhcp-ddns.conf kea-dhcp-ddns.conf_save\n\n[srvlan@srvlan:~$] sudo nano kea-dhcp-ddns.conf \n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>{\n    \"DhcpDdns\":\n    {\n      \"ip-address\": \"127.0.0.1\",\n      \"port\": 53001,\n      \"control-socket\": {\n          \"socket-type\": \"unix\",\n          \"socket-name\": \"/run/kea/kea-ddns-ctrl-socket\"\n      },\n      &lt;?include \"/etc/kea/tsig-keys.json\"?&gt;\n      \"forward-ddns\" : {\n          \"ddns-domains\" : [\n              {\n                   \"name\": \"intra.loupipfire.fr.\",\n                   \"key-name\": \"tsig-kea-bind\",\n                   \"dns-servers\": [\n                       { \"ip-address\": \"192.168.3.1\" }\n                   ]\n              }\n          ]\n      },\n      \"reverse-ddns\" : {\n          \"ddns-domains\" : [\n              {\n                   \"name\": \"3.168.192.in-addr.arpa.\",\n                   \"key-name\": \"tsig-kea-bind\",\n                   \"dns-servers\": [\n                       { \"ip-address\": \"192.168.3.1\" }\n                   ]\n              }\n          ]\n      },\n      \"loggers\": [\n        {\n            \"name\": \"kea-dhcp-ddns\",\n            \"output_options\": [\n          {\n           \"output\": \"/var/log/kea/kea-ddns.log\",\n           \"pattern\": \"%D{%Y-%m-%d %H:%M:%S.%q} %-5p %m\\n\"\n          }\n            ],\n            \"severity\": \"INFO\",\n            \"debuglevel\": 0\n        }\n      ]\n    }\n} \n</code></pre> <p>G\u00e9rez les permissions du fichier kea-dhcp-ddns.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo chown _kea:root kea-dhcp-ddns.conf\n</code></pre> <p>et v\u00e9rifiez la bonne syntaxe de celui-ci :</p> <pre><code>[srvlan@srvlan:~$] sudo kea-dhcp-ddns -t kea-dhcp-ddns.conf\n</code></pre> <p>Retour normal :</p> <pre><code>2024-03-26 16:12:45.442 INFO  [kea-dhcp-ddns.dctl/...]\nDCTL_CONFIG_CHECK_COMPLETE server has completed configuration check:\nlistening on 127.0.0.1, port 53001, using UDP,\nresult: success(0), text=Configuration check successful\n</code></pre> <p>Editez enfin le fichier de configuration principal du serveur Kea DHCP :</p> <pre><code>[srvlan@srvlan:~$] sudo nano kea-dhcp4.conf\n</code></pre> <p>Supprimez les 2 lignes suivantes :</p> <pre><code>// Pas de MAJ dynamique du serveur DNS Bind9.\n\"ddns-send-updates\" : false,\n</code></pre> <p>et ajoutez celles-ci sous la section loggers :</p> <pre><code>\"loggers\": [\n        ... \n    ],\n// Configuration du DNS dynamique\n\"dhcp-ddns\": {\n        \"enable-updates\": true\n     },\n\n     \"ddns-qualifying-suffix\": \"intra.loupipfire.fr\",\n     \"ddns-override-client-update\": true,\n     \"ddns-update-on-renew\": true\n// Ci-dessous, accolades existantes\n}\n}\n</code></pre> <p>Ne pas oublier d'ajouter une virgule derri\u00e8re le crochet de fin de section loggers.</p> <p>V\u00e9rifiez enfin la bonne syntaxe du fichier :</p> <pre><code>[srvlan@srvlan:~$] sudo kea-dhcp4 -t kea-dhcp4.conf\n</code></pre> <p>et relancez dans l'ordre les services DNS et DHCP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart bind9\n[srvlan@srvlan:~$] sudo systemctl status bind9\n\n[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp4-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server\n\n[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp-ddns-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp-ddns-server\n</code></pre>"},{"location":"blog/dns-dynamique---vboxdeb12/#tests-de-bon-fonctionnement","title":"Tests de bon fonctionnement","text":""},{"location":"blog/dns-dynamique---vboxdeb12/#-clients-debian12-vm1-et-2","title":"- Clients debian12-vm1 et 2","text":"<p>Au pr\u00e9alable, ouvrez 2 terminaux sur le bureau de <code>srvlan</code>.</p> <p>Connectez-vous ensuite sur ceux-ci en tant qu'utilisateur root (Cde su root).</p> <p>Entrez sur le terminal 1 cette demande de tra\u00e7age :</p> <pre><code>[root@srvlan:~#] tail -f /var/log/kea/kea-dhcp4.packets.log\n</code></pre> <p>et sur le terminal 2 celle ci-dessous :</p> <pre><code>[root@srvlan:~#] journalctl -u named -f\n</code></pre> <p>Red\u00e9marrez maintenant la VM <code>debian12-vm1</code>.</p> <p>V\u00e9rifiez ensuite sur le terminal 1 pour le DHCP Kea : - La demande de configuration r\u00e9seau (DHCPREQUEST). - L'envoi de la configuration (DHCPACK).</p> <pre><code># D\u00e9but de s\u00e9quence DHCP\n\n08:58:39... DHCP4_BUFFER_RECEIVED ... from 0.0.0.0:68 to ... over interface enp0s8\n\n08:58:39... DHCP4_SUBNET_SELECTED [hwtype=1 ...], cid=[01:08:00:27:c6:12:a3], ... ID 1 ...\n\n08:58:39... DHCP4_SUBNET_DATA [hwtype=1 ...], cid=[...12:a3], ... 192.168.3.0/24\n\n08:58:39... DHCP4_PACKET_RECEIVED [hwtype=1 ...], cid=[...12:a3], ... DHCPREQUEST ... enp0s8\n\n08:58:39... DHCP4_QUERY_DATA [hwtype=1 ...], cid=[...12:a3], ... msg_type=DHCPREQUEST ...\n\noptions:\n  type=012, len=012: \"debian12-vm1\" (string)\n  type=050, len=004: 192.168.3.31 (ipv4-address)\n  type=053, len=001: 3 (uint8)\n  type=055, len=017: 1(uint8) 2(uint8) ...\n  type=057, len=002: 576 (uint16)\n  type=061, len=007: 01:08:00:27:c6:12:a3\n08:58:39... DHCP4_SUBNET_SELECTED [hwtype=1 ...], cid=[01:08:00:27:c6:12:a3], ... ID 1 ...\n\n08:58:39... DHCP4_SUBNET_DATA [hwtype=1 ...], cid=[...12:a3], ... 192.168.3.0/24\n\n08:58:39... DHCP4_PACKET_SEND ... DHCPACK ... from 192.168.3.1:67 to ...3.31:68 ... enp0s8\n\n08:58:39... DHCP4_RESPONSE_DATA ... DHCPACK ... local...192.168.3.1... remote...3.31...\n\noptions:\n  type=001, len=004: 4294967040 (uint32)\n  type=003, len=004: 192.168.3.1\n  type=006, len=004: 192.168.3.1\n  type=012, len=032: \"debian12-vm1.intra.loupipfire.fr\" (string)\n  type=051, len=004: 28800 (uint32) #Dur\u00e9e du bail soit 8h\n  type=053, len=001: 5 (uint8)\n  type=054, len=004: 192.168.3.1\n  type=058, len=004: 14400 (uint32)\n  type=059, len=004: 27720 (uint32)\n  type=061, len=007: 01:08:00:27:c6:12:a3\n  type=119, len=021: \"intra.loupipfire.fr.\" (fqdn)\n\n# Fin de s\u00e9quence DHCP\n</code></pre> <p>Puis sur le terminal 2 pour le DNS Bind : - L'utilisation de la cl\u00e9 tsig-kea-bind. - L'existence de 3 adding an RR de type A, DHCID et PTR.</p> <pre><code># D\u00e9but de s\u00e9quence DNS\n\n08:58:39... srvlan named: client @0x7...cb68 192.168.3.1#3.../key tsig-kea-bind: updating zone\n'intra.loupipfire.fr/IN': adding an RR at 'debian12-vm1.intra.loupipfire.fr' A 192.168.3.31\n\n08:58:39... srvlan named: client @0x7...cb68 192.168.3.1#3.../key tsig-kea-bind: updating zone\n'intra.loupipfire.fr/IN': adding an RR at 'debian12-vm1.intra.loupipfire.fr' DHCID AAEBCN...\n\n08:58:39... srvlan named: client @0x7...ef68 192.168.3.1#4.../key tsig-kea-bind: updating zone\n'3.168.192.in-addr.arpa/IN': deleting rrset at '31.3.168.192.in-addr.arpa' PTR\n\n08:58:39... srvlan named: client @0x7...ef68 192.168.3.1#4.../key tsig-kea-bind: updating zone\n'3.168.192.in-addr.arpa/IN': deleting rrset at '31.3.168.192.in-addr.arpa' DHCID\n\n08:58:39... srvlan named: client @0x7...ef68 192.168.3.1#4.../key tsig-kea-bind: updating zone\n'3.168.192.in-addr.arpa/IN': adding an RR at '31.3.168.192.in-addr.arpa' PTR debian12-\nvm1.intra.loupipfire.fr.\n\n08:58:39... srvlan named: client @0x7...ef68 192.168.3.1#4.../key tsig-kea-bind: updating zone\n'3.168.192.in-addr.arpa/IN': adding an RR at '31.3.168.192.in-addr.arpa' DHCID AAEBCN...\n\n# Fin de s\u00e9quence DNS\n</code></pre> <p>Acc\u00e9dez ensuite au dossier /var/lib/bind/, attendez quelques minutes et v\u00e9rifiez dans le fichier DNS db.intra.loupipfire.fr.directe l'ajout automatique : - d'enregistrements A et DHCID pour <code>debian12-vm1</code>.</p> <pre><code>$ORIGIN .\n$TTL 86400  ; 1 day\nintra.loupipfire.fr  IN SOA  srvlan.intra.loup... (\n  71         ; serial\n  604800     ; refresh (1 week)\n  84600      ; retry (23 hours 30 minutes)\n  2419200    ; expire (4 weeks)\n  604800     ; minimum (1 week)\n  )\n                      NS srvlan.intra.loupipfire.fr.\n$ORIGIN intra.loupipfire.fr.\n$TTL 9600       ; 2 hours 40 minutes\nctn1                    A       192.168.3.20\n                        DHCID   ( AAABAtCkfY...\n                                LAI= ) ; 0 1 32\nctn2                    A       192.168.3.30\n                        DHCID   ( AAAB5AqOAZ...\n                                TMM= ) ; 0 1 32\ndebian12-vm1            A       192.168.3.31\n                        DHCID   ( AAEBCNtBcY...\n                                YmM= ) ; 1 1 32\ndebian12-vm2            A       192.168.3.32\n                        DHCID   ( AAEBCNtKaY...\n                                yDU= ) ; 1 1 32\n$TTL 86400      ; 1 day\novs                     A       192.168.3.15\nsrvlan                  A       192.168.3.1\n</code></pre> <p>V\u00e9rifiez dans le fichier DNS db.intra.loupipfire.fr.inverse l'ajout pour <code>debian12-vm1</code> : - d'un enregistrement PTR.</p> <pre><code>$ORIGIN .\n$TTL 86400        ; 1 day\n3.168.192.in-addr.arpa IN SOA srvlan.intra.loup... (\n                66         ; serial\n                604800     ; refresh (1 week)\n                86400      ; retry (1 day)\n                2419200    ; expire (4 weeks)\n                604800     ; minimum (1 week)\n                )\n                        NS      srvlan.intra.loupipfire.fr.\n$ORIGIN 3.168.192.in-addr.arpa.\n1               PTR     srvlan.intra.loupipfire.fr.\n15              PTR     ovs.intra.loupipfire.fr.\n$TTL 9600       ; 2 hours 40 minutes\n20              PTR     ctn1.intra.loupipfire.fr.\n                DHCID   ( AAABAtCkfY...\n                        LAI= ) ; 0 1 32\n30              PTR     ctn2.intra.loupipfire.fr.\n                DHCID   ( AAAB5AqOAZ...\n                        TMM= ) ; 0 1 32\n31              PTR     debian12-vm1.intra.loupipfire.fr.\n                DHCID   ( AAEBCNtBcY...\n                        YmM= ) ; 1 1 32\n32              PTR     debian12-vm2.intra.loupipfire.fr.\n                DHCID   ( AAEBCNtKaY...\n                        yDU= ) ; 1 1 32\n</code></pre> <p>Le bail attribu\u00e9 a \u00e9t\u00e9 mis en cache dans le fichier /var/lib/kea/kea-leases4.csv.2 de la VM <code>srvlan</code>.</p> <p>Effectuez \u00e0 pr\u00e9sent des pings entre <code>srvlan</code> et <code>debian12-vm1</code> pour v\u00e9rifier que la r\u00e9solution DNS interne fonctionne de nouveau correctement.</p> <p>La r\u00e9solution sur <code>debian12-vm2</code> doit \u00e9galement fonctionner apr\u00e8s un red\u00e9marrage de la VM.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#-clients-ctn1-et-2","title":"- Clients ctn1 et 2","text":"<p>Editez le fichier de configuration du serveur DHCP :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/kea/kea-dhcp4.conf\n</code></pre> <p>et modifiez cette section afin que soit propos\u00e9 le nom d'h\u00f4te <code>ctn2</code>ctn2 lors de la r\u00e9ception d'un DHCPREQUEST provenant de l'adresse MAC a2:20:b3:eb:30:67 :</p> <pre><code>// IP et noms d'h\u00f4tes r\u00e9serv\u00e9s.\n  \"reservations\": [\n                {\n                    \"hw-address\": \"e2:f0:31:2a:b6:05\",\n                    \"ip-address\": \"192.168.3.20\",\n                    \"hostname\": \"ctn1\"               \n                },\n                {\n                    \"hw-address\": \"a2:20:b3:eb:30:67\",\n                    \"hostname\": \"ctn2\"\n                }\n            ]\n</code></pre> <p>Red\u00e9marrez ensuite le serveur DHCP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp4-server\n</code></pre> <p>et modifiez le script networknamespace.sh situ\u00e9 sur la VM ovs comme suit :</p> <pre><code>[switch@ovs:~$] sudo nano /root/networknamespace.sh\n</code></pre> <pre><code>## Activation des extr\u00e9mit\u00e9s vctn1/2 et lo c\u00f4t\u00e9 nsct...\n...\n...\n...\nip netns exec nsctn2 ip link set vctn2 address a2:20:b3:eb:30:67 up\n\n## Ajout adresses IP extr\u00e9mit\u00e9s vctn1/2 c\u00f4t\u00e9 nsctn1/nsctn2\n...\n#ip netns exec nsctn2 ip addr add 192.168.3.8/24 dev vctn2\n\n## D\u00e9claration des interfaces vctn1/2 comme clients DHCP.\n...\nip netns exec nsctn2 dhclient -4 vctn2  # Ligne ajout\u00e9e\n</code></pre> <p>Red\u00e9marrez la VM <code>ovs</code> et contr\u00f4lez la bonne r\u00e9solution DNS interne pour le nom d'h\u00f4te <code>ctn2</code> :</p> <pre><code>[switch@ovs:~$] nslookup ctn2\n</code></pre> <p>Retour normal :</p> <p> </p> Conteneur ctn2 : R\u00e9solution DNS = OK <p>Pour le renouvellement du bail, il faut constater que la demande de celui-ci depuis les espaces de noms r\u00e9seau nsctn1 et nsctn2 ne se fait pas automatiquement.</p> <p>Vous ferez la demande \u00e0 l'aide d'une t\u00e2che Cron qui ex\u00e9cutera un script d\u00e9di\u00e9 \u00e0 cette fonction.</p> <p>Commencez par cr\u00e9er le script :</p> <pre><code>[switch@ovs:~$] sudo nano /root/networknamespace-ddns.sh\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>#!/bin/bash\n# Reset configurations IP/DNS de nsctn1/2\nip netns exec nsctn1 /usr/sbin/dhclient -4 -r vctn1\nip netns exec nsctn2 /usr/sbin/dhclient -4 -r vctn2\n\n# Renouvellement configuration IP/DNS de nsctn1/2\nip netns exec nsctn1 /usr/sbin/dhclient -4 vctn1\nip netns exec nsctn2 /usr/sbin/dhclient -4 vctn2\n\nexit 0\n</code></pre> <p>Rendez le script ex\u00e9cutable :</p> <pre><code>[switch@ovs:~$] sudo chmod +x /root/networknamespace-ddns.sh\n</code></pre> <p>Cr\u00e9ez maintenant une t\u00e2che Cron pour l'utilisateur root :</p> <pre><code>[switch@ovs:~$] su root\n\n[root@ovs:~#] crontab -e\n</code></pre> <p>en entrant ce contenu \u00e0 la fin du fichier ouvert :</p> <pre><code># Ex\u00e9cuter le script networknamespace-ddns.sh toutes les 7H\n0 */7 * * * /bin/bash /root/networknamespace-ddns.sh\n</code></pre> <p>La demande de renouvellement du bail sera ainsi ex\u00e9cut\u00e9e automatiquement toutes les 7H, ceci avant l'\u00e9ch\u00e9ance initiale de 8H.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#aide-au-depannage","title":"Aide au d\u00e9pannage","text":"<p>La m\u00e9thode ci-dessous r\u00e9glera un \u00e9ventuel probl\u00e8me de MAJ automatique d'un enregistrement DNS constat\u00e9 dans les logs du fichier /var/log/kea/kea-ddns.log.</p> <p>D\u00e9sactivez temporairement la MAJ du DNS :</p> <pre><code>[srvlan@srvlan:~$] sudo rndc freeze\n</code></pre> <p>Ouvrez, sur <code>srvlan</code>, les fichiers DNS de zone directe et inverse et supprimez l'enregistrement DNS critique.</p> <p>R\u00e9activez ensuite la MAJ du DNS :</p> <pre><code>[srvlan@srvlan:~$] sudo rndc thaw\n</code></pre> <p>Puis red\u00e9marrez le client DHCP \u00e0 l'origine de l'enregistrement, tout devrait rentrer dans l'ordre.</p>"},{"location":"blog/dns-dynamique---vboxdeb12/#bilan","title":"Bilan","text":"<p>Les \u00e9changes entre les serveurs DNS Bind9 et DHCP Kea, tous deux situ\u00e9s sur le m\u00eame h\u00f4te, sont g\u00e9r\u00e9s automatiquement et s\u00e9curis\u00e9s par cl\u00e9 TSIG.</p> <p>La configuration TSIG peut \u00e9videmment \u00eatre appliqu\u00e9e sur des serveurs distants l'un de l'autre.</p> <p></p> <p>  Voil\u00e0 une bonne chose de faite. Le m\u00e9mento 8.1 vous attend pour la mise en place d'un serveur Web PHP MySQL sur la VM <code>srvdmz</code>.</p> <p>M\u00e9mento 8.1 - Partie 1/2</p>"},{"location":"blog/dns-split---vboxdeb12/","title":"DNS split - VBox/Deb12","text":""},{"location":"blog/dns-split---vboxdeb12/#memento-101-dns-split-brain","title":"M\u00e9mento 10.1 - DNS Split-Brain","text":"<p>Rappel, 2 entit\u00e9s distinctes coexistent sur le r\u00e9seau : - Domaine <code>loupvirtuel.fr</code> en zone interne publique. - Sous-domaine <code>intra.loupipfire.fr</code> en zone interne priv\u00e9e.</p> <p>Le domaine n'est actuellement pas joignable depuis Internet et le sous-domaine n'est pas compatible avec le domaine.</p> <p>Pour le fun, vous allez cr\u00e9er un DNS split qui permettra de joindre le domaine depuis Internet ou la zone interne et une d\u00e9l\u00e9gation de zone qui d\u00e9clarera la gestion d'un sous-domaine compatible tel <code>intra.loupvirtuel.fr</code>.</p> <p>2 serveurs DNS dont 1 \u00e0 cr\u00e9er seront utilis\u00e9s : - 1 sur <code>srvdmz</code> pour le domaine <code>loupvirtuel.fr</code> (cr\u00e9ation). - 1 sur <code>srvlan</code> pour le sous-domaine <code>intra.loupvirtuel.fr</code>.</p> <p>Vous finirez en mettant en place un proxy inverse qui permettra de joindre le site Web du sous-domaine depuis Internet.</p>"},{"location":"blog/dns-split---vboxdeb12/#roles-dns-delegation-proxy","title":"R\u00f4les DNS, d\u00e9l\u00e9gation, proxy","text":""},{"location":"blog/dns-split---vboxdeb12/#-dns-split","title":"- DNS split","text":"<p>Fournir une IP publique aux requ\u00eates DNS provenant de la zone Internet et une IP locale aux requ\u00eates provenant des zones internes DMZ/LAN.</p> <p>Cela \u00e9vitera notamment de d\u00e9voiler au monde ext\u00e9rieur l'IP interne du domaine <code>loupvirtuel.fr</code>.</p>"},{"location":"blog/dns-split---vboxdeb12/#-delegation-de-zone","title":"- D\u00e9l\u00e9gation de zone","text":"<p>D\u00e9l\u00e9guer la gestion du sous-domaine <code>intra.louvirtuel.fr</code> au serveur DNS de la zone LAN qui sera notamment, pour les noms d'h\u00f4tes des VM de la zone LAN, charg\u00e9 de r\u00e9pondre aux requ\u00eates DNS issues de la zone DMZ.</p>"},{"location":"blog/dns-split---vboxdeb12/#-proxy-inverse","title":"- Proxy inverse","text":"<p>Permettre \u00e0 un utilisateur d'Internet d'acc\u00e9der au serveur interne de la zone LAN. Plac\u00e9 en zone DMZ, il agira \u00e9galement comme une barri\u00e8re de protection.</p>"},{"location":"blog/dns-split---vboxdeb12/#service-dns-sur-srvdmz","title":"Service DNS sur srvdmz","text":""},{"location":"blog/dns-split---vboxdeb12/#-installation-de-bind-9","title":"- Installation de Bind 9","text":"<p>Commencez par mettre \u00e0 jour la distribution Debian :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt update \n[srvdmz@srvdmz:~$] sudo apt upgrade\n[srvdmz@srvdmz:~$] sudo reboot\n</code></pre> <p>Nota</p> <p>La synchronisation horaire assur\u00e9e par d\u00e9faut depuis le service systemd-timesyncd de Debian est d\u00e9sactiv\u00e9e automatiquement au profit de celle assur\u00e9e depuis le service vboxadd-service de VirtualBox.</p> <p>Si vous n'utilisez pas VirtualBox, v\u00e9rifiez le statut du service systemd-timesyncd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl status systemd-timesyncd\n</code></pre> <p>Un serveur de temps tel <code>x.debian.pool.ntp.org</code> doit \u00eatre contact\u00e9.</p> <p>Installez \u00e0 pr\u00e9sent le m\u00eame serveur DNS que sur <code>srvlan</code> :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install bind9\n</code></pre> <p>Le d\u00e9mon bind9 d\u00e9marre automatiquement. - La configuration de base a \u00e9t\u00e9 cr\u00e9\u00e9e dans /etc/bind/. - Les fichiers de zone le seront dans /var/lib/bind/.</p>"},{"location":"blog/dns-split---vboxdeb12/#-aclvueszones-recherche","title":"- ACL/vues/zones recherche","text":"<p>Les Access Control List faciliteront l'\u00e9criture/lecture de la configuration DNS en proposant de changer les d\u00e9finitions des r\u00e9seaux IP filtr\u00e9s par des alias plus explicites.</p> <p>Les vues internes et externes contiendront pour chacune d'elles les d\u00e9finitions de leurs propres zones de recherche et fichiers de zone associ\u00e9s ainsi que celles des zones en d\u00e9l\u00e9gation.</p> <p>Les zones de recherche directe permettront de renvoyer une adresse IP associ\u00e9e \u00e0 un nom alors que les zones de recherche inverse renverront un nom associ\u00e9 \u00e0 une adresse IP.</p> <p>Au pr\u00e9alable, \u00e9ditez le fichier named.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/bind/named.conf\n</code></pre> <p>et commentez l'inclusion des zones par d\u00e9faut :</p> <pre><code>#include \"/etc/bind/named.conf.default-zones\";\n</code></pre> <p>Editez ensuite le fichier named.conf.local :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/bind/named.conf.local\n</code></pre> <p>et cr\u00e9ez les ACL, vues, zones de recherche et d\u00e9l\u00e9gations en ajoutant ceci \u00e0 la fin du fichier :</p> <pre><code>## D\u00e9finition des ACL pour les zones internes/externes\nacl interne { 192.168.2.0/24; 192.168.4.0/24; };\nacl externe { any; };\n\n## D\u00e9finition vue interne (loupvirtuel/intra.loupvirtuel)\nview \"interne\" {\n\nmatch-clients { interne; };\n\n# Zone de recherche directe loupvirtuel.fr\nzone \"loupvirtuel.fr\" IN {\ntype master;\nfile \"/var/lib/bind/db.loupvirtuel.fr.directe\";\nallow-update { none; };\n};\n\n# Zone de recherche inverse loupvirtuel.fr\nzone \"4.168.192.in-addr.arpa\" IN {\ntype master;\nfile \"/var/lib/bind/db.loupvirtuel.fr.inverse\";\nallow-update { none; };\n};\n\n# Zone de recherche directe s/domaine intra.loupvirtuel.fr\n# Zone d\u00e9l\u00e9gu\u00e9e au serveur DNS srvlan\nzone \"intra.loupvirtuel.fr\" IN {\ntype forward;\nforward only;\nforwarders { 192.168.3.1; };\n};\n\n# Zone de recherche inverse s/domaine intra.loupvirtuel.fr\n# Zone d\u00e9l\u00e9gu\u00e9e au serveur DNS srvlan\nzone \"3.168.192.in-addr.arpa\" IN {\ntype forward;\nforward only;\nforwarders { 192.168.3.1; };\n};\n\n## R\u00e9insertion des zones par d\u00e9faut fournies par bind9\ninclude \"/etc/bind/named.conf.default-zones\";\n};\n\n## D\u00e9finition vue externe, Internet -&gt; zone loupvirtuel.fr\nview \"externe\" {\n\nmatch-clients { externe; };\n\n# Zone de recherche directe loupvirtuel.fr\nzone \"loupvirtuel.fr\" IN {\ntype master;\nfile \"/var/lib/bind/db.loupvirtuel.fr.directe.externe\";\nallow-update { none; };\n};\n\n};\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-fichiers-zone-vue-interne","title":"- Fichiers zone vue interne","text":"<p>Cr\u00e9ez le fichier pour la zone directe :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/lib/bind\n[srvdmz@srvdmz:~$] sudo nano db.loupvirtuel.fr.directe\n</code></pre> <p>et ins\u00e9rez les lignes suivantes :</p> <pre><code>; DNS - Vue interne\n; R\u00e9solution directe pour loupvirtuel.fr\n$TTL 86400\n@ IN SOA srvdmz.loupvirtuel.fr. root.loupvirtuel.fr. (\n2024070401\n1w\n1d\n4w\n1w )\n@ IN NS srvdmz.loupvirtuel.fr.\nsrvdmz IN A 192.168.4.2\n@ IN A 192.168.4.2\nwww IN CNAME srvdmz\n; D\u00e9l\u00e9gation de zone pour intra.loupvirtuel.fr\n$ORIGIN intra.loupvirtuel.fr.\n@ IN NS srvlan.intra.loupvirtuel.fr.\nsrvlan IN A 192.168.3.1\n</code></pre> <p>2024070401 = cr\u00e9\u00e9 le 04/07/2024 + index de d\u00e9part 01</p> <p>Le fichier contient les enregistrements DNS ouvrant l'acc\u00e8s au domaine <code>loupvirtuel.fr</code> ainsi qu'une d\u00e9claration de d\u00e9l\u00e9gation de zone pour l'acc\u00e8s au sous-domaine <code>intra.loupvirtuel.fr</code>.</p> <p>Cr\u00e9ez maintenant le fichier pour la zone inverse :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/lib/bind\n[srvdmz@srvdmz:~$] sudo nano db.loupvirtuel.fr.inverse\n</code></pre> <p>et ins\u00e9rez les lignes suivantes :</p> <pre><code>; DNS - Vue interne\n; R\u00e9solution inverse pour loupvirtuel.fr\n$TTL 86400\n@ IN SOA srvdmz.loupvirtuel.fr. root.loupvirtuel.fr. (\n2024070401\n1w\n1d\n4w\n1w )\n@ IN NS srvdmz.loupvirtuel.fr.\n2 IN PTR srvdmz.loupvirtuel.fr.\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-fichier-zone-vue-externe","title":"- Fichier zone vue externe","text":"<p>Effectuez une copie du fichier db.loupvirtuel.fr.directe :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/lib/bind\n[srvdmz@srvdmz:~$] sudo cp *directe db.loupvirtuel.fr.directe.externe\n</code></pre> <p>et modifiez la copie avec l'\u00e9diteur nano comme suit :</p> <pre><code>; DNS - Vue externe\n; R\u00e9solution directe pour loupvirtuel.fr\n$TTL 86400\n@ IN SOA srvdmz.loupvirtuel.fr. root.loupvirtuel.fr. (\n2024070401\n1w\n1d\n4w\n1w )\n@ IN NS srvdmz.loupvirtuel.fr.\nsrvdmz IN A 192.168.x.w\n@ IN A 192.168.x.w\nwww IN CNAME srvdmz\n</code></pre> <p>Remplacez 192.168.x.w par l'IP de la carte RED IPFire. N'oubliez pas de retirer la partie d\u00e9l\u00e9gation de zone.</p>"},{"location":"blog/dns-split---vboxdeb12/#-permissions-sur-les-fichiers","title":"- Permissions sur les fichiers","text":"<p>Attachez les 3 fichiers de zone cr\u00e9\u00e9s au groupe bind :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chgrp bind /var/lib/bind/*loupvirtuel*\n</code></pre> <p>Le d\u00e9mon bind9 pourra ainsi acc\u00e9der \u00e0 leur contenu.</p> <p>Modifiez si besoin leurs permissions \u00e0 la valeur 644 :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chmod 644 /var/lib/bind/*loupvirtuel*\n</code></pre> <p>6 = Lecture/Ecriture pour le propri\u00e9taire root. 4 = Lecture pour le groupe bind. 4 = Lecture pour les autres utilisateurs.</p>"},{"location":"blog/dns-split---vboxdeb12/#-fichiers-hostsresolvconf","title":"- Fichiers hosts/resolv.conf","text":"<p>Avant, relancez bind9 pour traiter les fichiers ci-dessus :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart bind9\n[srvdmz@srvdmz:~$] sudo systemctl status bind9\n</code></pre> <p>Le statut signale pour l'instant un r\u00e9seau injoignable.</p> <p>Editez ensuite le fichier DNS de nom hosts :</p> <pre><code>[srvdmz@srvdmz:~$] sudo cat /etc/hosts\n</code></pre> <p>et v\u00e9rifiez qu'il contient bien le FQDN de <code>srvdmz</code> :</p> <pre><code>192.168.4.2 srvdmz.loupvirtuel.fr srvdmz loupvirtuel.fr \n</code></pre> <p>Corrigez ou ajoutez la ligne si n\u00e9cessaire.</p> <p>Videz ensuite le contenu du fichier DNS /etc/resolv.conf puis d\u00e9sactivez son remplissage auto par le service de NetworkManager comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/NetworkManager/conf.d\n[srvdmz@srvdmz:~$] sudo nano 90-dns-none.conf\n</code></pre> <p>Entrez les 2 lignes ci-dessous :</p> <pre><code>[main]\ndns=none \n</code></pre> <p>et relancez les services NetworkManager et bind9 :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl reload NetworkManager\n[srvdmz@srvdmz:~$] sudo systemctl restart NetworkManager\n[srvdmz@srvdmz:~$] sudo systemctl status NetworkManager\n\n[srvdmz@srvdmz:~$] sudo systemctl restart bind9\n[srvdmz@srvdmz:~$] sudo systemctl status bind9\n</code></pre> <p>V\u00e9rifiez que le fichier resolv.conf est bien toujours vide :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/resolv.conf\n</code></pre> <p>et si OK, entrez les lignes suivantes :</p> <pre><code># Fichier resolv.conf - Client DNS\n\n# Nom du domaine local\ndomain loupvirtuel.fr\n\n# Ajout automatique du nom de domaine aux h\u00f4tes\n# non pleinement qualifi\u00e9s\nsearch loupvirtuel.fr\nsearch intra.loupvirtuel.fr\n\n# Adresses IP du ou des serveurs DNS \u00e0 interroger\nnameserver 192.168.4.2\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-resolution-dns-externe","title":"- R\u00e9solution DNS externe","text":"<p>Comme dans le m\u00e9mento 7.1, vous allez faire en sorte que les demandes de r\u00e9solution externe (Ex : ping <code>www.yahoo.fr</code>) soient trait\u00e9es par le serveur DNS de la box Internet.</p> <p>Editez pour cela le fichier named.conf.options :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/bind\n[srvdmz@srvdmz:~$] sudo nano named.conf.options\n</code></pre> <p>et modifiez celui-ci afin qu'il contienne ces lignes :</p> <pre><code>options {\ndirectory \"/var/cache/bind\";\n\n# Pas d'utilisation du protocole DNSSEC\ndnssec-validation no;\n\n# Si r\u00e9ponse locale impossible, envoi des requ\u00eates DNS\n# vers la box Internet.\nforward only;\nforwarders { 192.168.x.z; };\nauth-nxdomain no;\n\nlisten-on-v6 { any; };\n};\n</code></pre> <p>Remplacez 192.168.x.z par l'IP de votre box Internet.</p> <p>Pour finir, relancez le service bind9 et v\u00e9rifiez le statut :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart bind9\n[srvdmz@srvdmz:~$] sudo systemctl status bind9\n</code></pre> <p>Le statut montre cette fois les zones DNS charg\u00e9es.</p>"},{"location":"blog/dns-split---vboxdeb12/#-securisation-de-bind-9","title":"- S\u00e9curisation de Bind 9","text":"<p>Editez de nouveau le fichier named.conf.options :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano named.conf.options\n</code></pre> <p>et ajoutez ce qui suit au dessus de # Pas d'utilis... :</p> <pre><code>allow-recursion { 192.168.4.0/24;192.168.2.0/24; };\nallow-query { any; };\nallow-query-cache { 192.168.4.0/24;192.168.2.0/24; };\nminimal-responses no;\n\n# Pas d'utilisation du protocole DNSSEC # ligne existante\n</code></pre> <p>- R\u00e9cursivit\u00e9 limit\u00e9e aux r\u00e9seaux indiqu\u00e9s. - Interrogation du DNS autoris\u00e9e pour tous les r\u00e9seaux. - Acc\u00e8s au cache DNS limit\u00e9s aux r\u00e9seaux indiqu\u00e9s. - R\u00e9ponses retourn\u00e9es compl\u00e8tes aux requ\u00eates DNS .</p> <p>La r\u00e9cursivit\u00e9, par s\u00e9curit\u00e9, est refus\u00e9e pour les requ\u00eates DNS provenant d'Internet.</p>"},{"location":"blog/dns-split---vboxdeb12/#-securisation-avec-cle-tsig","title":"- S\u00e9curisation avec cl\u00e9 TSIG","text":"<p>La Transaction Signature s\u00e9curisera la liaison entre les serveurs DNS de <code>srvdmz</code> et <code>srvlan</code>.</p> <p>Commencez par cr\u00e9er la cl\u00e9 secr\u00e8te de TSIG :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/bind\n[srvdmz@srvdmz:~$] su root\n\n[root@srvdmz:~$] sudo tsig-keygen -a HMAC-SHA256 tsig.key  &gt; tsig-dns-split.key\n\n[root@srvdmz:~$] chown bind:bind tsig-dns-split.key\n[root@srvdmz:~$] chmod 640 tsig-dns-split.key\n[root@srvdmz:~$] exit\n</code></pre> <p>La Cde tsig-keygen est fournie avec le paquet bind9.</p> <p>Affichez le contenu de la cl\u00e9 tsig-dns-split.key :</p> <pre><code>[srvdmz@srvdmz:~$] sudo cat tsig-dns-split.key\n</code></pre> <p>Retour :</p> <pre><code>key \"tsig.key\" {\n algorithm hmac-sha256;\n secret \"RzsH5sveyNOaRX2zHgp7bUPoUeBmAf5krR...\";\n};\n</code></pre> <p>Notez la valeur de la cl\u00e9 pour l'utiliser ci-dessous.</p> <p>Editez, pour d\u00e9clarer l'usage de la cl\u00e9, named.conf.local :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/bind/named.conf.local\n</code></pre> <p>et ajoutez ce contenu en fin de fichier :</p> <pre><code># D\u00e9claration cl\u00e9 TSIG et algorithme de chiffrage\nkey tsig-dns-split.key.\n{\nalgorithm hmac-sha256;\nsecret \"RzsH5sveyNOaRX2zHgp7bUPoUeBmAf5krR...\";\n};\n# IP du serveur DNS en d\u00e9l\u00e9gation pour intra.loupvirtuel.fr\nserver 192.168.3.1\n{\nkeys { tsig-dns-split.key; };\n};\n</code></pre> <p>Nota</p> <p>Ne pas oublier le point en fin de 2\u00e8me ligne.</p> <p>Red\u00e9marrez le serveur DNS :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart bind9\n[srvdmz@srvdmz:~$] sudo systemctl status bind9\n</code></pre> <p>Retour \u00e0 observer :</p> <pre><code>\u25cf named.service - BIND Domain Name Server\n   Loaded: loaded (/lib/sys...named.service; ena...)\n   Active: active (running) since Fri 2024-07-05 ...\n       Docs: man:named(8)\n   Main PID: 6353 (named)\n     Status: \"running\"\n      Tasks: 6 (limit: 1076)\n     Memory: 35.5M\n        CPU: 42ms\n     CGroup: /system.slice/named.service\n             \u2514\u25006353 /usr/sbin/named -f -u bind\n\nJuil.. zone 0.in-addr.arpa/IN/interne: loaded serial 1\njuil.. zone 127.in-addr.arpa/IN/interne: loaded serial 1\njuil.. zone loupvirtuel.fr/IN/interne load.. 2024070401\njuil.. zone localhost/IN/int.. load.. 2\njuil.. zone 4.168.192.in-addr../IN/int.. load.. 2024070401\njuil.. zone 255.in-addr../IN/interne: loaded serial 1\njuil.. zone loupvirtuel.fr/IN/externe load.. 2024070401\njuil.. all zones loaded\njuil.. running\njuil.. Started named.service - BIND Domain Name Server.\n</code></pre> <p>Si tout est OK, arr\u00eatez la VM :</p> <pre><code>[srvdmz@srvdmz:~$] sudo poweroff\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#pare-feu","title":"Modification du pare-feu IPFire","text":"<p>La suite du m\u00e9mento impose l'ajout de nouvelles r\u00e8gles.</p> <p>Acc\u00e9dez \u00e0 l'interface Web d'IPFire depuis <code>srvlan</code>, puis : Menu IPFire -&gt; Pakfire Effectuez la mise \u00e0 jour du syst\u00e8me si n\u00e9cessaire.</p> <p>Ensuite : Menu Pare-feu -&gt; Options de pare-feu -&gt; Section Param\u00e8tres pare-feu -&gt; Afficher tous les r\u00e9seaux sur le site de ... r\u00e8gles -&gt; Cochez on -&gt; Bouton Sauvegarder</p> <p>Menu Syst\u00e8me -&gt; Arr\u00eater -&gt; Red\u00e9marrer</p> <p>Menu Pare-feu -&gt; Groupes de pare-feu -&gt; Bouton H\u00f4tes -&gt; Ajouter un h\u00f4te -&gt; Nom : <code>srvdmz</code> -&gt; IP/MAC : 192.168.4.2 -&gt; Remarque : Serveur en zone orange -&gt; Bouton Sauvegarder</p> <p>-&gt; Nom : <code>srvlan</code> -&gt; IP/MAC : 192.168.3.1 -&gt; Remarque : Serveur en zone verte -&gt; Bouton Sauvegarder -&gt; Bouton Retour</p> <p>Menu Pare-feu -&gt; R\u00e8gles de pare-feu -&gt; Bouton Nouvelle r\u00e8gle</p> <p>a ) Ouverture du port HTTPS 443, Internet vers <code>srvdmz</code> : N\u00e9cessaire pour acc\u00e9der \u00e0 <code>loupvirtuel.fr</code> depuis Internet.</p> <p>Param\u00e9trage : - Source -&gt; Cochez R\u00e9seaux standards -&gt; ROUGE - NAT -&gt; Cochez Utiliser la trad... adresses r\u00e9seau (NAT) - Destination -&gt; Cochez Adresse IP de ... -&gt; 192.168.4.2 - Protocole -&gt; S\u00e9lectionnez TCP -&gt; Port de dest... -&gt; 443 - Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez HTTPS vers serveur Web zone orange autoris\u00e9 -&gt; Bouton Ajouter -&gt; Bouton Appliquer les changements</p> <p>Recommencez comme ci-dessus pour le port HTTP 80. Cela permettra de v\u00e9rifier la redirection de port vers HTTPS pour les URL http://<code>www.loupvirtuel.fr</code> et http://<code>loupvirtuel.fr</code>.</p> <p> </p> IPFire : HTTP/S ouverts zone Rouge vers Orange <p>b ) Ouverture du port DNS 53, <code>srvdmz</code> vers <code>srvlan</code> : Indispensable pour le dialogue DNS entre les 2 serveurs mais repr\u00e9sentant un petit trou de s\u00e9curit\u00e9 (pinhole IPFire) sachant que les demandes de liaison de la zone orange vers la verte sont normalement toutes bloqu\u00e9es.</p> <p>Param\u00e9trage : - Source -&gt; Cochez H\u00f4tes -&gt; <code>srvdmz</code> - NAT -&gt; Cochez Utiliser la trad... adresses r\u00e9seau (NAT) - Destination -&gt; Cochez H\u00f4tes -&gt; <code>srvlan</code> - Protocole -&gt; S\u00e9lectionnez TCP -&gt; Port de dest... -&gt; 53 - Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez DNS port TCP <code>srvdmz</code> vers <code>srvlan</code> autoris\u00e9 -&gt; Bouton Ajouter -&gt; Bouton Appliquer les changements</p> <p>Recommencez comme ci-dessus pour le protocole UDP car le dialogue DNS se fait en priorit\u00e9 via ce protocole.</p> <p> </p> IPFire : DNS ouvert zone Orange vers Verte <p>c ) Ouverture du port DNS 53, Internet vers <code>srvdmz</code> : Permettra d'interroger le serveur DNS depuis Internet.</p> <p>Param\u00e9trage : - Source -&gt; Cochez R\u00e9seaux standards -&gt; ROUGE - NAT -&gt; Cochez Utiliser la trad... adresses r\u00e9seau (NAT) - Destination -&gt; Cochez Adresse IP de \u2026 -&gt; 192.168.4.2 - Protocole -&gt; S\u00e9lectionnez UDP -&gt; Port de dest... -&gt; 53 - Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez DNS port UDP Internet vers <code>srvdmz</code> autoris\u00e9 -&gt; Bouton Ajouter -&gt; Bouton Appliquer les changements</p> <p> </p> IPFire : DNS UDP ouvert zone Rouge vers Orange <p>d ) Ouverture du port HTTP 80, <code>srvdmz</code> vers <code>srvlan</code> : R\u00e8gle temporaire cr\u00e9\u00e9e pour tester l'acc\u00e8s au serveur Web de <code>srvlan</code> depuis Internet ou <code>srvdmz</code> mais repr\u00e9sentant un trou de s\u00e9curit\u00e9 entre la zone publique DMZ et la zone priv\u00e9e LAN.</p> <p>Param\u00e9trage : - Source -&gt; Cochez H\u00f4tes -&gt; <code>srvdmz</code> - NAT -&gt; Cochez Utiliser la trad... adresses r\u00e9seau (NAT) - Destination -&gt; Cochez H\u00f4tes -&gt; <code>srvlan</code> - Protocole -&gt; S\u00e9lectionnez TCP -&gt; Port de dest... -&gt; 80 - Param\u00e8tres additionnels -&gt; Remarque -&gt; Entrez HTTP vers serveur Web zone verte autoris\u00e9 -&gt; Bouton Ajouter -&gt; Bouton Appliquer les changements</p> <p> </p> IPFire : HTTP ouvert zone Orange vers Verte"},{"location":"blog/dns-split---vboxdeb12/#service-dns-sur-srvlan","title":"Service DNS sur srvlan","text":""},{"location":"blog/dns-split---vboxdeb12/#-zones-recherche-intra","title":"- Zones recherche intra...","text":"<p>Editez le fichier de configuration DNS named.conf.local :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/bind/named.conf.local\n</code></pre> <p>et modifiez les 2 zones de recherche comme suit :</p> <pre><code># zone de recherche directe\nzone \"intra.loupvirtuel.fr\" {\ntype master;\nfile \"/var/lib/bind/db.intra.loupvirtuel.fr.directe\";\nupdate-policy {\n  grant tsig-kea-bind wildcard *.intra.loupvirtuel.fr A DHCID;\n  };\n};\n\n# zone de recherche inverse\n# Le r\u00e9seau 192.168.3.0 aura pour adresse inverse\n# 3.168.192.in-addr.arpa\nzone \"3.168.192.in-addr.arpa\" {\ntype master;\nfile \"/var/lib/bind/db.intra.loupvirtuel.fr.inverse\";\nupdate-policy {\n  grant tsig-kea-bind wildcard *.3.168.192.in-addr.arpa PTR DHCID;\n  };\n};\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-fichiers-de-zone-intra","title":"- Fichiers de zone intra...","text":"<p>Cr\u00e9ez le fichier pour la zone directe :</p> <pre><code>[srvlan@srvlan:~$] cd /var/lib/bind\n[srvlan@srvlan:~$] sudo nano db.intra.loupvirtuel.fr.directe\n</code></pre> <p>et ins\u00e9rez les lignes suivantes :</p> <pre><code>;\n; Zone DNS intra.loupvirtuel.fr - Fichier de zone pour\n; la r\u00e9solution directe\n;\n$TTL 86400\n@ IN SOA srvlan.intra.loupvirtuel.fr. root.intra.loupvirtuel.fr. (\n1              ; Serial\n604800         ; Refresh - 1w (1 semaine)\n84600          ; Retry - 1d (1 jour)\n2419200        ; Expire - 4w\n604800 )       ; Negative Cache TTL - 1w\n;\n@ IN NS srvlan.intra.loupvirtuel.fr.\nsrvlan IN A 192.168.3.1\n@ IN A 192.168.3.1\novs IN A 192.168.3.15\nwww  IN CNAME srvlan\n</code></pre> <p>Puis cr\u00e9ez le fichier pour la zone inverse :</p> <pre><code>[srvlan@srvlan:~$] sudo nano db.intra.loupvirtuel.fr.inverse\n</code></pre> <p>et ins\u00e9rez les lignes suivantes :</p> <pre><code>;\n; Zone DNS intra.loupvirtuel.fr - Fichier de zone pour\n; la r\u00e9solution inverse\n;\n$TTL 86400\n@ IN SOA srvlan.intra.loupvirtuel.fr. root.intra.loupvirtuel.fr. (\n1\n1w\n1d\n4w\n1w )\n;\n@ IN NS srvlan.intra.loupvirtuel.fr.\n1 IN PTR srvlan.intra.loupvirtuel.fr.\n15 IN PTR ovs.intra.loupvirtuel.fr.\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-reglage-des-permissions","title":"- R\u00e9glage des permissions","text":"<pre><code>[srvlan@srvlan:~$] sudo chgrp bind /var/lib/bind/*loupvirtuel*\n\n[srvlan@srvlan:~$] sudo chmod 644 /var/lib/bind/*loupvirtuel*\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-fichiers-dns-hosts-et","title":"- Fichiers DNS hosts et ...","text":"<p>Editez le fichier DNS hosts :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/hosts\n</code></pre> <p>et modifiez son contenu comme suit :</p> <pre><code>127.0.0.1           localhost\n127.0.1.1           srvlan\n\n# IP de srvlan       + FQDN    + nom d'h\u00f4te     + domaine\n192.168.3.1 srvlan.intra.loupvirtuel.fr  srvlan  intra.loupvirtuel.fr\n\n# The following lines are desirable for IPv6 capable hosts\n::1 localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n</code></pre> <p>Supprimez la ligne 192.168.4.2 <code>loupvirtuel.fr</code>, c'est le serveur DNS de <code>srvdmz</code> qui fournira dor\u00e9navant cette correspondance IP/Nom de domaine.</p> <p>Videz le contenu du fichier DNS /etc/resolv.conf puis d\u00e9sactivez son remplissage auto par le service de NetworkManager comme suit :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/NetworkManager/conf.d\n[srvlan@srvlan:~$] sudo nano 90-dns-none.conf\n</code></pre> <p>Entrez les 2 lignes ci-dessous :</p> <pre><code>[main]\ndns=none\n</code></pre> <p>et relancez les services NetworkManager et bind9 :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl reload NetworkManager\n[srvlan@srvlan:~$] sudo systemctl restart NetworkManager\n[srvlan@srvlan:~$] sudo systemctl status NetworkManager\n\n[srvlan@srvlan:~$] sudo systemctl restart bind9\n[srvlan@srvlan:~$] sudo systemctl status bind9\n</code></pre> <p>V\u00e9rifiez que le fichier resolv.conf est bien toujours vide :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/resolv.conf\n</code></pre> <p>et si OK entrez les lignes suivantes :</p> <pre><code># Fichier resolv.conf - Client DNS\n\n# Nom du domaine local\ndomain intra.loupvirtuel.fr\n\n# Ajout automatique du nom de domaine aux h\u00f4tes\n# non pleinement qualifi\u00e9s\nsearch intra.loupvirtuel.fr\nsearch loupvirtuel.fr\n\n# Adresses IP du ou des serveurs DNS \u00e0 interroger\nnameserver 192.168.3.1\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-fichiers-named-et-kea","title":"- Fichiers named... et kea...","text":"<p>Editez le fichier named.conf.options :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/bind/named.conf.options\n</code></pre> <p>et modifiez la valeur de ces param\u00e8tres comme suit :</p> <pre><code>dnssec-validation no;\nforwarders { 192.168.4.2; };\n</code></pre> <p>192.168.4.2 = IP du serveur DNS de <code>srvdmz</code></p> <p>Editez ensuite le fichier named.conf.local :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/bind/named.conf.local\n</code></pre> <p>et ajoutez \u00e0 la fin les informations sur la cl\u00e9 TSIG :</p> <pre><code># D\u00e9claration de la cl\u00e9 TSIG \u00e0 utiliser lors\n# des transactions DNS entre srvdmz et srvlan\nkey tsig-dns-split.key.\n{\nalgorithm hmac-sha256;\nsecret \"RzsH5sveyNOaRX2zHgp7bUPoUeBmAf5krR...\";\n};\n\n# IP du serveur DNS srvdmz pour la zone \"loupvirtuel.fr\"\nserver 192.168.4.2\n{\nkeys { tsig-dns-split.key; };\n};\n</code></pre> <p>Editez enfin le fichier DHCP kea-dhcp4.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/kea/kea-dhcp4.conf\n</code></pre> <p>et remplacez tous les <code>loupipfire</code> par <code>loupvirtuel</code>.</p> <p>Faites de m\u00eame avec le fichier kea-dhcp-ddns.conf.</p> <p>Puis, \u00e9ditez de nouveau le fichier kea-dhcp4.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/kea/kea-dhcp4.conf\n</code></pre> <p>et modifiez la section suivante comme ci-dessous :</p> <pre><code>// Domaine propos\u00e9 aux clients pour\n// r\u00e9soudre les noms d'h\u00f4tes via le DNS.\n{\n    \"name\": \"domain-search\",\n    \"data\": \"intra.loupvirtuel.fr, loupvirtuel.fr\"\n}\n</code></pre> <p>Cela permettra notamment la MAJ automatique du fichier DNS /etc/resolv.conf de la VM <code>ovs</code> ainsi que ceux des conteneurs Podman <code>ctn*</code>.</p> <p>Red\u00e9marrez ensuite les services et v\u00e9rifiez les statuts :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp4-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server\n\n[srvlan@srvlan:~$] sudo systemctl restart kea-dhcp-ddns-server\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp-ddns-server\n</code></pre> <p>Observez le contenu du cache DNS avant sa purge :</p> <pre><code>[srvlan@srvlan:~$] sudo rndc dumpdb -cache\n</code></pre> <p>La Cde ci-dessus cr\u00e9e dans /var/cache/bind/ un fichier de nom named_dump.db. Celui-ci renferme le contenu du cache DNS qui peut ainsi \u00eatre \u00e9dit\u00e9 pour lecture.</p> <pre><code>[srvlan@srvlan:~$] sudo cat /var/cache/bind/named_dump.db\n</code></pre> <p>Purgez maintenant le cache et relancez la m\u00eame Cde :</p> <pre><code>[srvlan@srvlan:~$] sudo rndc flush\n[srvlan@srvlan:~$] sudo rndc dumpdb -cache\n</code></pre> <p>Puis \u00e9ditez et observez le contenu du nouveau cache.</p> <p>Pour terminer, red\u00e9marrez la VM <code>srvlan</code> :</p> <pre><code>[srvlan@srvlan:~$] sudo reboot\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-installation-dapache","title":"- Installation d'Apache","text":"<p>Au pr\u00e9alable, red\u00e9marrez <code>srvdmz</code> sinon <code>srvlan</code> ne sera pas en mesure de joindre le monde ext\u00e9rieur pour notamment installer un nouveau paquet Linux.</p> <p>Ensuite, installez le paquet Apache :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install apache2\n[srvlan@srvlan:~$] sudo systemctl status apache2\n</code></pre> <p>Erreur : AH00558: apache2: Could not ... determine the server's fully qualified domain name</p> <p>Entrez ces Cdes pour r\u00e9gler le probl\u00e8me du FQDN :</p> <pre><code>[srvlan@srvlan:~$] sudo echo \"ServerName localhost\" | sudo tee /etc/apache2/conf-available/fqdn.conf\n\n[srvlan@srvlan:~$] sudo a2enconf fqdn\n[srvlan@srvlan:~$] sudo systemctl restart apache2\n[srvlan@srvlan:~$] sudo systemctl status apache2\n</code></pre> <p>et depuis <code>srvdmz</code>, testez l'URL <code>http://192.168.3.1</code>.</p> <p>Pr\u00e9parez la personnalisation de l'accueil du site Web :</p> <pre><code>[srvlan@srvlan:~$] cd /var/www/html\n[srvlan@srvlan:~$] sudo mv index.html index.html.origine\n[srvlan@srvlan:~$] sudo nano index.html\n</code></pre> <p>et remplissez le nouvel index.html avec ce contenu :</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;&lt;meta charset=\"utf-8\"&gt;&lt;/head&gt;\n&lt;body style=\"background-color:#ffab33\"&gt;\n\n&lt;h1 style=\"color:#000000\"&gt;\nAccueil Intranet de l'entreprise Loup Virtuel\n&lt;/h1&gt;\n\n&lt;p style=\"font-size:30px;color:#ffffff\"&gt;\nIci, des outils pour vous aider dans votre travail !\n&lt;/p&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>Pour finir, testez de nouveau l'URL <code>http://192.168.3.1</code>.</p>"},{"location":"blog/dns-split---vboxdeb12/#modification-sur-vm-zone-lan","title":"Modification sur VM zone LAN","text":"<p>- VM <code>ovs</code></p> <p>Red\u00e9marrez la VM <code>ovs</code> et v\u00e9rifiez la MAJ automatique de son fichier DNS /etc/resolv.conf ainsi que ceux des conteneurs Podman <code>ctn1/2</code> et <code>ctn3</code> (R\u00e9f. m\u00e9mento 5.2).</p> <p>Contenu normal suite \u00e0 la MAJ automatique par KEA :</p> <pre><code>search intra.loupvirtuel.fr. loupvirtuel.fr.\nnameserver 192.168.3.1\n</code></pre> <p>- VM <code>debian12-vm*</code> Faites un clic droit sur l'applet r\u00e9seau NetworkManager : -&gt; Modifier les connexions...</p> <p>Une fen\u00eatre Connexions r\u00e9seau s'ouvre : -&gt; S\u00e9lectionnez la connexion affich\u00e9e -&gt; Cliquez sur la roue dent\u00e9e situ\u00e9e en bas \u00e0 gauche</p> <p>Une fen\u00eatre Modification de ... s'ouvre : -&gt; Onglet Param\u00e8tres IPv4 -&gt; Domaines de recherche suppl\u00e9mentaires -&gt; Supprimez <code>intra.loupipfire.fr</code> -&gt; Remplacez par <code>intra.loupvirtuel.fr</code>, <code>loupvirtuel.fr</code> -&gt; Bouton Enregistrer</p> <p>Le param\u00e8tre search du fichier /etc/resolv.conf doit \u00eatre mis \u00e0 jour comme ceci :</p> <pre><code>[client-linux@debian12-vm*:~$] sudo systemctl restart NetworkManager\n\n[client-linux@debian12-vm*:~$] cat /etc/resolv.conf\n</code></pre> <p>Editez le fichier DNS hosts :</p> <pre><code>[client-linux@debian12-vm*:~$] sudo nano /etc/hosts\n</code></pre> <p>et modifiez son contenu comme suit :</p> <pre><code>127.0.0.1           localhost\n127.0.1.1           debian12-vm*\n\n# The following lines are desirable for IPv6 capable hosts\n::1 localhost ip6-localhost ip6-loopback\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\n</code></pre> <p>Supprimez la ligne 192.168.4.2 <code>loupvirtuel.fr</code>, c'est le serveur DNS de <code>srvdmz</code> qui fournira dor\u00e9navant cette correspondance IP/Nom de domaine.</p> <p>Par curiosit\u00e9, observez au bout de quelques minutes la bonne MAJ dynamique du fichier de zone DNS /var/lib/bind/db.intra.loupvirtuel.fr.directe situ\u00e9 sur <code>srvlan</code> :</p> <p> </p> srvlan : Fichier de zone db.intra.loupvirtuel.fr.directe"},{"location":"blog/dns-split---vboxdeb12/#controle-du-dns-split","title":"Contr\u00f4le du DNS split","text":""},{"location":"blog/dns-split---vboxdeb12/#-cote-srvdmz","title":"- C\u00f4t\u00e9 srvdmz","text":"<p>a ) V\u00e9rifiez l'usage de TSIG entre <code>srvdmz</code>/<code>srvlan</code> :</p> <pre><code>[srvdmz@srvdmz:~$] sudo dig -y hmac-sha256:tsig-dns-split.key:RzsH5sveyNOaRX2zHgp7bUPoUeBmAf5krR... @192.168.3.1 AXFR intra.loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>; &lt;&lt;&gt;&gt; DiG .. &lt;&lt;&gt;&gt; -y hmac-sha25.. intra.virtuel.fr\n; (1 server found)\n;; global options: +cmd\nintra.loupvirt.. 86400 IN SOA srvlan.intra.loup..\nintra.loupvirt.. 86400 IN NS  srvlan.intra.loup..\nintra.loupvirt.. 86400 IN A   192.168.3.1\nctn1.intra.loupvirt.. 9600 IN DHICD   \"AAABVT/nkT..\"\nctn1.intra.loupvirt.. 9600 IN A       192.168.3.20\nctn2.intra.loupvirt.. 9600 IN DHICD   \"AAABJW85g3..\"\nctn2.intra.loupvirt.. 9600 IN A       192.168.3.30\ndebian12-vm1.intra..  9600 IN DHICD   \"AAEBHGCxLT..\"\ndebian12-vm1.intra..  9600 IN A       192.168.3.31\ndebian12-vm2.intra..  9600 IN DHICD   \"AAEB7zLkSs..\"\ndebian12-vm2.intra..  9600 IN A       192.168.3.32\novs.intra.loupvirt.. 86400 IN A       192.168.3.15\nsrvlan.intra.loupv.. 86400 IN A       192.168.3.1\nwww.intra.loupvirt.. 86400 IN CNAME   srvlan.intra.loup..\nintra.loupvirtuel..  86400 IN SOA     srvlan.intra.loup..\ntsig-dns-split.key.. 0 ANY TSIG hmac... NOERROR 0 \n;; Query time: 4 msec\n;; SERVER: 192.168.3.1#53(192.168.3.1) (TCP)\n;; WHEN: Mon Jul 08 16:51:40 CEST 2024\n;; XFR size: 15 records (messages 1, bytes 624)\n</code></pre> <p>b ) V\u00e9rifiez le contenu du fichier named.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo named-checkconf\n</code></pre> <p>Aucune erreur ne sera retourn\u00e9e si OK.</p> <p>c ) V\u00e9rifiez la zone directe db.loupvirtuel.fr.directe :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/lib/bind\n\n[srvdmz@srvdmz:~$] sudo named-checkzone -d loupvirtuel.fr db.loupvirtuel.fr.directe\n</code></pre> <p>Retour :</p> <pre><code>loading \"loupvirtuel.fr\" from \"..directe\" class \"IN\"\nzone loupvirtuel.fr/IN: loaded serial 2024070401\nOK\n</code></pre> <p>d ) V\u00e9rifiez la zone inverse db.loupvirtuel.fr.inverse :</p> <pre><code>[srvdmz@srvdmz:~$] sudo named-checkzone -d 3.168.192.in-addr.arpa db.loupvirtuel.fr.inverse\n</code></pre> <p>Retour :</p> <pre><code>loading \"3.168.192.in-add..\" from \"..inverse\" class \"IN\"\nzone 3.168.192.in-add../IN: loaded serial 2024070401\nOK\n</code></pre> <p>e ) V\u00e9rifiez le r\u00e9sultat des 2 Cdes suivantes :</p> <pre><code>[srvdmz@srvdmz:~$] host -v srvdmz.loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>Trying \"srvdmz.loupvirtuel.fr\"\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id..\n;; flags: qr aa rd ra; ..RY: 1, ..ER: 1, ..TY: 1,..AL: 0\n\n;; QUESTION SECTION:\n;srvdmz.loupvirtuel.fr.      IN A\n\n;; ANSWER SECTION:\nsrvdmz.loupvirtuel.fr. 86400 IN A  192.168.4.2\n\n;; AUTHORITY SECTION:\nloupvirtuel.fr.        86400 IN NS srvdmz.loupvir..\n\nReceived 69 bytes from 192.168.4.2#53 in 4 ms\nTrying \"srvdmz.loupvirtuel.fr\"\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id..\n;; flags: ..; ..RY: 1, ..ER: 0, ..TY: 1, ..AL: 0\n\n;; QUESTION SECTION:\n;srvdmz.loupvirtuel.fr.      IN AAAA\n\n;; AUTHORITY SECTION:\nloupvirtuel.fr.        86400 IN SOA srvdmz.loupvir..\n\nReceived 80 bytes from 192.168.4.2#53 in 0 ms\nTrying \"srvdmz.loupvirtuel.fr\"\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id..\n;; flags: ..; ..RY: 1, ..ER: 0, ..TY: 1, ..AL: 0\n\n;; QUESTION SECTION:\n;srvdmz.loupvirtuel.fr.      IN MX\n\n;; AUTHORITY SECTION:\nloupvirtuel.fr.        86400 IN SOA srvdmz.loupvir..\n\nReceived 80 bytes from 192.168.4.2#53 in 4 ms\n</code></pre> <pre><code>[srvdmz@srvdmz:~$] sudo dig SOA srvdmz.loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>; &lt;&lt;&gt;&gt; DiG 9.18.24... &lt;&lt;&gt;&gt; SOA srvdmz.loupvirtuel.fr\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id..\n;; flags: ..; ..RY: 1, ..ER: 0, ..TY: 1, ..AL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: 7217bb51d09446ac01000000668d1948.. (good)\n;; QUESTION SECTION:\n;srvdmz.loupvirtuel.fr.        IN   SOA\n\n;; AUTHORITY SECTION:\nloupvirtuel.fr.         86400  IN   SOA  srvdmz.loupvir..\n\n;; Query time: 0 msec\n;; SERVER: 192.168.4.2#53(192.168.4.2) (UDP)\n;; WHEN: Tue Jul 09 13:04:40 CEST 2024\n;; MSG SIZE  rcvd: 119\n</code></pre> <p>f ) Contr\u00f4lez les IP retourn\u00e9es selon le domaine cibl\u00e9 :</p> <pre><code>[srvdmz@srvdmz:~$] nslookup loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>Server:   192.168.4.2\nAddress:  192.168.4.2#53\n\nName: loupvirtuel.fr\nAddress: 192.168.4.2\n</code></pre> <pre><code>[srvdmz@srvdmz:~$] nslookup intra.loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>Server:   192.168.4.2\nAddress:  192.168.4.2#53\n\nNon-authoritative answer:\nName: intra.loupvirtuel.fr\nAddress: 192.168.3.1\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-cote-srvlan","title":"- C\u00f4t\u00e9 srvlan","text":"<p>a ) V\u00e9rifiez l'usage de TSIG entre <code>srvlan</code>/<code>srvdmz</code> :</p> <pre><code>[srvlan@srvlan:~$] sudo dig -y hmac-sha256:tsig-dns-split.key:RzsH5sveyNOaRX2zHgp7bUPoUeBmAf5krR... @192.168.4.2 AXFR loupvirtuel.fr\n</code></pre> <p>et r\u00e9alisez les m\u00eames tests que ci-dessus avec <code>srvdmz</code> :</p> <pre><code>[srvlan@srvlan:~$] sudo named-checkconf\n\n[srvlan@srvlan:~$] cd /var/lib/bind\n\n[srvlan@srvlan:~$] sudo named-checkzone -d intra.loupvirtuel.fr db.intra.loupvirtuel.fr.directe\n\n[srvlan@srvlan:~$] sudo named-checkzone -d 3.168.192.in-addr.arpa db.intra.loupvirtuel.fr.inverse\n\n[srvlan@srvlan:~$] sudo host -v srvlan.intra.loupvirtuel.fr\n\n[srvlan@srvlan:~$] sudo dig SOA srvlan.intra.loupvirtuel.fr\n</code></pre> <p>b ) V\u00e9rifiez ensuite le statut du serveur DHCP Kea :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl status kea-dhcp4-server\n\n[srvlan@srvlan:~$] sudo systemctl status kea-dhcp-ddns-server\n</code></pre> <p>Red\u00e9marrez les VM <code>debian12-vm*</code> et v\u00e9rifiez sur <code>srvlan</code> que le fichier des baux /var/lib/kea/kea-leases4.csv.2 montre \u00e0 pr\u00e9sent le sous-domaine <code>intra.loupvirtuel.fr</code>.</p> <p>c ) Contr\u00f4lez le r\u00e9sultat des pings suivants :</p> <pre><code>[srvlan@srvlan:~$] ping debian12-vm1\n[srvlan@srvlan:~$] ping debian12-vm2.intra.loupvirtuel.fr\n\n[srvlan@srvlan:~$] ping srvlan                              # 127.0.1.1\n[srvlan@srvlan:~$] ping srvlan.intra.loupvirtuel.fr # 192.168.3.1\n\n[srvlan@srvlan:~$] ping ovs\n[srvlan@srvlan:~$] ping ctn1.intra.loupvirtuel.fr\n[srvlan@srvlan:~$] ping ctn2\n\n[srvlan@srvlan:~$] ping intra.loupvirtuel.fr\n\n[srvlan@srvlan:~$] ping loupvirtuel.fr\n[srvlan@srvlan:~$] ping srvdmz.loupvirtuel.fr\n[srvlan@srvlan:~$] ping srvdmz\n\n[srvlan@srvlan:~$] ping www.google.fr\n</code></pre> <p>Tous les pings doivent recevoir une r\u00e9ponse positive.</p> <p>d ) Contr\u00f4lez les IP retourn\u00e9es selon le domaine cibl\u00e9 :</p> <pre><code>[srvlan@srvlan:~$] nslookup intra.loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>Server:   192.168.3.1\nAddress:  192.168.3.1#53\n\nName: intra.loupvirtuel.fr\nAddress: 192.168.3.1\n</code></pre> <pre><code>[srvlan@srvlan:~$] nslookup loupvirtuel.fr\n</code></pre> <p>Retour :</p> <pre><code>Server:       192.168.3.1\nAddress:      192.168.3.1#53\n\nNon-authoritative answer:\nName: loupvirtuel.fr\nAddress: 192.168.4.2\n</code></pre>"},{"location":"blog/dns-split---vboxdeb12/#-cote-clients-debian12-vm","title":"- C\u00f4t\u00e9 clients debian12-vm*","text":"<p>Testez les 2 Cdes suivantes :</p> <pre><code>[client-linux@debian12-vm*:~$] dig SOA www.loupvirtuel.fr\n[client-linux@debian12-vm*:~$] dig SOA www.yahoo.fr \n</code></pre> <p>Retours \u00e0 observer dans la section AUTHORITY : - SOA <code>srvdmz.loupvirtuel.fr</code> pour la premi\u00e8re ligne. - SOA nom-serveur-DNS de Yahoo pour la seconde.</p> <p>Testez \u00e9galement la r\u00e9solution directe et inverse :</p> <pre><code>[client-linux@debian12-vm*:~$] nslookup www.loupvirtuel.fr\n[client-linux@debian12-vm*:~$] nslookup 192.168.4.2  \n</code></pre> <p>- Cde 1, <code>srvlan</code> renvoie l'IP locale de <code>srvweb</code>. - Cde 2, <code>srvlan</code> renvoie l'h\u00f4te <code>srvdmz.loupvirtuel.fr</code>.</p>"},{"location":"blog/dns-split---vboxdeb12/#test-dacces-depuis-internet","title":"Test d'acc\u00e8s depuis Internet","text":"<p>Le domaine <code>loupvirtuel.fr</code> n'\u00e9tant pas public, vous ne pouvez pas acc\u00e9der au site Web depuis Internet en tapant simplement son URL dans le champ adresse d'un navigateur Web.</p> <p>En revanche, vous pouvez simuler un acc\u00e8s Internet depuis le PC h\u00f4te de VirtualBox.</p>"},{"location":"blog/dns-split---vboxdeb12/#-preparation-simulation","title":"- Pr\u00e9paration simulation","text":"<p>L'exemple ci-dessous concerne un PC Windows 10/11.</p> <p>D\u00e9sactivez l'IPv6 et modifiez l'IPv4 du serveur DNS utilis\u00e9 par le PC Windows en rempla\u00e7ant celle-ci par l'IP 192.168.x.w de la carte RED d'IPFire comme suit :</p> <p>a) D\u00e9sactivation du protocole IPv6 : - Clic droit sur le menu Windows 10/11 -&gt; Ex\u00e9cuter -&gt; Entrez ncpa.cpl -&gt; Bouton OK -&gt; S\u00e9lectionnez votre carte r\u00e9seau active -&gt; Clic droit sur celle-ci -&gt; Propri\u00e9t\u00e9s -&gt; D\u00e9cochez Protocole Internet version 6 (TCP/IPv6)</p> <p> </p> Windows : IPv6 \u00e0 d\u00e9sactiver pour la simulation <p>b) Adresse IPv4 du serveur DNS pr\u00e9f\u00e9r\u00e9 \u00e0 utiliser :</p> <p>-&gt; S\u00e9lectionnez Protocole Internet version 4 (TCP/IPv4) -&gt; Bouton Propri\u00e9t\u00e9s -&gt; Serveur DNS pr\u00e9f\u00e9r\u00e9 -&gt; Entrez l'IP 192.168.x.w -&gt; Bouton OK -&gt; Bouton Fermer</p> <p> </p> Windows : IPv4 - DNS pr\u00e9f\u00e9r\u00e9 = 192.168.x.w <p>Vous pouvez \u00e0 pr\u00e9sent effectuer les tests ci-dessous.</p>"},{"location":"blog/dns-split---vboxdeb12/#-test-du-dns-de-srvdmz","title":"- Test du DNS de srvdmz","text":"<p>Depuis l'Invite de commandes du PC Windows, entrez :</p> <pre><code>[C:\\Users\\...&gt;] nslookup loupvirtuel.fr \n</code></pre> <p>Retour :</p> <pre><code>Serveur :   UnKnown\nAddress:  192.168.x.w\n\nNom :    loupvirtuel.fr  # R\u00e9ponse du DNS de srvdmz\nAddress:  192.168.x.w    # IP externe retourn\u00e9e\n</code></pre> <pre><code>[C:\\Users\\...&gt;] nslookup yahoo.fr \n</code></pre> <p>Retour :</p> <pre><code>Serveur :   UnKnown\nAddress:  192.168.x.w\n\n*** UnKnown ne parvient ... yahoo.fr : Query refused\n</code></pre> <pre><code>[C:\\Users\\...&gt;] nslookup intra.loupvirtuel.fr \n</code></pre> <p>Retour :</p> <pre><code>Serveur :   UnKnown\nAddress:  192.168.x.w\n\n*** UnKnown ... intra.loupvirtuel.fr : Non-existe...\n</code></pre> <p>Les 2 derni\u00e8res requ\u00eates sont rejet\u00e9es car, voir plus haut, la r\u00e9cursivit\u00e9 DNS a \u00e9t\u00e9 bloqu\u00e9e pour les requ\u00eates DNS provenant d'Internet, ceci pour raison de s\u00e9curit\u00e9.</p> <p>192.168.x.w = IP carte RED du serveur IPFire.</p>"},{"location":"blog/dns-split---vboxdeb12/#-test-vers-site-web-srvdmz","title":"- Test vers site web srvdmz","text":"<p>Testez depuis le navigateur Web du PC Windows les 2 URL suivantes : <code>http://www.loupvirtuel.fr</code> et <code>http://loupvirtuel.fr</code></p> <p>Toutes les deux doivent basculer vers le protocole https sous r\u00e9serve d'avoir au pr\u00e9alable import\u00e9 le certificat ssl loupvirtuel-ca.pem dans le magasin des autorit\u00e9s g\u00e9r\u00e9es par le navigateur Web (voir m\u00e9mento 8.1).</p> <p>Les autres URL comme par exemple <code>http://google.fr</code> doivent rester sans r\u00e9ponse car la r\u00e9cursivit\u00e9 DNS est bloqu\u00e9e.</p>"},{"location":"blog/dns-split---vboxdeb12/#-test-vers-site-web-srvlan","title":"- Test vers site web srvlan","text":"<p>Possible en utilisant le proxy inverse fourni par Apache.</p> <p>Chargez les modules concernant la fonction de proxy :</p> <pre><code>[srvdmz@srvdmz:~$] sudo a2enmod proxy\n[srvdmz@srvdmz:~$] sudo a2enmod proxy_http \n</code></pre> <p>Editez ensuite le virtualhost du domaine <code>loupvirtuel.fr</code> :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/apache2/sites-available\n[srvdmz@srvdmz:~$] sudo nano loupvirtuel.conf\n</code></pre> <p>et ajoutez la section VirtualHost ci-dessous :</p> <pre><code>&lt;VirtualHost *:80&gt;\nServerName extra.loupvirtuel.fr\n\n&lt;Proxy *&gt;\nOrder deny,allow\nAllow from all\n&lt;/Proxy&gt;\n\nProxyRequests Off\nProxyPreserveHost On\nProxyPass \"/\" \"http://192.168.3.1:80/\"\nProxyPassReverse \"/\" \"http://192.168.3.1:80/\"\n\nErrorLog /var/log/apache2/extra.loupvirtuel.error.log\nCustomLog /var/log/apache2/extra.loupvirtuel.access.log combined\n&lt;/VirtualHost&gt;\n</code></pre> <p>Red\u00e9marrez Apache :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart apache2\n[srvdmz@srvdmz:~$] sudo systemctl status apache2\n</code></pre> <p>Modifiez maintenant le fichier de zone DNS suivant :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/lib/bind\n[srvdmz@srvdmz:~$] sudo nano db.loupvirtuel.fr.directe.externe\n</code></pre> <p>en ajoutant l'enregistrement DNS ci-dessous :</p> <pre><code>extra IN A 192.168.x.w\n</code></pre> <p>192.168.x.w = IP carte RED du serveur IPFire.</p> <p>Pour finir, red\u00e9marrer le serveur DNS :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart bind9\n</code></pre> <p>et testez, depuis le navigateur Web du PC Windows, l'URL <code>http://extra.loupvirtuel.fr</code>.</p> <p>Le retour affich\u00e9 doit \u00eatre l'accueil du site Web de <code>srvlan</code>.</p> <p>Vous pouvez \u00e0 pr\u00e9sent d\u00e9sactiver ou non la r\u00e8gle de pare-feu \"HTTP vers serveur Web zone verte autoris\u00e9\".</p> <p>Enfin, pensez \u00e0 remettre en place sur le PC Windows la configuration initiale IPv4 et IPv6.</p> <p></p> <p>  Voil\u00e0, c'est termin\u00e9 pour le DNS split. Le m\u00e9mento 11.1 vous attend pour mettre en place un serveur de courrier bas\u00e9 sur Postfix.</p> <p>M\u00e9mento 11.1</p>"},{"location":"blog/dns-statique---vboxdeb12/","title":"DNS statique - VBox/Deb12","text":""},{"location":"blog/dns-statique---vboxdeb12/#memento-71-dns-avec-bind-9","title":"M\u00e9mento 7.1 - DNS avec BIND 9","text":"<p>Le service DNS statique reposera sur bind 9 qui sera install\u00e9 sur srvlan pour g\u00e9rer la zone LAN.</p>"},{"location":"blog/dns-statique---vboxdeb12/#preambule","title":"Pr\u00e9ambule","text":"<p>Le service g\u00e9rera un sous-domaine de loupipfire.fr nomm\u00e9 intra.loupipfire.fr. Le nom de ce sous-domaine sera associ\u00e9 aux adresses IP de la zone LAN.</p> <p>La VM srvlan doit conserver son IP fixe 192.168.3.1.</p> <p>Commencez par une MAJ des CTN de la zone LAN :</p> <pre><code>sudo podman exec -it ctn1 ou 2 bash   # Conteneurs rootfull\n# apt update\n# apt upgrade\n# exit\n\npodman exec -it ctn3 bash             # Conteneur rootless\n# apt update\n# apt upgrade\n# exit \n</code></pre> <p>et ensuite celle des VM de la zone LAN :</p> <pre><code>sudo apt update\nsudo apt upgrade\nsudo apt dist-upgrade\nsudo reboot\n</code></pre> <p>VM = Machine virtuelle et CTN = Conteneur Podman</p>"},{"location":"blog/dns-statique---vboxdeb12/#-situation-actuelle-zone-lan","title":"- Situation actuelle zone LAN","text":"<p>a) Une IP fixe et un nom d'h\u00f4te pour chaque VM/CTN. Ex : IP fixe 192.168.3.2 pour l'h\u00f4te debian12-vm1</p> <p>Cde utile pour d\u00e9couvrir les adresses IP :</p> <pre><code>[user@hostname:~$] ip address\n</code></pre> <p>Cdes utiles pour d\u00e9couvrir les noms d'h\u00f4tes :</p> <pre><code>[user@hostname:~$] cat /etc/hostname\n[user@hostname:~$] cat /etc/hosts               # Ligne 127.0.1.1\n</code></pre> <p>b) Une Box Internet d\u00e9clar\u00e9e comme serveur DNS.</p> <p>Cde utile pour d\u00e9couvrir les serveurs DNS exploit\u00e9s :</p> <pre><code>[user@hostname:~$] cat /etc/resolv.conf\n</code></pre> <p>c) Des pings qui \u00e9mis depuis le LAN montrent un retour : - Positif sur un nom de domaine Internet Ex : ping <code>www.google.fr</code></p> <p>- Positif sur leur propre nom d'h\u00f4te Ex : ping debian12-vm1 depuis la VM debian12-vm1</p> <p>- N\u00e9gatif sur les autres noms d'h\u00f4tes de la zone LAN</p> <p>Exemple de retour :</p> <pre><code>client-linux@debian12-vm1:~$ ping srvlan\nping: srvlan: Nom ou service inconnu\nclient-linux@debian12-vm1:~$\n</code></pre> <p>Un serveur DNS local solutionnera le retour n\u00e9gatif.</p>"},{"location":"blog/dns-statique---vboxdeb12/#mise-en-place-du-dns-statique","title":"Mise en place du DNS statique","text":"<p>Le syst\u00e8me fournit bind 9 et unbound soit les 2 serveurs DNS les plus utilis\u00e9s sous Debian.</p> <p>Le choix se portera sur bind 9 qui contrairement \u00e0 unbound peut \u00eatre utilis\u00e9 \u00e0 la fois comme serveur de noms r\u00e9cursif et serveur de noms faisant autorit\u00e9.</p> <p>Un serveur DNS r\u00e9cursif recherchera le r\u00e9sultat d'une requ\u00eate DNS dans son cache ou \u00e0 d\u00e9faut interrogera un serveur DNS faisant autorit\u00e9 pour obtenir le r\u00e9sultat.</p> <p>Un serveur DNS faisant autorit\u00e9 contiendra le r\u00e9sultat, il n'interrogera pas d'autres serveurs et sera l\u2019autorit\u00e9 finale contenant tous les noms d'h\u00f4tes et adresses IP d'une zone donn\u00e9e.</p> <p>Le service DNS sera statique car les donn\u00e9es seront pour l'instant renseign\u00e9es manuellement.</p> <p> </p> DNS : Fonctionnement de la r\u00e9cursion DNS"},{"location":"blog/dns-statique---vboxdeb12/#-installation-de-bind-9","title":"- Installation de bind 9","text":"<p>Installez le paquet bind9 :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install bind9\n</code></pre> <p>et v\u00e9rifiez le d\u00e9marrage de celui-ci :</p> <pre><code>[srvlan@srvlan:~$] systemctl status bind9\n</code></pre> <p>Retour :</p> <pre><code>\u25cf named.service - BIND Domain Name Server\n   Loaded: loaded (/lib/systemd/system/named.ser...\n     Active: active (running) since Thu 2024-01-...\n       Docs: man:named(8)\n   Main PID: 3234 (named)\n     Status: \"running\"\n      Tasks: 4 (limit: 1077)\n     Memory: 33.0M\n        CPU: 87ms\n     CGroup: /system.slice/named.service\n        \u2514\u25003234 /usr/sbin/named -f -u bind\n</code></pre> <p>V\u00e9rifiez son lancement automatique au boot de la VM :</p> <pre><code>[srvlan@srvlan:~$] systemctl is-enabled named\n</code></pre> <p>Retour :</p> <pre><code>enabled\n</code></pre> <p>V\u00e9rifiez la version install\u00e9e :</p> <pre><code>[srvlan@srvlan:~$] sudo named -v\n</code></pre> <p>Retour :</p> <pre><code>BIND 9.18.19...-Debian (Extended Support V...) &lt;id:&gt;\n</code></pre> <p>V\u00e9rifiez l'utilisation des ports TCP/UDP 53 et 953 :</p> <pre><code>[srvlan@srvlan:~$] sudo ss -tulpn | grep named\n</code></pre> <p>Retour partiel :</p> <pre><code>udp UNC... 0 0        192.168.3.1:53   ...\"named\"...      \nudp UNC... 0 0        192.168.2.2:53   ...\"named\"...      \nudp UNC... 0 0          127.0.0.1:53   ...\"named\"...      \nudp UNC... 0 0              [::1]:53   ...\"named\"...      \nudp UNC... 0 0   [fe80::...enp0s3:53   ...\"named\"...     \nudp UNC... 0 0   [fe80::...enp0s8:53   ...\"named\"...      \ntcp LIS... 0 10       192.168.3.1:53   ...\"named\"...      \ntcp LIS... 0 10       192.168.2.2:53   ...\"named\"...      \ntcp LIS... 0 10         127.0.0.1:53   ...\"named\"...      \ntcp LIS... 0 5         127.0.0.1:953   ...\"named\"...      \ntcp LIS... 0 10             [::1]:53   ...\"named\"...      \ntcp LIS... 0 10  [fe80::...enp0s3:53   ...\"named\"...      \ntcp LIS... 0 10  [fe80::...enp0s8:53   ...\"named\"...      \ntcp LIS... 0 5             [::1]:953   ...\"named\"...\n</code></pre> <p>53 = Port DNS TCP/UDP par d\u00e9faut 953 = Port des Cdes rndc pour g\u00e9rer le d\u00e9mon named</p> <p>V\u00e9rifiez l'activation de l'outil associ\u00e9 rndc :</p> <pre><code>[srvlan@srvlan:~$] sudo rndc status \n</code></pre> <p>Retour :</p> <pre><code>version: BIND 9.18...-Debian (Extended Supp...\nrunning on localhost: Linux x86_64 6...-amd...\nboot time: Thu, 11 Jan 2024 12:17:15 GMT\nlast configured: Thu, 11 Jan 2024 12:17:15 GMT\nconfiguration file: /etc/bind/named.conf\nCPUs found: 2\nworker threads: 2\nUDP listeners per interface: 2\nnumber of zones: 102 (97 automatic)\ndebug level: 0\nxfers running: 0\nxfers deferred: 0\nsoa queries in progress: 0\nquery logging is OFF\nrecursive clients: 0/900/1000\ntcp clients: 0/150\nTCP high-water: 0\nserver is up and running\n</code></pre> <p>L'interface en ligne de Cde rndc permet de g\u00e9rer le d\u00e9mon named localement ou \u00e0 distance.</p> <p>Pour finir, observez les fichiers de configuration DNS pr\u00e9sents dans les dossiers suivants :</p> <pre><code>[srvlan@srvlan:~$] ls /etc/bind\n[srvlan@srvlan:~$] ls /var/cache/bind    \n</code></pre>"},{"location":"blog/dns-statique---vboxdeb12/#configuration-de-base","title":"Configuration de base","text":""},{"location":"blog/dns-statique---vboxdeb12/#-ajout-de-zones-de-recherche","title":"- Ajout de zones de recherche","text":"<p>Une zone de recherche directe permet \u00e0 un service DNS interrog\u00e9 de renvoyer une adresse IP associ\u00e9e \u00e0 un nom alors qu'une zone de recherche inverse fera le contraire.</p> <p>Le fichier named.conf.local contient la configuration locale du serveur DNS bind9, vous y d\u00e9clarerez donc les zones de recherche pour intra.loupipfire.fr.</p> <p>Editez le fichier de configuration named.conf.local :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/bind/named.conf.local    \n</code></pre> <p>et ajoutez les lignes suivantes \u00e0 la fin de celui-ci :</p> <pre><code># Zone ou Domaine intra.loupipfire.fr\n# D\u00e9finition des zones de recherche directe et inverse\n# Serveur DNS ma\u00eetre pour le domaine (type)\n# Fichiers de zones associ\u00e9s dans /etc/bind (file)\n# MAJ dynamique des fichiers de zones &gt; none (allow-update)  \n\n# zone de recherche directe\nzone \"intra.loupipfire.fr\" {\ntype master;\nfile \"/etc/bind/db.intra.loupipfire.fr.directe\";\nallow-update { none; };\n};\n\n# zone de recherche inverse\n# Le r\u00e9seau 192.168.3.0 aura pour adresse inverse \n# 3.168.192.in-addr.arpa \nzone \"3.168.192.in-addr.arpa\" {\ntype master;\nfile \"/etc/bind/db.intra.loupipfire.fr.inverse\";\nallow-update { none; };\n};    \n</code></pre>"},{"location":"blog/dns-statique---vboxdeb12/#-configuration-des-zones","title":"- Configuration des zones","text":"<p>Les fichiers de zones de recherche contiendront les directives et enregistrements de ressources pour le domaine intra.loupipfire.fr.</p> <p>Cr\u00e9ez le fichier pour la zone directe :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/bind\n[srvlan@srvlan:~$] sudo nano db.intra.loupipfire.fr.directe    \n</code></pre> <p>et ins\u00e9rez les lignes suivantes :</p> <pre><code>;\n; DNS - Fichier de zone pour la r\u00e9solution directe\n;\n$TTL 86400\n@   IN   SOA   srvlan.intra.loupipfire.fr. root.intra.loupipfire.fr. (\n1                             ; Serial\n604800                  ; Refresh - 1w (1 semaine)\n84600                    ; Retry - 1d (1 jour)\n2419200               ; Expire - 4w \n604800 )               ; Negative Cache TTL - 1w\n;\n@       IN     NS     srvlan.intra.loupipfire.fr.\nsrvlan       IN     A     192.168.3.1\novs       IN     A     192.168.3.15\ndebian12-vm1       IN     A     192.168.3.2\ndebian12-vm2       IN     A     192.168.3.4\nctn1       IN     A     192.168.3.6\nctn2       IN     A     192.168.3.8    \n</code></pre> <p>- D\u00e9tail des param\u00e8tres - a) Directives SOA (Start of Authority) :</p> @ Repr\u00e9sente le nom de domaine de la zone soit intra.loupipfire.fr IN SOA D\u00e9signe srvlan comme autorit\u00e9 pour la zone intra.loupipfire.fr 1 N\u00b0 de s\u00e9rie du fichier, \u00e0 changer \u00e0 chaque modification de celui-ci 604800 Un DNS esclave attendra 1w avant de rafraichir ses donn\u00e9es 84600 Si \u00e9chec, il r\u00e9essaiera 1d apr\u00e8s 2419200 Si \u00e9chec durant 4w, il cessera de r\u00e9pondre en tant qu'autorit\u00e9 604800 Mise en cache des r\u00e9ponses n\u00e9gatives durant 1w <p>Le n\u00b0 de s\u00e9rie peut \u00eatre une date suivie d'un n\u00b0 d'ordre : Ex : AAAAMMJJxx</p> <p>b) Enregistrements de type NS et A :</p> IN NS Indique le nom du serveur DNS pour la zone IN A Relie un nom d\u2019h\u00f4te (domaine - s/domaine) \u00e0 une adresse IPv4 <p>Cr\u00e9ez maintenant le fichier pour la zone inverse :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/bind\n[srvlan@srvlan:~$] sudo nano db.intra.loupipfire.fr.inverse    \n</code></pre> <p>et ins\u00e9rez les lignes suivantes :</p> <pre><code>;\n;  DNS - Fichier de zone pour la r\u00e9solution inverse\n;\n$TTL 86400\n@   IN   SOA   srvlan.intra.loupipfire.fr. root.intra.loupipfire.fr. (\n1\n1w\n1d\n4w\n1w )\n;\n@       IN     NS     srvlan.intra.loupipfire.fr.\n1       IN     PTR     srvlan.intra.loupipfire.fr.\n15       IN     PTR     ovs.intra.loupipfire.fr. \n2       IN     PTR     debian12-vm1.intra.loupipfire.fr. \n4       IN     PTR     debian12-vm2.intra.loupipfire.fr.\n6       IN     PTR     ctn1.intra.loupipfire.fr.\n8       IN     PTR     ctn2.intra.loupipfire.fr.    \n</code></pre> <p>- D\u00e9tail des param\u00e8tres - a) Directives SOA (Start of Authority) : Idem fichier de zone pour la r\u00e9solution directe.</p> <p>b) Enregistrements de type PTR :</p> IN PTR Relie une adresse IP \u00e0 un nom d'h\u00f4te <p>Nota</p> <p>Le conteneur s\u00e9curis\u00e9 rootless ctn3 n'a pas \u00e9t\u00e9 trait\u00e9, le service r\u00e9seau slirp4netns qui lui est associ\u00e9 manque de certaines fonctionnalit\u00e9s notamment celle de ne pas donner au conteneur une adresse IP routable.</p>"},{"location":"blog/dns-statique---vboxdeb12/#-mise-a-jour-de-bind-9","title":"- Mise \u00e0 jour de Bind 9","text":"<p>Red\u00e9marrez le service DNS :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart bind9    \n</code></pre>"},{"location":"blog/dns-statique---vboxdeb12/#configuration-finale-et-tests","title":"Configuration finale et tests","text":""},{"location":"blog/dns-statique---vboxdeb12/#-refonte-fichier-hosts","title":"- Refonte fichier hosts","text":"<p>Editez le fichier DNS hosts :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/hosts    \n</code></pre> <p>et ajoutez le FQDN de srvlan (nom d'h\u00f4te + nom de domaine) comme suit :</p> <pre><code>127.0.0.1        localhost\n127.0.1.1        srvlan\n192.168.3.1    srvlan.intra.loupipfire.fr srvlan   \n</code></pre> <p>Ce fichier est consult\u00e9 avant l'acc\u00e8s au serveur bind et peut donc \u00eatre utilis\u00e9 pour un minimum de r\u00e9solution de noms en cas de panne du serveur DNS.</p> <p>N'effacez pas le groupe de lignes d\u00e9di\u00e9 \u00e0 l'IPv6.</p>"},{"location":"blog/dns-statique---vboxdeb12/#-refonte-fichier-resolvconf","title":"- Refonte fichier resolv.conf","text":"<p>Vous allez modifier ce fichier actuellement trait\u00e9 dynamiquement par l'outil NetworkManager et qui indique \u00e0 srvlan quel serveur DNS interroger.</p> <p>Faites un clic droit sur l'applet r\u00e9seau NetworkManager : -&gt; Modifier les connexions...</p> <p>Une fen\u00eatre Connexions r\u00e9seau s'ouvre : -&gt; S\u00e9lectionnez la Connexion carte 2 -&gt; Cliquez sur la roue dent\u00e9e situ\u00e9e en bas \u00e0 gauche</p> <p>Une fen\u00eatre Modification de la Connexion ... s'ouvre : -&gt; Onglet Param\u00e8tres IPv4</p> <p>Modifiez ensuite la valeur des champs suivants : -&gt; Serveurs DNS &gt; 192.168.3.1 -&gt; Domaines de recherche &gt; intra.loupipfire.fr -&gt; Bouton Enregistrer -&gt; Authentifiez-vous si une demande est affich\u00e9e</p> <p>Modifiez ensuite la Connexion carte 1 en effa\u00e7ant le contenu du champ Serveurs DNS.</p> <p>Puis red\u00e9marrez le r\u00e9seau pour une MAJ des nouveaux param\u00e8tres nameserver et search :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart NetworkManager  \n</code></pre> <p>Affichez pour finir le contenu du fichier resolv.conf :</p> <pre><code>[srvlan@srvlan:~$] cat /etc/resolv.conf \n</code></pre> <p>qui doit montrer ceci :</p> <pre><code># Generated by NetworkManager\nsearch intra.loupipfire.fr\nnameserver 192.168.3.1\n</code></pre>"},{"location":"blog/dns-statique---vboxdeb12/#-tests-du-dns-depuis-srvlan","title":"- Tests du DNS depuis srvlan","text":"<p>a) V\u00e9rifiez la syntaxe du fichier /etc/bind/named.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo named-checkconf \n</code></pre> <p>Sont inclus dans la v\u00e9rification les fichiers DNS : - named.conf.options - named.conf.local - named.conf.default-zones Aucune erreur ne sera retourn\u00e9e en cas de r\u00e9sultat OK.</p> <p>b) V\u00e9rifiez la validit\u00e9 du fichier de zone directe :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/bind\n\n[srvlan@srvlan:~$] sudo named-checkzone -d intra.loupipfire.fr db.intra.loupipfire.fr.directe \n</code></pre> <p>La Cde retourne normalement :</p> <pre><code>loading \"intra.loupipfire.fr\" from \"db.intra.loupipfire.fr.directe\" class \"IN\"\nzone intra.loupipfire.fr/IN: loaded serial 1\nOK \n</code></pre> <p>c) V\u00e9rifiez la validit\u00e9 du fichier de zone inverse :</p> <pre><code>[srlan@srvlan:~$] sudo named-checkzone -d 3.168.192.in-addr.arpa  db.intra.loupipfire.fr.inverse   \n</code></pre> <p>La Cde retourne normalement :</p> <pre><code>loading \"3.168.192.in-addr.arpa\" from \"db.intra.loupipfire.fr.inverse\" class \"IN\"\nzone 3.168.192.in-addr.arpa/IN: loaded serial 1\nOK\n</code></pre> <p>d) Testez les outils de v\u00e9rification host et dig : Ceux-ci peuvent aider \u00e0 d\u00e9tecter des probl\u00e8mes dans la r\u00e9solution de noms.</p> <p>La Cde host est incluse dans le paquet bind9-host install\u00e9 de base :</p> <pre><code>[srvlan@srvlan:~$] sudo host -v srvlan.intra.loupipfire.fr  \n</code></pre> <p>Celle-ci retourne normalement :</p> <pre><code>Trying \"srvlan.intra.loupipfire.fr\"\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 9400\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;srvlan.intra.loupipfire.fr. IN A\n\n;; ANSWER SECTION:\nsrvlan.intra.loupipfire.fr. 86400 IN A 192.168.3.1\n\nReceived 60 bytes from 192.168.3.1#53 in 16 ms\nTrying \"srvlan.intra.loupipfire.fr\"\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 64294\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;srvlan.intra.loupipfire.fr. IN AAAA\n\n;; AUTHORITY SECTION:\nintra.loupipfire.fr. 86400 IN SOA srvlan.intra.loupipfire.fr. root.intra.loupipfire.fr. 1 604800 84600 2419200 604800\n\nReceived 85 bytes from 192.168.3.1#53 in 0 ms\nTrying \"srvlan.intra.loupipfire.fr\"\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 51406\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;srvlan.intra.loupipfire.fr IN MX\n\n;; AUTHORITY SECTION:\nintra.loupipfire.fr. 86400 IN SOA srvlan.intra.loupipfire.fr. root.intra.loupipfire.fr. 1 604800 84600 2419200 604800\n\nReceived 85 bytes from 192.168.3.1#53 in 0 ms\n</code></pre> <p>La Cde dig est incluse dans le paquet bind9-dnsutils install\u00e9 de base :</p> <pre><code>[srvlan@srvlan:~$] sudo dig SOA srvlan.intra.loupipfire.fr  \n</code></pre> <p>Celle-ci retourne normalement :</p> <pre><code>; &lt;&lt;&gt;&gt; DiG 9.18.19-1~deb12u1-Debian &lt;&lt;&gt;&gt; SOA srvlan.intra.loupipfire.fr\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26365\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: ce938125a123e1bd0100000065a1... (good)\n;; QUESTION SECTION:\n;srvlan.intra.loupipfire.fr. IN SOA\n\n;; AUTHORITY SECTION:\nintra.loupipfire.fr. 86400 IN SOA srvlan.intra.loupipfire.fr. root.intra.loupipfire.fr. 1 604800 84600 2419200 604800\n\n;; Query time: 0 msec\n;; SERVER: 192.168.3.1#53(192.168.3.1) (UDP)\n;; WHEN: Fri Jan 12 17:26:23 CET 2024\n;; MSG SIZE  rcvd: 124  \n</code></pre> <p>e) Testez la r\u00e9solution DNS interne et externe :</p> <pre><code>[srvlan@srvlan:~$] ping debian12-vm1\n[srvlan@srvlan:~$] ping debian12-vm2.intra.loupipfire.fr\n[srvlan@srvlan:~$] ping srvlan\n[srvlan@srvlan:~$] ping srvlan.intra.loupipfire.fr\n[srvlan@srvlan:~$] ping ctn2\n[srvlan@srvlan:~$] ping lemonde.fr  \n</code></pre> <p>Le ping srvlan renvoie 127.0.1.1. Le ping srvlan.intra.loupipfire.fr renvoie 192.168.3.1.</p> <p>f) Pour finir, v\u00e9rifiez le chargement des zones :</p> <pre><code>sudo named-checkconf -z   # Liste des zones charg\u00e9es \n</code></pre>"},{"location":"blog/dns-statique---vboxdeb12/#dns-externe","title":"D\u00e9claration d'un DNS externe","text":"<p>Le DNS utilise 13 destinations de serveurs racines pour g\u00e9rer les requ\u00eates d'acc\u00e8s \u00e0 Internet. Ces serveurs sont charg\u00e9s de renvoyer lesdites requ\u00eates vers des serveurs DNS de premier niveau appropri\u00e9s (.com, .fr, etc...).</p> <p>Le r\u00e9solveur bind9 exploite par d\u00e9faut le fichier /usr/share/dns/root.hints pour interroger ces serveurs racines (adresses de a.root-servers.net \u00e0 m.root-servers.net) et obtenir les r\u00e9ponses aux requ\u00eates d'acc\u00e8s \u00e0 Internet.</p> <p>Actuellement bind9 traite les requ\u00eates locales (Ex : ping debian12-vm1.intra.loupipfire.fr) ainsi que les requ\u00eates d'acc\u00e8s \u00e0 Internet (Ex : ping lemonde.fr) et construit son cache en fonction.</p> <p>Test d'une requ\u00eate locale :</p> <pre><code>[srvlan@srvlan:~$] nslookup ovs.intra.loupipfire.fr \n</code></pre> <p>Retour :</p> <pre><code>Server: 192.168.3.1 (IP serveur DNS soit srvlan)\nAddress:    192.168.3.1#53\n\nName: ovs.intra.loupipfire.fr\nAddress: 192.168.3.15\n</code></pre> <p>La VM srvlan est l'autorit\u00e9 pour la r\u00e9ponse.</p> <p>Test d'une requ\u00eate d'acc\u00e8s \u00e0 Internet :</p> <pre><code>[srvlan@srvlan:~$] nslookup mappy.fr\n</code></pre> <p>Retour :</p> <pre><code>Server:     192.168.3.1 (IP serveur DNS soit srvlan)\nAddress:    192.168.3.1#53\n\nNon-authoritative answer:\nName:    mappy.fr\nAddress: 193.203.32.57\n</code></pre> <p>Constat, srvlan n'est plus l'autorit\u00e9 pour la r\u00e9ponse.</p> <p>Vous allez \u00e0 pr\u00e9sent, pour all\u00e9ger le travail de srvlan, demander que les requ\u00eates d'acc\u00e8s \u00e0 Internet (les demandes de r\u00e9solutions externes) soient dor\u00e9navant trait\u00e9es par les serveurs DNS de Google.</p> <p>Editez pour cela le fichier DNS named.conf.options :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/bind/named.conf.options\n</code></pre> <p>et modifiez celui-ci afin qu'il contienne ces lignes :</p> <pre><code>options {\n     directory \"/var/cache/bind\";\n\n     dnssec-validation auto;      \n\n     // Limiter les r\u00e9ponses r\u00e9cursives aux\n     // r\u00e9seaux/IP des interfaces du serveur DNS srvlan\n     allow-recursion { localnets; }; \n\n     // Pour les autres r\u00e9seaux/IP,\n     // transfert des requ\u00eates DNS vers Internet.\n     // Adresses IPv4 des serveurs DNS de Google.\n     forward only;\n     forwarders { 8.8.8.8; 8.8.4.4; }; \n\n     listen-on-v6 { any; };\n};    \n</code></pre> <p>Red\u00e9marrez maintenant le service bind9 :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart bind9 \n</code></pre> <p>et testez une requ\u00eate d'acc\u00e8s \u00e0 Internet :</p> <pre><code>[srvlan@srvlan:~$] nslookup yahoo.fr \n</code></pre> <p>Retour :</p> <pre><code>Server: 192.168.3.1\nAddress: 192.168.3.1#53\n\nNon-authoritative answer:\nName: yahoo.fr\nAddress: 44.228.206.170\nName: yahoo.fr\nAddress: 34.213.101.254\nName: yahoo.fr\nAddress: 13.50.184.192\nName: yahoo.fr\nAddress: 13.251.69.97\n...\n</code></pre> <p>La r\u00e9solution externe se fait toujours mais utilisez-vous les DNS de Google ?</p> <p>Pour le savoir, remplacez les IP du param\u00e8tre forwarders par des IP quelconques, red\u00e9marrez le service bind9 afin de vider le cache DNS actif et relancez la requ\u00eate :</p> <pre><code>[srvlan@srvlan:~$] nslookup yahoo.fr  \n</code></pre> <p>Retour :</p> <pre><code>;; communications error to 192.168.3.1#53: timed out\nServer: 192.168.3.1\nAddress: 192.168.3.1#53\n\n** server can't find yahoo.fr: SERVFAIL \n</code></pre> <p>La r\u00e9solution externe ne fonctionne plus, vous utilisiez bien les DNS de Google.</p> <p>Remettez maintenant les bonnes adresses IP er red\u00e9marrez le service bind9.</p>"},{"location":"blog/dns-statique---vboxdeb12/#tests-dns-depuis-les-vmctn","title":"Tests DNS depuis les VM/CTN","text":""},{"location":"blog/dns-statique---vboxdeb12/#-vm-ovs-et-ctn-ctn1ctn2","title":"- VM ovs et CTN ctn1/ctn2","text":"<p>Se connecter en SSH sur la VM ovs (voir M\u00e9mento 6.1).</p> <p>Editez ensuite son fichier DNS resolv.conf :</p> <pre><code>[switch@ovs:~$] sudo nano /etc/resolv.conf  \n</code></pre> <p>et remplacez le contenu existant par celui-ci :</p> <pre><code># Fichier resolv.conf - Client DNS\n\n# Nom du domaine local\ndomain intra.loupipfire.fr \n\n# Ajout auto du nom de domaine local aux\n# noms d'h\u00f4tes non pleinement qualifi\u00e9s\nsearch intra.loupipfire.fr\n\n# Adresses IP du ou des serveurs DNS \u00e0 interroger\nnameserver 192.168.3.1  \n</code></pre> <p>Rebootez la VM :</p> <pre><code>[switch@ovs:~$] sudo reboot \n</code></pre> <p>Puis, utilisez cette Cde pour interagir avec ctn1/ctn2 :</p> <pre><code>[switch@ovs:~$] sudo podman exec -it ctn1 ou 2 bash \n</code></pre> <p>et contr\u00f4lez le contenu des 2 fichiers resolv.conf qui doivent montrer ceci :</p> <pre><code>search intra.loupipfire.fr\nnameserver 192.168.3.1 \n</code></pre> <p>Celui-ci a \u00e9t\u00e9 mis \u00e0 jour automatiquement lors de la reconstruction des 2 conteneurs Podman.</p> <p>V\u00e9rifiez l'ID du Name Server pour intra.loupipfire.fr :</p> <pre><code>[switch@ovs:~$] dig NS intra.loupipfire.fr +short  \n</code></pre> <p>Retour :</p> <pre><code>srvlan.intra.loupipfire.fr.  \n</code></pre> <p>Pour finir, depuis les 3 syst\u00e8mes, pinguez les VM suivantes et observez les FQDN retourn\u00e9s :</p> <pre><code>ping srvlan\nping debian12-vm1.intra.loupipfire.fr\nping debian12-vm2  \n</code></pre> <p>FQDN = nom_h\u00f4te.nom_domaine</p>"},{"location":"blog/dns-statique---vboxdeb12/#vm-debian","title":"- VM debian12-vm*","text":"<p>Idem srvlan.</p> <p>Faites un clic droit sur l'applet r\u00e9seau NetworkManager : -&gt; Modifier les connexions...</p> <p>Une fen\u00eatre Connexions r\u00e9seau s'ouvre : -&gt; S\u00e9lectionnez la connexion r\u00e9seau affich\u00e9e -&gt; Cliquez sur la roue dent\u00e9e situ\u00e9e en bas \u00e0 gauche</p> <p>Une fen\u00eatre Modification de la Connexion ... s'ouvre : -&gt; Onglet Param\u00e8tres IPv4</p> <p>Modifiez ensuite la valeur des champs suivants : -&gt; Serveurs DNS &gt; 192.168.3.1 -&gt; Domaines de recherche &gt; intra.loupipfire.fr -&gt; Bouton Enregistrer -&gt; Authentifiez-vous si une demande est affich\u00e9e</p> <p>Puis effectuez une MAJ des param\u00e8tres nameserver et search du fichier DNS /etc/resolv.conf :</p> <pre><code>[client-linux@debian12-vm*:~$] sudo systemctl restart NetworkManager\n</code></pre> <p>Installez le paquet incluant la Cde DNS nslookup :</p> <pre><code>[client-linux@debian12-vm*:~$]  sudo apt install dnsutils\n</code></pre> <p>et v\u00e9rifiez l'IP du Name Server pour intra.loupipfire.fr :</p> <pre><code>[client-linux@debian12-vm*:~$] nslookup ovs.intra.loupipfire.fr\n</code></pre> <p>Retour :</p> <pre><code>Server: 192.168.3.1\nAddress: 192.168.3.1#53\n\nName: ovs.intra.loupipfire.fr\nAddress: 192.168.3.15\n</code></pre> <p>Pinguez les VM suivantes et observez les FQDN retourn\u00e9s :</p> <pre><code>[client-linux@debian12-vm*:~$] ping srvlan.intra.loupipfire.fr\n[client-linux@debian12-vm*:~$] ping ovs\n</code></pre> <p>Pour terminer, lancez le navigateur Web et v\u00e9rifiez le bon acc\u00e8s \u00e0 Internet.</p>"},{"location":"blog/dns-statique---vboxdeb12/#simulation-de-panne","title":"Simulation de panne","text":"<p>Arr\u00eatez le service DNS fourni par srvlan :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl stop bind9\n</code></pre> <p>Red\u00e9marrez les clients debian12-vm* et ovs afin de vider leurs caches DNS.</p> <p>Les pings du \u00a7 VM debian12-vm* lanc\u00e9s depuis les VM debian12-vm* devraient \u00e9chouer.</p> <p>Red\u00e9marrez le service DNS et v\u00e9rifiez que les pings fonctionnent \u00e0 nouveau.</p> <p></p> <p>  Voil\u00e0, c'est fini pour le DNS statique. Le m\u00e9mento 7.2 vous attend \u00e0 pr\u00e9sent pour installer un serveur DHCP.</p> <p>M\u00e9mento 7.2</p>"},{"location":"blog/e-mail---vboxdeb12-13/","title":"E-mail - VBox/Deb12 1/3","text":""},{"location":"blog/e-mail---vboxdeb12-13/#memento-111-postfixdovecot","title":"M\u00e9mento 11.1 - Postfix/Dovecot","text":"<p>Le serveur de courrier sera install\u00e9 sur <code>srvdmz</code>.</p> <p>Il sera fait appel aux logiciels Postfix, Dovecot, Mail et PostfixAdmin ainsi qu'aux outils de s\u00e9curit\u00e9 tels SSL/TLS, SASL, HTTPS, SPF, DKIM et DMARC.</p> <p>Postfix utilisera un service de relais SMTP pour optimiser la d\u00e9livrabilit\u00e9 des e-mails et \u00e9viter que ceux-ci soient marqu\u00e9s comme SPAM par les destinataires.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#preambule","title":"Pr\u00e9ambule","text":"<p>Documentation de Postfix en fran\u00e7ais sur cette page.</p> <p>Noms d'h\u00f4te et de domaine actifs sur la VM <code>srvdmz</code> : <code>srvdmz</code> et <code>loupvirtuel.fr</code></p> <p>V\u00e9rifiez \u00e0 l'aide des Cdes suivantes :</p> <pre><code>[srvdmz@srvdmz:~$] hostname\n[srvdmz@srvdmz:~$] hostname -d  \n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-role-du-serveur-de-courrier","title":"- R\u00f4le du serveur de courrier","text":"<p>Il consiste tout simplement \u00e0 transmettre des messages \u00e9lectroniques ou e-mails.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-principe-de-fonctionnement","title":"- Principe de fonctionnement","text":"<p>Le traitement du courrier respecte les \u00e9tapes suivantes :</p> <p>1) D\u00e9part depuis le client e-mail MUA de l'exp\u00e9diteur -&gt; Un serveur d'envoi MTA (SMTP)</p> <p>2) Acheminement au travers d'un ou plusieurs MTA -&gt; Un serveur de r\u00e9ception MDA (POP/IMAP)</p> <p>3) Demande de rel\u00e8ve depuis le MUA du destinataire -&gt; Le serveur de r\u00e9ception MDA</p> <p>4) Acheminement final depuis le MDA -&gt; Le MUA du destinataire</p> <p>Le MUA (Mail User Agent) ou client e-mail s'occupe d'\u00e9mettre et relever le courrier.</p> <p>Le MTA (Mail Transfer Agent) g\u00e8re le transfert du courrier \u00e9mis jusqu'\u00e0 sa destination.</p> <p>Le MDA (Mail Delivery Agent) stocke le courrier re\u00e7u en attendant une rel\u00e8ve par le destinataire.</p> <p>Le protocole SMTP est utilis\u00e9 par les MUA et MTA pour envoyer le courrier \u00e0 destination.</p> <p>Les protocoles POP/IMAP le sont par les MDA et MUA pour relever le courrier.</p> <p>Liste des logiciels auxquels vous ferez appel : - Le trio apache + php + mysql d\u00e9j\u00e0 pr\u00e9sent sur <code>srvdmz</code>. - postfix comme MTA ou serveur SMTP. - postfixadmin comme interface Web d'administration. - dovecot comme MDA ou serveur POP/IMAP. - mail comme MUA en mode console. - thunderbird comme MUA en mode graphique.</p> <p>Vous l'aurez compris, la mise en place d'un serveur de courrier est relativement compliqu\u00e9e.</p> <p>Sch\u00e9ma r\u00e9capitulant l'envoi d'un courrier :</p> <p></p>"},{"location":"blog/e-mail---vboxdeb12-13/#installation","title":"Installation","text":""},{"location":"blog/e-mail---vboxdeb12-13/#-postfix-mtasmtp","title":"- Postfix (MTA/SMTP)","text":"<p>Au pr\u00e9alable, mettez \u00e0 jour la distribution Debian :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt update\n[srvdmz@srvdmz:~$] sudo apt upgrade\n[srvdmz@srvdmz:~$] sudo reboot\n[srvdmz@srvdmz:~$] sudo apt autoremove --purge  \n</code></pre> <p>et installez le paquet postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install postfix  \n</code></pre> <p>Une fen\u00eatre Postfix Configuration s'ouvre : -&gt; OK -&gt; S\u00e9lectionnez Site Internet -&gt; OK -&gt; OK -&gt; Nom du courrier -&gt; Entrez <code>loupvirtuel.fr</code> -&gt; OK</p> <p>Editez ensuite son fichier de configuration main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf  \n</code></pre> <p>V\u00e9rifiez les valeurs des param\u00e8tres ci-dessous :</p> <pre><code>myhostname = srvdmz.loupvirtuel.fr\n\nmydestination = $myhostname, loupvirtuel.fr, srvdmz.loupvirtuel.fr, localhost.loupvirtuel.fr, localhost  \n</code></pre> <p>- myhostname = Nom FQDN du serveur Postfix. - mydestination = Liste des domaines livr\u00e9s localement. - $myhostname = Valeur de myhostname.</p> <p>et d\u00e9commentez la ligne suivante :</p> <pre><code>myorigin = /etc/mailname       # Domaine sortant valide \n</code></pre> <p>- myorigin = Contenu de mailname soit <code>loupvirtuel.fr</code>.</p> <p>Testez par s\u00e9curit\u00e9 la bonne configuration de Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo postfix check  \n</code></pre> <p>Si OK, aucun retour.</p> <p>Red\u00e9marrez Postix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix  \n</code></pre> <p>et testez une connexion sur celui-ci avec la Cde telnet :</p> <pre><code>[srvdmz@srvdmz:~$]  telnet localhost 25   # 25 = port SMTP  \n</code></pre> <p>Retour observ\u00e9 :</p> <pre><code>Trying ::1...\nConnected to localhost.\nEscape character is '^]'.\n220 srvdmz.loupvirtuel.fr ESMTP Postfix (Debian/GNU)\n</code></pre> <p>Puis touches Ctrl droite + AltGr + ] -&gt; prompt -&gt; quit</p> <p>Nota</p> <p>L'installation a g\u00e9n\u00e9r\u00e9 un utilisateur <code>postfix</code> et un groupe de m\u00eame nom sur <code>srvdmz</code>.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#dovecot","title":"- Dovecot (MDA/POP-IMAP)","text":"<p>Installez les paquets dovecot suivants :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install dovecot-mysql dovecot-imapd dovecot-pop3d \n</code></pre> <p>Etendez ensuite les possibilit\u00e9s de filtrage du courrier entrant en installant le plugin sieve :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install dovecot-managesieved\n</code></pre> <p>Les filtres fournis par le plugin permettront de traiter un courrier entrant en fonction d\u2019un certain nombre de r\u00e8gles (scripts) d\u00e9finies par le destinataire.</p> <p>Les r\u00e8gles seront enregistr\u00e9es et trait\u00e9es sur le serveur.</p> <p>Le plugin permettra entre autres de g\u00e9rer de la r\u00e9ponse automatique en cas d'absence, de r\u00e9exp\u00e9dier des courriers d\u00e8s leur r\u00e9ception sur le serveur, etc...</p> <p>Les r\u00e8gles sont g\u00e9n\u00e9ralement d\u00e9finies via des interfaces de gestion respectant le protocole de filtrage telles que celles fournies par les plugins Sieve de Thunderbird, RoundCube et Rainloop.</p> <p>Activez maintenant la prise en compte du plugin :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart dovecot\n</code></pre> <p>et testez une connexion POP sur Dovecot :</p> <pre><code>[srvdmz@srvdmz:~$] telnet localhost 110   # 110 = port POP3\n</code></pre> <p>Retour observ\u00e9 :</p> <pre><code>Trying ::1...\nConnected to localhost.\nEscape character is '^]'.\n+OK Dovecot (Debian) ready.\n</code></pre> <p>Puis touches Ctrl droite + AltGr + ] -&gt; prompt -&gt; quit</p> <p>Testez \u00e9galement le r\u00e9sultat d'une connexion IMAP :</p> <pre><code>[srvdmz@srvdmz:~$] telnet localhost 143   # 143 = port IMAP4\n</code></pre> <p>Nota</p> <p>L'installation a g\u00e9n\u00e9r\u00e9 un utilisateur <code>dovecot</code> et un groupe de m\u00eame nom sur <code>srvdmz</code>.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-mail-mua-mode-console","title":"- Mail (MUA - mode console)","text":"<p>Installez le paquet mailutils :</p> <pre><code>[srvdmz@srvdmz:~$]  sudo apt install mailutils\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#dns-et-redirection-de-mails","title":"DNS et redirection d'e-mails","text":""},{"location":"blog/e-mail---vboxdeb12-13/#-dns-enregistrement-mx","title":"- DNS (enregistrement MX)","text":"<p>Vous allez ajouter un enregistrement de type MX (Mail eXchanger) qui associera le domaine <code>loupvirtuel.fr</code> au serveur de courrier install\u00e9 sur <code>srvdmz</code>.</p> <p>Cet enregistrement permettra de d\u00e9terminer vers quel serveur un courrier doit \u00eatre achemin\u00e9 lorsque le protocole SMTP est utilis\u00e9, ceci en associant la partie \u00e0 droite de l'@ des adresses e-mail au serveur de courrier.</p> <p>Vous en ajouterez aussi de type CNAME (alias) pour les serveurs SMTP (Postfix) et POP/IMAP (Dovecot).</p> <p>Editez pour cela le fichier DNS db.loupvirtuel.fr.directe :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/lib/bind\n[srvdmz@srvdmz:~$] sudo nano db.loupvirtuel.fr.directe\n</code></pre> <p>et ajoutez ceci juste avant www IN CNAME srvdmz :</p> <pre><code>@     IN   MX 10   srvdmz.loupvirtuel.fr.\nsmtp  IN   CNAME   srvdmz\npop   IN   CNAME   srvdmz\nimap  IN   CNAME   srvdmz\n</code></pre> <p>Faites de m\u00eame avec db.loupvirtuel.fr.directe.externe.</p> <p>Red\u00e9marrez les services DNS et Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart bind9\n[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre> <p>ainsi que le service DNS sur <code>srvlan</code>.</p> <p>Puis testez le bon fonctionnement du DNS comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] ping smtp.loupvirtuel.fr\n[srvdmz@srvdmz:~$] ping pop.loupvirtuel.fr\n[srvdmz@srvdmz:~$] ping imap.loupvirtuel.fr\n[srvdmz@srvdmz:~$] dig mx loupvirtuel.fr\n</code></pre> <p> </p> Postfix : Retour de la Cde dig mx loupvirtuel.fr <p>Les 4 Cdes ci-dessus doivent fonctionner depuis <code>srvlan</code>.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-redirection-de-mails-root","title":"- Redirection d'e-mails (root)","text":"<p>La redirection des courriers se g\u00e8re depuis le fichier Bdd /etc/aliases.db qui peut \u00eatre mis \u00e0 jour depuis le ficher texte /etc/aliases.</p> <p>Editez ce dernier :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/aliases\n</code></pre> <p>et redirigez le courrier adress\u00e9 \u00e0 root en ajoutant ceci :</p> <pre><code>root: srvdmz\n</code></pre> <p><code>srvdmz</code> \u00e9tant l'utilisateur principal du serveur de courrier de nom d'h\u00f4te <code>srvdmz.loupvirtuel.fr</code>.</p> <p>Terminez en mettant \u00e0 jour le fichier Bdd aliases.db :</p> <pre><code>[srvdmz@srvdmz:~$] sudo newaliases\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#test-denvoi-et-de-reception","title":"Test d'envoi et de r\u00e9ception","text":"<p>Dans l'imm\u00e9diat, l'envoi d'un courrier vers un utilisateur quelconque tel <code>clientmail-vm1</code> n\u00e9cessite la cr\u00e9ation de celui-ci comme utilisateur local sur l'h\u00f4te <code>srvdmz</code>.</p> <p>Cr\u00e9ez donc un utilisateur local UNIX <code>clientmail-vm1</code>:</p> <pre><code>[srvdmz@srvdmz:~$] sudo adduser clientmail-vm1\n</code></pre> <p>Puis envoyez un courrier de <code>root</code> vers <code>clientmail-vm1</code>:</p> <pre><code>srvdmz@srvdmz:~$] su root\n\n[root@srvdmz:~$]  mail clientmail-vm1@loupvirtuel.fr\nCc: # appuyez sur Entr\u00e9e\nSubject: Test d'envoi depuis root # et appuyez sur Entr\u00e9e\nTexte de mon premier courrier. Fin. # et appuyez sur Entr\u00e9e\nCTRL+D # signifie Envoyer et quitter\n[root@srvdmz:~$] exit\n</code></pre> <p>et v\u00e9rifiez la cr\u00e9ation dans /var/mail d'un fichier clientmail-vm1 stockant le contenu du courrier :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/mail\n[srvdmz@srvdmz:~$] sudo cat clientmail-vm1\n</code></pre> <p>Connectez-vous maintenant en tant que <code>clientmail-vm1</code> et lancez le MUA mail :</p> <pre><code>[srvdmz@srvdmz:~$] su clientmail-vm1\n\n[clientmail-vm1@srvdmz:~$] mail\n</code></pre> <p>Relevez ensuite le courrier avec la Cde t 1 suivie de quit :</p> <p> </p> Postfix : Rel\u00e8ve de l'e-mail n\u00b01 <p>Reconnectez-vous en tant que <code>srvdmz</code> avec la Cde exit et v\u00e9rifiez la cr\u00e9ation dans /home/clientmail-vm1 d'un fichier mbox stockant le contenu du courrier relev\u00e9.</p> <p>V\u00e9rifiez le vidage cons\u00e9cutif du contenu de ce courrier dans le fichier /var/mail/clientmail-vm1.</p> <p>Finissez en envoyant un e-mail depuis <code>clientmail-vm1</code> vers <code>root</code> et v\u00e9rifiez la bonne redirection du courrier en relevant celui-ci depuis l'utilisateur <code>srvdmz</code>.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#securites-ssltls-et-sasl","title":"S\u00e9curit\u00e9s SSL/TLS et SASL","text":""},{"location":"blog/e-mail---vboxdeb12-13/#-ssl-authentificchiffre","title":"- SSL authentific.../chiffre...","text":"<p>- SSL/TLS Couche Secure Sockets Layer/Transport Layer Security.</p> <p>Cette couche fournit des authentifications bas\u00e9es sur des certificats ainsi que le chiffrement des sessions de transport. Une session chiffr\u00e9e prot\u00e8ge le contenu des messages SMTP ainsi que celui des authentifications SASL.</p> <p>Vous utiliserez pour Postfix les certificats loupvirtuel.crt et loupvirtuel.key issus du m\u00e9mento 8.1 - HTTPS (SSL/TLS).</p> <p>Ces 2 fichiers peuvent servir aux applications de <code>srvdmz</code> faisant appel au chiffrage SSL/TLS.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-postfix-et-certificats-ssl","title":"- Postfix et certificats SSL","text":"<p>Indiquez le chemin des certificats en \u00e9ditant main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et en modifiant les lignes ci-dessous comme suit :</p> <pre><code>smtpd_tls_cert_file=/etc/ssl/loupvirtuel.crt\nsmtpd_tls_key_file=/etc/ssl/loupvirtuel.key\n</code></pre> <p>Activez la modification :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-sasl-authentificutilisa","title":"- SASL authentific.../utilisa...","text":"<p>- SASL Couche Simple Authentication and Security Layer.</p> <p>Cette couche, utilisable avec des protocoles fonctionnant en mode connect\u00e9 comme le SMTP, permet d'authentifier les utilisateurs cherchant \u00e0 envoyer des messages par le biais du serveur de courrier et ainsi \u00e9viter que celui-ci ne soit notamment exploit\u00e9 pour diffuser du SPAM.</p> <p>Installez les paquets suivants :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install sasl2-bin db-util\n</code></pre> <p>Les d\u00e9pendances libsasl2-2 et libsasl2-modules sont d\u00e9j\u00e0 pr\u00e9sentes sur <code>srvdmz</code>.</p> <p>Pour activer automatiquement le service SASL au boot du syst\u00e8me, \u00e9ditez le fichier saslauthd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/default/saslauthd\n</code></pre> <p>et modifiez ou ajoutez le param\u00e8tre START :</p> <pre><code># D\u00e9marrage automatique du service saslauthd\nSTART=yes\n</code></pre> <p>D\u00e9marrez le service :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl start saslauthd\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-postfixdovecot-et-sasl","title":"- Postfix/Dovecot et SASL","text":"<p>Vous allez maintenant configurer le syst\u00e8me afin que Postix utilise l'authentification SMTP en faisant appel au support SASL fourni de base avec Dovecot.</p> <p>a) Configuration c\u00f4t\u00e9 Dovecot</p> <p>Editez, le fichier 10-master.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/dovecot/conf.d\n[srvdmz@srvdmz:~$] sudo nano 10-master.conf\n</code></pre> <p>et modifiez la section Postfix smtp-auth comme suit :</p> <pre><code># Postfix smtp-auth\nunix_listener /var/spool/postfix/private/auth {\nmode = 0666\nuser = postfix\ngroup = postfix\n}\n</code></pre> <p>Editez ensuite le fichier 10-auth.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano 10-auth.conf\n</code></pre> <p>et modifiez la valeur de auth_mechanisms comme suit :</p> <pre><code>auth_mechanisms = plain login\n</code></pre> <p>Red\u00e9marrez Dovecot :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart dovecot\n</code></pre> <p>b) Configuration c\u00f4t\u00e9 Postfix</p> <p>Editez le fichier de configuration main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et ajoutez les lignes suivantes en fin de fichier :</p> <pre><code># Gestion protocole SASL partie serveur SMTP de Postfix\nsmtpd_sasl_type = dovecot\nsmtpd_sasl_path = private/auth\nsmtpd_sasl_auth_enable = yes\nsmtpd_recipient_restrictions = permit_sasl_authenticated,permit_mynetworks,reject_unauth_destination\n</code></pre> <p>Red\u00e9marrez Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-controle-de-la-configuration","title":"- Contr\u00f4le de la configuration","text":"<p>V\u00e9rifiez la prise en compte des 2 protocoles de s\u00e9curisation \u00e0 l'aide de la Cde suivante :</p> <pre><code>[srvdmz@srvdmz:~$] telnet localhost 25    # 25 = n\u00b0 port SMTP\n</code></pre> <p>Retour :</p> <pre><code>Trying ::1...\nConnected to localhost.\nEscape character is '^]'.\n220 srvdmz.loupvirtuel.fr ESMTP Postfix (Debian/GNU)\n</code></pre> <p>Entrez sous la ligne 220 srvdmz... l'instruction suivante :</p> <pre><code>ehlo srvdmz.loupvirtuel.fr\n</code></pre> <p>et observez le retour :</p> <pre><code>250-srvdmz.loupvirtuel.fr\n250-PIPELINING\n250-SIZE 10240000\n250-VRFY\n250-ETRN\n250-STARTTLS\n250-AUTH PLAIN LOGIN\n250-ENHANCEDSTATUSCODES\n250-8BITMIME\n250-DSN\n250-SMTPUTF8\n250 CHUNKING\n</code></pre> <p>Doivent \u00eatre pr\u00e9sents STARTTLS et AUTH PLAIN LOGIN.</p> <p>Fermez la connexion \u00e0 l'aide de la Cde quit.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-postfix-et-chiffrage-ssl","title":"- Postfix et chiffrage SSL","text":"<p>SASL avec son MDP diffus\u00e9 en clair sur le r\u00e9seau, impose par s\u00e9curit\u00e9, de chiffrer la phase d'authentification et \u00e9galement d'utiliser le port de soumission 587 \u00e0 la place du port 25.</p> <p>Vous allez donc forcer les clients MUA du r\u00e9seau comme l'application Thunderbird \u00e0 \u00e9tablir des sessions SMTP enti\u00e8rement chiffr\u00e9es SSL/TLS (pas uniquement l'authentification SASL).</p> <p>Editez pour cela le fichier de configuration master.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/master.cf\n</code></pre> <p>et activez le port 587 en d\u00e9commentant cette ligne :</p> <pre><code>submission inet n - y - - smtpd\n</code></pre> <p>Editez ensuite le fichier principal main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et modifiez le smtpd_tls_security_level comme suit :</p> <pre><code>smtpd_tls_security_level = encrypt\n</code></pre> <p>Les \u00e9changes entre MUA et Postfix seront ainsi chiffr\u00e9s.</p> <p>Relancez Postfix pour traiter la nouvelle configuration :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#relais-smtp","title":"Service de relais SMTP","text":"<p>Le domaine <code>loupvirtuel.fr</code> n'existant pas, vous pouvez vous procurer un nom de domaine gratuit et envoyer du courrier au travers d'Internet en demandant \u00e0 Postfix d'utiliser un service de relais SMTP gratuit sur lequel vous aurez enregistr\u00e9 le nom de domaine gratuit.</p> <p>A) Pour un nom de domaine gratuit, vous avez le choix : dynu.com, cloudns.net, etc... (Partie offres DynDNS)</p> <p>Enregistrez par exemple sur <code>dynu.com</code> un domaine gratuit <code>zzz.freeddns.org</code> et cr\u00e9ez un 1er enregistrement DNS de type MX contenant le m\u00eame nom de domaine.</p> <p>B) Pour un relais SMTP gratuit, vous avez le choix : relai-smtp.com, mailjet.com, brevo.com, etc...</p> <p>Enregistrez par exemple sur <code>relai-smtp.com</code> un compte SMTP <code>x.y@zzz.freeddns.org</code>.</p> <p>C) Les ouvertures de session SMTP depuis Postfix vers Internet au travers du relais SMTP seront s\u00e9curis\u00e9es par authentification SASL chiffr\u00e9e SSL/TLS sur le port 587.</p> <p>En g\u00e9n\u00e9ral, les services de relais SMTP disposent dans leur documentation d'une note d\u00e9di\u00e9e \u00e0 Postfix pour ce type de configuration.</p> <p>Pour cela, commencez par cr\u00e9er le fichier suivant :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/postfix/sasl\n[srvdmz@srvdmz:~$] sudo nano sasl_passwd\n</code></pre> <p>et entrez le contenu ci-dessous sur une seule ligne :</p> <pre><code>[smtp.relai-smtp.net]:587 x.y@zzz.freeddns.org:MDP_compte_relai-smtp\n</code></pre> <p>Chiffrez ensuite le contenu :</p> <pre><code>[srvdmz@srvdmz:~$] sudo postmap hash:sasl_passwd\n</code></pre> <p>Un fichier Bdd sasl_passwd.db est alors cr\u00e9\u00e9.</p> <p>Prot\u00e9gez le fichier texte en modifiant ses permissions :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chmod 600 sasl_passwd\n</code></pre> <p>Editez maintenant le fichier main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/postfix\n[srvdmz@srvdmz:~$] sudo nano main.cf\n</code></pre> <p>Modifiez son param\u00e8tre relayhost comme suit :</p> <pre><code>relayhost = [smtp.relai-smtp.net]:587\n</code></pre> <p>et ajoutez ces lignes \u00e0 la fin du fichier :</p> <pre><code># Gestion protocole SASL partie client SMTP de Postfix\nsmtp_sasl_password_maps = hash:/etc/postfix/sasl/sasl_passwd\nsmtp_sasl_auth_enable = yes\nsmtp_sasl_security_options = noanonymous\nsmtpd_client_restrictions = permit_sasl_authenticated,reject_unknown_client_hostname\n</code></pre> <p>Red\u00e9marrez Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre> <p>L'envoi d'un courrier vers Internet n\u00e9cessite que l'adresse d'\u00e9mission contienne un nom de compte connu du relais SMTP soit <code>x.y@zzz.freeddns.org</code>.</p> <p>Exemple d'un envoi vers une adresse Gmail :</p> <pre><code>[srvdmz@srvdmz:~$] mail -s \"Test du relais SMTP\" -a \"From: x.y@zzz.freeddns.org\" x.y@gmail.com\nCc: &lt;Entr\u00e9e&gt;\nTest relayhost depuis le serveur du courrier h\u00e9berg\u00e9. &lt;Entr\u00e9e&gt;\nCTRL+D\n[srvdmz@srvdmz:~$]\n</code></pre> <p>Le courrier doit arriver \u00e0 l'adresse Gmail de destination, \u00e9ventuellement trait\u00e9 comme SPAM.</p> <p>La configuration pour ne pas finir trait\u00e9 comme SPAM est pr\u00e9sent\u00e9e au \u00a7 Envoi/Rel\u00e8ve ...</p>"},{"location":"blog/e-mail---vboxdeb12-13/#interface-web-postfixadmin","title":"Interface Web PostfixAdmin","text":"<p>L'interface Web impose de modifier la configuration des serveurs Apache-PHP, MySQL, Postfix et Dovecot.</p> <p>Elle permettra de g\u00e9rer le domaine <code>loupvirtuel.fr</code> et les utilisateurs du serveur de courrier sans \u00eatre oblig\u00e9 de cr\u00e9er sur <code>srvdmz</code> un compte Unix par utilisateur.</p> <p>Le domaine et les utilisateurs seront virtuels et contenus dans une Bdd.</p> <p>La gestion multi-domaines sera \u00e9galement possible.</p> <p>Par s\u00e9curit\u00e9, la liaison entre l'interface Web et le serveur Apache sera chiffr\u00e9e SSL/TLS.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-installation","title":"- Installation","text":"<p>Rappel : Le module ssl pour Apache a \u00e9t\u00e9 activ\u00e9 dans le m\u00e9mento 8.1 - HTTPS (SSL/TLS).</p> <p>Installez postfixadmin comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install postfixadmin\n</code></pre> <p>Une fen\u00eatre Configuration de postfixadmin s'ouvre : -&gt; Faut-il configurer ... avec dbconfig-common ? -&gt; Oui -&gt; Mot de passe ... postfixadmin : -&gt; Entrez un MDP -&gt; Ok -&gt; Confirmation du mot de passe : -&gt; MDP -&gt; Ok  </p> <p>L'installation de base se termine.</p> <p>Ajustez les permissions sur le dossier template_C :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chown -R www-data:www-data /usr/share/postfixadmin/templates_c\n</code></pre> <p>Effectuez ensuite une MAJ de la Bdd postfixadmin :</p> <pre><code>[srvdmz@srvdmz:~$] sudo -u www-data php /usr/share/postfixadmin/public/upgrade.php\n</code></pre> <p>et v\u00e9rifiez avec adminer la pr\u00e9sence de 13 tables.</p> <p>Apr\u00e8s cela, connectez-vous sur le serveur MySQL :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mariadb -u root -p\n</code></pre> <p>et cr\u00e9ez l'utilisateur postfixadmin suivant :</p> <pre><code>&gt; USE postfixadmin;\n\n&gt; CREATE USER 'postfixadmin'@'192.168.4.2' IDENTIFIED BY 'votre-mdp-user-postfixadmin';\n\n&gt; GRANT ALL PRIVILEGES ON `postfixadmin` . * TO 'postfixadmin'@'192.168.4.2';\n\n&gt; FLUSH PRIVILEGES;\n\n&gt; QUIT;\n</code></pre> <p>L'utilisateur <code>postfixadmin</code> = lecture/\u00e9criture sur la Bdd.</p> <p>Enfin, cr\u00e9ez un fichier de configuration config.local.php :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/postfixadmin\n[srvdmz@srvdmz:~$] sudo nano config.local.php\n</code></pre> <p>et entrez le contenu PHP suivant pour PostfixAdmin :</p> <pre><code>&lt;?php\n$CONF['configured'] = true;\n$CONF['default_language'] = 'fr';\n$CONF['database_type'] = 'mysqli';\n$CONF['database_host'] = '192.168.4.2';\n$CONF['database_user'] = 'postfixadmin';\n$CONF['database_password'] = 'mdp-user-postfixadmin';\n$CONF['database_name'] = 'postfixadmin';\n$CONF['dovecotpw'] = \"/usr/bin/doveadm pw -r 5\";\n$CONF['admin_email'] = 'postmaster@loupvirtuel.fr';\n?&gt;\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-hote-virtuel-et-https","title":"- H\u00f4te virtuel et HTTPS","text":"<p>La redirection HTTP du domaine <code>loupvirtuel.fr</code> vers HTTPS est assur\u00e9e depuis cette section situ\u00e9e au d\u00e9but du fichier /etc/apache2/sites-available/loupvirtuel.conf :</p> <pre><code>&lt;VirtualHost *:80&gt;\nServerName loupvirtuel.fr\nServerAlias www.loupvirtuel.fr srvdmz.loupvirtuel.fr\nRedirect permanent / https://loupvirtuel.fr/\n&lt;/VirtualHost&gt;\n</code></pre> <p>Si vous avez ex\u00e9cut\u00e9 le m\u00e9mento 8.1, les 3 URL HTTP ci-dessous seront redirig\u00e9es automatiquement vers HTTPS sans faire l'objet d'une alerte de s\u00e9curit\u00e9.</p> <p>- <code>http://loupvirtuel.fr/postfixadmin</code> - <code>http://www.loupvirtuel.fr/postfixadmin</code> - <code>http://srvdmz.loupvirtuel.fr/postfixadmin</code></p> <p>Editez maintenant l'h\u00f4te virtuel Apache loupvirtuel.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/apache2/sites-available\n[srvdmz@srvdmz:~$] sudo nano loupvirtuel.conf\n</code></pre> <p>et ajoutez cet alias dans la section VirtualHost *:443 :</p> <pre><code>&lt;VirtualHost *:443&gt;\n\nSSLCertificateKeyFile /etc/ssl/loupvirtuel.key # existant\n\nAlias /postfixadmin /usr/share/postfixadmin/public\n\nErrorLog ${APACHE_LOG_DIR}/postfixadmin_error.log\nCustomLog ${APACHE_LOG_DIR}/postfixadmin_access.log combined\n\n\n&lt;Directory /usr/share/postfixadmin/public&gt;\nOptions FollowSymLinks MultiViews\nAllowOverride None\nRequire all granted\n&lt;/Directory&gt;\n\n&lt;/VirtualHost&gt; # existant\n</code></pre> <p>Red\u00e9marrez le serveur Web Apache :</p> <pre><code>[srvdmz@srvdmz:~$]  sudo systemctl restart apache2\n</code></pre> <p>Ensuite, depuis <code>srvlan</code>, lancez l'URL suivante : <code>https://loupvirtuel.fr/postfixadmin/setup.php</code></p> <p>Une fois la page setup.php ouverte, actualisez-la pour obtenir le contenu ci-dessous, celui-ci pr\u00e9cisant si toutes les d\u00e9pendances sont install\u00e9es et configur\u00e9es :</p> <p> </p> PostfixAdmin : Page setup.php <p>Fournissez, comme demand\u00e9, un Setup password : -&gt; Entrez le MDP mdp_setup28 -&gt; Confirmez le MDP -&gt; Cliquez sur le bouton Generate setup_password hash</p> <p>-&gt; La page Web s'actualise et montre le hash du MDP -&gt; Gardez la page ouverte et notez la valeur du hash</p> <p>Editez \u00e0 pr\u00e9sent, sur <code>srvdmz</code>, le fichier config.local.php :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/www/html/postfixadmin\n[srvdmz@srvdmz:~$] sudo nano config.local.php\n</code></pre> <p>et ajoutez le param\u00e8tre ci-dessous comme suit :</p> <pre><code>$CONF['setup_password'] = 'Entrez le hash du MDP';\n</code></pre> <p>Revenez sur <code>srvlan</code>, actualisez la page et cr\u00e9ez le compte super-administrateur : -&gt; Setup password -&gt; mdp_setup28 -&gt; Administrateur -&gt; <code>postmaster@loupvirtuel.fr</code> -&gt; Mot de passe -&gt; mdp_postmaster -&gt; Confirmez -&gt; Cliquez sur le bouton Ajouter un administrateur</p> <p>Le texte de validation suivant appara\u00eet si tout est OK :</p> <pre><code> L'administrateur postmaster@loupvirtuel.fr a \u00e9t\u00e9 ajout\u00e9\n</code></pre> <p>Fermez la page Web et entrez maintenant l'URL : <code>https://loupvirtuel.fr/postfixadmin/</code></p> <p>La page de connexion de PostfixAdmin doit s'ouvrir : - Adresse -&gt; <code>postmaster@loupvirtuel.fr</code> - Mot de passe -&gt; mdp_postmaster -&gt; Bouton Entrer</p> <p> </p> PostfixAdmin : Vue de la page de connexion <p>Cr\u00e9ez maintenant le domaine virtuel <code>loupvirtuel.fr</code> : Menu Liste des domaines -&gt; S\u00e9lectionnez Nouveau domaine -&gt; Domaine -&gt; <code>loupvirtuel.fr</code> -&gt; D\u00e9cochez Ajouter les alias par d\u00e9faut -&gt; Bouton Ajouter un domaine</p> <p>Vous pouvez aussi ajouter le domaine <code>zzz.freeddns.org</code>.</p> <p> </p> PostfixAdmin : Liste des domaines virtuels <p>Cr\u00e9ez ensuite ces 7 comptes courriels virtuels : Menu Liste des virtuels -&gt; S\u00e9lectionnez Ajouter un compte courriel -&gt; Nom d'utilisateur -&gt; <code>clientmail-vm1</code> -&gt; Mot de passe -&gt; Votre MDP -&gt; Mot de passe (confirmation) -&gt; Votre MDP -&gt; Nom -&gt; debian12-vm1 -&gt; Bouton Ajouter un compte courriel</p> <p>Vous pouvez aussi ajouter celui pour <code>zzz.freeddns.org</code>.</p> <p> </p> PostfixAdmin : Liste des comptes courriels virtuels <p>Pour finir, cr\u00e9ez un alias de <code>root</code> vers <code>postmaster</code> : Menu Liste des virtuels -&gt; S\u00e9lectionnez Ajouter un alias -&gt; Alias = <code>root</code> -&gt; A = <code>postmaster@loupvirtuel.fr</code> -&gt; Bouton Ajouter un alias</p> <p> </p> PostfixAdmin : Liste des alias virtuels"},{"location":"blog/e-mail---vboxdeb12-13/#-postfixbdd-postfixadmin","title":"- Postfix:Bdd PostfixAdmin","text":"<p>Revenez sur <code>srvdmz</code>.</p> <p>Vous allez cr\u00e9er un utilisateur local <code>vmail</code> qui n'aura pas de MDP associ\u00e9 et se verra donc interdit de connexion.</p> <p>Un dossier /var/mail/vmail affect\u00e9 \u00e0 cet utilisateur et \u00e0 un groupe de m\u00eame nom servira de racine aux comptes e-mail virtuels.</p> <p>Commencez par cr\u00e9er le groupe/utilisateur <code>vmail</code> :</p> <pre><code>[srvdmz@srvdmz:~$] sudo groupadd -g 5000 vmail\n\n[srvdmz@srvdmz:~$] sudo useradd -g vmail -u 5000 vmail -d /home/vmail -s /bin/false\n</code></pre> <p>GID/UID 5000 = identifiants groupe/utilisateur.</p> <p>et le r\u00e9pertoire ou seront stock\u00e9s les e-mails :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mkdir -p /var/mail/vmail\n[srvdmz@srvdmz:~$] cd /var/mail\n[srvdmz@srvdmz:~$] sudo chown -R 5000:5000 vmail\n[srvdmz@srvdmz:~$] sudo chmod -R 770 vmail\n</code></pre> <p>L'utilisateur MySQL postfixadmin d\u00e9clar\u00e9 ci-dessus au \u00a7 Installation sera utilis\u00e9 par Postfix pour acc\u00e9der \u00e0 la base de donn\u00e9es postfixadmin.</p> <p>Cr\u00e9ez le fichier qui assurera la recherche des domaines virtuels cr\u00e9\u00e9s sous PostfixAdmin :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/postfix\n\n[srvdmz@srvdmz:~$] sudo nano mysql_virtual_mailbox_domains_maps.cf\n</code></pre> <p>et entrez le contenu ci-dessous :</p> <pre><code>user = postfixadmin\npassword = votre-mdp-user-postfixadmin\nhosts = 192.168.4.2\ndbname = postfixadmin\nquery = SELECT domain FROM domain WHERE domain='%s' AND active = '1'\n</code></pre> <p>D\u00e9clarez ensuite ce fichier dans /etc/postfix/main.cf :</p> <pre><code>sudo postconf -e virtual_mailbox_domains=mysql:/etc/postfix/mysql_virtual_mailbox_domains_maps.cf\n</code></pre> <p>et v\u00e9rifiez que <code>loupvirtuel.fr</code> existe dans PostfixAdmin :</p> <pre><code>sudo postmap -q loupvirtuel.fr mysql:/etc/postfix/mysql_virtual_mailbox_domains_maps.cf\n</code></pre> <p>Si OK, la Cde retourne <code>loupvirtuel.fr</code>, sinon rien.</p> <p>Cr\u00e9ez le fichier qui assurera la recherche des comptes mail virtuels cr\u00e9\u00e9s sous PostfixAdmin :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano mysql_virtual_mailbox_maps.cf\n</code></pre> <p>et entrez les lignes ci-dessous :</p> <pre><code>user = postfixadmin\npassword = votre-mdp-user-postfixadmin\nhosts = 192.168.4.2\ndbname = postfixadmin\nquery = SELECT maildir FROM mailbox WHERE username='%s' AND active = '1'\n</code></pre> <p>D\u00e9clarez ensuite ce fichier dans /etc/postfix/main.cf :</p> <pre><code>sudo postconf -e virtual_mailbox_maps=mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf\n</code></pre> <p>et testez l'existence de srvlan dans PostfixAdmin :</p> <pre><code>sudo postmap -q srvlan@loupvirtuel.fr mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf\n</code></pre> <p>Si OK, la Cde retourne loupvirtuel.fr/srvlan/, sinon rien.</p> <p>Cr\u00e9ez le fichier qui assurera la recherche des alias virtuels cr\u00e9\u00e9s sous PostfixAdmin :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano mysql_virtual_mailbox_aliases_maps.cf\n</code></pre> <p>et entrez les lignes ci-dessous :</p> <pre><code>user = postfixadmin\npassword = votre-mdp-user-postfixadmin\nhosts = 192.168.4.2\ndbname = postfixadmin\nquery = SELECT goto FROM alias WHERE address='%s' AND active = '1'\n</code></pre> <p>D\u00e9clarez ensuite ce fichier dans /etc/postfix/main.cf :</p> <pre><code>sudo postconf -e virtual_alias_maps=mysql:/etc/postfix/mysql_virtual_mailbox_aliases_maps.cf\n</code></pre> <p>et testez l'existence d'un alias pour <code>root</code> :</p> <pre><code>sudo postmap -q root@loupvirtuel.fr mysql:/etc/postfix/mysql_virtual_mailbox_aliases_maps.cf\n</code></pre> <p>Si OK, la Cde retourne <code>postmaster@loupvirtuel.fr</code>.</p> <p>S\u00e9curisez les droits d'acc\u00e8s sur les 3 fichiers de recherche dont les MDP sont \u00e9crits en clair :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/postfix\n[srvdmz@srvdmz:~$] sudo chgrp postfix mysql_*.cf\n[srvdmz@srvdmz:~$] sudo chmod u=rw,g=r,o= mysql_*.cf\n</code></pre> <p>Editez maintenant le fichier main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et ajoutez ceci en fin de fichier juste au dessus des lignes d\u00e9clarant les 3 fichiers de recherche :</p> <pre><code># Param\u00e8tres utilisation domaines/utilisateurs virtuels\nlocal_transport = virtual\nvirtual_gid_maps = static:5000\nvirtual_uid_maps = static:5000\nvirtual_mailbox_base = /var/mail/vmail\n\n# Lignes existantes d\u00e9clarant les 3 fichiers de recherche\nvirtual_mailbox_domains = mysql:/etc/postfix/mysql_virtual_mailbox_domains_maps.cf\n\nvirtual_mailbox_maps = mysql:/etc/postfix/mysql_virtual_mailbox_maps.cf\n\nvirtual_alias_maps = mysql:/etc/postfix/mysql_virtual_mailbox_aliases_maps.cf \n</code></pre> <p>Le domaine virtuel <code>loupvirtuel.fr</code> cr\u00e9\u00e9 dans PostfixAdmin impose de supprimer sa r\u00e9f\u00e9rence dans main.cf car un domaine virtuel ne doit jamais se trouver dans la liste du param\u00e8tre mydestination.</p> <p>Editez pour cela de nouveau main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et modifiez le param\u00e8tre mydestination comme suit :</p> <pre><code>mydestination = srvdmz, localhost\n</code></pre> <p>Terminez en red\u00e9marrant Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-dovecotbdd-postfixadmin","title":"- Dovecot:Bdd PostfixAdmin","text":"<p>Par d\u00e9faut, Dovecot utilise les utilisateurs r\u00e9els du syst\u00e8me et non les utilisateurs virtuels.</p> <p>Pour corriger cela, \u00e9ditez le fichier 10-auth.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/dovecot\n[srvdmz@srvdmz:~$] sudo nano conf.d/10-auth.conf\n</code></pre> <p>et modifiez le groupe !include comme suit :</p> <pre><code>#!include auth-deny.conf.ext\n#!include auth-master.conf.ext\n\n#!include auth-system.conf.ext  # Ligne \u00e0 commenter\n!include auth-sql.conf.ext      # Ligne \u00e0 d\u00e9commenter\n#!include auth-ldap.conf.ext\n#!include auth-passwdfile.conf.ext\n#!include auth-checkpassword.conf.ext\n#!include auth-static.conf.ext\n</code></pre> <p>Pour l'acc\u00e8s aux e-mails, \u00e9ditez auth-sql.conf.ext :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano conf.d/auth-sql.conf.ext\n</code></pre> <p>Commentez la 2\u00e8me section userdb puis modifiez la 3\u00e8me section comme suit :</p> <pre><code>userdb {  \n   driver = static  \n   args = uid=vmail gid=vmail home=/var/mail/vmail/%d/%n  \n     }\n</code></pre> <p>Pour l'acc\u00e8s \u00e0 la Bdd, \u00e9ditez dovecot-sql.conf.ext :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano dovecot-sql.conf.ext\n</code></pre> <p>et ajoutez ces lignes \u00e0 la fin du fichier :</p> <pre><code>driver = mysql\n\nconnect = host=localhost dbname=postfixadmin user=postfixadmin password=votre-mdp-user-postfixadmin\n\npassword_query = SELECT username,domain,password FROM mailbox WHERE username='%u';\n</code></pre> <p>Pour compl\u00e9ter l'acc\u00e8s aux e-mails, \u00e9ditez 10-mail.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano conf.d/10-mail.conf\n</code></pre> <p>et modifiez le param\u00e8tre mail_location comme suit :</p> <pre><code>mail_location = maildir:/var/mail/vmail/%d/%n/Maildir\n</code></pre> <p>Les e-mails sont ainsi d\u00e9clar\u00e9s stock\u00e9s sous la forme : /var/mail/vmail/[domaine]/[utilisateur]/Maildir</p> <p>Pour traiter l'authentification TLS, \u00e9ditez 10-ssl.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano conf.d/10-ssl.conf\n</code></pre> <p>et modifiez les 3 param\u00e8tres ci-dessous comme suit :</p> <pre><code>ssl = required\nssl_cert = &lt;/etc/ssl/loupvirtuel.crt\nssl_key = &lt;/etc/ssl/loupvirtuel.key\n</code></pre> <p>Les certificats SSL sont ceux d\u00e9clar\u00e9s au \u00a7 Postfix et certificats SSL.</p> <p>Pour compl\u00e9ter la partie TLS, \u00e9ditez 10-auth.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano conf.d/10-auth.conf\n</code></pre> <p>et n'autorisez le login que si la couche TLS est charg\u00e9e en d\u00e9commentant la ligne :</p> <pre><code>disable_plaintext_auth = yes\n</code></pre> <p>Pour traiter le Local Delivery Agent, \u00e9ditez 15-lda.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano conf.d/15-lda.conf\n</code></pre> <p>D\u00e9commentez le param\u00e8tre postmaster_address puis modifiez-le comme suit :</p> <pre><code>postmaster_address = postmaster@loupvirtuel.fr\n</code></pre> <p>Modifiez aussi le bloc protocol lda comme ci-dessous :</p> <pre><code>protocol lda {  \n     # Space separated ... to load (default is glob...).  \n     mail_plugins = $mail_plugins sieve \n     }\n</code></pre> <p>Ceci activera le plugin de filtrage des e-mails soit sieve.</p> <p>Dovecot qui inclut un module de statistiques signalera une erreur si jamais celui-ci n\u2019est pas d\u00e9fini dans sa configuration.</p> <p>Pour \u00e9viter cela, \u00e9ditez le fichier 10-master.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano conf.d/10-master.conf\n</code></pre> <p>et ajoutez ce bloc d'instructions en fin de celui-ci :</p> <pre><code>service stats {\n unix_listener stats-reader {\n user = vmail\n group = vmail\n mode = 0660\n }\n unix_listener stats-writer {\n user = vmail\n group = vmail\n mode = 0660\n }\n }\n</code></pre> <p>Terminez en red\u00e9marrant Dovecot :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart dovecot\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#-postfixlda-de-dovecot","title":"- Postfix:LDA de Dovecot","text":"<p>Vous allez demander \u00e0 Postfix de ne pas utiliser son propre LDA (Local Delivery Agent) pour trier les e-mails dans leurs dossiers de destination respectifs mais plut\u00f4t celui de Dovecot plus performant et permettant de profiter des avantages du plugin Sieve.</p> <p>Pour cela, \u00e9ditez le fichier master.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/master.cf\n</code></pre> <p>et ajoutez \u00e0 la fin de celui-ci les lignes suivantes :</p> <pre><code># Configuration pour une utilisation du LDA de Dovecot\ndovecot     unix     -      n     n     -     -     pipe\n  flags=DRhu user=vmail:vmail argv=/usr/lib/dovecot/dovecot-lda -f ${sender} -d ${recipient}\n }\n</code></pre> <p>Attention : 2\u00e8me ligne = tabulation entre chaque champ 3\u00e8me ligne = d\u00e9but indent\u00e9 de 2 espaces</p> <p>Editez ensuite le fichier main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et ajoutez les lignes suivantes afin que Postifx exploite ce que vous venez de configurer :</p> <pre><code># D\u00e9claration d'utilisation du LDA de Dovecot\nvirtual_transport=dovecot\ndovecot_destination_recipient_limit=1\n</code></pre> <p>Red\u00e9marrez \u00e0 pr\u00e9sent ``srvdmz :</p> <pre><code>[srvdmz@srvdmz:~$] sudo reboot\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-13/#envoireleve-depuis-le-lan","title":"Envoi/Rel\u00e8ve depuis le LAN","text":""},{"location":"blog/e-mail---vboxdeb12-13/#-envoi-mua-mail","title":"- Envoi (MUA Mail)","text":"<p>Envoyez un mail de <code>clientmail-vm1</code> vers <code>postmaster</code> :</p> <pre><code>[srvdmz@srvdmz:~$] echo \"Test\u00e9 et approuv\u00e9\" | mail \\\n-s \"Envoy\u00e9 par clientmail-vm1\" postmaster@loupvirtuel.fr \\\n-a From:clientmail-vm1@loupvirtuel.fr  \n</code></pre> <p>Le caract\u00e8re  indique d'\u00e9crire le tout sur une seule ligne.</p> <p>et observez le r\u00e9sultat dans le journal des logs :</p> <pre><code>[srvdmz@srvdmz:~$] sudo journalctl -n 50 | grep postfix  \n</code></pre> <p>Retour pour Postfix :</p> <pre><code>postfix/pickup..9CD2.. uid=.. from=&lt;clientmail-vm1..&gt;\npostfix/cleanup..9CD2.. message-id=&lt;..9CD2..@srvdmz.l..&gt;\npostfix/qmgr..9CD2.. from=&lt;clientmail-vm1..&gt;.. active)\npostfix/pipe..9CD2.. to=&lt;postmaster..&gt;.. status=sent\npostfix/qmgr..9CD2.. removed\n</code></pre> <p>Pas d'erreur signal\u00e9e, courrier \u00e9mis (status sent).</p> <pre><code>[srvdmz@srvdmz:~$] sudo cat /var/log/syslog | grep dovecot  \n</code></pre> <p>Retour pour Dovecot :</p> <pre><code>dovecot: lda(postmaster..).. msgid=&lt;..9CD2..&gt;: saved\n</code></pre> <p>Pas d'erreur signal\u00e9e, courrier re\u00e7u et stock\u00e9 (saved).</p>"},{"location":"blog/e-mail---vboxdeb12-13/#-releve-mua-thunderbird","title":"- Rel\u00e8ve (MUA Thunderbird)","text":"<p>Installez sur <code>srvlan</code> le client de messagerie Thunderbird :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install thunderbird\n[srvlan@srvlan:~$] sudo apt install thunderbird-l10n-fr\n</code></pre> <p>Puis copiez le certificat CA /etc/ssl/loupvirtuel-ca.pem situ\u00e9 sur la VM <code>srvdmz</code> dans le dossier partag\u00e9 par le PC h\u00f4te de VirtualBox.</p> <p>Lancez enfin le client Thunderbird depuis le menu Xfce.</p> <p>- Menu de Thunderbird (Les 3 barres en haut \u00e0 droite) -&gt; Param\u00e8tres -&gt; Vie priv\u00e9e et s\u00e9curit\u00e9 -&gt; Certificats -&gt; Bouton G\u00e9rer les certificats...</p> <p>Une fen\u00eatre Gestionnaire de certificats s'ouvre : -&gt; Onglet Autorit\u00e9s -&gt; Bouton Importer... -&gt; Acc\u00e9dez au dossier partag\u00e9 par le PC h\u00f4te -&gt; S\u00e9lectionnez le certificat SSL loupvirtuel-ca.pem -&gt; Bouton Ouvrir</p> <p>Une fen\u00eatre T\u00e9l\u00e9chargement du certificat s'ouvre : -&gt; Cochez Confirmer ... AC pour identifier ... web. -&gt; Cochez Confirmer ... AC pour identifier ... courrier. -&gt; Bouton OK -&gt; Bouton OK</p> <p>Ceci \u00e9vitera d'avoir \u00e0 traiter une exception de s\u00e9curit\u00e9 due \u00e0 l'usage d'un certificat auto-sign\u00e9. En fait on simule un certificat v\u00e9rifi\u00e9 par une autorit\u00e9 (CA) publique.</p> <p>- Onglet Configuration du compte -&gt; Votre nom complet -&gt; Entrez Le Postmaster du domaine <code>loupvirtuel.fr</code> -&gt; Adresse e-mail -&gt; Entrez <code>postmaster@loupvirtuel.fr</code> -&gt; Mot de passe -&gt; Entrez le mdp_postmaster Ref: \u00a7 H\u00f4te virtuel ...</p> <p>-&gt; Cliquez sur Ligne Configuration manuelle</p> <p>Appliquez la configuration de la capture ci-dessous : - Nom d'h\u00f4te : Enlevez le . situ\u00e9 devant <code>loupvirtuel.fr</code>. -&gt; Bouton Retester pour v\u00e9rifier si tout est OK. -&gt; Bouton Termin\u00e9 pour valider et cr\u00e9er le compte.</p> <p> </p> Thunderbird : Compte Postmaster <p>Vous pouvez lire le mail de <code>clientmail-vm1</code> (Ref: \u00a7 Envoi ...) :</p> <p> </p> Thunderbird : R\u00e9ception du e-mail de clientmail-vm1 <p>Pour aller plus loin, cr\u00e9ez sur les VM <code>debian12-vm*</code> et <code>srvdmz</code> les comptes appropri\u00e9s en ayant pr\u00e9alablement install\u00e9 thunderbird et importer le certificat CA.</p> <p>Cr\u00e9ez sur <code>srvlan</code>, en compl\u00e9ment du compte <code>postmaster</code>, un compte <code>srvlan@loupvirtuel.fr</code>.</p> <p>R\u00e9alisez ensuite des tests d'envois/r\u00e9ceptions entre les VM pour v\u00e9rifier le bon fonctionnement.</p> <p>Un envoi vers <code>root</code> doit parvenir \u00e0 <code>postmaster</code>.</p>"},{"location":"blog/e-mail---vboxdeb12-13/#spf-dkim","title":"Envoi/Rel\u00e8ve depuis Internet","text":"<p>Pour ce test, vous allez de nouveau exploiter le nom de domaine <code>zzz.freeddns.org</code> et le service de relais SMTP trait\u00e9s ci-dessus (Ref: \u00a7 Service de relais SMTP).</p> <p>Afin d'\u00e9viter que les envois depuis Postfix finissent dans un dossier SPAM, le service de relais SMTP fournit g\u00e9n\u00e9ralement les valeurs des enregistrements DNS pour les protocoles SPF, DKIM et DMARC.</p> <p>Il suffit alors d'enregistrer ceux-ci chez le fournisseur de noms de domaine.</p> <p>A) Exemple d'ajout des enregistrements sur <code>dynu.com</code>.</p> <p>Cr\u00e9ez un 2\u00e8me enregistrement DNS de type TXT pour SPF comme suit :</p> <pre><code>Sous-domaine : Laissez vide\nType : TXT\nTexte : v=spf1 a mx include:spf-relai.relai-smtp.net\n</code></pre> <p>Le SPF (Sender Policy Framework) permet \u00e0 un serveur qui re\u00e7oit un e-mail de s\u2019assurer que ce dernier a bien \u00e9t\u00e9 envoy\u00e9 par un serveur qui en a le droit.</p> <p>A d\u00e9faut, l'e-mail pourrait \u00eatre consid\u00e9r\u00e9 comme du SPAM ou rejet\u00e9 avant d'arriver \u00e0 destination.</p> <p>Cr\u00e9ez un 3\u00e8me enregistrement DNS de type TXT pour DKIM comme suit :</p> <pre><code>Sous-domaine : relai-smtp-com._domainkey\nType : TXT\nTexte : v=DKIM1;h=sha256;k=rsa;s=email;p=......cl\u00e9 dkim publique....\n</code></pre> <p>Le DKIM (Domain Keys Identified Mail) permet au destinataire de v\u00e9rifier qu\u2019un e-mail a bien \u00e9t\u00e9 envoy\u00e9 par le propri\u00e9taire du domaine de l'adresse e-mail.</p> <p>Cr\u00e9ez un 4\u00e8me enregistrement DNS de type TXT pour DMARC comme suit :</p> <pre><code>Sous-domaine : _dmarc\nType : TXT\nTexte : v=DMARC1;p=reject; adkim=s; aspf=s\n</code></pre> <p>Le DMARC (Domain-based Message Authentication, Reporting and Conformance) indique la conduite \u00e0 tenir si le mail ne r\u00e9pond pas aux normes SPF ou DKIM.</p> <p>B) Cr\u00e9ez sur Postfixadmin le domaine virtuel <code>zzz.freeddns.org</code> ainsi qu'un compte virtuel <code>x.y@zzz.freeddns.org</code> de MDP y42.</p> <p>C) Modifiez la configuration de votre Box Internet afin d'ouvrir les ports 25, 587 et 993 vers l'IP de la carte enp0s3 de <code>srvsec</code> qui est le point d'entr\u00e9e du r\u00e9seau local virtuel.</p> <p>D) Ouvrez sur le pare-feu d'IPFire le port 25 vers <code>srvdmz</code>.</p> <p> </p> IPFire : Port 25 ouvert d'Internet vers srvdmz <p>E) Proc\u00e9dez de m\u00eame pour les ports 587 et 993.</p> <p> </p> IPFire : Ports 25, 587 et 993 ouverts <p>F) Cr\u00e9ez ensuite sur le Thunderbird de <code>srvlan</code> un compte <code>x.y@zzz.freeddns.org</code> avec les m\u00eames param\u00e8tres IMAP/SMTP que le compte <code>postmaster</code>, attention : Nom d'h\u00f4te : <code>loupvirtuel.fr</code> Nom d'utilisateur : <code>x.y@zzz.freeddns.org</code></p> <p>G) Pour finir, envoyez un e-mail depuis le MUA de votre mobile vers l'adresse <code>x.y@zzz.freeddns.org</code> et relevez celui-ci depuis le Thunderbird de <code>srvlan</code> et inversement.</p> <p> </p> Thunderbird : Envoi d'un courrier vers Internet <p>Les envois depuis Postfix arriveront majoritairement \u00e0 destination mais certains, en fonction de leur contenu et de la politique anti-spam du FAI destinataire, pourront encore \u00eatre trait\u00e9s comme SPAM.</p> <p>Le test permet toutefois de v\u00e9rifier le fonctionnement en \u00e9mission/r\u00e9ception du serveur de courrier sur Internet.</p> <p>Vous pouvez tester la validit\u00e9 des s\u00e9curit\u00e9s SSL/TLS, SPF, DKIM et DMARC depuis ces 2 sites : https://mail-tester.com et https://appmaildev.com</p> <p></p> <p>  Ouf, pas facile. Postfix et Dovecot sont op\u00e9rationnels. La partie 2 vous attend pour en r\u00e9ception traiter la pr\u00e9sence \u00e9ventuelle de SPAM ou de VIRUS.</p> <p>Partie 2</p>"},{"location":"blog/e-mail---vboxdeb12-23/","title":"E-mail - VBox/Deb12 2/3","text":""},{"location":"blog/e-mail---vboxdeb12-23/#memento-112-anti-spamvirus","title":"M\u00e9mento 11.2 - Anti spam/virus","text":"<p>Le filtrage du courrier ind\u00e9sirable fera appel aux outils antispam Postscreen et Rspamd plus r\u00e9cents que SpamAssassin ainsi qu'\u00e0 l'antivirus ClamAV.</p>"},{"location":"blog/e-mail---vboxdeb12-23/#filtrage-du-courrier-indesirable","title":"Filtrage du courrier ind\u00e9sirable","text":"<p>Le filtrage exigera de la ressource m\u00e9moire, ClamAV en sera le principal consommateur.</p> <p>V\u00e9rifiez la m\u00e9moire de base actuellement utilis\u00e9e :</p> <pre><code>[srvdmz@srvdmz:~$] free --mega -t  \n</code></pre> total utilis\u00e9 libre Mem: 1007 848 66 Partition d'\u00e9change: 1022 98 924 Total 2029 946 990 <p>Constat : \u2248 1Go de libre incluant la partition d'\u00e9change.</p> <p>Augmentez, si possible, la RAM actuelle de 1Go \u00e0 4 Go.</p> <p>Les 3 Go d'\u00e9cart seront utilis\u00e9s par ClamAV, \u00e0 d\u00e9faut celui-ci ne fonctionnera pas bien ou pas du tout et il sera pr\u00e9f\u00e9rable de ne pas traiter la partie antivirus.</p> <p>Vous rev\u00e9rifierez cette ressource \u00e0 la fin du m\u00e9mento.</p>"},{"location":"blog/e-mail---vboxdeb12-23/#-postscreen-installation","title":"- Postscreen : installation","text":"<p>Postscreen, plac\u00e9 en amont du d\u00e9mon smtpd, rejettera entre autres les connexions issues des spambots avant que celles-ci ne viennent polluer le serveur Postfix.</p> <p>Les spambots sont des robots \u00e0 l'origine de la majorit\u00e9 des SPAM \u00e9mis sur Internet.</p> <p>Pour activer Postscreen, \u00e9ditez le fichier master.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/master.cf \n</code></pre> <p>Commentez la ligne suivante (# devant la ligne) :</p> <pre><code>smtp  inet          n     -     y     -     -     smtpd\n</code></pre> <p>et d\u00e9commentez celles-ci (suppression du #) :</p> <pre><code>smtp  inet       n     -     y     -      1    postscreen\nsmtpd pass       -     -     y     -      -    smtpd\ndnsblog  unix    -     -     y     -      0    dnsblog\ntlsproxy unix    -     -     y     -      0    tlsproxy\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-23/#-postscreen-configuration","title":"- Postscreen : configuration","text":"<p>Pour le configurer, \u00e9ditez le fichier main.cf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et entrez le contenu suivant en fin de fichier :</p> <pre><code># Filtrage avec Postscreen\npostscreen_access_list = permit_mynetworks, cidr:/etc/postfix/postscreen_access.cidr\n\npostscreen_denylist_action = drop\n\npostscreen_greet_wait = 3s\npostscreen_greet_banner = Bienvenue,merci de patienter..\npostscreen_greet_action = enforce\n\npostscreen_dnsbl_threshold = 3\npostscreen_dnsbl_action = enforce\npostscreen_dnsbl_sites =\n        zen.spamhaus.org*3\n        b.barracudacentral.org=127.0.0.[2..11]*2\n        bl.spameatingmonkey.net*2\n        bl.spamcop.net\n        #dnsbl.sorbs.net\n        swl.spamhaus.org*-4,\n        list.dnswl.org=127.[0..255].[0..255].0*-2,\n        list.dnswl.org=127.[0..255].[0..255].1*-4,\n        list.dnswl.org=127.[0..255].[0..255].[2..3]*-6\n\npostscreen_dnsbl_allowlist_threshold = -2\n\npostscreen_non_smtp_command_enable = yes\npostscreen_non_smtp_command_action = enforce\n\npostscreen_pipelining_enable = yes\npostscreen_pipelining_action = enforce\n\npostscreen_bare_newline_enable = yes\npostscreen_bare_newline_action = enforce\n</code></pre> <p>Le test access_list permettra de filtrer les clients SMTP selon la valeur des IP contenues dans le param\u00e8tre mynetworks et le fichier postscreen_access.cidr.</p> <p>Ce dernier doit \u00eatre cr\u00e9\u00e9 et rempli manuellement :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/postfix/\n[srvdmz@srvdmz:~$] sudo touch postscreen_access.cidr\n</code></pre> <p>Ci-dessous, un exemple de contenu (vide par d\u00e9faut) :</p> <pre><code># Adresses IP autoris\u00e9es\n192.168.2.2       permit\n\n# Adresses IP rejet\u00e9es\n164.52.24.168     reject\n71.6.158.166      reject\n71.6.146.186      reject\n101.36.106.89     reject\n87.236.176.0/24   reject\n...\n</code></pre> <p>Le test greet permettra de rejeter les clients SMTP qui parleront avant que le serveur ne les y autorise comme l'exige le protocole SMTP.</p> <p>Les tests dnsbl (Black List DNS) et dnswl (White List DNS) permettront de filtrer \u00e0 l'aide de listes fournies sur Internet les clients SMTP consid\u00e9r\u00e9s comme fiables ou susceptibles de transmettre des SPAMS.</p> <p>Nota</p> <p>Postscreen maintient une liste blanche dynamique dans le fichier postscreen_cache.db situ\u00e9 dans /var/lib/postfix.</p> <p>Le test non_smtp permettra de rejeter les clients qui useront de Cdes non SMPT telles connect, get et post.</p> <p>Le test pipelining permettra de rejeter les clients ne respectant pas le protocole d'envoi de Cdes SMTP par lot.</p> <p>Le test bare_newline permettra de rejeter les clients ne respectant pas la syntaxe SMTP de fin de ligne.</p> <p>Pour terminer, red\u00e9marrez Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart postfix\n</code></pre> <p>Vous devriez rapidement constater le travail de Postscreen en \u00e9ditant les logs de Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo journalctl -n 100 | grep postfix\n</code></pre> <p>Retour :</p> <pre><code>...\noct. 02 10:59:54 srvdmz postfix/postscreen[11713]: CONNECT from [71.6.232.28]:53354 to [192.168.4.2]:25\n\noct. 02 10:59:54 srvdmz postfix/postscreen[11713]: PREGREET 27 after 0 from [71.6.232.28]:53354: EHLO zx18.quadmetrics.com\\r\\n\n\noct. 02 10:59:54 srvdmz postfix/postscreen[11713]: DISCONNECT [71.6.232.28]:53354\n...\n\n...\noct. 02 12:06:22 srvdmz postfix/postscreen[12309]: CONNECT from [101.36.106.89]:33098 to [192.168.4.2]:25\n\noct. 02 12:06:22 srvdmz postfix/dnsblog[12312]: addr 101.36.106.89 listed by domain zen.spamhaus.org as 127.0.0.2\n\noct. 02 12:06:22 srvdmz postfix/postscreen[12309]: PREGREET 10 after 0.05 from [101.36.106.89]:33098: EHLO ABC\\r\\n\n\noct. 02 12:06:22 srvdmz postfix/postscreen[12309]: DNSBL rank 3 for [101.36.106.89]:33098\n\noct. 02 12:06:24 srvdmz postfix/postscreen[12309]: DISCONNECT [101.36.106.89]:33098\n...\n</code></pre> <p>Si IP rejet\u00e9e dans le fichier postscreen_access.cidr :</p> <pre><code>...\noct. 05 21:34:36 srvdmz postfix/postscreen[3200]: CONNECT from [101.36.106.89]:46110 to [192.168.4.2]:25\n\noct. 05 21:34:36 srvdmz postfix/postscreen[3200]: DENYLISTED [101.36.106.89]:46110\n\noct. 05 21:34:36 srvdmz postfix/postscreen[3200]: DISCONNECT [101.36.106.89]:46110\n...\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-23/#-rspamd-installation","title":"- Rspamd : installation","text":"<p>Rspamd, plus r\u00e9cent et moderne que SpamAssassin, viendra compl\u00e9ter la lutte antispam.</p> <p>Installez le paquet rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install rspamd\n</code></pre> <p>Son installation inclut celle d'un serveur de Bdd Redis.</p> <p>Tous les fichiers de configuration ont \u00e9t\u00e9 cr\u00e9\u00e9s dans le dossier /etc/rspamd/.</p> <p>V\u00e9rifiez enfin le statut des services rspamd et redis :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl status rspamd\n[srvdmz@srvdmz:~$] sudo systemctl status redis\n</code></pre> <p>Retours :</p> <p> </p> Rspamd et Redis : Statuts <p>L'int\u00e9gration du logiciel Rspamd dans Postfix se fera via le protocole Milter.</p> <p>Pour activer celle-ci, \u00e9ditez le fichier main.cf de Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/postfix/main.cf\n</code></pre> <p>et ajoutez la section suivante en fin de fichier :</p> <pre><code># Applications Milter (RSPAMD, ...)\nsmtpd_milters = inet:127.0.0.1:11332\nnon_smtpd_milters = $smtpd_milters\nmilter_protocol = 6\nmilter_default_action = accept\nmilter_mail_macros = i {mail_addr} {client_addr} {client_name} {auth_authen}\n</code></pre> <p>Rechargez enfin la nouvelle configuration de Postfix :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl reload postfix\n</code></pre> <p>et red\u00e9marrez Rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart rspamd\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-23/#-rspamd-filtrage-bayesien","title":"- Rspamd : filtrage bay\u00e9sien","text":"<p>Activez l'auto-apprentissage bay\u00e9sien en cr\u00e9ant le fichier classifier-bayes.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/rspamd/override.d\n[srvdmz@srvdmz:~$] sudo nano classifier-bayes.conf\n</code></pre> <p>et en y ins\u00e9rant les lignes suivantes :</p> <pre><code>autolearn = true;\n\n# Envoi des donn\u00e9es statistiques vers le serveur Redis\nusers_enabled = true;\nbackend = \"redis\";\n</code></pre> <p>Le filtrage bay\u00e9sien est une technique de probabilit\u00e9 permettant de traiter le courrier ind\u00e9sirable.</p> <p>Cr\u00e9ez ensuite un fichier redis.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano redis.conf\n</code></pre> <p>et indiquez la localisation du serveur Redis comme suit :</p> <pre><code>servers = \"127.0.0.1\";\n</code></pre> <p>Demandez \u00e0 Rspamd de taguer le courrier ind\u00e9sirable en cr\u00e9ant un fichier milter_headers.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano milter_headers.conf\n</code></pre> <p>et en y ins\u00e9rant l'instruction suivante :</p> <pre><code>extended_spam_headers = true;\n</code></pre> <p>Pour classer automatiquement ce courrier tagu\u00e9 X-Spam: Yes, vous ferez appel au plugin sieve de Dovecot.</p> <p>Editez, pour cela, le fichier 90-sieve.conf de Dovecot :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/dovecot/conf.d\n[srvdmz@srvdmz:~$] sudo nano 90-sieve.conf\n</code></pre> <p>et ajoutez ceci sous la ligne #sieve_after = :</p> <pre><code>sieve_after = /etc/dovecot/sieve-after\n</code></pre> <p>Cr\u00e9ez ensuite le dossier sieve-after :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mkdir /etc/dovecot/sieve-after\n</code></pre> <p>et ajoutez dans celui-ci un fichier 10-spam.sieve :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/dovecot/sieve-after\n[srvdmz@srvdmz:~$] sudo nano 10-spam.sieve\n</code></pre> <p>contenant la r\u00e8gle Sieve suivante :</p> <pre><code>require [\"fileinto\",\"mailbox\"];\nif header :contains \"X-Spam\" \"Yes\" {\nfileinto :create \"Junk\";\nstop;\n}\n</code></pre> <p>L'utilisation de la r\u00e8gle implique de compiler celle-ci :</p> <pre><code>[srvdmz@srvdmz:~$] sudo sievec 10-spam.sieve\n</code></pre> <p>Un fichier binaire 10-spam.svbin a \u00e9t\u00e9 g\u00e9n\u00e9r\u00e9.</p> <p>Red\u00e9marrez maintenant Dovecot et Rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart dovecot\n[srvdmz@srvdmz:~$] sudo systemctl restart rspamd\n</code></pre> <p>La syntaxe des fichiers de configuration de Rspamd peut \u00eatre contr\u00f4l\u00e9e comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] sudo rspamadm configtest\n</code></pre> <p>Retour :</p> <pre><code>Syntax OK\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-23/#-rspamd-apprentissage","title":"- Rspamd : apprentissage","text":"<p>Si un utilisateur d\u00e9place un courrier dans le dossier des spams, Rspamd apprendra que c\u2019est un spam et si un utilisateur d\u00e9place un courrier du dossier des spams vers un dossier autre que la corbeille, Rspamd apprendra que c'est un ham soit le contraire d'un spam.</p> <p>Cet apprentissage impose l'usage du plugin imap_sieve, \u00e9ditez pour cela le fichier 20-imap.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/dovecot/conf.d\n[srvdmz@srvdmz:~$] sudo nano 20-imap.conf\n</code></pre> <p>et ajoutez ceci sous #mail_plugins = $mail_plugins :</p> <pre><code>protocol imap {          # Ligne existante\n\nmail_plugins = $mail_plugins imap_sieve\n\n}                        # Ligne existante\n</code></pre> <p>Editez ensuite le fichier 90-sieve.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano 90-sieve.conf\n</code></pre> <p>et entrez le contenu suivant \u00e0 la fin du fichier :</p> <pre><code>plugin {          # Ligne existante\n\n# Apprentissage selon actions utilisateurs\n\n  sieve_plugins = sieve_imapsieve sieve_extprograms\n\n # Si d\u00e9plac\u00e9 dans dossier spam &gt; script learn-spam.sieve\n imapsieve_mailbox1_name = Junk\n imapsieve_mailbox1_causes = COPY\n imapsieve_mailbox1_before = file:/etc/dovecot/sieve/learn-spam.sieve\n\n # Si retir\u00e9 du dossier spam &gt; script learn-ham.sieve\n imapsieve_mailbox2_name = *\n imapsieve_mailbox2_from = Junk\n imapsieve_mailbox2_causes = COPY\n imapsieve_mailbox2_before = file:/etc/dovecot/sieve/learn-ham.sieve\n\n # Dossier contenant les fichiers de scripts\n sieve_pipe_bin_dir = /etc/dovecot/sieve\n\n # Autoriser l'envoi d'e-mails vers un programme externe\n sieve_global_extensions = +vnd.dovecot.pipe +vnd.dovecot.environment\n\n}                 # Ligne existante\n</code></pre> <p>Cr\u00e9ez le dossier sieve d\u00e9di\u00e9 aux scripts Sieve/Rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mkdir /etc/dovecot/sieve\n</code></pre> <p>G\u00e9n\u00e9rez le 1er script Sieve learn-spam.sieve :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/dovecot/sieve/\n[srvdmz@srvdmz:~$] sudo nano learn-spam.sieve\n</code></pre> <p>et entrez le contenu suivant propos\u00e9 par Dovecot :</p> <pre><code>require [\"vnd.dovecot.pipe\", \"copy\", \"imapsieve\", \"environment\", \"variables\"];\nif environment :matches \"imap.user\" \"*\" {\n  set \"username\" \"${1}\";\n}\npipe :copy \"rspamd-learn-spam.sh\" [ \"${username}\" ];\n</code></pre> <p>G\u00e9n\u00e9rez enfin le 2\u00e8me script Sieve learn-ham.sieve :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano learn-ham.sieve\n</code></pre> <p>et entrez le contenu suivant propos\u00e9 par Dovecot :</p> <pre><code>require [\"vnd.dovecot.pipe\", \"copy\", \"imapsieve\", \"environment\", \"variables\"];\nif environment :matches \"imap.mailbox\" \"*\" {\n  set \"mailbox\" \"${1}\";\n}\nif string \"${mailbox}\" \"Trash\" {\n  stop;\n}\nif environment :matches \"imap.user\" \"*\" {\n  set \"username\" \"${1}\";\n}\npipe :copy \"rspamd-learn-ham.sh\" [ \"${username}\" ];\n</code></pre> <p>Red\u00e9marrez Dovecot avant de continuer :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart dovecot\n</code></pre> <p>puis compilez les scripts Sieve et modifiez leurs droits :</p> <pre><code>[srvdmz@srvdmz:~$] sudo sievec learn-spam.sieve\n[srvdmz@srvdmz:~$] sudo sievec learn-ham.sieve\n\n[srvdmz@srvdmz:~$] sudo chmod u=rw,go= /etc/dovecot/sieve/learn-{spam,ham}.{sieve,svbin}\n\n[srvdmz@srvdmz:~$] sudo chown vmail:vmail /etc/dovecot/sieve/learn-{spam,ham}.{sieve,svbin}\n</code></pre> <p>G\u00e9n\u00e9rez le 1er script Rspamd rspamd-learn-spam.sh :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano rspamd-learn-spam.sh\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>#!/bin/sh\nexec /usr/bin/rspamc learn_spam\n</code></pre> <p>G\u00e9n\u00e9rez le 2\u00e8me script Rspamd rspamd-learn-ham.sh :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano rspamd-learn-ham.sh\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>#!/bin/sh\nexec /usr/bin/rspamc learn_ham\n</code></pre> <p>Modifiez les droits des 2 fichiers et relancez Dovecot :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chmod u=rwx,go= /etc/dovecot/sieve/rspamd-learn-{spam,ham}.sh\n\n[srvdmz@srvdmz:~$] sudo chown vmail:vmail /etc/dovecot/sieve/rspamd-learn-{spam,ham}.sh\n\n[srvdmz@srvdmz:~$] sudo systemctl restart dovecot\n</code></pre> <p>Pour tester la configuration, respectez ces 6 \u00e9tapes :</p> <p>1) Affichez le dossier Ind\u00e9sirables sur les Thunderbird. -&gt; Clic droit sur les comptes ...@<code>loupvirtuel.fr</code> -&gt; Param\u00e8tres -&gt; Param\u00e8tres des ind\u00e9sirables -&gt; Cochez D\u00e9placer les nouv... ind\u00e9sirables vers -&gt; S\u00e9lectionnez Dossier &lt;&lt; Ind\u00e9sirables &gt;&gt; sur -&gt; ...@<code>loupvirtuel.fr</code></p> <p>Faites de m\u00eame pour le compte <code>x.y@zzz.freeddns.org</code>.</p> <p>2) Activez le mail_debug de /etc/dovecot/conf.d/10-logging.conf \u00e0 yes et relancez Dovecot.</p> <p>3) Envoyez un mail de <code>srvdmz</code> vers <code>srvlan</code> et d\u00e9placez le mail re\u00e7u dans le dossier Ind\u00e9sirables.</p> <p>4) D\u00e9placez ensuite ce mail du dossier Ind\u00e9sirables vers le dossier Courrier entrant de <code>srvlan</code>.</p> <p>5) Observez enfin le contenu des logs de /var/log/mail.log et /var/log/rspamd/rspamd.log.</p> <p> </p> Logs : Lignes pr\u00e9sentes de Dovecot et Rspamd <p>6) Terminez en remettant la valeur du param\u00e8tre mail_debug \u00e0 no et relancez Dovecot.</p>"},{"location":"blog/e-mail---vboxdeb12-23/#-rspamd-interface-web","title":"- Rspamd : interface Web","text":"<p>Rspamd est fourni avec une interface Web permettant de contr\u00f4ler les courriers marqu\u00e9s comme spam, d'avoir des statistiques, etc...</p> <p>Il est n\u00e9cessaire, pour acc\u00e9der \u00e0 celle-ci, d'\u00e9diter l'h\u00f4te virtuel loupvirtuel.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/apache2/sites-available\n[srvdmz@srvdmz:~$] sudo nano loupvirtuel.conf\n</code></pre> <p>et d'ajouter ceci dans la section VirtualHost *:443 :</p> <pre><code>ProxyPass \"/rspamd\" \"http://localhost:11334\"\nProxyPassReverse \"/rspamd\" \"http://localhost:11334\"\n</code></pre> <p>Red\u00e9marrez le serveur Web Apache :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart apache2\n</code></pre> <p>Cr\u00e9ez enfin le MDP d'acc\u00e8s exig\u00e9 par l'interface Web :</p> <pre><code>[srvdmz@srvdmz:~$] sudo rspamadm pw\n</code></pre> <p>Exemple de retour :</p> <pre><code>Enter passphrase: Entrez votre MDP\n$2$z777ywazwfxww636chfnmyifd83wb1p4$8b8c...\n</code></pre> <p>Cr\u00e9ez maintenant un fichier worker-controller.inc :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/rspamd/local.d\n[srvdmz@srvdmz:~$] sudo nano worker-controller.inc\n</code></pre> <p>Entrez le hachage du MDP comme suit :</p> <pre><code>password = \"$2$z777ywazwfxww636chfnmyifd83wb1p4$8b8c...\"\n</code></pre> <p>et relancez rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart rspamd\n</code></pre> <p>Pour finir, testez l'URL <code>https://loupvirtuel.fr/rspamd/</code> :</p> <p> </p> Rspamd : Interface Web"},{"location":"blog/e-mail---vboxdeb12-23/#-clamav-installation","title":"- ClamAV : installation","text":"<p>Par curiosit\u00e9, contr\u00f4lez de nouveau les ressources disponibles qui ont du peu \u00e9voluer :</p> <pre><code>[srvdmz@srvdmz:~$] free --mega -t\n[srvdmz@srvdmz:~$] df /dev/sda1 -H\n</code></pre> <p>Installez maintenant les paquets ClamAV suivants :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install clamav clamav-daemon\n[srvdmz@srvdmz:~$] sudo apt install clamav-unofficial-sigs\n</code></pre> <p>Un groupe/utilisateur clamav et 2 services ont \u00e9t\u00e9 cr\u00e9\u00e9s.</p> <p>Le paquet clamav-unofficial-sigs installe une base virale fournie par la soci\u00e9t\u00e9 SaneSecurity, base qui vient compl\u00e9ter celles de ClamAV.</p> <p>Attendez 5 \u00e0 10 minutes et v\u00e9rifiez le statut du service de MAJ des Bdd ClamAV :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart clamav-freshclam\n[srvdmz@srvdmz:~$] sudo systemctl status clamav-freshclam\n[srvdmz@srvdmz:~$] sudo systemctl enable clamav-freshclam\n</code></pre> <p> </p> ClamAV : Statut du service clamav-freshclam <p>Les Bdd daily, main et bytecode doivent \u00eatre up to date.</p> <p>Si Bdd up to date, d\u00e9marrez le service clamav-daemon :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl start clamav-daemon\n[srvdmz@srvdmz:~$] sudo systemctl status clamav-daemon\n</code></pre> <p> </p> ClamAV : Statut du service clamav-daemon <p>Au prochain boot syst\u00e8me, le service clamav-daemon d\u00e9marrera automatiquement.</p> <p>Le scan d'un dossier peut d\u00e9j\u00e0 s'effectuer comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] sudo clamscan /home/srvdmz\n</code></pre> <p> </p> ClamAV : Scan du dossier /home/srvdmz <p>Les logs sont consultables dans /var/log/clamav/.</p> <p>Le bon traitement de la base virale clamav-unofficial-sigs peut \u00eatre v\u00e9rifi\u00e9 comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] cd /home/srvdmz\n[srvdmz@srvdmz:~$] sudo clamscan --debug 2&gt;&amp;1 /dev/null | grep \"sanesecurity\"\n</code></pre> <p>Retour :</p> <pre><code>LibClamAV debug: /var/lib/clamav/sanesecurity.ftm loaded\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-23/#-clamav-configuration","title":"- ClamAV : configuration","text":"<p>Les fichiers sont situ\u00e9s dans le dossier /etc/clamav/.</p> <p>Il est possible de r\u00e9duire la fr\u00e9quence de MAJ des Bdd en \u00e9ditant le fichier freshclam.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/clamav/freshclam.conf\n</code></pre> <p>et en modifiant la valeur 24 du param\u00e8tre Checks \u00e0 3 :</p> <pre><code>Checks 3\n</code></pre> <p>Les MAJ seront effectu\u00e9es 3 fois par jour au lieu de 24.</p> <p>Nota</p> <p>Comme pour root, cr\u00e9ez depuis l'interface de PostfixAdmin un alias de l'utilisateur clamav vers postmaster afin que ce dernier puisse recevoir les notifications par e-mail de ClamAV.</p>"},{"location":"blog/e-mail---vboxdeb12-23/#-clamav-lien-avec-rspamd","title":"- ClamAV : lien avec Rspamd","text":"<p>Afin que Rspamd utilise ClamAV, cr\u00e9ez le fichier suivant :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/rspamd/local.d/antivirus.conf\n</code></pre> <p>et entrez le contenu ci-dessous :</p> <pre><code>clamav {\n    scan_mime_parts = false;\n    symbol = \"CLAM_VIRUS\";\n    type = \"clamav\";\n    action = \"reject\";\n    servers = \"/var/run/clamav/clamd.ctl\";\n}\n</code></pre> <p>Pour finir rechargez la configuration de Rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl reload rspamd\n</code></pre>"},{"location":"blog/e-mail---vboxdeb12-23/#tests","title":"Tests","text":""},{"location":"blog/e-mail---vboxdeb12-23/#-detection-dun-spam","title":"- D\u00e9tection d'un SPAM","text":"<p>Au pr\u00e9alable, cr\u00e9ez un fichier temporaire options.inc :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/rspamd/local.d\n[srvdmz@srvdmz:~$] sudo nano options.inc\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>enable_test_patterns = true;\n</code></pre> <p>Ceci permettra d'effectuer le test attendu, voir les explications sur le site rspamd.com.</p> <p>Red\u00e9marrez ensuite Rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart rspamd\n</code></pre> <p>et envoyez, depuis le Thunderbird de <code>srvlan</code>, un courrier de <code>postmaster</code> vers <code>clientmail-vm2</code> contenant ceci :</p> <pre><code>D\u00e9but\nYJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-\\\nANTI-UBE-TEST-EMAIL*C.34X\nCe courrier doit normalement \u00eatre trait\u00e9 comme spam.\nLa source de celui-ci sera compl\u00e9t\u00e9 du tag X-Spam: Yes.\nFin\n</code></pre> <p>Le caract\u00e8re  indique d'\u00e9crire le tout sur une seule ligne.</p> <p>Si tout se passe bien, le courrier sera, pour le compte <code>clientmail-vm2</code>, stock\u00e9 automatiquement dans le dossier des Ind\u00e9sirables de Thunderbird.</p> <p>V\u00e9rifiez sur <code>debian12-vm2</code> que <code>clientmail-vm2</code> le re\u00e7oit bien notifi\u00e9 du tag X-Spam: Yes :</p> <p> </p> Thunderbird : Tag X-Spam: Yes <p>Sur <code>srvdmz</code>, le courrier a \u00e9t\u00e9 stock\u00e9 dans :</p> <p> </p> srvdmz : SPAM dans le dossier .Junk <p>Le groupe date/heure correspond avec celui du mail re\u00e7u sur le compte virtuel <code>clientmail-vm2</code>.</p> <p>Si OK, vous pouvez supprimer le fichier options.inc.</p>"},{"location":"blog/e-mail---vboxdeb12-23/#-detection-dun-virus","title":"- D\u00e9tection d'un VIRUS","text":"<p>Au pr\u00e9alable, \u00e9ditez le fichier antivirus.conf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/rspamd/local.d\n[srvdmz@srvdmz:~$] sudo nano antivirus.conf\n</code></pre> <p>et modifiez son contenu comme suit :</p> <pre><code>clamav {\n    scan_mime_parts = false;\n    symbol = \"CLAM_VIRUS\";\n    type = \"clamav\";\n    action = \"reject\";\n    servers = \"/var/run/clamav/clamd.ctl\";\n\npatterns {\n    JUST_EICAR = '^Eicar-Test-Signature$';\n                }\n}\n</code></pre> <p>Ceci permettra d'effectuer le test attendu, voir les explications sur le site rspamd.com.</p> <p>Red\u00e9marrez ensuite Rspamd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart rspamd\n</code></pre> <p>Envoyez \u00e0 pr\u00e9sent, depuis <code>srvlan</code>, un courrier de <code>srvlan</code> vers <code>clientmail-vm1</code> contenant ceci :</p> <pre><code>X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-\\\nANTIVIRUS-TEST-FILE!$H+H*\n</code></pre> <p>Le caract\u00e8re  indique d'\u00e9crire le tout sur une seule ligne.</p> <p>Ce contenu est t\u00e9l\u00e9chargeable depuis le site Eicar (European Institute for Computer Antivirus Research) en utilisant l'URL https://secure.eicar.org/eicar.com.txt.</p> <p>R\u00e9sultat, le virus sera d\u00e9tect\u00e9 lors de la phase d'envoi du mail depuis <code>srvlan</code> et rejet\u00e9 (param\u00e8tre action = \"reject\"; du fichier antivirus.conf).</p> <p> </p> Thunderbird : Information de virus d\u00e9tect\u00e9"},{"location":"blog/e-mail---vboxdeb12-23/#-memoire-systeme","title":"- M\u00e9moire syst\u00e8me","text":"<p>ClamAV est gourmand :</p> <pre><code>[srvdmz@srvdmz:~$] free --mega -t\n</code></pre> total utilis\u00e9 libre Mem: 4105 2456 803 Partition d'\u00e9change: 1022 620 401 Total 5127 3077 1205 <p>Constat : \u2248 1Go de libre incluant la partition d'\u00e9change.</p> <p>ClamAV exigera parfois plus que le 2456 Mo affich\u00e9 ci-dessus d'o\u00f9 le besoin de 4 Go de RAM. A d\u00e9faut n'utilisez pas le logiciel antivirus.</p>"},{"location":"blog/e-mail---vboxdeb12-23/#-controle-des-logs","title":"- Contr\u00f4le des logs","text":"<p>Consultez le journal des logs (Cde journalctl) et le fichier /var/log/rspamd/rspamd.log, le premier permettant notamment d'observer l'efficacit\u00e9 de l'outil Postscreen.</p> <p>Vous allez vite comprendre que l'ouverture du port 25 sur votre box Internet sera rapidement exploit\u00e9e par divers scanners et robots spammeurs.</p> <p></p> <p>  Voil\u00e0 ! Le courrier ind\u00e9sirable est g\u00e9r\u00e9. La partie 3 vous attend pour traiter le WebMail avec Roundcube ...</p> <p>Partie 3</p>"},{"location":"blog/e-mail---vboxdeb12-33/","title":"E-mail - VBox/Deb12 3/3","text":""},{"location":"blog/e-mail---vboxdeb12-33/#memento-113-roundcube","title":"M\u00e9mento 11.3 - Roundcube","text":"<p>Le service Webmail fera appel au logiciel Roundcube qui est un client de messagerie au m\u00eame titre que Thunderbird mais s'ex\u00e9cutant sur serveur.</p> <p>Il servira d'interface entre le serveur de courrier et n'importe quel navigateur Web connect\u00e9 \u00e0 Internet ce qui le rend pratique pour une consultation de son courrier en situation de mobilit\u00e9.</p>"},{"location":"blog/e-mail---vboxdeb12-33/#webmail-roundcube","title":"Webmail Roundcube","text":""},{"location":"blog/e-mail---vboxdeb12-33/#-installation-et-configuration","title":"- Installation et configuration","text":"<p>Installez le paquet Debian roundcube :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install roundcube \n</code></pre> <p>Une fen\u00eatre Configuration de roundcube-core s'ouvre : - Faut-il configurer ... roundcube ... -common ? =&gt; Oui - MDP de connexion MySQL ... =&gt; roundcubemysql =&gt; OK - Confirmation du MDP =&gt; roundcubemysql =&gt; OK</p> <p>L'installation continue jusqu'\u00e0 son terme.</p> <p>Les d\u00e9pendances ont \u00e9t\u00e9 ajout\u00e9es automatiquement.</p> <p>Les fichiers ont \u00e9t\u00e9 install\u00e9s essentiellement dans : - /etc/roundcube/ - /var/lib/roundcube/ - /usr/share/roundcube/ - /var/log/roundcube/</p> <p>Une Bdd de nom roundcube a \u00e9galement \u00e9t\u00e9 cr\u00e9\u00e9e ainsi qu'un lien de configuration Apache de nom roundcube.conf dans /etc/apache2/conf-enabled/.  </p> <p>Editez ensuite le fichier de configuration config.inc.php :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/roundcube\n[srvdmz@srvdmz:~$] sudo nano config.inc.php \n</code></pre> <p>Modifiez le contenu de ces lignes comme suit :</p> <pre><code>$config['imap_host'] = [\"ssl://loupvirtuel.fr:993\"];\n$config['smtp_host'] = 'tls://loupvirtuel.fr:587';\n$config['smtp_user'] = '%u'; \n$config['smtp_pass'] = '%p';\n$config['product_name'] = 'Serveur Webmail Roundcube'; \n</code></pre> <p>et ajoutez celui-ci \u00e0 la fin du fichier :</p> <pre><code># Ci-dessous, contenu de defaults.inc.php remplac\u00e9\n# SSL IMAP\n$config['imap_conn_options'] = [\n  'ssl'         =&gt; [\n     'verify_peer'  =&gt; true,\n     'verify_depth' =&gt; 3,\n     'cafile'       =&gt; '/etc/ssl/loupvirtuel-ca.pem',\n   ],\n ];\n# TLS SMTP\n$config['smtp_conn_options'] = [\n  'ssl' =&gt; [\n     'verify_peer'  =&gt; true,\n     'verify_depth' =&gt; 3,\n     'cafile'       =&gt; '/etc/ssl/loupvirtuel-ca.pem',\n   ],\n ];\n# Ajout auto du domaine aux cr\u00e9ations d'utilisateurs\n$config['mail_domain'] = 'loupvirtuel.fr';\n</code></pre> <p>Editez enfin le fichier de configuration apache.conf :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano apache.conf\n</code></pre> <p>et d\u00e9commentez l'alias situ\u00e9 en d\u00e9but de fichier :</p> <pre><code>Alias /roundcube /var/lib/roundcube/public_html\n</code></pre> <p>Pour traiter l'alias, red\u00e9marrez Apache :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart apache2\n</code></pre> <p>L'acc\u00e8s \u00e0 la Bdd roundcube peut \u00eatre test\u00e9 avec Adminer, voir M\u00e9mento 8.1 : - Utilisateur =&gt; roundcube - Mot de passe =&gt; roundcubemysql</p>"},{"location":"blog/e-mail---vboxdeb12-33/#-acces-depuis-la-vm-srvlan","title":"- Acc\u00e8s depuis la VM srvlan","text":"<p>Au pr\u00e9alable, cr\u00e9ez sur <code>srvdmz</code> un lien symbolique vers le dossier Web de roundcube :</p> <pre><code>[srvdmz@srvdmz:~$] sudo  ln -s /var/lib/roundcube /var/www/html/roundcube\n</code></pre> <p>et donnez aux 2 dossiers Roundcube ci-dessous les permissions suivantes :</p> <pre><code>[srvdmz@srvdmz:~$]  sudo chown -R www-data:www-data /var/lib/roundcube\n\n[srvdmz@srvdmz:~$]  sudo chown -R www-data:www-data /var/log/roundcube\n</code></pre> <p>Comme avec PostfixAdmin, la redirection vers HTTPS est assur\u00e9e depuis cette section situ\u00e9e au d\u00e9but du fichier /etc/apache2/sites-available/loupvirtuel.conf :</p> <pre><code>&lt;VirtualHost *:80&gt;\nServerName loupvirtuel.fr\nServerAlias www.loupvirtuel.fr srvdmz.loupvirtuel.fr\nRedirect permanent / https://loupvirtuel.fr/\n&lt;/VirtualHost&gt;\n</code></pre> <p>Si vous avez ex\u00e9cut\u00e9 le M\u00e9mento 8.1 2/2, les 3 URL HTTP ci-dessous seront redirig\u00e9es automatiquement vers HTTPS sans faire l'objet d'une alerte de s\u00e9curit\u00e9.</p> <p>- <code>http://loupvirtuel.fr/roundcube</code> - <code>http://www.loupvirtuel.fr/roundcube</code> - <code>http://srvdmz.loupvirtuel.fr/roundcube</code></p> <p>Renforcez la redirection https en \u00e9ditant config.inc.php :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/roundcube\n[srvdmz@srvdmz:~$] sudo nano config.inc.php\n</code></pre> <p>et en ajoutant les 2 lignes suivantes en fin de fichier :</p> <pre><code># Utilisation forc\u00e9e du protocole HTTPS\n$config['force_https'] = true;\n</code></pre> <p>Ensuite, depuis <code>srvlan</code>, lancez l'URL suivante : <code>https://loupvirtuel.fr/roundcube</code></p> <p>Une fen\u00eatre de connexion Rouncube s'affiche : =&gt; Nom d'utilisateur =&gt; <code>postmaster@loupvirtuel.fr</code> =&gt; Mot de passe =&gt; postmaster31 =&gt; Bouton Connexion</p> <p> </p> Roundcube : Fen\u00eatre de connexion <p>Vous devriez trouver dans la bo\u00eete de r\u00e9ception affich\u00e9e par Roundcube les courriers transmis \u00e0 Postmaster lors des m\u00e9mentos pr\u00e9c\u00e9dents.</p>"},{"location":"blog/e-mail---vboxdeb12-33/#-envoireception-lan","title":"- Envoi/r\u00e9ception LAN","text":"<p>Depuis <code>debian12-vm1</code>, utilisez Roundcube pour envoyer un courrier vers <code>srvlan@loupvirtuel.fr</code>.</p> <p>Param\u00e8tres de connexion sur l'h\u00f4te <code>debian12-vm1</code> : =&gt; <code>https://loupvirtuel.fr/roundcube</code> =&gt; Nom d'utilisateur =&gt; <code>clientmail-vm1@loupvirtuel.fr</code> =&gt; Mot de passe =&gt; Votre MDP =&gt; Bouton Connexion</p> <p>- Menu de gauche =&gt; Ic\u00f4ne R\u00e9diger</p> <p>Envoyez votre courrier et r\u00e9cup\u00e9rez celui-ci en utilisant Roundcube depuis l'h\u00f4te <code>srvlan</code> :</p> <p> </p> Roundcube : Courrier re\u00e7u sur l'h\u00f4te srvlan <p>R\u00e9alisez le m\u00eame test depuis <code>srvlan</code> vers <code>debian12-vm1</code>.</p>"},{"location":"blog/e-mail---vboxdeb12-33/#-envoireception-internet","title":"- Envoi/r\u00e9ception INTERNET","text":"<p>R\u00e9f\u00e9rence : M\u00e9mento 11.1</p> <p>Effectuez un envoi depuis le MUA de votre smartphone vers l'adresse <code>x.y@zzz.freeddns.org</code> et r\u00e9cup\u00e9rez celui-ci depuis l'h\u00f4te <code>srvlan</code> et inversement.</p> <p>Pour v\u00e9rifier la r\u00e9ception depuis <code>srvlan</code>, utilisez l'URL : <code>https://loupvirtuel.fr/roundcube</code></p> <p>Une fen\u00eatre de connexion Roundcube s'affiche : =&gt; Utilisateur =&gt; <code>x.y@zzz.freeddns.org</code> =&gt; Mot de passe =&gt; y42 =&gt; Bouton Connexion</p>"},{"location":"blog/e-mail---vboxdeb12-33/#-ajout-des-filtres-de-tri-sieve","title":"- Ajout des filtres de tri Sieve","text":"<p>R\u00e9f\u00e9rence : M\u00e9mento 11.1</p> <p>Installez le paquet contenant les plugins de Roundcube :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install roundcube-plugins\n</code></pre> <p>Ceux-ci ont \u00e9t\u00e9 install\u00e9s dans /etc/roundcube/plugins.</p> <p>Activez le plugin managesieve en \u00e9ditant ce fichier :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/roundcube\n[srvdmz@srvdmz:~$] sudo nano config.inc.php\n</code></pre> <p>et en modifiant la section suivante comme ci-dessous :</p> <pre><code>$config['plugins'] = [\n    'managesieve',\n];\n</code></pre> <p>Quittez si besoin la session roundcube en cours et reconnectez-vous pour exploiter les filtres.</p>"},{"location":"blog/e-mail---vboxdeb12-33/#-filtre-de-reponse-auto","title":"- Filtre de r\u00e9ponse auto","text":"<p>Cr\u00e9ez sur l'h\u00f4te <code>debian12-vm2</code> un filtre permettant de g\u00e9n\u00e9rer une r\u00e9ponse automatique en cas d'absence, ceci pour tous les courriers re\u00e7us.</p> <p>Depuis le navigateur Web, entrez l'URL : <code>https://loupvirtuel.fr/roundcube</code></p> <p>Une fen\u00eatre de connexion Rouncube s'affiche : =&gt; Nom d'utilisateur =&gt; <code>clientmail-vm2@loupvirtuel.fr</code> =&gt; Mot de passe =&gt; Votre MDP =&gt; Bouton Connexion</p> <p>- Menu de gauche =&gt; Ic\u00f4ne Param\u00e8tres =&gt; Volet Param\u00e8tres =&gt; Ic\u00f4ne Filtres =&gt; Volet le plus \u00e0 droite =&gt; Ic\u00f4ne Cr\u00e9er</p> <p>Remplissez la d\u00e9finition du filtre comme le montre la capture ci-dessous et enregistrez celle-ci :</p> <p> </p> Roundcube : Filtre de r\u00e9ponse automatique <p>Le chiffre 3 de l'\u00e9tiquette 8 repr\u00e9sente le nombre de jours pendant lesquels le message d'absence ne sera pas renvoy\u00e9 \u00e0 l'exp\u00e9diteur, peu importe le nombre de courriers qu'il vous envoie.</p> <p>Testez le filtre depuis le Thunderbird de l'h\u00f4te <code>srvlan</code> en envoyant un e-mail de <code>postmaster</code> vers <code>clientmail-vm2</code>.</p> <p>Ensuite, d\u00e9sactivez celui-ci depuis le switch de nom Le filtre est activ\u00e9 visible sur la capture d'\u00e9cran ci-dessus.</p> <p>Par curiosit\u00e9, contr\u00f4lez sur le Thunderbird de <code>srvlan</code> qu'un module de nom Sieve peut \u00eatre install\u00e9 depuis son menu Modules compl\u00e9mentaires et th\u00e8mes.</p>"},{"location":"blog/e-mail---vboxdeb12-33/#-filtre-de-transfert-auto","title":"- Filtre de transfert auto","text":"<p>Cr\u00e9ez, toujours depuis l'h\u00f4te <code>debian12-vm2</code>, un second filtre permettant le transfert automatique de tous les courriers provenant de <code>postmaster</code> vers <code>srvlan</code> :</p> <p> </p> Roundcube : Filtre de transfert automatique <p>Envoyez ensuite depuis le Thunderbird de <code>srvlan</code> un courrier de <code>postmaster</code> vers <code>clientmail-vm2</code> et v\u00e9rifiez le transfert de celui-ci sur le compte <code>srvlan@loupvirtuel.fr</code>.</p> <p> </p> Thunderbird : Courrier transf\u00e9r\u00e9 vers srvlan <p></p> <p>  Voil\u00e0, c'est fini. Si administrer \u00e0 distance le r\u00e9seau virtuel vous tente, alors le m\u00e9mento 12.1 vous attend pour d\u00e9couvrir l'outil Cockpit.</p> <p>M\u00e9mento 12.1</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/","title":"FTPS avec VsFTPd - VBox/Deb12","text":""},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#memento-92-serveur-vsftpd","title":"M\u00e9mento 9.2 - Serveur VsFTPd","text":"<p>Le serveur VsFTPd sera install\u00e9 sur la VM <code>srvlan</code>.</p> <p>Le FTP est un protocole de communication d\u00e9di\u00e9 au transfert de fichiers sur un r\u00e9seau TCP/IP.</p> <p>Les utilisateurs des VM <code>debian12-vm*</code> (clients) utiliseront la VM <code>srvlan</code> (serveur) pour d\u00e9poser ou s'\u00e9changer des fichiers.</p> <p>Selon le param\u00e9trage FTP, un utilisateur pourra ou non D\u00e9poser, T\u00e9l\u00e9charger, Lire, Modifier ou Supprimer des dossiers/fichiers.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#preambule","title":"Pr\u00e9ambule","text":"<p>Outils utilis\u00e9s : - Serveur VsFTPd (Very secure FTP daemon). - Console client lftp \u00e0 la place de ftp.</p> <p>Configurations propos\u00e9es : - Usage du FTPS (FTP via SSL). - Usage du mode passif.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-role-dun-serveur-ftp","title":"- R\u00f4le d'un serveur FTP","text":"<p>Il permet le transfert de dossiers/fichiers avec un client distant, par Internet ou par le r\u00e9seau informatique local. Le transfert, selon un mod\u00e8le client/serveur, peut se faire dans les 2 sens.</p> <p>Le serveur FTP d'un h\u00e9bergeur permet par exemple \u00e0 un client distant de d\u00e9poser ou t\u00e9l\u00e9charger les fichiers de son site web.</p> <p>En g\u00e9n\u00e9ral, deux modes de connexion sont utilis\u00e9s : Le mode anonyme qui autorise l'acc\u00e8s au dossier public du serveur sans fournir de nom d'utilisateur ni de MDP. Les fichiers de ce dossier sont souvent en lecteur seule.</p> <p>Le mode authentifi\u00e9 qui permet \u00e0 un utilisateur local ou virtuel, apr\u00e8s contr\u00f4le de son nom et de son MDP, d'acc\u00e9der en lecture/\u00e9criture \u00e0 ses propres fichiers.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#installation","title":"Installation","text":""},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-serveur-vsftpd","title":"- Serveur vsftpd","text":"<p>Au pr\u00e9alable, mettez \u00e0 jour la distribution Debian 12 :</p> <pre><code>[srvlan@srvlan:~$] sudo apt update\n[srvlan@srvlan:~$] sudo apt upgrade\n[srvlan@srvlan:~$] sudo reboot\n[srvlan@srvlan:~$] sudo apt autoremove --purge\n</code></pre> <p>et installez vsftpd pour son c\u00f4t\u00e9 l\u00e9ger et s\u00e9curis\u00e9 :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install vsftpd \n</code></pre> <p>V\u00e9rifiez le bon d\u00e9marrage de celui-ci :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl status vsftpd \n</code></pre> <p>Retour :</p> <pre><code>\u25cf vsftpd.service - vsftpd FTP server\n   Loaded: loaded (/lib/systemd/system/vsftpd...\n   Active: active (running) since Mon 2024-... ago\n  Process: 1989 ExecStartPre=/bin/mkdir -p /var...\n Main PID: 1990 (vsftpd)\n    Tasks: 1 (limit: 1077)\n   Memory: 2.0M\n      CPU: 15ms\n   CGroup: /system.slice/vsftpd.service\n             \u2514\u25001990 /usr/sbin/vsftpd /etc/vsftd...\n\njuin 03 ... srvlan systemd[1]: Starting vsftpd ...\njuin 03 ... srvlan systemd[1]: Started vsftpd ...\n</code></pre> <p>Un utilisateur de nom <code>ftp</code> a \u00e9t\u00e9 cr\u00e9\u00e9 lors de l'installation. Un dossier personnel /srv/ftp/ lui a \u00e9t\u00e9 associ\u00e9. Il s'agit du dossier public FTP par d\u00e9faut du serveur.</p> <p>Pour les tests, copiez ces 2 fichiers dans ce dossier :</p> <pre><code>[srvlan@srvlan:~$] cd /usr/share/doc/vsftpd\n[srvlan@srvlan:~$] sudo cp README /srv/ftp/README\n[srvlan@srvlan:~$] sudo cp TODO /srv/ftp/TODO \n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-securisation-via-ssl","title":"- S\u00e9curisation via SSL","text":"<p>De base le serveur vsftpd ne chiffre rien mais il peut utiliser le protocole FTPS (FTP via SSL) pour chiffrer ses communications avec les clients.</p> <p>Pour information, diff\u00e9rences entre le SFTP et le FTPS : - SFTP plus r\u00e9cent utilise par d\u00e9faut le port SSH 22 pour traiter l\u2019authentification, les Cdes FTP et le transfert de donn\u00e9es.</p> <p>La gestion d'un pare-feu est facilit\u00e9e, un seul port.</p> <p>- FTPS utilise par d\u00e9faut le port 21 pour traiter l'authentification et les Cdes FTP ainsi que le port 20 (en mode actif) ou une tranche de ports (en mode passif) pour le transfert de donn\u00e9es.</p> <p>Un pare-feu sera donc plus compliqu\u00e9 \u00e0 g\u00e9rer.</p> <p>Pour le FTPS, installez si absent le paquet openssl :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install openssl \n</code></pre> <p>Connectez-vous en tant que <code>root</code> et cr\u00e9ez un certificat CA (Certificate Authority) auto-sign\u00e9 :</p> <pre><code>[srvlan@srvlan:~$] su root\n\n[root@srvlan:~#] cd /etc/ssl/private\n[root@srvlan:~#] openssl req -x509 -nodes -newkey rsa:2048 -keyout vsftpd.pem -out vsftpd.pem -days 3650 \n</code></pre> <p>R\u00e9pondez aux questions pos\u00e9es comme suit :</p> <pre><code>Country Name (2 letter code) [AU]:FR\nState or Prov... Name (full name) [Some-State]:Paris\nLocality Name (eg, city) []:Paris\nOrganization Name (e...) [Interne...]:Intra-InfoLoup            \nOrganizational Uni... (eg...) []:Intra-Labo-FTPS\nCommon Name (... server FQDN or YOUR name) []:srvlan\nEmail Address []: Touche Entr\u00e9e\n</code></pre> <p>Le Common Name doit correspondre au nom d'h\u00f4te du serveur FTP soit ici <code>srvlan</code>.</p> <p>Editez ensuite le fichier de configuration vsftpd.conf :</p> <pre><code>[root@srvlan:~#] exit\n\n[srvlan@srvlan:~$] sudo nano /etc/vsftpd.conf \n</code></pre> <p>et ajustez vers la ligne 147 les param\u00e8tres SSL :</p> <pre><code># This option specifies the location of the RSA certifi...\n# encrypted connections.\nrsa_cert_file=/etc/ssl/private/vsftpd.pem\nrsa_private_key_file=/etc/ssl/private/vsftpd.pem\nssl_enable=YES\n\n# Lignes ajout\u00e9es\nssl_ciphers=HIGH\nssl_tlsv1=YES\nssl_sslv2=NO\nssl_sslv3=NO\nforce_local_data_ssl=YES\nforce_local_logins_ssl=YES\nallow_anon_ssl=NO\n\n#\n# Uncomment  this to indicate that vsftpd use ...\n</code></pre> <p>Le contenu des 7 lignes ajout\u00e9es signifie : - Niveau de chiffrement \u00e9lev\u00e9 impos\u00e9. - Protocole ssl_tlsv1 autoris\u00e9. - Protocole ssl_sslv2 refus\u00e9 car moins s\u00e9curis\u00e9. - Protocole ssl_sslv3 refus\u00e9 car moins s\u00e9curis\u00e9. - Login non anonyme forc\u00e9 SSL pour l'envoi des Data. - Login non anonyme forc\u00e9 SSL pour l'envoi du MDP. - Login anonyme non forc\u00e9 SSL.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-activation-mode-ftp-passif","title":"- Activation mode FTP passif","text":"<p>Le serveur fonctionne par d\u00e9faut en mode actif.</p> <p>Il vaut mieux, pour \u00e9viter que le pare-feu d'un client distant situ\u00e9 sur Internet ne bloque la liaison FTPS, passer celui-ci en mode passif.</p> <p>Le synoptique du m\u00e9mento d\u00e9taille l'int\u00e9r\u00eat de ce mode.</p> <p>Activez celui-ci en ajoutant ceci en fin de vsftpd.conf :</p> <pre><code># Activation du mode passif\npasv_enable=YES\npasv_min_port=12500\npasv_max_port=12550\n</code></pre> <p>La tranche de ports al\u00e9atoires doit \u00eatre sup\u00e9rieure \u00e0 1024, ici 12500 \u00e0 12550.</p> <p>Red\u00e9marrez le serveur FTP pour la prise en compte :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart vsftpd\n[srvlan@srvlan:~$] sudo systemctl status vsftpd\n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#acces-ftp-anonymes","title":"Acc\u00e8s FTP anonymes","text":""},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-configuration-de-base","title":"- Configuration de base","text":"<p>Par d\u00e9faut, vsftpd refuse les connexions anonymes. Pour changer cela, \u00e9ditez son fichier de configuration :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd.conf\n</code></pre> <p>et r\u00e9glez les valeurs de ces 3 param\u00e8tres comme suit :</p> <pre><code>anonymous_enable=YES             # Acc\u00e8s anonyme autoris\u00e9\nanon_upload_enable=NO           # D\u00e9p\u00f4t fichiers interdit\nanon_mkdir_write_enable=NO  # Cr\u00e9ation dossiers interdite\n</code></pre> <p>N'oubliez pas de retirer si besoin le # de d\u00e9but de ligne.</p> <p>Red\u00e9marrez le serveur FTP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart vsftpd\n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-connexion-depuis-lftp","title":"- Connexion depuis LFTP","text":"<p>Installez le client FTP de nom lftp sur <code>debian12-vm2</code> :</p> <pre><code>[client-linux@debian12-vm2:~$] sudo apt install lftp\n</code></pre> <p>Ce programme permet d'envoyer des lignes de Cdes vers un serveur FTP/FTPS/SFTP.</p> <p>Cr\u00e9ez un fichier cach\u00e9 .lftprc qui sera utilis\u00e9 par lftp :</p> <pre><code>[client-linux@debian12-vm2:~$] cd /home/client-linux\n[client-linux@debian12-vm2:~$] nano .lftprc\n</code></pre> <p>et entrez la configuration suivante :</p> <pre><code># Configuration trait\u00e9e au d\u00e9marrage du client lftp\nset ftp:passive-mode true\nset ftp:ssl-auth TLS\nset ftp:ssl-force true\nset ftp:ssl-protect-data true\nset ftp:ssl-protect-list true\nset ssl:verify-certificate no\n</code></pre> <p>Enfin, connectez-vous sur le serveur vsftpd de <code>srvlan</code> :</p> <pre><code>[client-linux@debian12-vm2:~$] lftp srvlan\nlftp srvlan:~&gt; ls\n</code></pre> <p>La Cde ls renvoie le contenu du dossier public /srv/ftp/ :</p> <pre><code>-rw-r--r--    1 0      0  1361 Juin 03 16:42 README\n-rw-r--r--    1 0      0  1833 Juin 03 16:42 TODO\nlftp srvlan:/&gt; quit\n</code></pre> <p>Utilisez la Cde quit pour fermer la connexion distante.</p> <p>Testez ensuite un t\u00e9l\u00e9chargement FTP :</p> <pre><code>[client-linux@debian12-vm2:~$] cd Documents\n[client-linux@debian12-vm2:~$] lftp srvlan\nlftp srvlan:~&gt; get TODO\n</code></pre> <p>Retour :</p> <pre><code>1833 octets transf\u00e9r\u00e9s                        \nlftp srvlan:/&gt; quit\n</code></pre> <p>Cr\u00e9ez enfin un fichier de test test-ftp-vm2 comme suit :</p> <pre><code>[client-linux@debian12-vm2:~$] touch test-ftp-vm2\n[client-linux@debian12-vm2:~$] echo \"Test Upload FTP\" &gt; test-ftp-vm2\n</code></pre> <p>et testez un envoi FTP dans le dossier public de <code>srvlan</code> :</p> <pre><code>[client-linux@debian12-vm2:~$] lftp srvlan\nlftp srvlan:~&gt; put test-ftp-vm2\n</code></pre> <p>Retour :</p> <pre><code>put: L'acc\u00e8s a \u00e9chou\u00e9 : 550 Permission denied. (te...\nlftp srvlan:/&gt; quit\n</code></pre> <p>Echec normal (... denied) puisque vous avez plus haut interdit le d\u00e9p\u00f4t anonyme de fichiers.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-connexion-depuis-filezilla","title":"- Connexion depuis FileZilla","text":"<p>Installez sur <code>debian12-vm2</code> le client FTP/SFTP FileZilla :</p> <pre><code>[client-linux@debian12-vm2:~$] sudo apt install filezilla\n</code></pre> <p>FileZilla fonctionne en mode passif par d\u00e9faut.</p> <p>Ouvrez ensuite l'application graphique : - Menu Applications -&gt; Internet -&gt; Ic\u00f4ne FileZilla</p> <p>Cliquez sur l'ic\u00f4ne situ\u00e9e la plus \u00e0 gauche de la barre des ic\u00f4nes afin d'ouvrir le Gestionnaire de Sites et cliquez sur le bouton Nouveau site.</p> <p>Cr\u00e9ez un site de nom srvlan-anonymous comme suit : - Onglet G\u00e9n\u00e9ral</p> <p> </p> FileZilla : R\u00e9glages g\u00e9n\u00e9raux FTP Anonymous <p>- Onglet Avanc\u00e9</p> <p> </p> FileZilla : R\u00e9glages avanc\u00e9s FTP Anonymous <p>Une fen\u00eatre Se souvenir des mots de passe ? s'ouvre : -&gt; Cochez Sauvegarder les mots de passe -&gt; Valider</p> <p>Le site srvlan-anonymous est \u00e0 pr\u00e9sent cr\u00e9\u00e9. Cliquez sur la fl\u00e8che situ\u00e9e \u00e0 droite de l'ic\u00f4ne du Gestionnaire de Sites et s\u00e9lectionnez celui-ci.</p> <p>Une fen\u00eatre Connexion FTP non s\u00e9curis\u00e9e s'ouvre : -&gt; Cochez Toujours autoriser FTP non s\u00e9curis\u00e9 pour ... -&gt; Valider</p> <p>La connexion s'\u00e9tablit et la zone Site distant doit montrer le contenu du dossier public de <code>srvlan</code>.</p> <p> </p> FileZilla : Connexion FTP Anonymous \u00e9tablie <p>Pour Afficher/Editer les fichiers texte, proc\u00e9dez ainsi : -&gt; Menu Edition de FileZilla -&gt; Param\u00e8tres... -&gt; S\u00e9lectionnez Edition des fichiers -&gt; Cochez Utiliser l'\u00e9diteur pers... -&gt; /usr/bin/mousepad -&gt; Cochez Toujours utiliser l'\u00e9diteur par d\u00e9faut -&gt; Bouton Valider</p> <p>V\u00e9rifiez \u00e0 pr\u00e9sent que vous pouvez : - En zone Site local T\u00e9l\u00e9charger un fichier mais non en Envoyer (Upload).</p> <p>- En zone Site distant Afficher/Editer un fichier mais non le Renommer ni le Supprimer.</p> <p>Cliquez sur l'ic\u00f4ne serveur/croix-rouge pour fermer la connexion.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-configuration-avec-upload","title":"- Configuration avec Upload","text":"<p>Choix d\u00e9conseill\u00e9 pour raison de s\u00e9curit\u00e9, un anonyme pouvant d\u00e9poser un fichier infect\u00e9.</p> <p>Cr\u00e9ez et affectez un dossier uploads \u00e0 l'utilisateur <code>ftp</code> :</p> <pre><code>[srvlan@srvlan:~$] sudo mkdir /srv/ftp/uploads\n[srvlan@srvlan:~$] sudo chown ftp:ftp /srv/ftp/uploads\n</code></pre> <p>Donnez \u00e0 l'utilisateur <code>ftp</code> le droit d'\u00e9criture sur celui-ci :</p> <pre><code>[srvlan@srvlan:~$] sudo chmod 755 /srv/ftp/uploads\n</code></pre> <p>et retirez lui ce droit sur le dossier racine /srv/ftp/ :</p> <pre><code>[srvlan@srvlan:~$] sudo chmod 555 /srv/ftp\n</code></pre> <p>Editez ensuite le fichier de configuration vsftpd.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd.conf\n</code></pre> <p>puis ajustez les param\u00e8tres ci-dessous comme suit :</p> <pre><code>write_enable=YES                     # Ecriture autoris\u00e9e\nanon_upload_enable=YES          # D\u00e9p\u00f4t fichiers autoris\u00e9\nanon_mkdir_write_enable=YES # Cr\u00e9ation dossiers autoris\u00e9e\n</code></pre> <p>et ajoutez les 2 lignes suivantes en fin de fichier :</p> <pre><code># Permissions affect\u00e9es au contenu du dossier uploads \nanon_umask=022\n</code></pre> <p>- umask 022 = Permissions \u00e0 755 dossiers/644 fichiers</p> <p>Pour finir, red\u00e9marrez le serveur FTP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart vsftpd\n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-test-de-lupload-depot","title":"- Test de l'Upload (D\u00e9p\u00f4t)","text":"<p>Acc\u00e9dez au dossier suivant de la VM <code>debian12-vm2</code> :</p> <pre><code>[client-linux@debian12-vm2:~$] cd /home/client-linux\n[client-linux@debian12-vm2:~$] cd Documents\n</code></pre> <p>et testez le d\u00e9p\u00f4t (upload) suivant avec la Cde lftp :</p> <pre><code>[client-linux@debian12-vm2:~$] lftp srvlan\nlftp srvlan:~&gt; ls\n</code></pre> <p>Retour :</p> <pre><code>-rw-r--r--    1 0    0      1361 Jun 03 16:42 README\n-rw-r--r--    1 0    0      1833 Jun 03 16:42 TODO\ndrwxr-xr-x    2 112  122    4096 Jun 04 12:56 uploads\n</code></pre> <pre><code>lftp srvlan:/&gt; cd uploads\nlftp srvlan:/uploads&gt; put test-ftp-vm2\n</code></pre> <p>Retour :</p> <pre><code>16 octets transf\u00e9r\u00e9s\n</code></pre> <pre><code>lftp srvlan:/uploads&gt; ls\n</code></pre> <p>Retour :</p> <pre><code>-rw-r--r--    1 112  122    16 Jun 04 13:17 test-ftp-vm2\nlftp srvlan:/uploads&gt; quit\n</code></pre> <p>Ensuite, dans FileZilla, v\u00e9rifiez le r\u00e9sultat et contr\u00f4lez l'impossibilit\u00e9 de Supprimer, Renommer et Modifier un fichier/dossier d\u00e9pos\u00e9 dans le dossier uploads.</p> <p>V\u00e9rifiez \u00e9galement l'impossibilit\u00e9 maintenant de r\u00e9aliser un envoi FTP en dehors du dossier uploads (droits du dossier racine /srv/ftp/ fix\u00e9s ci-dessus \u00e0 555).</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#acces-ftp-utilisateurs-locaux","title":"Acc\u00e8s FTP utilisateurs locaux","text":""},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-sur-un-dossier-commun","title":"- Sur un dossier commun","text":"<p>C'est par d\u00e9faut l'utilisateur <code>nobody</code> de Linux qui permet au d\u00e9mon vsftpd d'ex\u00e9cuter ses processus enfants non privil\u00e9gi\u00e9s. L'inconv\u00e9nient est que d'autres d\u00e9mons peuvent \u00e9galement travailler avec cet utilisateur.</p> <p>Il est donc, par s\u00e9curit\u00e9, conseill\u00e9 de cr\u00e9er un utilisateur non privil\u00e9gi\u00e9 d\u00e9di\u00e9 au d\u00e9mon vsftpd et de le d\u00e9clarer dans vsftpd.conf \u00e0 l'aide du param\u00e8tre nopriv_user.</p> <p>Pour cela, vous allez cr\u00e9er un utilisateur local de nom <code>userftps</code> sans MDP associ\u00e9, ce qui interdira toute tentative de connexion avec ce nom sur <code>srvlan</code>.</p> <p>Un dossier /home/ftp/ affect\u00e9 \u00e0 cet utilisateur et au groupe grftps servira de racine aux utilisateurs locaux et plus tard aux utilisateurs virtuels.</p> <p>Cr\u00e9ez le dossier/groupe/utilisateur et les permissions :</p> <pre><code>[srvlan@srvlan:~$] sudo mkdir -p /home/ftp\n[srvlan@srvlan:~$] sudo groupadd grftps\n\n[srvlan@srvlan:~$] sudo useradd -g grftps -d /home/ftp userftps\n\n[srvlan@srvlan:~$] sudo chown userftps:grftps /home/ftp\n[srvlan@srvlan:~$] sudo chmod 555 /home/ftp\n</code></pre> <p>Cr\u00e9ez ensuite les utilisateurs locaux <code>clientvm*</code> suivants :</p> <pre><code>[srvlan@srvlan:~$] sudo adduser clientvm1\n[srvlan@srvlan:~$] sudo adduser clientvm2\n</code></pre> <p>Un MDP UNIX sera demand\u00e9 pour chacun d'eux. Vous pouvez utiliser ceux des utilisateurs des VM <code>debian12-vm*</code> mais ce n'est pas obligatoire. Vous \u00eates \u00e9galement libre de r\u00e9pondre ou non aux demandes d'information qui appara\u00eetront.</p> <p>Ajoutez les 2 utilisateurs au groupe grftps :</p> <pre><code>[srvlan@srvlan:~$] sudo adduser clientvm1 grftps\n[srvlan@srvlan:~$] sudo adduser clientvm2 grftps\n</code></pre> <p>et cr\u00e9ez pour ceux-ci le dossier commun_locaux :</p> <pre><code>[srvlan@srvlan:~$] cd /home/ftp\n[srvlan@srvlan:~$] sudo mkdir commun_locaux\n\n[srvlan@srvlan:~$] sudo chown userftps:grftps commun_locaux\n\n[srvlan@srvlan:~$] sudo chmod 775 commun_locaux\n[srvlan@srvlan:~$] sudo chmod +t commun_locaux\n</code></pre> <p>Le +t (sticky bit) interdira aux utilisateurs locaux de Supprimer/Modifier les fichiers situ\u00e9s dans le dossier commun_locaux dont ils ne sont pas propri\u00e9taires.</p> <p>V\u00e9rifiez toutes les cr\u00e9ations dans /home/ ainsi que le contenu de ces 3 fichiers :</p> <pre><code>[srvlan@srvlan:~$] sudo cat /etc/group\n[srvlan@srvlan:~$] sudo cat /etc/passwd\n[srvlan@srvlan:~$] sudo cat /etc/shadow\n</code></pre> <p>Editez \u00e0 pr\u00e9sent le fichier de configuration vsftpd.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd.conf\n</code></pre> <p>puis ajustez les param\u00e8tres suivants comme affich\u00e9s :</p> <pre><code>local_enable=YES            # Acc\u00e8s utilisateur local=YES\nwrite_enable=YES         # Ecriture utilisateur local=YES\nlocal_umask=022  # 644 fichiers re\u00e7us, 755 dossiers re\u00e7us\nnopriv_user=userftps         # Utilisateur non privil\u00e9gi\u00e9\nftpd_banner=Serveur FTP du Loup.      # Accueil de vsftpd\nchroot_local_user=YES    # Utilisateur limit\u00e9 \u00e0 sa racine\nsecure_chroot_dir=/home/ftp          # Racine de userftps\n</code></pre> <p>- ftpd_banner : Permet de cacher la version de vsftpd.</p> <p>et ajoutez ces 3 lignes en fin de fichier :</p> <pre><code># Gestion des utilisateurs locaux\nlocal_root=/home/ftp/commun_locaux\nallow_writeable_chroot=YES\n</code></pre> <p>- Ecriture OK dans le dossier racine commun_locaux.</p> <p>Red\u00e9marrez le serveur FTP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart vsftpd\n</code></pre> <p>Cr\u00e9ez la note suivante dans le dossier commun_locaux :</p> <pre><code>[srvlan@srvlan:~$] cd /home/ftp/commun_locaux\n[srvlan@srvlan:~$] sudo nano note-ftps-utilisateurs-locaux\n</code></pre> <p>et entrez ce contenu pr\u00e9cisant le r\u00f4le du dossier :</p> <pre><code>Ici, dossier FTP d\u00e9di\u00e9 aux utilisateurs locaux.\n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-test-de-connexion-ftps","title":"- Test de connexion FTPS","text":"<p>Cr\u00e9ez sur le client FileZilla de <code>debian12-vm2</code> un site de nom srvlan-commun.</p> <p>Param\u00e9trez celui-ci comme montr\u00e9 ci-dessous : - Onglet G\u00e9n\u00e9ral</p> <p> </p> FileZilla : Cr\u00e9ation du site FTPS srvlan-commun <p>- Onglet Avanc\u00e9 -&gt; Dossier local par d\u00e9faut -&gt; Parcourir... -&gt; S\u00e9lectionnez /home/client-linux/Documents -&gt; Bouton Valider</p> <p>Lancez ensuite une connexion FTPS sur le site.</p> <p>1 ) Traitez le certificat SSL pr\u00e9sent\u00e9 comme suit :</p> <p> </p> FileZilla : Certificat SSL \u00e9mis par le serveur vsftpd <p>2 ) La connexion est \u00e9tablie :</p> <p> </p> FileZilla : Connexion s\u00e9curis\u00e9e FTPS \u00e9tablie <p>Le transfert FTP doit fonctionner dans les 2 sens.</p> <p>Mais vous ne devez pas pouvoir, zone Site distant, Supprimer, Renommer et Modifier les fichiers d\u00e9pos\u00e9s sur <code>srvlan</code> par d'autres utilisateurs, cas du fichier note-ftps-utilisateurs-locaux.</p> <p>Vous devez en revanche pouvoir lire leur contenu.</p> <p>Pour finir, cr\u00e9ez sur le client FileZilla de <code>debian12-vm1</code> le site srvlan-commun avec comme utilisateur local <code>clientvm1</code> et contr\u00f4lez apr\u00e8s connexion que vous retrouvez bien les m\u00eames permissions que ci-dessus.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-sur-tous-les-dossiers","title":"- Sur tous les dossiers","text":"<p>Choix d\u00e9conseill\u00e9, l'utilisateur du FTP pouvant acc\u00e9der \u00e0 des fichiers sensibles.</p> <p>La configuration actuelle enferme les utilisateurs locaux tels <code>clientvm*</code> dans le dossier racine commun_locaux, ceux-ci ne peuvent donc pas acc\u00e9der au dossier parent donc \u00e0 l'arborescence compl\u00e8te de <code>srvlan</code>.</p> <p>Ce comportement s\u00e9curis\u00e9 vient de ces param\u00e8tres :</p> <pre><code>chroot_local_user=YES    # Utilisateur limit\u00e9 \u00e0 sa racine \nlocal_root=/home/ftp/commun_locaux               # Racine\n</code></pre> <p>Mais vous pouvez avoir besoin qu'un utilisateur local acc\u00e8de \u00e0 toute l'arborescence de <code>srvlan</code> ceci avec des permissions diff\u00e9rentes de celles de son dossier personnel et du dossier racine commun_locaux.</p> <p>Editez pour cela le fichier vsftpd.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd.conf\n</code></pre> <p>puis d\u00e9commentez les 2 lignes suivantes :</p> <pre><code>chroot_list_enable=YES\nchroot_list_file=/etc/vsftpd.chroot_list\n</code></pre> <p>et red\u00e9marrez le serveur FTP :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart vsftpd\n</code></pre> <p>Cr\u00e9ez maintenant un utilisateur local de nom <code>indiscret</code> :</p> <pre><code>[srvlan@srvlan:~$] sudo adduser indiscret\n</code></pre> <p>Pour simplifier, donnez lui le MDP indiscret.</p> <p>Affectez ensuite celui-ci au groupe grftps :</p> <pre><code>[srvlan@srvlan:~$] sudo adduser indiscret grftps\n</code></pre> <p>Pour finir, cr\u00e9ez le fichier vsftpd.chroot_list :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd.chroot_list\n</code></pre> <p>et entrez l'utilisateur <code>indiscret</code> en d\u00e9but de celui-ci :</p> <pre><code>indiscret\n</code></pre> <p>Si d'autres noms, placez ceux-ci les uns sous les autres.</p> <p>Cr\u00e9ez sur le FileZilla de <code>debian12-vm1</code> le site srvlan-complet et attribuez lui ces param\u00e8tres :</p> <p>- Onglet G\u00e9n\u00e9ral -&gt; H\u00f4te -&gt; <code>srvlan</code> -&gt; Chiffrement -&gt; Connexion FTP explicite sur TLS si ... -&gt; Type d'authentification -&gt; Normale -&gt; Utilisateur -&gt; indiscret -&gt; Mot de passe -&gt; indiscret</p> <p>- Onglet Avanc\u00e9 -&gt; Dossier local par d\u00e9faut -&gt; Parcourir... -&gt; S\u00e9lectionnez /home/client-linux/Documents -&gt; Dossier distant par d\u00e9faut -&gt; Entrez /home/indiscret -&gt; Bouton Valider</p> <p>Lancez une connexion sur le site srvlan-complet :</p> <p> </p> FileZilla : Acc\u00e8s complet aux dossiers/fichiers de srvlan <p>et v\u00e9rifiez que rien, en dehors de /home/indiscret/ et /home/ftp/commun_locaux/, ne peut \u00eatre supprim\u00e9 ou modifi\u00e9 mais le droit de lire et t\u00e9l\u00e9charger tous les fichiers de <code>srvlan</code> repr\u00e9sente un risque de s\u00e9curit\u00e9.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#acces-ftp-utilisateurs-virtuels","title":"Acc\u00e8s FTP utilisateurs virtuels","text":"<p>Choix conseill\u00e9 pour raison de s\u00e9curit\u00e9.</p> <p>Les utilisateurs virtuels non d\u00e9clar\u00e9s avec la Cde adduser seront comme l'utilisateur local <code>userftps</code> inconnus du syst\u00e8me mais verront leurs demandes de connexion mapp\u00e9es vers celui-ci, chacun dans leur dossier respectif.</p> <p>Il s\u2019agit l\u00e0 d\u2019une protection plus efficace que la cr\u00e9ation d'utilisateurs locaux.</p> <p>La configuration s\u2019op\u00e8re en 4 \u00e9tapes : - Cr\u00e9ation d\u2019une Bdd Berkeley utilisateurs virtuels - Liaison de la Bdd avec le module PAM de vsftpd - Cr\u00e9ation des permissions et dossiers des utilisateurs - Configuration de vsftpd et test de connexion</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-creation-bdd-berkeley","title":"- Cr\u00e9ation Bdd Berkeley","text":"<p>Installez au pr\u00e9alable le paquet db5.3-util :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install db5.3-util\n</code></pre> <p>puis cr\u00e9ez ensuite le dossier et le fichier suivants :</p> <pre><code>[srvlan@srvlan:~$] sudo mkdir /etc/vsftpd\n[srvlan@srvlan:~$] sudo touch /etc/vsftpd/virtuels.txt \n</code></pre> <p>Editez le fichier cr\u00e9\u00e9 virtuels.txt :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd/virtuels.txt\n</code></pre> <p>et entrez, l'un sous l'autre, ces utilisateurs et MDP :</p> <pre><code>clientvm1-virtuel\nMDP de clientvm1-virtuel\nclientvm2-virtuel\nMDP de clientvm2-virtuel\n</code></pre> <p>Terminez la liste par un retour de chariot.</p> <p>Nota</p> <p>Les utilisateurs ci-dessus, inconnus de <code>srvlan</code>, peuvent avoir des MDP diff\u00e9rents ou non de ceux affect\u00e9s aux utilisateurs locaux des VM <code>debian12-vm*</code>.</p> <p>Cr\u00e9ez enfin la Bdd virtuels.db pour le module PAM :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/vsftpd\n[srvlan@srvlan:~$] sudo db5.3_load -T -t hash -f virtuels.txt virtuels.db \n</code></pre> <p>et autorisez la lecture des 2 fichiers \u00e0 <code>root</code> uniquement :</p> <pre><code>[srvlan@srvlan:~$] sudo chmod 600 /etc/vsftpd/virtuels.db\n[srvlan@srvlan:~$] sudo chmod 600 /etc/vsftpd/virtuels.txt \n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-liaison-bdd-avec-pam","title":"- Liaison Bdd avec PAM","text":"<p>Editez le fichier de configuration PAM suivant :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/pam.d/vsftpd \n</code></pre> <p>et ajoutez, sous # Note : vsftpd..., ces 2 instructions :</p> <pre><code>auth sufficient /lib/x86_64-linux-gnu/security/pam_userdb.so db=/etc/vsftpd/virtuels\n\naccount sufficient /lib/x86_64-linux-gnu/security/pam_userdb.so db=/etc/vsftpd/virtuels \n</code></pre> <p>Mettre i386-linux-gnu \u00e0 la place de x86_64-linux-gnu pour un syst\u00e8me 32 bits.</p> <p>Le module pam_userdb (Pluggable Authentication Modules) v\u00e9rifiera les authentifications utilisateurs virtuels/MDP avec les valeurs stock\u00e9es dans la Bdd Berkeley.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-permissions-et-dossiers","title":"- Permissions et dossiers","text":"<p>Cr\u00e9ez le dossier qui contiendra les permissions :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/vsftpd\n[srvlan@srvlan:~$] sudo mkdir vsftpd_user_conf\n</code></pre> <p>Cr\u00e9ez le fichier des permissions pour <code>clientvm1-virtuel</code> :</p> <pre><code>[srvlan@srvlan:~$] cd vsftpd_user_conf\n[srvlan@srvlan:~$] sudo nano clientvm1-virtuel\n</code></pre> <p>et entrez pour cet utilisateur les permissions suivantes :</p> <pre><code># Configuration vsftpd de l'utilisateur \"clientvm1-virtuel\"\n# Param\u00e9trage pour les m\u00eames droits qu'un utilisateur local\n\n# Activation de l'utilisateur comme utilisateur virtuel\nguest_enable=YES\n\n# Ecriture autoris\u00e9e\nwrite_enable=YES\n\n# Modification et suppression autoris\u00e9es\nanon_other_write_enable=YES\n\n# Download autoris\u00e9 m\u00eame si un fichier\n# n'est pas en lecture pour tous\nanon_world_readable_only=NO\n\n# Dossier dans lequel sera enferm\u00e9 l'utilisateur\nlocal_root=/home/ftp/clientvm1-virtuel \n</code></pre> <p>Cr\u00e9ez maintenant son dossier personnel :</p> <pre><code>[srvlan@... ~$] cd /home/ftp\n[srvlan@... ~$] sudo mkdir clientvm1-virtuel\n\n[srvlan@... ~$] sudo chown userftps:grftps clientvm1-virtuel\n[srvlan@... ~$] sudo chmod 755 clientvm1-virtuel \n</code></pre> <p>Cr\u00e9ez une note qui permettra d'identifier le dossier :</p> <pre><code>[srvlan@srvlan:~$] cd /home/ftp/clientvm1-virtuel\n[srvlan@srvlan:~$] sudo nano note-clientvm1-virtuel \n</code></pre> <p>et entrez le texte suivant :</p> <pre><code>Ici, dossier FTP personnel de \"clientvm1-virtuel\".\n</code></pre> <p>Effectuez les m\u00eames op\u00e9rations que ci-dessus pour l'utilisateur virtuel <code>clientvm2-virtuel</code>.</p>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#-test-de-connexion","title":"- Test de connexion","text":"<p>Editez le fichier de configuration de serveur FTP :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/vsftpd.conf\n</code></pre> <p>et ajoutez les lignes suivantes \u00e0 la fin de celui-ci :</p> <pre><code># Gestion des utilisateurs virtuels\nguest_username=userftps\nuser_config_dir=/etc/vsftpd/vsftpd_user_conf\nvirtual_use_local_privs=YES\n</code></pre> <p>Mappage sur l'utilisateur <code>userftps</code> et attribution des m\u00eames privil\u00e8ges que ceux des utilisateurs locaux de <code>srvlan</code>.</p> <p>Red\u00e9marrez le serveur :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart vsftpd\n</code></pre> <p>Cr\u00e9ez depuis FileZilla les sites srvlan-clientvm*-virtuel sur les VM <code>debian12-vm*</code> comme suit :</p> <p>- Onglet G\u00e9n\u00e9ral -&gt; H\u00f4te -&gt; srvlan -&gt; Chiffrement -&gt; Connexion FTP explicite sur TLS si ... -&gt; Type d'authentification -&gt; Normale -&gt; Utilisateur -&gt; clientvm1-virtuel ou clientvm2-virtuel -&gt; Mot de passe -&gt; MDP de clientvm1-virtuel ou clientv...</p> <p>Pour les MDP, voir le \u00a7 5.1.</p> <p>- Onglet Avanc\u00e9 -&gt; Dossier local par d\u00e9faut -&gt; Parcourir... -&gt; S\u00e9lectionnez /home/client-linux/Documents -&gt; Bouton Valider</p> <p>V\u00e9rifiez apr\u00e8s connexion que chaque utilisateur virtuel : - Peut Transf\u00e9rer des fichiers dans les 2 sens. - Peut Supprimer/Modifier ses d\u00e9p\u00f4ts sur <code>srvlan</code>. - Reste bien enferm\u00e9 dans son dossier personnel.</p> <p>V\u00e9rifiez que chaque dossier/fichier d\u00e9pos\u00e9 sur <code>srvlan</code> est bien mapp\u00e9 sur l'utilisateur <code>userftps</code> :</p> <pre><code>[srvlan@srvlan:~$] ls -l /home/ftp/clientvm1-virtuel\n[srvlan@srvlan:~$] ls -l /home/ftp/clientvm2-virtuel\n</code></pre>"},{"location":"blog/ftps-avec-vsftpd---vboxdeb12/#configuration-preferentielle","title":"Configuration pr\u00e9f\u00e9rentielle","text":"<p>En l'\u00e9tat, le serveur FTP accepte les connexions d'utilisateurs anonymes, locaux et virtuels.</p> <p>Vous l'avez compris, la connexion authentifi\u00e9e d'utilisateurs virtuels est la plus s\u00e9curis\u00e9e des 3.</p> <p>Pour ne traiter que celle-ci, appliquez dans vsftpd.conf :</p> <pre><code>anonymous_enable=NO              # Acc\u00e8s anonyme interdit\n</code></pre> <p>Editez ensuite le fichier de configuration PAM :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/pam.d/vsftpd\n</code></pre> <p>et commentez ces 4 lignes d\u00e9di\u00e9es utilisateurs locaux :</p> <pre><code># @include common-account\n# @include common-session\n# @include common-auth\n# auth      required      pam_shells.so\n</code></pre> <p>La 2\u00e8me ligne de ce fichier fait r\u00e9f\u00e9rence au fichier /etc/ftpusers. Pour info, celui-ci contient une liste par d\u00e9faut d'utilisateurs locaux n'ayant pas le droit de se connecter sur le service FTP.</p> <p>On pourrait encore augmenter la s\u00e9curit\u00e9 (changement de n\u00b0 de port FTP, filtrage IP, adresses IP virtuelles, etc...) mais la connexion authentifi\u00e9e d'utilisateurs virtuels est un bon d\u00e9but.</p> <p></p> <p>  Repos m\u00e9rit\u00e9, respirez ! Le m\u00e9mento 10.1 propose de rendre le r\u00e9seau plus coh\u00e9rent avec entre autres la cr\u00e9ation d'un DNS split.</p> <p>M\u00e9mento 10.1</p>"},{"location":"blog/lamp---vboxdeb12-12/","title":"LAMP - VBox/Deb12 1/2","text":""},{"location":"blog/lamp---vboxdeb12-12/#memento-81-web-php-mysql","title":"M\u00e9mento 8.1 - Web PHP MySQL","text":"<p>Le service LAMP sera install\u00e9 sur la VM <code>srvdmz</code>.</p> <p>Il permettra de cr\u00e9er un site Web reposant sur : Linux + Apache + MySQL + PHP (LAMP)</p>"},{"location":"blog/lamp---vboxdeb12-12/#preambule","title":"Pr\u00e9ambule","text":"<p>Logiciels utilis\u00e9s \u00e0 l'int\u00e9rieur des parties 1 et 2 : - Apache pour diffuser les pages web. - PHP pour g\u00e9n\u00e9rer les pages web dynamiques. - MySQL/MariaDB pour stocker le contenu des pages. - OpenSSL pour s\u00e9curiser le protocole HTTP (HTTPS). - Adminer pour g\u00e9rer la base de donn\u00e9es MySQL. - CMS Dotclear pour cr\u00e9er facilement un blog complet.</p>"},{"location":"blog/lamp---vboxdeb12-12/#-fichier-dns-hosts","title":"- Fichier DNS hosts","text":"<p>FQDN (Fully Qualified Domain Name) = Nom de domaine pleinement qualifi\u00e9.</p> <p>Cr\u00e9ez celui de <code>srvdmz</code> en \u00e9ditant son fichier DNS hosts :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/hosts\n</code></pre> <p>et en le modifiant comme ci-dessous :</p> <pre><code>127.0.0.1    localhost\n127.0.1.1    srvdmz.loupvirtuel.fr srvdmz\n\n# IP de srvdmz     +  FQDN       + nom d'h\u00f4te  + domaine\n192.168.4.2  srvdmz.loupvirtuel.fr  srvdmz  loupvirtuel.fr\n</code></pre> <p>Ne touchez pas au bloc de lignes concernant l'IPv6.</p> <p>Testez la prise en compte du FQDN :</p> <pre><code>[srvdmz@srvdmz:~$] hostname --fqdn\n</code></pre> <p>Retour :</p> <pre><code>srvdmz.loupvirtuel.fr\n</code></pre> <p>Apache aura besoin du FQDN de <code>srvdmz</code> pour s'installer sans erreur.</p>"},{"location":"blog/lamp---vboxdeb12-12/#service-lamp","title":"Service LAMP","text":""},{"location":"blog/lamp---vboxdeb12-12/#-maj-du-systeme-debian","title":"- MAJ du syst\u00e8me Debian","text":"<pre><code>[srvdmz@srvdmz:~$] sudo apt update\n[srvdmz@srvdmz:~$] sudo apt upgrade\n[srvdmz@srvdmz:~$] sudo reboot\n[srvdmz@srvdmz:~$] sudo apt autoremove --purge\n[srvdmz@srvdmz:~$] cat /etc/debian_version\n</code></pre> <p>La derni\u00e8re Cde doit retourner le num\u00e9ro de la version Debian courante.</p>"},{"location":"blog/lamp---vboxdeb12-12/#-apache","title":"- Apache","text":"<p>Installez le paquet apache2 :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install apache2\n</code></pre> <p>et contr\u00f4lez le num\u00e9ro de la version install\u00e9e :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apache2 -v \n</code></pre> <p>Retour :</p> <pre><code>Server version: Apache/2.4.57 (Debian)\nServer built:   2023-04-13T03:26:51 -v \n</code></pre> <p>Puis v\u00e9rifiez le d\u00e9marrage automatique du serveur :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl status apache2  \n</code></pre> <p>Retour :</p> <pre><code>\u25cf apache2.service - The Apache HTTP Server\n     Loaded: loaded (/.../apache2...enabled; ...\n     Active: active (running) since Mon 2024-04...\n       Docs: https://httpd.apache.org/docs/2.4/\n   Main PID: 3386 (apache2)\n      Tasks: 55 (limit: 1077)\n     Memory: 9.1M\n        CPU: 145ms\n     CGroup: /system.slice/apache2.service\n             \u251c\u25003386 /usr/sbin/apache2 -k start\n             \u251c\u25003388 /usr/sbin/apache2 -k start\n             \u2514\u25003389 /usr/sbin/apache2 -k start\n\navril 15 ... srvdmz systemd[1]: Starting ..\navril 15 ... srvdmz systemd[1]: Started ...  \n</code></pre> <p>et la bonne syntaxe de ses fichiers de configuration :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apache2ctl -t  \n</code></pre> <p>Retour :</p> <pre><code>Syntax OK  \n</code></pre> <p>Enfin, depuis la VM <code>Debian12-vm1</code>, testez l'URL : <code>http://192.168.4.2</code></p> <p> </p> Apache : Accueil /var/www/html/index.html <p>Pour jouer, remplacez l'accueil ci-dessus comme suit :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/www/html \n[srvdmz@srvdmz:~$] sudo  mv index.html index.html.origine\n[srvdmz@srvdmz:~$] sudo  touch index.html\n[srvdmz@srvdmz:~$] sudo  nano index.html  \n</code></pre> <p>et remplissez le nouvel index.html avec ce contenu :</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;&lt;meta charset=\"utf-8\"&gt;&lt;/head&gt;\n&lt;title&gt;Loup Virtuel&lt;/title&gt;\n&lt;body style=\"background-color:#ADEAFF\"&gt;\n\n&lt;h1 style=\"color:#000000\"&gt;\nAccueil Web du site Loup Virtuel &lt;i&gt;(Debian 12)&lt;/i&gt;\n&lt;/h1&gt;\n\n&lt;p style=\"font-size:28px;\"&gt;\nCette page Web remplace celle fournie par Apache.\n&lt;/p&gt;\n\n&lt;p&gt;Fin&lt;/p&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;  \n</code></pre> <p>Pour finir, testez de nouveau l'URL : <code>http://192.168.4.2</code></p> <p> </p> Apache : Page d'accueil personnalis\u00e9e"},{"location":"blog/lamp---vboxdeb12-12/#-php","title":"- PHP","text":"<p>Installez le paquet php :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install php \n</code></pre> <p>Cr\u00e9ez ensuite un fichier de contr\u00f4le phpinfo.php :</p> <pre><code>[srvdmz@srvdmz:~$] sudo touch /var/www/html/phpinfo.php \n</code></pre> <p>Editez celui-ci :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /var/www/html/phpinfo.php \n</code></pre> <p>et entrez le contenu ci-dessous :</p> <pre><code>&lt;?php phpinfo(); ?&gt; \n</code></pre> <p>Puis, depuis la VM <code>srvlan</code>, testez l'URL : <code>http://192.168.4.2/phpinfo.php</code></p> <p> </p> PHP : Page Web Infos PHP <p>Les Cdes suivantes afficheront la version de PHP ainsi que la liste des modules PHP install\u00e9s :</p> <pre><code>[srvdmz@srvdmz:~$] php -v\n[srvdmz@srvdmz:~$] php -m \n</code></pre>"},{"location":"blog/lamp---vboxdeb12-12/#titre-mysql","title":"- MySQL","text":"<p>MariaDB est un moteur de Bdd reposant sur MySQL.</p> <p>Installez le paquet suivant :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install mariadb-server\n</code></pre> <p>V\u00e9rifiez le d\u00e9marrage automatique du serveur MySQL :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl status mariadb \n</code></pre> <p>Retour :</p> <pre><code>\u25cf mariadb.service - MariaDB 10.11.6 database server\n   Loaded: loaded (/lib/.../mariadb.se... enabled; ...\n   Active: active (running) since Mon 2024-04... ago\n     Docs: man:mariadbd(8)\n           https://mariadb.com/kb/en/library/systemd/\n Main PID: 10720 (mariadbd)\n   Status: \"Taking your SQL requests now...\"\n   Tasks: 10 (limit: 1077)\n   Memory: 91.3M\n      CPU: 709ms\n   CGroup: /system.slice/mariadb.service\n             \u2514\u250010720 /usr/sbin/mariadbd\n\n...\n... srvdmz mariadbd.../mariadbd: ready for connections.\n... srvdmz mariadbd... '/run/mysqld/mysqld.sock' ... 3306\n... srvdmz systemd... Started mariadb.service - Maria...\n... srvdmz /etc/mysql/debian... Checking ... root accounts. \n</code></pre> <p>puis modifiez en partie ses param\u00e8tres de s\u00e9curit\u00e9 :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mysql_secure_installation  \n</code></pre> <p>en traitant le retour de la Cde ci-dessus comme suit :</p> <pre><code>NOTE: RUNNING ALL PARTS OF THIS ... FOR ALL MariaDB\n      SERVERS IN PRODUCTION USE! PLEAS... CAREFULLY!\n\nIn order to log into MariaDB to secur... the current\npassword ...  If you've just installed MariaDB, and\nhaven't set the root ... just press enter here.\n\nEnter ... password for root ... : Appuyez sur Entr\u00e9e\nOK, successfully used password, moving on...\n\nSetting the root password or ... unix_socket ... nobody\ncan log into the MariaDB root user with... authorisation.\n\nYou already ... root ... protected, ... answer 'n'.\n\nSwitch to unix_socket authentication [Y/n] n\n ... skipping.\n\nYou already ... root ... protected, ... answer 'n'.\n\nChange the root password? [Y/N] y      \nNew password: Votre MDP pour le root de MySQL\nRe-enter new password: \nPassword updated successfully!\nReloading privilege tables..\n ... Success!\n\n\nBy default, a MariaDB installa..., allowing anyone\nto log into MariaDB without ... account created for\nthem.  This is intended ... to make the installation\ngo a bit smoother.  You shou... before moving into a\nproduction environment.\n\nRemove anonymous users? [Y/n] y\n ... Success! Acc\u00e8s anonymous d\u00e9sactiv\u00e9\n\nNormally, root should ... from 'localhost'.  This\nensures that ... the root password from the network.\n\nDisallow root login remotely? [Y/n] n\n ... skipping. Acc\u00e8s root distant conserv\u00e9\n\nBy default, MariaDB ... named 'test' that anyone can\naccess.  This is also ...ting, and should be removed\nbefore moving into a production environment.\n\nRemove test database and access to it? [Y/n] n \n ... skipping. Bdd test conserv\u00e9e pour des tests\n\nReloading the privilege tables ... made so far\nwill take effect immediately.\n\nReload privilege tables now? [Y/n] y\n ... Success!\n\nCleaning up...\n\nAll done!  If you've completed ... your MariaDB\ninstallation should now be secure.\n\nThanks for using MariaDB!  \n</code></pre> <p>Testez une connexion locale en tant que root MySQL :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mysql -u root -p\n[sudo] Mot de passe de srvdmz :\nEnter password: Peu importe, MariaDB g\u00e9rant par d\u00e9faut root avec son plugin unix_socket \n</code></pre> <p>Retour :</p> <pre><code>Welcome to the MariaDB monitor.  Commands end wit...\nYour MariaDB connection id is 36\nServer version: 10.11.6-MariaDB-0+deb12u1 Debian 12 \n\nCopyright (c) 2000, 2018, Oracle, MariaDB Corpora...\n\nType 'help;' or '\\h' for help. Type '\\c' to clear ..\n\nMariaDB [(none)]&gt; quit\nBye \n</code></pre> <p>Un prompt d'acc\u00e8s \u00e0 la console MysQL s'affiche. Utilisez la Cde quit pour quitter.</p> <p>Pour tester une connexion distante, commencez par \u00e9ditez le fichier 50-server.cnf :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/mysql/mariadb.conf.d\n[srvdmz@srvdmz:~$] sudo nano 50-server.cnf \n</code></pre> <p>et remplacez la ligne bind-address = 127.0.0.1 par :</p> <pre><code>bind-address = 192.168.4.2            # IP du serveur MySQL \n</code></pre> <p>Reconnectez-vous localement et cr\u00e9ez une Bdd parc :</p> <pre><code>MariaDB [(none)]&gt; CREATE DATABASE parc;\n</code></pre> <p>Touche Entr\u00e9e apr\u00e8s le point-virgule.</p> <p>Retour :</p> <pre><code>Query OK, 1 row affected (0.001sec)\n\nMariaDB [(none)]&gt; \n</code></pre> <p>Cr\u00e9ez maintenant un utilisateur <code>mysqluserdist</code> autoris\u00e9 \u00e0 g\u00e9rer celle-ci depuis la VM <code>srvlan</code> :</p> <pre><code>MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON parc.* TO mysqluserdist@'192.168.2.2' IDENTIFIED BY 'le MDP que vous voulez ';\n</code></pre> <p>Touche Entr\u00e9e apr\u00e8s le point-virgule.</p> <p>Retour :</p> <pre><code>Query OK, 0 row affected (0.003sec)\n\nMariaDB [(none)]&gt; quit\n</code></pre> <p>Red\u00e9marrez MySQL :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart mariadb   \n</code></pre> <p>Allez sur <code>srvlan</code>, installez le paquet mariadb-client :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install mariadb-client   \n</code></pre> <p>et testez une connexion distante sur le serveur MySQL :</p> <pre><code>[srvlan@srvlan:~$] mysql -u mysqluserdist -p -h 192.168.4.2\nEnter password: Entrez le MDP de l'utilisateur mysqluserdist   \n</code></pre> <p>Retour :</p> <pre><code>Welcome to the MariaDB monitor.  Commands end wit...\nYour MariaDB connection id is 31\nServer version: 10.11.6-MariaDB-0+deb12u1 Debian 12\n\nCopyright (c) 2000, 2018, Oracle, MariaDB Corpora...\n\nType 'help;' or '\\h' for help. Type '\\c' to clear ..\n\nMariaDB [(none)]&gt;   \n</code></pre> <p>Listez les Bdd visibles pour <code>mysqluserdist</code> :</p> <p> </p> MySQL : Retour Cde SHOW DATABASES"},{"location":"blog/lamp---vboxdeb12-12/#adminer","title":"Gestionnaire de Bdd Adminer","text":"<p>Cet outil plus l\u00e9ger que phpMyAdmin permettra d'administrer les Bdd du serveur MySQL facilement, ceci en local ou \u00e0 distance via une interface Web.</p> <p>Installez le paquet adminer :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install adminer\n</code></pre> <p>Un fichier de configuration adminer.conf a \u00e9t\u00e9 cr\u00e9\u00e9 dans /etc/apache2/conf-available/.</p> <p>Demandez \u00e0 Apache de prendre en compte le fichier :</p> <pre><code>[srvdmz@srvdmz:~$] sudo a2enconf adminer.conf \n</code></pre> <p>et rechargez la configuration pour traitement :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl reload apache2 \n</code></pre>"},{"location":"blog/lamp---vboxdeb12-12/#-acces-distant-sur-mysql","title":"- Acc\u00e8s distant sur MySQL","text":"<p>Depuis la VM <code>debian12-vm1</code>, testez l'URL : <code>http://192.168.4.2/adminer</code></p> <p> </p> Adminer : Fen\u00eatre de connexion <p>Utilisez pour l'utilisateur <code>root</code> le MDP cr\u00e9\u00e9 au \u00a7 MySQL avec mysql_secure_installation.</p> <p> </p> Adminer : Fen\u00eatre d'administration"},{"location":"blog/lamp---vboxdeb12-12/#test-global-du-serveur-lamp","title":"Test global du serveur LAMP","text":"<p>Ce test fera appel \u00e0 un script PHP que vous allez \u00e9crire et ex\u00e9cuter.</p> <p>Le script ouvrira une connexion sur la Bdd parc cr\u00e9\u00e9e ci-dessus et permettra d'afficher sur une page Web le contenu d'une table de nom PC.</p> <p>Connectez-vous localement sans utiliser la Cde sudo :</p> <pre><code>[srvdmz@srvdmz:~$] mysql -u root -p\nEnter password : MDP root cr\u00e9\u00e9 au paragraphe 2.4 \n</code></pre> <p>et entrez les Cdes SQL suivantes pour cr\u00e9er, remplir et afficher la table PC :</p> <pre><code>MariaDB [none]&gt; USE parc;\n\nMariaDB [parc]&gt; CREATE TABLE PC (Ligne INTEGER NOT NULL PRIMARY KEY);\n\nMariaDB [parc]&gt; ALTER TABLE PC ADD COLUMN H\u00f4te VARCHAR(20);\nMariaDB [parc]&gt; ALTER TABLE PC ADD COLUMN OS VARCHAR(20);\nMariaDB [parc]&gt; ALTER TABLE PC ADD COLUMN Zone VARCHAR(10); \n\nMariaDB [parc]&gt; INSERT INTO PC VALUES (1,'srvsec','Linux From Scratch','WAN');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (2,'srvdmz','Debian 12','DMZ');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (3,'srvlan','Debian 12','LAN');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (4,'ovs','Debian 12','LAN');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (5,'debian12-vm1','Debian 12','LAN');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (6,'debian12-vm2','Debian 12','LAN');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (7,'ctn1','Debian 12','LAN');\nMariaDB [parc]&gt; INSERT INTO PC VALUES (8,'ctn2','Debian 10','LAN');\n\nMariaDB [parc]&gt; SELECT * FROM PC; \n</code></pre> <p>Retour de la derni\u00e8re requ\u00eate SQL :</p> <p> </p> MySQL : Retour Cde SELECT * FROM PC <p>Maintenant, cr\u00e9ez et \u00e9ditez le script testweb.php :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/www/html\n[srvdmz@srvdmz:~$] sudo touch testweb.php\n[srvdmz@srvdmz:~$] sudo nano testweb.php  \n</code></pre> <p>puis entrez le code HTML et PHP suivant :</p> <pre><code>&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;meta charset=\"utf-8\"&gt;\n&lt;title&gt;Test Web-PHP-MySQL VM srvdmz&lt;/title&gt;\n&lt;/head&gt;\n&lt;body style=\"background-color:#F2F2BB\"&gt;\n&lt;h2 style=\"color:brown\"&gt;Test global du serveur Apache&lt;/h2&gt;\n&lt;p&gt;Exemple d'une page Web dynamique :&lt;/p&gt;\n&lt;p&gt;Apache affiche les r\u00e9ponses de MySQL \u00e0 propos&lt;br /&gt;\nde la Bdd 'parc' interrog\u00e9e par PHP.&lt;/p&gt;&lt;br /&gt;\n&lt;table border=1&gt;\n&lt;caption&gt;Affichage de la table 'PC'&lt;/caption&gt;\n&lt;tr&gt;\n&lt;th&gt;Ligne&lt;/th&gt;&lt;th&gt;H\u00f4te&lt;/th&gt;&lt;th&gt;OS&lt;/th&gt;&lt;th&gt;Zone&lt;/th&gt;\n&lt;/tr&gt;\n&lt;?php\n// Connexion sur le serveur MySQL\n$srv = \"localhost\"; $user = \"root\";\n$pass = \"votre MDP MySQL pour root\"; $bdd = \"parc\";\n$conn = mysqli_connect($srv,$user,$pass,$bdd,) or die (\"Connexion MySQL impossible...\");\n// Gestion des accents inclus dans les requ\u00eates SQL\nmysqli_set_charset($conn,\"utf8\");\n// S\u00e9lection des enregistrements de la table 'PC' et\n// envoi du r\u00e9sultat\n$query = \"SELECT * FROM PC\";\n$result = mysqli_query($conn,$query) or die (\"Echec sur la table PC...\");\n// Insertion des lignes d'enregistrements trouv\u00e9es\n// dans un tableau HTML\nwhile ($ligne = mysqli_fetch_array ($result))\n{\necho \"&lt;tr&gt;&lt;td&gt;\" . $ligne [\"Ligne\"] . \"&amp;nbsp;&amp;nbsp;&lt;/td&gt;\";\necho \"&lt;td&gt;\" . $ligne [\"H\u00f4te\"] . \"&amp;nbsp;&amp;nbsp;&lt;/td&gt;\";\necho \"&lt;td&gt;\" . $ligne [\"OS\"] . \"&amp;nbsp;&amp;nbsp;&lt;/td&gt;\";\necho \"&lt;td&gt;\" . $ligne [\"Zone\"] . \"&amp;nbsp;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;\";\n}\n// Fermeture de la connexion\nmysqli_close($conn);\n?&gt;\n&lt;/table&gt;\n&lt;/body&gt;\n&lt;/html&gt;  \n</code></pre> <p>Testez, cette fois depuis la VM <code>srvlan</code>, l'URL : <code>http://192.168.4.2/testweb.php</code></p> <p> </p> Apache : Ex\u00e9cution du script testweb.php <p>Nota</p> <p>Un m\u00e9mento futur traitera de l'acc\u00e8s au serveur Web depuis Internet.</p> <p></p> <p>  Voil\u00e0 pour la cr\u00e9ation de base d'un site Web PHP MySQL. La partie 2 vous attend pour la cr\u00e9ation d'un blog Dotclear s\u00e9curis\u00e9 HTTPS.</p> <p>M\u00e9mento 8.1 - Partie 2/2</p>"},{"location":"blog/lamp---vboxdeb12-22/","title":"LAMP - VBox/Deb12 2/2","text":""},{"location":"blog/lamp---vboxdeb12-22/#memento-81-https-ssltls","title":"M\u00e9mento 8.1 - HTTPS (SSL/TLS)","text":""},{"location":"blog/lamp---vboxdeb12-22/#https","title":"Protocole HTTPS","text":"<p>Ce protocole servira \u00e0 garantir la s\u00e9curit\u00e9 et l\u2019int\u00e9grit\u00e9 des informations \u00e9chang\u00e9es entre le site <code>loupvirtuel.fr</code> et les navigateurs Web.</p> <p>HTTPS combinera le HTTP avec une couche de chiffrement SSL/TLS.</p> <p>Vous utiliserez, pour le chiffrement, l'outil openssl install\u00e9 avec Apache.</p> <p>Les cl\u00e9s et certificats d\u00e9di\u00e9s au HTTPS seront cr\u00e9\u00e9s dans le dossier /etc/ssl/.</p> <p>Le domaine <code>loupvirtuel.fr</code> \u00e9tant fictif, impossible de demander \u00e0 une Autorit\u00e9 de Certification existante de le valider. Il faudra en cr\u00e9er une localement.</p>"},{"location":"blog/lamp---vboxdeb12-22/#-certificat-pem-ca","title":"- Certificat PEM (CA)","text":"<p>CA = Certificate Authority (Autorit\u00e9 de Certification) PEM = Format de texte cod\u00e9 en Base64</p> <p>Cr\u00e9ez une cl\u00e9 priv\u00e9e contenant un MDP pour le CA :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/ssl \n[srvdmz@srvdmz:~$] sudo openssl genrsa -aes128 -out loupvirtuel-ca.key 2048 \n</code></pre> <p>G\u00e9rez le retour ainsi :</p> <pre><code>Enter PEM pass phrase: Ce que vous voulez\nVerifying - Enter PEM pass phrase:\n</code></pre> <p>et g\u00e9n\u00e9rez le certificat CA X.509 associ\u00e9 \u00e0 cette cl\u00e9 :</p> <pre><code>[srvdmz@srvdmz:~$] sudo openssl req -x509 -new -nodes -key loupvirtuel-ca.key -sha256 -days 3650 -out loupvirtuel-ca.pem \n</code></pre> <p>G\u00e9rez le retour pour le Certificate Authority ainsi :</p> <pre><code>Enter pass ... loupvirtuel-ca.key: Votre pass phrase CA\nYou are about ...\n-----\nCountry Name (2 letter code) [AU]:FR\nState or Province Name (full name) [Some-State]:Ain\nLocality Name (eg, city) []:Bourg-en-Bresse           \nOrganization Name (eg...) [Internet ... Ltd]:Internet-CA\nOrganizational Unit Name (eg...) []:Labo Certificats CA\nCommon Name (e.g... FQDN ...) []:internet-ca.org\nEmail Address []:Rien -&gt; Touche Entr\u00e9e\n</code></pre>"},{"location":"blog/lamp---vboxdeb12-22/#-certificats-csrcrt","title":"- Certificats CSR/CRT","text":"<p>Cr\u00e9ez une cl\u00e9 priv\u00e9e pour le serveur Apache :</p> <pre><code>[srvdmz@srvdmz:~$] sudo openssl genrsa -out loupvirtuel.key 2048  \n</code></pre> <p>et g\u00e9n\u00e9rez le certificat CSR associ\u00e9 \u00e0 cette cl\u00e9 :</p> <pre><code>[srvdmz@srvdmz:~$] sudo openssl req -new -key loupvirtuel.key -out loupvirtuel.csr   \n</code></pre> <p>G\u00e9rez le retour pour le Certificate Signing Request ainsi :</p> <pre><code>You are about ...\n-----\nCountry Name (2 letter code) [AU]:FR\nState or ... Name (full name) [Some...]:Var\nLocality Name (eg, city) []:Cuers\nOrganization Name (eg...) [Internet ... Ltd]:InfoLoup\nOrganizational Unit Name (eg...) []:Blog Loup Virtuel\nCommon Name (e.g... FQDN ...) []:loupvirtuel.fr\nEmail Address []:admin@loupvirtuel.fr\n\nPlease enter ...\n-----\nA challenge password []:Rien -&gt; Touche Entr\u00e9e\nAn optional company name []:Rien -&gt; Touche Entr\u00e9e\n</code></pre> <p>Le certificat CSR sera trait\u00e9 par le CA comme une demande de signature.</p> <p>Il est recommand\u00e9 aujourd'hui d'ajouter l'extension d'identification de noms de domaines alternatifs (subjectAltName) \u00e0 la demande de signature.</p> <p>Pour cela, cr\u00e9ez un fichier d'extension de nom csr.ext :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano csr.ext   \n</code></pre> <p>et entrez ce contenu r\u00e9pondant \u00e0 la norme X509v3 :</p> <pre><code>authorityKeyIdentifier=keyid,issuer \nbasicConstraints=CA:FALSE\nkeyUsage = nonRepudiation, digitalSignature, keyEncipherment, dataEncipherment\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1 = loupvirtuel.fr\nDNS.2 = localhost\nDNS.3 = srvdmz.loupvirtuel.fr\nIP.1 = 127.0.0.1 \n</code></pre> <p>Enfin, traitez le CSR et son extension en g\u00e9n\u00e9rant un certificat CRT final sign\u00e9 pour Apache :</p> <pre><code>[srvdmz@srvdmz:~$] sudo openssl x509 -req -in loupvirtuel.csr -CA loupvirtuel-ca.pem -CAkey loupvirtuel-ca.key -CAcreateserial  -out loupvirtuel.crt -days 3650 -sha256 -extfile csr.ext    \n</code></pre> <p>Retour pour le certificat final (CRT) :</p> <pre><code>Certificate request self-signature ok\nsubject=C = FR, ST = Var, L = Cuers, O = InfoLoup, OU = Blog Loup Virtuel, CN = loupvirtuel.fr, emailAddress = admin@loupvirtuel.fr\nEnter pass ... loupvirtuel-ca.key: Votre pass phrase CA \n</code></pre> <p>Nota</p> <p>C'est en tant que CA (autorit\u00e9 de certification) que vous venez de g\u00e9n\u00e9rer le certificat CRT.</p> <p>Bilan des cl\u00e9s et certificats cr\u00e9\u00e9s dans /etc/ssl/ :</p> <ul> <li>loupvirtuel-ca.key</li> <li>loupvirtuel-ca.pem</li> <li>loupvirtuel.key</li> <li>loupvirtuel.csr</li> <li>csr.ext</li> <li>loupvirtuel-ca.srl</li> <li>loupvirtuel.crt</li> </ul>"},{"location":"blog/lamp---vboxdeb12-22/#-certificat-pem-dans-firefox","title":"- Certificat PEM dans Firefox","text":"<p>Afin que le HTTPS fonctionne sans alerte avec un certificat CA auto-sign\u00e9, il est n\u00e9cessaire d'importer celui-ci dans la configuration du navigateur Web Firefox.</p> <p>Pour cela, acc\u00e9dez aux Param\u00e8tres du navigateur Web : -&gt; Vie priv\u00e9e et s\u00e9curit\u00e9 -&gt; Certificats -&gt; Bouton Afficher les certificats...</p> <p>Une fen\u00eatre Gestionnaire de certificats s'ouvre : -&gt; Onglet Autorit\u00e9s -&gt; Bouton Importer...</p> <p>-&gt; /etc/ssl/ -&gt; S\u00e9lectionnez loupvirtuel-ca.pem -&gt; Ouvrir</p> <p>Une fen\u00eatre T\u00e9l\u00e9chargement du certificat s'ouvre : -&gt; Cochez les 2 demandes de confirmation -&gt; OK -&gt; OK</p> <p>Vous devriez \u00e0 pr\u00e9sent trouver dans la liste des autorit\u00e9s g\u00e9r\u00e9es par Firefox l'Autorit\u00e9 de Certification de nom Internet-CA.</p>"},{"location":"blog/lamp---vboxdeb12-22/#-hote-virtuel-et-test-https","title":"- H\u00f4te virtuel et test HTTPS","text":"<p>Au pr\u00e9alable, demandez \u00e0 Apache de prendre en compte son module ssl :</p> <pre><code>[srvdmz@srvdmz:~$] sudo a2enmod ssl    \n</code></pre> <p>Retour :</p> <pre><code>Considering dependency setenvif for ssl:\nModule setenvif already enabled\nConsidering dependency mime for ssl:\nModule mime already enabled\nConsidering dependency socache_shmcb for ssl:\nEnabling module socache_shmcb.\nEnabling module ssl.\nSee /usr/share/doc/apache2/README.Debian.gz on ...\nTo activate the new configuration, you need to run:\n  systemctl restart apache2    \n</code></pre> <p>Cr\u00e9ez maintenant un h\u00f4te virtuel de nom loupvirtuel :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/apache2/sites-available\n[srvdmz@srvdmz:~$] sudo touch loupvirtuel.conf    \n</code></pre> <p>Editez celui-ci :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano loupvirtuel.conf     \n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>&lt;VirtualHost *:80&gt;\nServerName loupvirtuel.fr\nServerAlias www.loupvirtuel.fr srvdmz.loupvirtuel.fr\nRedirect permanent / https://loupvirtuel.fr/\n&lt;/VirtualHost&gt;\n\n&lt;VirtualHost *:443&gt;\n\nDocumentRoot /var/www/html/\nServerName loupvirtuel.fr\n\n&lt;Directory /var/www/html/&gt;\n     Options -Indexes +FollowSymlinks +MultiViews\n     AllowOverride None\n     Require all granted\n&lt;/Directory&gt;\n\nErrorLog /var/log/apache2/loupvirtuel.error.log\nCustomLog /var/log/apache2/loupvirtuel.access.log combined\n\nSSLEngine On\nSSLOptions +FakeBasicAuth +ExportCertData +StrictRequire\nSSLCertificateFile /etc/ssl/loupvirtuel.crt\nSSLCertificateKeyFile /etc/ssl/loupvirtuel.key\n\n&lt;/VirtualHost&gt;     \n</code></pre> <p>Demandez ensuite \u00e0 Apache de traiter cet h\u00f4te virtuel :</p> <pre><code>[srvdmz@srvdmz:~$] sudo a2ensite loupvirtuel     \n</code></pre> <p>et red\u00e9marrez celui-ci :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart apache2     \n</code></pre> <p>Testez depuis le navigateur Firefox l'URL : <code>https://loupvirtuel.fr</code></p> <p>Cliquez ensuite sur le cadenas de la barre d'adresse puis sur la ligne Connexion s\u00e9curis\u00e9e :</p> <p> </p> HTTPS : Site loupvirtuel.fr s\u00e9curis\u00e9 <p>Cliquez enfin sur la ligne Plus d'informations et sur Afficher le certificat :</p> <p> </p> HTTPS : D\u00e9tail du certificat SSL pour loupvirtuel.fr <p>Les 2 captures ci-dessus montrent le site <code>loupvirtuel.fr</code> valid\u00e9 HTTPS.</p> <p>Par curiosit\u00e9, compl\u00e9tez la v\u00e9rification SSL :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/ssl\n\n[srvdmz@srvdmz:~$] sudo openssl s_client \\\n-CAfile loupvirtuel-ca.pem -connect loupvirtuel.fr:443     \n</code></pre> <p>Le caract\u00e8re  indique d'\u00e9crire la Cde sur une seule ligne.</p> <p>Vous devriez trouver dans le retour et dans l'ordre : - depth =1 ... -&gt; verifiy return :1 - depth =0 ... -&gt; verifiy return :1 - SSL handshake ... -&gt; Verification : OK - New, TLSv1.3 ... -&gt; Verify return code: 0 (ok) - Post handshake ... -&gt; Verify return code: 0 (ok) - Post handshake ... -&gt; Verify return code: 0 (ok)</p> <p>Aucun message d'erreur ne doit appara\u00eetre.</p>"},{"location":"blog/lamp---vboxdeb12-22/#-tests-depuis-srvlan-etc","title":"- Tests depuis srvlan, etc...","text":"<p>La configuration actuelle exige, pour joindre le domaine <code>loupvirtuel.fr</code> depuis les VM <code>srvlan</code> et <code>debian12-vm*</code>, de modifier leurs fichiers DNS respectifs /etc/hosts.</p> <p>Editez chacun des 3 fichiers DNS et ajoutez cette ligne :</p> <pre><code>192.168.4.2     loupvirtuel.fr\n</code></pre> <p>Exemple pour le fichier hosts de la VM srvlan :</p> <pre><code>127.0.0.1      localhost\n127.0.1.1      srvlan\n192.168.3.1    srvlan.intra.loupipfire.fr srvlan\n192.168.4.2    loupvirtuel.fr\n</code></pre> <p>Puis, copiez le certificat CA dans le dossier partag\u00e9 :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/ssl\n[srvdmz@srvdmz:~$] sudo cp loupvirtuel-ca.pem /home/srvdmz/Partage/\n</code></pre> <p>et importez celui-ci dans les navigateurs Web des VM en proc\u00e9dant comme avec <code>srvdmz</code> mais en s\u00e9lectionnant le fichier loupvirtuel-ca.pem situ\u00e9 dans /home/srvlan/Partage/ ou /home/clientx2dlinux/Partage/.</p> <p>Pour finir, testez pour chacune des VM l'acc\u00e8s \u00e0 l'URL : <code>https://loupvirtuel.fr</code></p>"},{"location":"blog/lamp---vboxdeb12-22/#installation-du-cms-dotclear","title":"Installation du CMS Dotclear","text":"<p>CMS = Content Management System</p> <p>Dotclear est un moteur de blog fran\u00e7ais performant et facile d'utilisation que j'exploite personnellement pour g\u00e9rer mes notes techniques.</p>"},{"location":"blog/lamp---vboxdeb12-22/#-telechargement-extraction","title":"- T\u00e9l\u00e9chargement / Extraction","text":"<pre><code>[srvdmz@srvdmz:~$] cd /var/www/html\n[srvdmz@srvdmz:~$] sudo wget https://download.dotclear.net/latest.tar.gz\n\n[srvdmz@srvdmz:~$] sudo tar zxvf latest.tar.gz\n[srvdmz@srvdmz:~$] sudo rm latest.tar.gz\n</code></pre> <p>Un dossier dotclear a \u00e9t\u00e9 cr\u00e9\u00e9 dans /var/www/html.</p>"},{"location":"blog/lamp---vboxdeb12-22/#-preparation-de-linstallation","title":"- Pr\u00e9paration de l'installation","text":"<p>Cr\u00e9ez avec le gestionnaire Adminer une Bdd loupvirtuel d'interclassement utf8mb4_general_ci :</p> <p> </p> Adminer : Cr\u00e9ation d'une Bdd loupvirtuel <p>et ajoutez les modules PHP 8.2 suivants :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install php8.2-mbstring php8.2-gd php8.2-xml\n</code></pre> <p>Modifiez le propri\u00e9taire et le groupe du dossier dotclear :</p> <pre><code>[srvdmz@srvdmz:~$] sudo chown -R www-data:www-data /var/www/html/dotclear \n</code></pre> <p>Editez ensuite l'h\u00f4te virtuel loupvirtuel cr\u00e9\u00e9 ci-dessus :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/apache2/sites-available\n[srvdmz@srvdmz:~$] sudo nano loupvirtuel.conf   \n</code></pre> <p>et modifiez sa section  comme suit :</p> <pre><code>&lt;VirtualHost *:443&gt;\n\nDocumentRoot /var/www/html/dotclear/\nServerName loupvirtuel.fr\n\n&lt;Directory /var/www/html/dotclear/&gt;\n     Options -Indexes +FollowSymlinks +MultiViews\n     AllowOverride ALL\n     Require all granted\n&lt;/Directory&gt;\n\nErrorLog /var/log/apache2/loupvirtuel.error.log\nCustomLog /var/log/apache2/loupvirtuel.access.log combined\n\nSSLEngine On\nSSLOptions +FakeBasicAuth +ExportCertData +StrictRequire\nSSLCertificateFile /etc/ssl/loupvirtuel.crt\nSSLCertificateKeyFile /etc/ssl/loupvirtuel.key\n\n&lt;/VirtualHost&gt;     \n</code></pre> <p>Rechargez enfin la configuration de Apache :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl reload apache2  \n</code></pre> <p>Vous \u00eates maintenant pr\u00eat pour effectuer une installation de Dotclear sans incident.</p>"},{"location":"blog/lamp---vboxdeb12-22/#-installation-et-test","title":"- Installation et test","text":"<p>Ouvrez Firefox, videz son historique et lancez l'URL <code>https://loupvirtuel.fr</code>.</p> <p>Une page Assistant d'installation de Dotclear s'ouvre : -&gt; Type de base de donn\u00e9es : MySQLi -&gt; Nom d'h\u00f4te de la base de donn\u00e9es : localhost -&gt; Nom de la base de donn\u00e9es : loupvirtuel -&gt; Nom d'utilisateur de la base de donn\u00e9es : root -&gt; MDP de la base de donn\u00e9es : Votre MDP root Mysql -&gt; Pr\u00e9fixe des tables de la base de donn\u00e9es : dc_ -&gt; Email principal : Votre adresse Email personnelle</p> <p>-&gt; Bouton Continuer</p> <p>Une page Installation de Dotclear s'ouvre : - Informations utilisateur -&gt; Pr\u00e9nom : Votre pr\u00e9nom -&gt; Nom : Votre nom -&gt; Email : Votre adresse Email personnelle</p> <p>- Identifiant et mot de passe -&gt; Nom d'utilisateur : Ce que vous voulez -&gt; Nouveau mot de passe : Ce que vous voulez -&gt; Confirmer le mot de passe :</p> <p>-&gt; Bouton Enregistrer</p> <p>Si tout est OK, une page titr\u00e9e C'est termin\u00e9 ! s'affiche : -&gt; Bouton G\u00e9rer votre blog pour l'acc\u00e8s \u00e0 l'administration</p> <p> </p> Dotclear : Panneau d'administration <p>Le menu pour se d\u00e9connecter se situe en haut \u00e0 droite.</p> <p>Les URL \u00e0 retenir : <code>https://loupvirtuel.fr/admin/</code> pour administrer le site. <code>https://loupvirtuel.fr</code> pour parcourir le site.</p> <p>Amusez-vous maintenant avec Dotclear et cr\u00e9ez votre propre page d'accueil.</p> <p>Exemple de page d'accueil :</p> <p> </p> Dotclear : Page d'accueil de loupvirtuel.fr <p></p> <p>  Voil\u00e0 ! Termin\u00e9 pour ce grand chapitre. Le m\u00e9mento 9.1 vous attend pour d\u00e9couvrir l'usage du protocole SFTP.</p> <p>M\u00e9mento 9.1</p>"},{"location":"blog/open-vswitch---vboxdeb12/","title":"Open vSwitch - VBox/Deb12","text":""},{"location":"blog/open-vswitch---vboxdeb12/#memento-51-switch-virtuel-ovs","title":"M\u00e9mento 5.1 - Switch virtuel OvS","text":"<p>Open vSwitch (OvS) se comportera comme un v\u00e9ritable switch physique en proposant la gestion des adresses MAC tel un switch L2 ainsi que celle des adresses IP pour le routage des paquets IP tel un switch L3.</p> <p>Le switch virtuel sera, contrairement \u00e0 une architecture standard, install\u00e9 sur une VM et non sur le PC h\u00f4te de l'hyperviseur VirtualBox.</p> <p>Le raccordement externe des clients LAN Debian sur le switch se fera \u00e0 l'aide de ports patch.</p> <p>Le moyen d'approcher l'architecture standard sera de cr\u00e9er un conteneur \u00e0 l'int\u00e9rieur de la VM et de connecter celui-ci sur OVS \u00e0 l'aide d'une interface r\u00e9seau virtuelle Veth (M\u00e9mento suivant).  </p> <p>La gestion possible de VLAN ne sera pas trait\u00e9e ici.</p>"},{"location":"blog/open-vswitch---vboxdeb12/#construction-de-la-vm-ovs","title":"Construction de la VM ovs","text":"<p>L'utilisation de VirtualBox est consid\u00e9r\u00e9e acquise.  </p> <p>A d\u00e9faut, r\u00e9f\u00e9rez-vous aux m\u00e9mentos suivants : VirtualBox - Installation VirtualBox - Mode d\u2019acc\u00e8s r\u00e9seau par pont</p>"},{"location":"blog/open-vswitch---vboxdeb12/#-creation-et-configuration","title":"- Cr\u00e9ation et configuration","text":"<p>Le PC h\u00f4te doit \u00eatre un PC\u00a064 bits, courant de nos jours.  </p> <p>T\u00e9l\u00e9chargez l'ISO debian-12.x.y-amd64-netinst.iso : https://cdimage.debian.org/.../current/amd64/iso-cd/ </p> <p>- D\u00e9marrez ensuite l'application VirtualBox 7.x, puis : - - Menu de VirtualBox &gt; Machine &gt; Nouvelle... -&gt; Nom : ovs -&gt; Folder : S\u00e9lectionnez le dossier de stockage des VM -&gt; ISO Image : S\u00e9lectionnez l'ISO t\u00e9l\u00e9charg\u00e9e ci-dessus -&gt; Type : Linux -&gt; Version : Debian (64-bit) -&gt; Cochez Skip Unattended Installation (important) -&gt; Bouton Suivant  </p> <p>-&gt; M\u00e9moire vive : 1024 MB -&gt; Processors : 2 CPU si possible -&gt; Bouton Suivant</p> <p>-&gt; Create a Virtual Hard Disk Now : Ajustez \u00e0 12 Go -&gt; Bouton Suivant</p> <p>-&gt; V\u00e9rifiez le R\u00e9capitulatif -&gt; Bouton Finish</p> <p>La VM s'affiche dans le panneau gauche de VirtualBox.  </p> <p>- S\u00e9lectionnez maintenant la nouvelle VM, puis : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet G\u00e9n\u00e9ral -&gt; Avanc\u00e9 &gt; Presse-papier partag\u00e9 &gt; Bidirectionnel</p> <p>- - - Onglet Syst\u00e8me -&gt; Carte m\u00e8re &gt; Ordre d'amor\u00e7age &gt; D\u00e9cochez Disquette -&gt; Processeur &gt; Cochez Activer PAE/NX</p> <p>-&gt; OK  </p> <p>Les autres param\u00e8tres peuvent rester inchang\u00e9s.</p>"},{"location":"blog/open-vswitch---vboxdeb12/#-installation-de-debian-12","title":"- Installation de Debian 12","text":"<p>Conseil pratique avant de d\u00e9marrer la nouvelle VM : Si le curseur de la souris disparait lors d'un clic dans la fen\u00eatre de la VM, celui-ci peut \u00eatre r\u00e9cup\u00e9r\u00e9 par le PC h\u00f4te \u00e0 l'aide de la touche CTRL situ\u00e9e \u00e0 droite de la barre d'espace du clavier.  </p> <p>- - Menu de VirtualBox &gt; Machine &gt; D\u00e9marrer -&gt; D\u00e9marrage normal (La VM s'ex\u00e9cute)</p> <p>S\u00e9lectionnez Graphical Install et appliquez ce qui suit : - Language &gt; Fran\u00e7ais - Pays (territoire ou r\u00e9gion) &gt; France - Disposition de clavier \u00e0 utiliser &gt; Fran\u00e7ais - Nom de machine &gt; ovs - Domaine &gt; Laissez le champ vide - MDP du super utilisateur root &gt; Votre MDP root - Confirmation du MDP &gt; Votre MDP root - Nom complet du nouvel utilisateur &gt; Ex: switch - Identifiant pour le compte utilisateur &gt; switch - MDP pour le nouvel utilisateur &gt; Votre MDP switch - Confirmation du MDP &gt; Votre MDP switch - M\u00e9thode de partitionnement &gt; Assist\u00e9 - utili... entier - Disque \u00e0 partitionner &gt; Celui propos\u00e9 de 12 Go - Sch\u00e9ma de partitionnement &gt; Tout ... seule partition - Table des partitions &gt; Terminer le partitionnement ... - Faut-il appliquer les changements \u2026 disques ? &gt; Oui  </p> <p>L'installation de base commence : - Faut-il analyser d'autres supports ... ? &gt; Non - Pays du miroir de l'archive Debian &gt; France - Miroir de l'archive Debian &gt; deb.debian.org - Mandataire HTTP (lais...) &gt; Laissez vide  </p> <p>L'installation continue : - Souhaitez-vous participer \u00e0 l'\u00e9tude statistique... &gt; Non - Logiciels \u00e0 installer -&gt; D\u00e9cochez environnement de bureau Debian -&gt; D\u00e9cochez ... GNOME -&gt; Conservez utilitaires usuels du syst\u00e8me  </p> <p>L'installation se termine : - Installer ... de d\u00e9marrage GRUB sur le secteur ... &gt; Oui - P\u00e9riph\u00e9rique ... programme de d\u00e9marrage &gt; /dev/sda - Installation termin\u00e9e &gt; Continuer (sans retrait du CD) </p> <p>Le syst\u00e8me reboot et une fen\u00eatre de connexion s'ouvre : -&gt; ovs login : Entrez switch -&gt; Password : Entrez Votre MDP switch Si tout est OK, affichage du prompt switch@ovs:~$</p> <p> </p> Open vSwitch : Premier d\u00e9marrage de la VM ovs <p>Donnez \u00e0 pr\u00e9sent les droits d'administrateur root \u00e0 l'utilisateur switch :</p> <pre><code>[switch@ovs:~$] su root\nMot de passe : Votre MDP root\n[root@ovs:~#] apt install sudo\n[root@ovs:~#] sudo usermod -aG sudo switch\n[root@ovs:~#] sudo reboot\n</code></pre> <p>et reconnectez-vous en tant qu'utilisateur switch.  </p> <p>Pour info, la VM peut \u00eatre arr\u00eat\u00e9e de 2 fa\u00e7ons :</p> <pre><code>[switch@ovs:~$] sudo poweroff  \n[switch@ovs:~$] sudo shutdown -h now\n</code></pre>"},{"location":"blog/open-vswitch---vboxdeb12/#installation-configuration-dovs","title":"Installation-configuration d'OvS","text":"<p>Au pr\u00e9alable, observez la configuration r\u00e9seau active :</p> <p> </p> Open vSwitch : Cartes r\u00e9seau de base lo et enp0s3"},{"location":"blog/open-vswitch---vboxdeb12/#-installation","title":"- Installation","text":"<p>Installez le paquet openvswitch-switch :</p> <pre><code>[switch@ovs:~$] sudo apt install openvswitch-switch\n</code></pre> <p>Les paquets concernant les d\u00e9pendances manquantes sont ajout\u00e9s automatiquement.</p> <p>Affichez maintenant la version d'Open vSwitch (OvS) :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl show\n</code></pre> <p> </p> Open vSwitch : Affichage de la version <p>ainsi que les informations du module openvswitch int\u00e9gr\u00e9 dans le noyau linux :</p> <pre><code>[switch@ovs:~$] sudo modinfo openvswitch\n</code></pre> <p> </p> Open vSwitch : Chemin du module openvswitch.ko <p>Contr\u00f4lez enfin le bon chargement du module :</p> <pre><code>[switch@ovs:~$] lsmod | grep openvswitch\n</code></pre> <p> </p> Open vSwitch : Module openvswitch.ko charg\u00e9 <p>- - Liste des principaux composants OVS install\u00e9s - -</p> <p>- /usr/sbin/ovs-vswitchd : Le service de commutation (compatible OpenFlow).  </p> <p>- /usr/bin/ovs-appctl : Dialogue CLI (Command Line Interface) avec le service.  </p> <p>- /usr/bin/ovs-vsctl : Configuration CLI du service via le serveur de Bdd.  </p> <p>- /usr/sbin/ovsdb-server : Le serveur de Bdd contenant la configuration du service.  </p> <p>- /usr/bin/ovsdb-client : Dialogue CLI avec le serveur de Bdd (backup, etc...).  </p> <p>- /usr/bin/ovsdb-tool : Configuration CLI des fichiers de la Bdd (cr\u00e9ation, etc...).  </p> <p>- /usr/bin/ovs-dpctl : Configuration CLI des datapaths du noyau d'OVS.  </p> <p>- /usr/bin/ovs-ofctl : Configuration CLI de la partie OpenFlow d'OVS.  </p> <p>La Bdd conf.db se situe dans /etc/openvswitch/. Les logs se situent dans /var/log/openvswitch/.</p> <p>Contr\u00f4lez l'activation du service openvswitch-switch :</p> <pre><code>[switch@ovs:~$] sudo systemctl status openvswitch-switch\n</code></pre> <p> </p> Open vSwitch : Service openvswitch-switch activ\u00e9 <p>ainsi que celle des 2 services suivants :</p> <pre><code>[switch@ovs:~$] sudo systemctl status ovsdb-server\n[switch@ovs:~$] sudo systemctl status ovs-vswitchd\n</code></pre>"},{"location":"blog/open-vswitch---vboxdeb12/#-configuration","title":"- Configuration","text":"<p>Commencez par cr\u00e9er un bridge (switch) de nom br0 :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl add-br br0   \n[switch@ovs:~$] sudo ovs-vsctl show\n</code></pre> <p> </p> Open vSwitch : Vue cr\u00e9ation bridge br0 <p>Un port et une interface virtuels de m\u00eame nom ont \u00e9t\u00e9 associ\u00e9s au bridge.</p> <p>Utilisez la Cde del-br pour d\u00e9truire un bridge existant.</p> <p>Observez les infos d\u00e9taill\u00e9es du bridge br0 comme suit :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl list br br0\n</code></pre> <p>et la cr\u00e9ation de l'interface br0 avec la Cde ip address :</p> <p> </p> Open vSwitch : Vue interface br0 <p>Testez l'interface enp0s3 avec un ping vers yahoo.fr, celui-ci doit recevoir une r\u00e9ponse positive.</p> <p>Rattachez \u00e0 pr\u00e9sent l'interface enp0s3 au bridge br0 :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl add-port br0 enp0s3  \n[switch@ovs:~$] sudo ovs-vsctl show\n</code></pre> <p> </p> Open vSwitch : Vue affectation enp0s3 sur br0 <p>Le port virtuel enp0s3 et l'interface virtuelle enp0s3 ne font qu'un.</p> <p>Utilisez la Cde del-port pour d\u00e9truire un port existant.</p> <p>Observez de nouveau le retour de la Cde ip address :</p> <p> </p> Open vSwitch : M\u00eames adresses MAC enp0s3/br0 <p>La carte virtuelle br0 poss\u00e8de \u00e0 pr\u00e9sent la m\u00eame adresse MAC que la carte virtuelle enp0s3.</p>"},{"location":"blog/open-vswitch---vboxdeb12/#integration-de-la-vm-ovs","title":"Int\u00e9gration de la VM ovs","text":""},{"location":"blog/open-vswitch---vboxdeb12/#-configuration-reseau-vbox","title":"- Configuration r\u00e9seau VBox","text":"<p>Stoppez la VM :</p> <pre><code>[switch@ovs:~$] sudo poweroff\n</code></pre> <p>S\u00e9lectionnez ensuite celle-ci dans VirtualBox, puis : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet R\u00e9seau -&gt; Adapter 1 -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Name &gt; S\u00e9lectionnez switch_interne -&gt; Avanc\u00e9 &gt; Mode Promiscuit\u00e9 -&gt; S\u00e9lectionnez Allow VMs</p> <p>-&gt; Adapter 2 -&gt; Cochez Activer l'interface r\u00e9seau -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Name &gt; Entrez liaison_vm1 -&gt; Avanc\u00e9 &gt; Mode Promiscuit\u00e9 -&gt; S\u00e9lectionnez Allow VMs</p> <p>-&gt; Adapter 3 -&gt; Cochez Activer l'interface r\u00e9seau -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Name &gt; Entrez liaison_vm2 -&gt; Avanc\u00e9 &gt; Mode Promiscuit\u00e9 -&gt; S\u00e9lectionnez Allow VMs</p> <p>-&gt; OK</p> <p>Red\u00e9marrez la VM.</p> <p>Il est impossible, OVS n'\u00e9tant pas install\u00e9 sur le PC h\u00f4te de VirtualBox, d'attribuer aux interfaces 2 et 3 un mode d'acc\u00e8s r\u00e9seau g\u00e9n\u00e9ralement utilis\u00e9 avec OVS soit un mode de type Acc\u00e8s par pont au travers d'une interface r\u00e9seau virtuelle TAP ( Voir le \u00a7 4 ).</p> <p>C'est donc le type R\u00e9seau interne qui sera utilis\u00e9.  </p> <p>Le mode promiscuit\u00e9 Allow VMs permettra \u00e0 la VM ovs de travailler tel un switch et traiter ainsi tout le trafic r\u00e9seau \u00e0 destination et en provenance d'autres VM.  </p> <p>Il est n\u00e9cessaire, dans une infrastructure virtualis\u00e9e telle Open vSwitch install\u00e9 sur une VM, d'appliquer le mode promiscuit\u00e9 \u00e0 une interface r\u00e9seau devant agir comme un pont (bridge).</p>"},{"location":"blog/open-vswitch---vboxdeb12/#-configuration-reseau-debian","title":"- Configuration r\u00e9seau Debian","text":"<p>Vous allez \u00e0 pr\u00e9sent configurer OVS au boot de la VM.</p> <p>Editez pour cela le fichier r\u00e9seau interfaces :</p> <pre><code>[switch@ovs:~$] sudo nano /etc/network/interfaces\n</code></pre> <p>et modifiez le comme suit :</p> <pre><code># This file describes the network interfaces availabl...\n# and how to activate them. For more information, see ...\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\n# Mettre un # devant les 2 lignes ci-dessous\n#allow-hotplug enp0s3\n#iface enp0s3 inet dhcp\n\n## Configuration Open vSwitch\n# Activation de l'interface br0\nauto br0\nallow-ovs br0\n\n# Configuration IP de l'interface br0\niface br0 inet static\naddress 192.168.3.15\nnetmask 255.255.255.0\ngateway 192.168.3.1\novs_type OVSBridge\novs_ports enp0s3\n\n# Attachement du port/interface enp0s3 au bridge br0\nallow-br0 enp0s3\niface enp0s3 inet manual\novs_bridge br0\novs_type OVSPort\n</code></pre> <p>Red\u00e9marrez ensuite le service networking.service :</p> <pre><code>[switch@ovs:~$] sudo systemctl restart networking\n</code></pre> <p>et contr\u00f4lez le r\u00e9sultat avec la Cde ip address :</p> <p> </p> Open vSwitch : Vue adresse IP sur interface br0 <p>Constat : - 2 nouvelles interfaces r\u00e9seau enp0s8 et enp0s9 - L'interface br0 a la m\u00eame adresse MAC que enp0s3 - L'interface br0 poss\u00e8de l'adresse IP 192.168.3.15 - Le ping vers l'adresse lP 192.168.3.1 fonctionne</p> <p>L'adresse IP 192.168.3.15 sera utilis\u00e9e plus tard pour administrer Open vSwitch \u00e0 distance.</p> <p>Attention : Lors d'un reboot du syst\u00e8me, il est souvent n\u00e9cessaire de relancer manuellement le service networking pour qu'Open vSwitch refonctionne correctement (bug ?).</p> <p>Vous allez donc cr\u00e9er un nouveau service charg\u00e9 de relancer automatiquement celui-ci durant la phase de reboot, ceci avant l'ouverture de la session utilisateur.</p> <p>Cr\u00e9ez le service networking-restart.service :</p> <pre><code>[switch@ovs:~$] cd /etc/systemd/system/\n[switch@ovs:~$] sudo nano networking-restart.service\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription=Red\u00e9marrage du service networking\nBefore=graphical.target\nAfter=network.target\n\n[Service]\nType=oneshot\nExecStart=/bin/sleep 6\nExecStart=/sbin/service networking restart\nRemainAfterExit=true\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>La Cde sleep 6 fera que le service networking sera relanc\u00e9 6 secondes apr\u00e8s le boot.</p> <p>Testez le nouveau service :</p> <pre><code>[switch@ovs:~$] sudo systemctl start networking-restart\n[switch@ovs:~$] sudo systemctl status networking-restart\n</code></pre> <p>Si le statut est OK, activez le service :</p> <pre><code>[switch@ovs:~$] sudo systemctl enable networking-restart\n[switch@ovs:~$] sudo reboot\n</code></pre> <p>Vous ne devriez plus avoir besoin de red\u00e9marrer manuellement le service networking apr\u00e8s un boot, le ping vers l'adresse lP 192.168.3.1 doit fonctionner.</p>"},{"location":"blog/open-vswitch---vboxdeb12/#titre-4","title":"Raccordement vm1-2 sur OvS","text":"<p>Open vSwitch est g\u00e9n\u00e9ralement install\u00e9 sur le PC h\u00f4te de l'hyperviseur. Un bridge tel br0 utilise alors les interfaces r\u00e9seau physiques du PC h\u00f4te pour l'acc\u00e8s \u00e0 Internet et des interfaces r\u00e9seau virtuelles TAP de niveau L2 pour l'acc\u00e8s aux VM.</p> <p>Dans le cas pr\u00e9sent, Open vSwitch est install\u00e9 sur une VM de VirtualBox.</p> <p>Vous allez donc raccorder les 2 clients Debian sur les interfaces r\u00e9seau enp0s8/9 de la VM ovs, interfaces qui seront rattach\u00e9es \u00e0 des bridges de nom br1/2.</p> <p>Vous lierez les 3 bridges \u00e0 l'aide de ports patch :</p> <p> </p> Open vSwitch : Bridges mont\u00e9s en cascade <p>L'ensemble des bridges rattach\u00e9s avec des ports patch (ports de brassage) peut \u00eatre vu comme un seul pont.  </p> <p>La cr\u00e9ation de VLAN et le routage de paquets IP entre ceux-ci restent possibles.</p>"},{"location":"blog/open-vswitch---vboxdeb12/#-creation-des-bridges-ports","title":"- Cr\u00e9ation des bridges-ports","text":"<p>Cr\u00e9ez les bridges br1 et br2 :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl add-br br1  \n[switch@ovs:~$] sudo ovs-vsctl add-br br2\n</code></pre> <p>Rattachez les interfaces enp0s8/9 aux bridges br1/2 :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl add-port br1 enp0s8  \n[switch@ovs:~$] sudo ovs-vsctl add-port br2 enp0s9\n</code></pre> <p>Reliez maintenant br0 avec br1 :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl -- add-port br0 br0-patch0 \\\n-- set interface br0-patch0 type=patch options:peer=br1-patch0\n\n[switch@ovs:~$] sudo ovs-vsctl -- add-port br1 br1-patch0 \\\n-- set interface br1-patch0 type=patch options:peer=br0-patch0\u00a0 \n</code></pre> <p>Le caract\u00e8re\u00a0\\\u00a0indique d'\u00e9crire le tout sur une seule ligne.  </p> <p>puis br1 avec br2 :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl -- add-port br1 br1-patch1 \\\n-- set interface br1-patch1 type=patch options:peer=br2-patch0 \n\n[switch@ovs:~$] sudo ovs-vsctl -- add-port br2 br2-patch0 \\\n-- set interface br2-patch0 type=patch options:peer=br1-patch1\n</code></pre> <p>Contr\u00f4lez la prise en compte de la configuration :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl  show\n</code></pre> <p> </p> Open vSwitch : Contr\u00f4le configuration patch"},{"location":"blog/open-vswitch---vboxdeb12/#-parametrage-reseau-debian","title":"- Param\u00e9trage r\u00e9seau Debian","text":"<p>Editez le fichier interfaces :</p> <pre><code>[switch@ovs:~$] sudo nano /etc/network/interfaces\n</code></pre> <p>et modifiez le comme suit :</p> <pre><code># This file describes the network interfaces availabl...\n# and how to activate them. For more information, see ...\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\n# Mettre un # devant les 2 lignes ci-dessous\n#allow-hotplug enp0s3\n#iface enp0s3 inet dhcp\n\n## Configuration Open vSwitch\n# Configuration du bridge br0\nauto br0\nallow-ovs br0\n\n# Configuration IP de l'interface br0\niface br0 inet static\naddress 192.168.3.15\nnetmask 255.255.255.0\ngateway 192.168.3.1\novs_type OVSBridge\novs_ports enp0s3 br0-patch0\n\n# Attachement du port/interface enp0s3 au bridge br0\nallow-br0 enp0s3\niface enp0s3 inet manual\novs_bridge br0\novs_type OVSPort\n\n# Liaison patch br0 vers br1\nallow-br0 br0-patch0\niface br0-patch0 inet manual\novs_bridge br0\novs_type OVSPatchPort\novs_patch_peer br1-patch0  \n \u00a0\n# Configuration du bridge br1\nauto br1\nallow-ovs br1\niface br1 inet manual\novs_type OVSBridge\novs_ports enp0s8 br1-patch0 br1-patch1\n \u00a0\nallow-br1 enp0s8\niface enp0s8 inet manual\novs_bridge br1\novs_type OVSPort\n\n# Liaisons patch br1 vers br0 et br2 \nallow-br1 br1-patch0\niface br1-patch0 inet manual\novs_bridge br1\novs_type OVSPatchPort\novs_patch\\_peer br0-patch0\n\nallow-br1 br1-patch1\niface br1-patch1 inet manual\novs_bridge br1\novs_type OVSPatchPort\novs_patch\\_peer br2-patch0\n\n# Configuration du bridge br2\nauto br2\nallow-ovs br2\niface br2 inet manual\novs_type OVSBridge\novs_ports enp0s9 br2-patch0\n \u00a0\nallow-br2 enp0s9\niface enp0s9 inet manual\novs_bridge br2\novs_type OVSPort\n\n # Liaison patch br2 vers br1\u00a0\nallow-br2 br2-patch0\niface br2-patch0 inet manual\novs_bridge br2\novs_type OVSPatchPort\novs_patch\\_peer br1-patch1\n</code></pre> <p>Red\u00e9marrez la VM pour appliquer la configuration :</p> <pre><code>[switch@ovs:~$] sudo reboot\n</code></pre> <p>puis contr\u00f4lez le statut du service r\u00e9seau :</p> <pre><code>[switch@ovs:~$] sudo systemctl status networking\n</code></pre> <p>ainsi que le contenu de la Bdd d'Open vSwitch :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl show\n</code></pre>"},{"location":"blog/open-vswitch---vboxdeb12/#-parametrage-reseau-vbox","title":"- Param\u00e9trage r\u00e9seau VBox","text":"<p>Sans stopper les VM, modifiez l'onglet r\u00e9seau des 2 clients debian12-vm* comme suit : -&gt; Adapter 1 -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Name &gt; S\u00e9lectionnez liaison_vm* selon la VM -&gt; OK</p>"},{"location":"blog/open-vswitch---vboxdeb12/#raccordement-vm1-2-sur-br0","title":"Raccordement vm1-2 sur br0","text":"<p>Vous avez d\u00e9couvert ci-dessus le raccordement sur plusieurs bridges reli\u00e9s entre eux par des ports patch.</p> <p>Il est possible aussi de faire plus simple en raccordant toutes les interfaces r\u00e9seau de la VM ovs sur un seul bridge tel br0.</p> <p>Exemple :</p> <p> </p> Open vSwitch : Version un seul bridge <p>Au pr\u00e9alable, supprimez les bridges br1 et br2 construits dans la partie 4 comme ceci :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl del-br br1\n[switch@ovs:~$] sudo ovs-vsctl del-br br2\n</code></pre> <p>Editez ensuite le fichier r\u00e9seau interfaces :</p> <pre><code>[switch@ovs:~$] sudo nano /etc/network/interfaces\n</code></pre> <p>et modifiez son contenu comme suit :</p> <pre><code># This file describes the network interfaces availabl...\n# and how to activate them. For more information, see ...\n\nsource /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n## Configuration Open vSwitch\n# Activation de l'interface br0\nauto br0\nallow-ovs br0\n\n# Configuration IP de l'interface br0\niface br0 inet static\naddress 192.168.3.15\nnetmask 255.255.255.0\ngateway 192.168.3.1\novs_type OVSBridge\novs_ports enp0s3 enp0s8 enp0s9\n\n# Attachement du port/interface enp0s3 au bridge br0\nallow-br0 enp0s3\niface enp0s3 inet manual\novs_bridge br0\novs_type OVSPort\n\n# Attachement du port/interface enp0s8 au bridge br0\nallow-br0 enp0s8\niface enp0s8 inet manual\novs_bridge br0\novs_type OVSPort\n\n# Attachement du port/interface enp0s9 au bridge br0\nallow-br0 enp0s9\niface enp0s9 inet manual\novs_bridge br0\novs_type OVSPort\n</code></pre> <p>Red\u00e9marrez la VM pour appliquer la configuration :</p> <pre><code>[switch@ovs:~$] sudo reboot\n</code></pre> <p>V\u00e9rifiez enfin le r\u00e9sultat de celle-ci :</p> <pre><code>[switch@ovs:~$] sudo ovs-vsctl show\n</code></pre> <p>Retour normal :</p> <pre><code>Bridge br0\n    Port enp0s9\n        Interface enp0s9\n    Port enp0s8\n        Interface enp0s8\n    Port enp0s3\n        Interface enp0s3\n    Port br0\n        Interface br0\n            type: internal\novs_version: \"3.1.0\"\n</code></pre>"},{"location":"blog/open-vswitch---vboxdeb12/#test-du-fonctionnement-dovs","title":"Test du fonctionnement d'OvS","text":"<p>V\u00e9rifiez \u00e0 l'aide de la Cde ping la conformit\u00e9 des r\u00e9sultats avec ceux indiqu\u00e9s sur la maquette r\u00e9seau local virtuel.</p> <p>Stoppez ensuite la VM ovs support d'Open vSwitch et assurez-vous que les 2 clients Debian ne peuvent plus communiquer entre eux.</p> <p></p> <p>  Voil\u00e0, c'est termin\u00e9 ! Le r\u00e9seau virtuel de base est cr\u00e9\u00e9. Le m\u00e9mento 5.2 vous attend pour d\u00e9couvrir les conteneurs.</p> <p>M\u00e9mento 5.2</p>"},{"location":"blog/podman---vboxdeb12-12/","title":"Podman - VBox/Deb12 1/2","text":""},{"location":"blog/podman---vboxdeb12-12/#memento-52-conteneurs-lxc","title":"M\u00e9mento 5.2 - Conteneurs LXC","text":"<p>En virtualisation, l\u2019isolation des VM se fait au niveau mat\u00e9riel (CPU/RAM/Disque ...) avec un acc\u00e8s virtuel aux ressources de l'h\u00f4te via un hyperviseur tel VirtualBox.  </p> <p>En conteneurisation, l'isolation se fait au niveau de l'OS h\u00f4te. Les conteneurs se partagent le noyau de celui-ci et ne prennent pas plus de m\u00e9moire que n\u00e9cessaire.  </p> <p>Cette technique moins exigeante en ressources favorise l'ex\u00e9cution d'applications l\u00e9g\u00e8res, ces derni\u00e8res incluant tout le n\u00e9cessaire pour tourner de mani\u00e8re autonome.</p> <p>Podman qui est un moteur LinuX Container permet de cr\u00e9er des conteneurs en tant que root (mode rootfull) et en tant qu'utilisateur standard (mode rootless).</p> <p>Le mode rootless offre plus de s\u00e9curit\u00e9 car l'utilisateur standard peut cr\u00e9er, ex\u00e9cuter et g\u00e9rer des conteneurs sans processus n\u00e9cessitant des privil\u00e8ges root.</p> <p>Podman (POD MANager) permet aussi de cr\u00e9er des pods soit des groupes de conteneurs partageant, par exemple, un m\u00eame r\u00e9seau IP (non pr\u00e9sent\u00e9 ici).</p> <p>Podman se pose en concurrent de Docker et est pilotable graphiquement depuis l'outil Cockpit.</p>"},{"location":"blog/podman---vboxdeb12-12/#installation-de-podman","title":"Installation de Podman","text":"<p>Installez le paquet podman et ses d\u00e9pendances :</p> <pre><code>[switch@ovs:~$] sudo apt install podman\n</code></pre> <p>Contr\u00f4lez ensuite le num\u00e9ro de la version install\u00e9e :</p> <pre><code>[switch@ovs:~$] podman version\n</code></pre> <p>Retour :</p> <pre><code>Client:       Podman Engine\nVersion:      4.3.1\nAPI Version:  4.3.1\nGo Version:   go1.19.8\nBuilt:        Thu Jan 1 01:00:00 1970\nOS/Arch:      linux/amd64\n</code></pre> <p>La Cde podman info retournera plus de d\u00e9tails.</p> <p>Les dossiers et fichiers \u00e0 suivre se trouvent dans : /etc/containers/ /home/switch/.local/share/containers/ (rootless) /var/lib/containers/ (rootfull)</p> <p>V\u00e9rifiez maintenant l'activation du socket de Podman :</p> <pre><code>[switch@ovs:~$] sudo systemctl status podman.socket \n[switch@ovs:~$] sudo systemctl is-enabled podman.socket\n</code></pre> <p>Retours attendus : active(listening) et enabled.</p> <p>Podman a besoin de cgroup pour fonctionner.</p> <p>Control groups (cgroup) est une fonctionnalit\u00e9 du noyau Linux pour limiter, compter et isoler l'utilisation des ressources (processeur, m\u00e9moire, disque, etc...).</p> <p>V\u00e9rifiez le montage automatique de cgroup version 2 :</p> <pre><code>[switch@ovs:~$] mount | grep cgroup\n</code></pre> <p>Retour :</p> <pre><code>cgroup2 on /sys/fs/cgroup type cgroup2 (rw,nosuid...)\n</code></pre> <p>Editez \u00e0 pr\u00e9sent le fichier des d\u00e9p\u00f4ts registries.conf :</p> <pre><code>[switch@ovs:~$] sudo nano /etc/containers/registries.conf\n</code></pre> <p>et ajoutez \u00e0 la fin de celui-ci la ligne suivante :</p> <pre><code>unqualified-search-registries = [ 'docker.io']\n</code></pre> <p>Ceci permettra de contacter automatiquement le registre (d\u00e9p\u00f4t) de Docker, lorsque vous ex\u00e9cuterez la Cde podman search ou podman pull.</p> <p>Pour finir, red\u00e9marrez le service socket de Podman :</p> <pre><code>[switch@ovs:~$] sudo systemctl restart podman.socket\n</code></pre>"},{"location":"blog/podman---vboxdeb12-12/#conteneurs-en-mode-rootfull","title":"Conteneurs en mode rootfull","text":"<p>Le raccordement r\u00e9seau d'un conteneur rootfull fait appel par d\u00e9faut au paquet netavark qui fournit pour cela un bridge de nom podman.</p> <p>Mais pour un raccordement sur le bridge br0 d'Open vSwicth, la configuration ci-dessous propose d'exploiter les espaces de noms r\u00e9seau Linux plut\u00f4t que netavark.</p>"},{"location":"blog/podman---vboxdeb12-12/#-espaces-de-noms-reseau","title":"- Espaces de noms r\u00e9seau","text":"<p>Dans une configuration r\u00e9seau plus ou moins complexe, le mode rootfull peut s'av\u00e9rer plus adapt\u00e9 que le mode rootless pour notamment affecter des espaces de noms r\u00e9seau et des adresses IP aux conteneurs.</p> <p>Un conteneur joint \u00e0 un espace de noms r\u00e9seau peut communiquer avec les autres espaces de noms r\u00e9seau au travers d'interfaces r\u00e9seau virtuelles de type Veth.</p> <p>Vous raccorderez donc les conteneurs ctn1 et ctn2 au bridge br0 d'Open vSwitch comme ceci :</p> <p> </p> Podman : Raccordement des conteneurs sur OVS <p>La cr\u00e9ation des espaces de noms r\u00e9seau passera par l'activation d'un service systemd qui se chargera de lancer un simple script shell.</p> <p>Commencez par cr\u00e9er le service networknamespace :</p> <p>Attention</p> <p>La plupart des Cdes ci-dessous n\u00e9cessitent l'utilisation de sudo.</p> <pre><code>sudo nano /etc/systemd/system/networknamespace.service\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription=Ajout espaces de noms r\u00e9seau.\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=simple\nExecStart=/bin/bash /root/networknamespace.sh\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Cr\u00e9ez ensuite le script shell networknamespace.sh :</p> <pre><code>sudo nano /root/networknamespace.sh\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>#!/bin/bash\n## Cr\u00e9ation des espaces de noms r\u00e9seau pour ctn1/ctn2.\nip netns add nsctn1\nip netns add nsctn2\n\n## Cr\u00e9ation des paires veth pour nsctn1/nsctn2.\nip link add v0br type veth peer name vctn1\nip link add v1br type veth peer name vctn2\n\n## Raccordement extr\u00e9mit\u00e9s vctn1/2 c\u00f4t\u00e9 nsctn1/nsctn2.\nip link set vctn1 netns nsctn1\nip link set vctn2 netns nsctn2\n\n## Activation des extr\u00e9mit\u00e9s vctn1/2 et lo c\u00f4t\u00e9 nsctn1/nsctn2.\nip netns exec nsctn1 ip link set lo up\nip netns exec nsctn2 ip link set lo up\nip netns exec nsctn1 ip link set vctn1 up\nip netns exec nsctn2 ip link set vctn2 up\n\n## Ajout adresses IP extr\u00e9mit\u00e9s vctn1/2 c\u00f4t\u00e9 nsctn1/nsctn2.\nip netns exec nsctn1 ip addr add 192.168.3.6/24 dev vctn1\nip netns exec nsctn2 ip addr add 192.168.3.8/24 dev vctn2\n\n## Ajout route acc\u00e8s au r\u00e9seau 192.168.3.0/24.\nip netns exec nsctn1 ip route add default via 192.168.3.15\nip netns exec nsctn2 ip route add default via 192.168.3.15\n\n## Raccordement extr\u00e9mit\u00e9s v0/1br au bridge OVS br0.\novs-vsctl add-port br0 v0br\novs-vsctl add-port br0 v1br\n\n## Activation des extr\u00e9mit\u00e9s v0/1br c\u00f4t\u00e9 br0.\nip link set v0br up\nip link set v1br up\n\n## Autorisation de routage IP pour l'acc\u00e8s \u00e0 Internet.\necho 1 &gt; /proc/sys/net/ipv4/ip_forward\n\nexit 0\n</code></pre> <p>Rendez le script ex\u00e9cutable :</p> <pre><code>sudo chmod +x /root/networknamespace.sh\n</code></pre> <p>Ex\u00e9cutez le service networknamespace pour test :</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl start networknamespace\nsudo systemctl status networknamespace (normal=dead)\nsudo systemctl enable networknamespace\n</code></pre> <p>V\u00e9rifiez la cr\u00e9ation des espaces de noms r\u00e9seau :</p> <pre><code>sudo ls /var/run/netns/\nip netns list\n</code></pre> <p>Retour de la Cde ip netns list :</p> <pre><code>nsctn2 (id: 1)\nnsctn1 (id: 0)\n</code></pre> <p>V\u00e9rifiez aussi la cr\u00e9ation des adresses et routes IP :</p> <pre><code>sudo ip netns exec nsctn1 ip link\nsudo ip netns exec nsctn1 ip a\nsudo ip netns exec nsctn1 ip route\nsudo ip netns exec nsctn2 ip link\nsudo ip netns exec nsctn2 ip a\nsudo ip netns exec nsctn2 ip route\n</code></pre> <p>Retour de la Cde ip netns exec nsctn1 ip a :</p> <p> </p> Podman : Espace de nom r\u00e9seau nsctn1 : Interface veth UP <p>V\u00e9rifiez le ping depuis la VM ovs sur nsctn1/nsctn2 :</p> <pre><code>ping 192.168.3.6\nping 192.168.3.8\n</code></pre> <p>Les retours doivent \u00eatre positifs (liaisons veth/br0 OK).</p> <p>V\u00e9rifiez le ping entre les deux espaces de noms r\u00e9seau :</p> <pre><code>sudo nsenter --net=/var/run/netns/nsctn1\n\n[root@ovs:~#] ping 192.168.3.8          # IP de nsctn2\n[root@ovs:~#] exit\n</code></pre> <p>Les retours doivent \u00e9galement \u00eatre positifs.</p> <p>Une autre fa\u00e7on de proc\u00e9der entre les deux espaces :</p> <pre><code>sudo ip netns exec nsctn1 ping 192.168.3.8     # -&gt; nsctn2\nsudo ip netns exec nsctn2 ping 192.168.3.6     # -&gt; nsctn1\n</code></pre>"},{"location":"blog/podman---vboxdeb12-12/#-images-docker","title":"- Images Docker","text":"<p>Nota</p> <p>Podman et Docker sont globalement compatibles car fonctionnant tous les deux avec des images conformes \u00e0 la norme OCI (Open Container Initiative).</p> <p>Podman se base sur ce type d'images qu'il est possible de rechercher sur Internet pour cr\u00e9er des conteneurs.</p> <p>Recherchez la disponibilit\u00e9 des 2 images ci-dessous :</p> <pre><code>podman search debian\n</code></pre> <p> </p> Podman : Image debian sur docker.io <pre><code>podman search uptime-kuma\n</code></pre> <p> </p> Podman : Image uptime-kuma sur docker.io <p>T\u00e9l\u00e9chargez ensuite l'image de la distribution Debian :</p> <pre><code>sudo podman pull docker.io/library/debian\n</code></pre> <p> </p> Podman : Pull de l'image debian <p>et l'image de l'application Uptime Kuma :</p> <pre><code>sudo podman pull docker.io/louislam/uptime-kuma:1\n</code></pre> <p> </p> Podman : Pull de l'image uptime-kuma de Tag 1 <p>L'outil Uptime Kuma fournira de la surveillance r\u00e9seau.</p> <p>V\u00e9rifiez le r\u00e9sultat des t\u00e9l\u00e9chargements :</p> <p> </p> Podman : Liste des images t\u00e9l\u00e9charg\u00e9es <p>Les informations d\u00e9taill\u00e9es des images se trouvent sur le site dockerhub.</p> <p>Les images t\u00e9l\u00e9charg\u00e9es sont stock\u00e9es dans /var/lib/containers/storage/overlay-images/.</p> <p>Cde Podman utile : Suppression -&gt; sudo podman rmi nom-image</p>"},{"location":"blog/podman---vboxdeb12-12/#-conteneur-podman-ctn1","title":"- Conteneur Podman ctn1","text":"<p>Cr\u00e9ez et lancez le conteneur ctn1 comme suit :</p> <pre><code>sudo podman run -dit --net ns:/var/run/netns/nsctn1 --name ctn1 debian\n</code></pre> <p>D\u00e9tail des options -dit et --net : Le d lance le conteneur en arri\u00e8re plan. Le i autorise le mode interactif avec le conteneur. Le t alloue un pseudo terminal au conteneur. Le net ns attache le conteneur \u00e0 l'espace nsctn1.</p> <p> </p> Podman : Cr\u00e9ation du conteneur ctn1 <p>Le conteneur cr\u00e9\u00e9 est stock\u00e9 dans /var/lib/containers/storage/overlay-containers/.</p> <p>V\u00e9rifiez la cr\u00e9ation et le statut du conteneur :</p> <pre><code>sudo podman ps\n</code></pre> <p> </p> Podman : Conteneur ctn1 cr\u00e9\u00e9 et d\u00e9marr\u00e9 <p>Inspectez par curiosit\u00e9 les informations du conteneur :</p> <pre><code>sudo podman inspect ctn1 | grep net\nsudo podman inspect ctn1 | grep Address\n</code></pre> <p>Cdes Podman utiles : Arr\u00eat -&gt; sudo podman stop ou kill nom-conteneur D\u00e9marrage -&gt; sudo podman start nom-conteneur Suppression -&gt; sudo podman rm nom-conteneur</p>"},{"location":"blog/podman---vboxdeb12-12/#-conteneur-podman-ctn2","title":"- Conteneur Podman ctn2","text":"<p>A pr\u00e9sent, cr\u00e9ez et lancez le conteneur ctn2 :</p> <pre><code>sudo podman volume create uptime-kuma\n\nsudo podman run -dit --net ns:/var/run/netns/nsctn2 --name ctn2 -v uptime-kuma:/app/data uptime-kuma:1\n</code></pre> <p>Cdes d\u00e9duites de cette page du site dockerhub.</p> <p>V\u00e9rifiez le r\u00e9sultat des cr\u00e9ations :</p> <pre><code>sudo podman volume ls\nsudo podman ps\n</code></pre> <p> </p> Podman : Conteneur ctn2 cr\u00e9\u00e9 et d\u00e9marr\u00e9 <p>Le conteneur ctn2 doit \u00eatre \u00e0 l'\u00e9tat UP.</p> <p>Le volume cr\u00e9\u00e9 est stock\u00e9 dans /var/lib/containers/storage/volumes/.</p> <p>Les donn\u00e9es persistantes d'Uptime Kuma seront stock\u00e9es sur le volume cr\u00e9\u00e9 et resteront disponibles m\u00eame apr\u00e8s une suppression ou une MAJ du conteneur.</p> <p>Cdes Podman utiles : Suppression -&gt; sudo podman volume rm nom-volume</p> <p>V\u00e9rifiez l'ID de l'espace de noms r\u00e9seau comme ceci :</p> <pre><code>sudo podman ps --namespace\n</code></pre> <p>Retour :</p> <pre><code>CONTAINER ID NAMES PID  CGROUPNS   ... NET        ..      \n4e84e08e79f5 ctn1  1144 4026532389 ... 4026532388 ..\n215292d920df ctn2  1200 4026532394 ... 4026532393 ..\n</code></pre> <p>ou comme ceci :</p> <pre><code>sudo lsns -t net\n</code></pre> <p>Retour :</p> <pre><code>        NS ...  PID USER ... NSFS              ...\n4026532388 ... 1144 root ... /run/netns/nsctn1 ...\n4026532393 ... 1200 root ... /run/netns/nsctn2 ...\n</code></pre>"},{"location":"blog/podman---vboxdeb12-12/#-interactions-avec-ctn1ctn2","title":"- Interactions avec ctn1/ctn2","text":"<p>La Cde podman exec est disponible pour cela.</p> <p>Commencez par tester celle-ci sur ctn1 :</p> <pre><code>sudo podman exec -it ctn1 bash\n</code></pre> <p>Un prompt root@ID du conteneur ctn1:/# doit s'afficher.</p> <p>Observez ensuite l'arborescence de ctn1 avec la Cde ls :</p> <pre><code>[root@4e84e08e79f5:/#] ls\n</code></pre> <p> </p> Podman : Arborescence du conteneur ctn1 <p>La Cde cat /etc/resolv.conf doit retourner l'IP de la box Internet et les Cdes de mise \u00e0 jour du conteneur apt update et apt upgrade doivent fonctionner.</p> <p>Utilisez la Cde exit pour fermer la connexion en cours.</p> <p>Testez ensuite les 4 Cdes ci-dessus avec ctn2.</p> <p>Testez \u00e9galement depuis le navigateur Firefox de srvlan l'URL <code>http://192.168.3.8:3001</code> qui doit retourner la page setup de l'application Uptime Kuma.</p>"},{"location":"blog/podman---vboxdeb12-12/#ajout-de-paquets-sur-ctn1ctn2","title":"Ajout de paquets sur ctn1/ctn2","text":"<p>Nota</p> <p>Les Cdes ip address et ping ne sont pas incluses dans les images debian et uptime-kuma.</p> <p>Pour corriger cela, modifiez le conteneur ctn1 ainsi :</p> <pre><code>sudo podman exec -it ctn1 bash\n\n[root@4e84e08e79f5:/#] apt update\n[root@4e84e08e79f5:/#] apt install iproute2\n[root@4e84e08e79f5:/#] ip address\n</code></pre> <p>La Cde ip address doit retourner l'IP du conteneur.</p> <pre><code>[root@4e84e08e79f5:/#] apt install iputils-ping\n[root@4e84e08e79f5:/#] chmod u+s /bin/ping\n[root@4e84e08e79f5:/#] setcap cap_net_raw+p /bin/ping\n[root@4e84e08e79f5:/#]  ping 192.168.3.1\n</code></pre> <p>La Cde ping doit recevoir une r\u00e9ponse positive.</p> <pre><code>[root@4e84e08e79f5:/#]  exit\n</code></pre> <p>Effectuez la m\u00eame op\u00e9ration avec le conteneur ctn2.</p> <p>Sauvegardez ensuite les modifications r\u00e9alis\u00e9es en cr\u00e9ant deux nouvelles images locales :</p> <pre><code>sudo podman commit ctn1 debian:1             # latest -&gt; tag 1\nsudo podman commit ctn2 uptime-kuma:2  # tag 1 -&gt; tag 2\n</code></pre> <p>Pour finir, v\u00e9rifiez la cr\u00e9ation des nouvelles images :</p> <pre><code>sudo podman images\n</code></pre> <p> </p> Podman : Affichage des 2 nouvelles images locales"},{"location":"blog/podman---vboxdeb12-12/#demarrage-auto-de-ctn1ctn2","title":"D\u00e9marrage auto de ctn1/ctn2","text":"<p>Au pr\u00e9alable, recr\u00e9ez les conteneurs ctn1/ctn2 \u00e0 partir des images locales qui int\u00e8grent les modifications permettant d'utiliser les Cdes ip address et ping.</p> <p>ctn1 :</p> <pre><code>sudo podman kill ctn1\nsudo podman rm ctn1\n\nsudo podman run -dit --net ns:/var/run/netns/nsctn1 --name ctn1 debian:1\n</code></pre> <p>ctn2 :</p> <pre><code>sudo podman kill ctn2\nsudo podman rm ctn2\n\nsudo podman run -dit --net ns:/var/run/netns/nsctn2 --name ctn2 -v uptime-kuma:/app/data uptime-kuma:2\n</code></pre> <p>V\u00e9rifiez ensuite le bon d\u00e9marrage des 2 conteneurs :</p> <pre><code>sudo podman ps\n</code></pre> <p> </p> Podman : Conteneurs issus des nouvelles images <p>Podman fournit une Cde pour g\u00e9n\u00e9rer le service de d\u00e9marrage automatique d'un conteneur.</p> <p>Suivez la s\u00e9quence de Cdes ci-dessous pour ctn1 :</p> <pre><code>cd /etc/systemd/system\n\nsudo podman generate systemd --new --files --name ctn1\ncat container-ctn1.service              # Lecture par curiosit\u00e9\n\nsudo systemctl daemon-reload\nsudo systemctl start container-ctn1\nsudo systemctl status container-ctn1\nsudo systemctl enable container-ctn1\n</code></pre> <p>Effectuez la m\u00eame s\u00e9quence de Cdes mais pour ctn2.</p> <p>Puis rebootez la VM ovs et contr\u00f4lez le r\u00e9sultat :</p> <pre><code>sudo podman ps\n</code></pre> <p>Les conteneurs ctn1/ctn2 doivent avoir le statut UP.</p>"},{"location":"blog/podman---vboxdeb12-12/#test-de-pings-sur-le-reseau","title":"Test de pings sur le r\u00e9seau","text":"<p>Connectez-vous sur le conteneur ctn1 :</p> <pre><code>sudo podman exec -it ctn1 bash\n</code></pre> <p>et testez les pings suivants :</p> <pre><code>[root@... :/#] ping lemonde.fr           # Internet\n[root@... :/#] ping 192.168.2.1         # VM srvsec\n[root@... :/#] ping 192.168.4.2         # VM srvdmz\n[root@... :/#] ping 192.168.3.4         # VM debian12-vm2\n</code></pre> <p>Tous doivent recevoir une r\u00e9ponse positive.</p> <p>Pour finir, testez un ping depuis la VM srvsec sur ctn1 :</p> <pre><code>[root@srvsec:~#] ping 192.168.3.6              # Conteneur ctn1\n</code></pre> <p>Si retour OK, la partie 1 est alors termin\u00e9e.</p> <p></p> <p>  Voil\u00e0, premi\u00e8re \u00e9tape franchie ! La partie 2 vous attend \u00e0 pr\u00e9sent pour la cr\u00e9ation d'un conteneur Podman en mode rootless.</p> <p>Partie 2</p>"},{"location":"blog/podman---vboxdeb12-22/","title":"Podman - VBox/Deb12 2/2","text":""},{"location":"blog/podman---vboxdeb12-22/#memento-52-conteneurs-lxc","title":"M\u00e9mento 5.2 - Conteneurs LXC","text":"<p>Vous allez \u00e0 pr\u00e9sent cr\u00e9er un conteneur plus s\u00e9curis\u00e9 dit rootless, celui-ci diminuant le risque de voir l'utilisateur root du conteneur obtenir tous les droits sur l'h\u00f4te ovs.</p> <p>Le conteneur rootless (non privil\u00e9gi\u00e9) se veut plus isol\u00e9 de l'h\u00f4te LXC qu'un conteneur rootfull.</p>"},{"location":"blog/podman---vboxdeb12-22/#conteneur-en-mode-rootless","title":"Conteneur en mode rootless","text":"<p>Pour le raccordement r\u00e9seau d'un conteneur rootless, Podman utilise par d\u00e9faut le paquet slirp4netns qui fournit une interface r\u00e9seau virtuelle de type Tun/Tap.</p> <p>Le conteneur partage alors le m\u00eame espace de noms r\u00e9seau que l'h\u00f4te, ce qui signifie qu'il partage la m\u00eame interface r\u00e9seau, les m\u00eames tables de routage, etc...</p> <p>Le conteneur rootless ne disposant pas par d\u00e9faut d'une adresse IP, c'est le mappage de ports qui est utilis\u00e9 pour joindre celui-ci.</p> <p>Nota</p> <p>Depuis la version 4.0, il est possible de faire appel \u00e0 netavark pour configurer le r\u00e9seau (non trait\u00e9 ici).</p> <p>Le conteneur ctn3 sera donc raccord\u00e9 par d\u00e9faut ainsi :</p> <p> </p> Podman : Raccordement de ctn3 sur l'h\u00f4te"},{"location":"blog/podman---vboxdeb12-22/#-conteneur-podman-ctn3","title":"- Conteneur Podman ctn3","text":"<p>Les conteneurs rootless sont cr\u00e9\u00e9s et accessibles sans avoir besoin d'\u00eatre root ou un utilisateur du groupe sudo.</p> <p>Ceci est plus s\u00e9curis\u00e9 car l'on ne peut pas devenir root sur l'h\u00f4te m\u00eame si l'on r\u00e9ussit \u00e0 sortir du conteneur.</p> <p>Cr\u00e9ez et lancez le conteneur ctn3 comme suit :</p> <pre><code>podman pull docker.io/louislam/uptime-kuma:1\n\npodman volume create uptime-kuma\n\npodman run -dit --name ctn3 -p 3001:3001 -v uptime-kuma:/app/data uptime-kuma:1\n</code></pre> <p>Les donn\u00e9es persistantes d'Uptime Kuma seront stock\u00e9es sur le volume cr\u00e9\u00e9 et resteront disponibles m\u00eame apr\u00e8s une suppression ou une MAJ du conteneur.</p> <p>D\u00e9tail des options -dit et -p : Le d lance le conteneur en arri\u00e8re plan. Le i autorise le mode interactif avec le conteneur. Le t alloue un pseudo terminal au conteneur. Le p mappe le port 3001 d'ovs sur le port 3001 de ctn3.</p> <p>V\u00e9rifiez le t\u00e9l\u00e9chargement et les cr\u00e9ations :</p> <pre><code>podman images\npodman volume ls\npodman ps\n</code></pre> <p>Retour de la Cde podman ps :</p> <p> </p> Podman : Conteneur ctn3 cr\u00e9\u00e9 et d\u00e9marr\u00e9 <p>L'image, le volume et le conteneur se trouvent dans : /home/switch/.local/share/containers/storage/*</p>"},{"location":"blog/podman---vboxdeb12-22/#-interaction-avec-ctn3","title":"- Interaction avec ctn3","text":"<p>Connectez-vous sur ctn3 :</p> <pre><code>podman exec -it ctn3 bash\n</code></pre> <p>Un prompt root@ID du conteneur ctn3:/# doit s'afficher :</p> <p> </p> Podman : Arborescence du conteneur ctn3 <p>Le retour de la Cde cat /etc/resolv.conf doit montrer l'IP de la box Internet et les Cdes de mise \u00e0 jour apt update et apt upgrade doivent fonctionner.</p> <p>V\u00e9rifiez depuis le navigateur Firefox de srvlan que l'URL <code>http://192.168.3.15:3001</code> affiche bien la page setup de l'application Uptime Kuma.</p> <p>L'IP de l'URL est celle de l'h\u00f4te du conteneur soit ovs.</p> <p>Ajoutez ensuite le paquet iproute2 au conteneur :</p> <pre><code>[root@106374e6e828:/app#] apt install iproute2\n</code></pre> <p>et observez la configuration r\u00e9seau par d\u00e9faut :</p> <pre><code>[root@106374e6e828:/app#] ip address\n</code></pre> <p> </p> Podman : Configuration r\u00e9seau de ctn3 <p>Le r\u00e9sultat montre la pr\u00e9sence de l'interface TAP (tap0) au sein du conteneur.</p> <p>Si non install\u00e9, ajoutez \u00e9galement le paquet iputils-ping puis autorisez l'usage de la Cde ping depuis ctn3 en modifiant le param\u00e8tre suivant au niveau de l'h\u00f4te ovs :</p> <pre><code>[root@106374e6e828:/app#] exit\n\nsudo sysctl -w \"net.ipv4.ping_group_range=0     2000000\"\n</code></pre> <p>Fichier modifi\u00e9 = /proc/sys/net/ipv4/ping_group_range (valeurs par d\u00e9faut = 1 0).</p> <p>Reconnectez-vous sur ctn3 et tester la Cde ping :</p> <pre><code>podman exec -it ctn3 bash\n\n[root@106374e6e828:/app#] ping google.fr\n</code></pre> <p> </p> Podman : Cde ping fonctionnelle depuis ctn3 <p>Pour l'autoriser de fa\u00e7on permanente, proc\u00e9dez ainsi :</p> <pre><code>[root@106374e6e828:/app#] exit\n\nsudo nano /etc/sysctl.d/99-allow-ping.conf\n</code></pre> <p>Entrez la ligne suivante :</p> <pre><code>net.ipv4.ping_group_range=0   2000000\n</code></pre>"},{"location":"blog/podman---vboxdeb12-22/#sauvegarde-de-ctn3-modifie","title":"Sauvegarde de ctn3 modifi\u00e9","text":"<p>Sauvegardez les modifications r\u00e9alis\u00e9es au niveau du conteneur ctn3 en cr\u00e9ant une image locale de l'application Uptime Kuma :</p> <pre><code>podman commit ctn3 uptime-kuma:2\n</code></pre> <p>V\u00e9rifiez la cr\u00e9ation de l'image locale :</p> <pre><code>podman images\n</code></pre> <p> </p> Podman : Vue de l'image locale uptime-kuma:2 <p>et recr\u00e9ez le conteneur ctn3 \u00e0 partir de celle-ci :</p> <pre><code>podman kill ctn3\npodman rm ctn3\n\npodman run -dit --name ctn3 -p 3001:3001 -v uptime-kuma:/app/data uptime-kuma:2\n</code></pre> <p>V\u00e9rifiez le d\u00e9marrage du conteneur :</p> <pre><code>podman ps\n</code></pre> <p> </p> Podman : Conteneur ctn3 issu de l'image locale"},{"location":"blog/podman---vboxdeb12-22/#demarrage-auto-de-ctn3","title":"D\u00e9marrage auto de ctn3","text":"<p>Podman fournit une Cde pour g\u00e9n\u00e9rer le service de d\u00e9marrage automatique d'un conteneur.</p> <p>Suivez la s\u00e9quence de Cdes ci-dessous pour ctn3 :</p> <pre><code>cd /home/switch\n\nsudo loginctl enable-linger switch\npodman generate systemd --new --files --name ctn3\ncat container-ctn3.service               # Lecture par curiosit\u00e9\n\nmkdir -p .config/systemd/user\nmv container-ctn3.service .config/systemd/user/container-ctn3.service\n\npodman stop ctn3\n\nsystemctl --user daemon-reload\nsystemctl --user start container-ctn3\nsystemctl --user status container-ctn3\nsystemctl --user enable container-ctn3\n</code></pre> <p>Puis rebootez la VM ovs et contr\u00f4lez le r\u00e9sultat :</p> <pre><code>podman ps\n</code></pre> <p>Le conteneur ctn3 doit avoir le statut UP.</p>"},{"location":"blog/podman---vboxdeb12-22/#test-de-pings-sur-le-reseau","title":"Test de pings sur le r\u00e9seau","text":"<p>Connectez-vous sur le conteneur ctn3 :</p> <pre><code>podman exec -it ctn3 bash\n</code></pre> <p>et testez les pings suivants :</p> <pre><code>[root@... :/#] ping lemonde.fr          # Internet\n[root@... :/#] ping 192.168.2.1         # VM srvsec\n[root@... :/#] ping 192.168.4.2         # VM srvdmz\n[root@... :/#] ping 192.168.3.4         # VM debian12-vm2\n</code></pre> <p>Tous doivent recevoir une r\u00e9ponse positive.</p> <p>Testez de nouveau depuis srvlan l'URL d'acc\u00e8s \u00e0 Uptime Kuma soit <code>http://192.168.3.15:3001</code>.</p> <p>Si la page setup s'affiche, alors c'est termin\u00e9.</p> <p></p> <p>  Voil\u00e0 pour les bases de Podman ! Le m\u00e9mento 6.1 vous attend pour d\u00e9couvrir l'acc\u00e8s \u00e0 distance sur les VM et les conteneurs.</p> <p>M\u00e9mento 6.1</p>"},{"location":"blog/srvdmz---vboxdeb12/","title":"srvdmz - VBox/Deb12","text":""},{"location":"blog/srvdmz---vboxdeb12/#memento-31-serveur-srvdmz","title":"M\u00e9mento 3.1 - Serveur srvdmz","text":"<p>IPFire \u00e9tant install\u00e9, vous allez \u00e0 pr\u00e9sent cr\u00e9er le serveur srvdmz que vous placerez en zone dite d\u00e9militaris\u00e9e et qui fournira plus tard des services tels que le Web, FTP, DNS, Mail, etc... pour Internet et le r\u00e9seau local.</p> <p>La configuration sera identique \u00e0 celle de la VM srvlan hormis la partie r\u00e9seau.</p>"},{"location":"blog/srvdmz---vboxdeb12/#construction-de-la-vm","title":"Construction de la VM","text":"<p>L'utilisation de VirtualBox est consid\u00e9r\u00e9e acquise.</p> <p>A d\u00e9faut, r\u00e9f\u00e9rez-vous aux m\u00e9mentos suivants : VirtualBox - Installation VirtualBox - Mode d\u2019acc\u00e8s r\u00e9seau par pont</p>"},{"location":"blog/srvdmz---vboxdeb12/#-creation-et-configuration","title":"- Cr\u00e9ation et configuration","text":"<p>Le PC h\u00f4te doit \u00eatre un PC 64 bits, courant de nos jours.</p> <p>T\u00e9l\u00e9chargez l'ISO debian-12.x.y-amd64-netinst.iso : https://cdimage.debian.org/.../current/amd64/iso-cd/</p> <p>- D\u00e9marrez ensuite l'application VirtualBox 7.x, puis : - - Menu de VirtualBox &gt; Machine &gt; Nouvelle... -&gt; Nom : srvdmz DMZ -&gt; Folder : S\u00e9lectionnez le dossier de stockage des VM -&gt; ISO Image : S\u00e9lectionnez l'ISO t\u00e9l\u00e9charg\u00e9e ci-dessus -&gt; Type : Linux -&gt; Version : Debian (64-bit) -&gt; Cochez Skip Unattended Installation (important) -&gt; Bouton Suivant</p> <p>-&gt; M\u00e9moire vive : 1024 MB -&gt; Processors : 2 CPU si possible -&gt; Bouton Suivant</p> <p>-&gt; Create a Virtual Hard Disk Now : Ajustez \u00e0 12 Go -&gt; Bouton Suivant</p> <p>-&gt; V\u00e9rifiez le R\u00e9capitulatif -&gt; Bouton Finish</p> <p>La VM s'affiche dans le panneau gauche de VirtualBox.</p> <p>- S\u00e9lectionnez maintenant la nouvelle VM, puis : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet G\u00e9n\u00e9ral -&gt; Avanc\u00e9 &gt; Presse-papier partag\u00e9 &gt; Bidirectionnel</p> <p>- - - Onglet Syst\u00e8me -&gt; Carte m\u00e8re &gt; Ordre d'amor\u00e7age &gt; D\u00e9cochez Disquette -&gt; Processeur &gt; Cochez Activer PAE/NX</p> <p>Facultatif, acc\u00e8s au dossier partag\u00e9 par le PC h\u00f4te : - - - Onglet Dossiers partag\u00e9s -&gt; Cliquez sur l'ic\u00f4ne + (Ajoute un ... dossier partag\u00e9.) -&gt; Chemin du dossier &gt; S\u00e9lectionnez Autre... -&gt; Acc\u00e9dez \u00e0 votre dossier &gt; Ex : C:\\Partage-Windows -&gt; S\u00e9lectionner un dossier ou Ouvrir &gt; OK &gt; OK</p> <p>Les autres param\u00e8tres peuvent rester inchang\u00e9s.</p>"},{"location":"blog/srvdmz---vboxdeb12/#-installation-de-debian-12","title":"- Installation de Debian 12","text":"<p>Conseil pratique avant de d\u00e9marrer la nouvelle VM : Si le curseur de la souris dispara\u00eet lors d'un clic dans la fen\u00eatre de la VM, celui-ci peut \u00eatre r\u00e9cup\u00e9r\u00e9 par le PC h\u00f4te \u00e0 l'aide de la touche CTRL situ\u00e9e \u00e0 droite de la barre d'espace du clavier.</p> <p>- - Menu de VirtualBox &gt; Machine &gt; D\u00e9marrer -&gt; D\u00e9marrage normal (La VM s'ex\u00e9cute)</p> <p>S\u00e9lectionnez Graphical Install et appliquez ce qui suit : - Language &gt; Fran\u00e7ais - Pays (territoire ou r\u00e9gion) &gt; France - Disposition de clavier \u00e0 utiliser &gt; Fran\u00e7ais - Nom de machine &gt; srvdmz - Domaine &gt; Laissez le champ vide - MDP du super utilisateur root &gt; Votre MDP root - Confirmation du MDP &gt; Votre MDP root - Nom complet du nouvel utilisateur &gt; Ex: srvdmz - Identifiant pour le compte utilisateur &gt; srvdmz - MDP pour le nouvel utilisateur &gt; Votre MDP srvdmz - Confirmation du MDP &gt; Votre MDP srvdmz - M\u00e9thode de partitionnement &gt; Assist\u00e9 - utili... entier - Disque \u00e0 partitionner &gt; Celui propos\u00e9 de 12 Go - Sch\u00e9ma de partitionnement &gt; Tout ... seule partition - Table des partitions &gt; Terminer le partitionnement .. - Faut-il appliquer les changements ... disques ? &gt; Oui</p> <p>L'installation commence : - Faut-il analyser d'autres supports ... ? &gt; Non - Pays du miroir de l'archive Debian &gt; France - Miroir de l'archive Debian &gt; deb.debian.org - Mandataire HTTP (lais...) &gt; Laissez vide</p> <p>L'installation continue : - Souhaitez-vous participer \u00e0 l'\u00e9tude statistique ... &gt; Non - Logiciels \u00e0 installer -&gt; D\u00e9cochez environnement de bureau Debian -&gt; D\u00e9cochez ... GNOME -&gt; Cochez ... Xfce -&gt; Conservez utilitaires usuels du syst\u00e8me</p> <p>L'installation se termine : - Installer ... de d\u00e9marrage GRUB sur le disque ... &gt; Oui - P\u00e9riph\u00e9rique ... programme de d\u00e9marrage &gt; /dev/sda - Installation termin\u00e9e &gt; Continuer (sans retrait du CD)</p> <p>Le syst\u00e8me reboot et une fen\u00eatre de connexion s'ouvre :</p> <p> </p> Fen\u00eatre de connexion Xfce <p>-&gt; Premier champ : Entrez srvdmz -&gt; Second champ : Entrez Votre MDP srvdmz -&gt; Bouton Se connecter</p> <p>Le bureau Xfce s'ouvre :</p> <p> </p> Bureau Xfce <p>Ouvrez le terminal de Cdes en cliquant sur son ic\u00f4ne situ\u00e9e en bas \u00e0 l'int\u00e9rieur du dock.</p> <p>Autorisez l'usage de sudo \u00e0 l'utilisateur srvdmz :</p> <pre><code>[srvdmz@srvdmz:~$] su root\nMot de passe : Votre MDP root\n[root@srvdmz:~#] sudo usermod -aG sudo srvdmz\n[root@srvdmz:~#] exit\n</code></pre> <p>et red\u00e9marrez le serveur : - - Menu Applications de Xfce situ\u00e9 en haut \u00e0 gauche -&gt; D\u00e9connexion (Une fen\u00eatre s'ouvre) -&gt; Bouton Red\u00e9marrer</p> <p>Reconnectez-vous ensuite en tant qu'utilisateur srvdmz et rouvrez le terminal de Cdes.</p>"},{"location":"blog/srvdmz---vboxdeb12/#ajout-des-utilitaires-virtualbox","title":"Ajout des utilitaires VirtualBox","text":"<p>Ils permettront entre autres le copier/coller et l'acc\u00e8s au dossier partag\u00e9 par le PC h\u00f4te.</p> <p>Notez par curioist\u00e9 la version courante du noyau linux :</p> <pre><code>[srvdmz@srvdmz:~$] uname -r\n</code></pre> <p>Exemple de retour :</p> <pre><code>6.1.0-10-amd64\n</code></pre> <p>Installez ensuite les 2 paquets Linux suivants :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install dkms build-essential\n</code></pre> <p>Debian installera automatiquement la d\u00e9pendance linux-headers-6.1.0-10-amd64.</p> <p>Ouvrez le menu VirtualBox situ\u00e9 sur la fen\u00eatre de la VM : -&gt; P\u00e9riph\u00e9riques &gt; Ins\u00e9rer l'image CD des Additions inv...</p> <p>Montez l'image CD, installez les utilitaires et rebootez :</p> <pre><code>[srvdmz@srvdmz:~$] sudo mount /dev/cdrom /media/cdrom\n[srvdmz@srvdmz:~$] cd /media/cdrom\n[srvdmz@srvdmz:~$] sudo ./VBoxLinuxAdditions.run\n[srvdmz@srvdmz:~$] sudo reboot\n</code></pre> <p>Une fois fini, reconnectez-vous, la fen\u00eatre de la VM peut \u00e0 pr\u00e9sent \u00eatre redimensionn\u00e9e avec la souris. Sa nouvelle taille sera enregistr\u00e9e au sein de srvdmz.</p> <p>Le copier/coller entre le PC h\u00f4te et srvdmz doit maintenant fonctionner dans les 2 sens.</p> <p>Sans fermer la VM, retirez l'image CD du lecteur virtuel : - - Menu de VirtualBox &gt; Machine &gt; Configurations... - - - Onglet Stockage -&gt; Zone Unit\u00e9s de stockage &gt; S\u00e9lectionnez VBoxGuest... -&gt; Zone Attributs &gt; Cliquez sur l'ic\u00f4ne CD -&gt; Retirer le disque du lecteur virtuel &gt; OK</p>"},{"location":"blog/srvdmz---vboxdeb12/#suppression-de-paquets-debian","title":"Suppression de paquets Debian","text":"<p>Supprimez ces applications non utiles sur srvdmz :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt autoremove --purge \\\nlibreoffice-writer libreoffice-impress \\\nlibreoffice-calc libreoffice-math \\\nlibreoffice-draw libreoffice-base-core \\\nlibreoffice-core libreoffice-common\n</code></pre> <pre><code>[srvdmz@srvdmz:~$] sudo rm -r /etc/libreoffice\n[srvdmz@srvdmz:~$] sudo rm -r /usr/share/fonts/truetype/libreoffice\n</code></pre> <pre><code>[srvdmz@srvdmz:~$] sudo apt autoremove --purge \\\nexfalso quodlibet\n</code></pre> <p>La configuration de base est presque termin\u00e9e :</p> <p> </p> Debian 12 : Bureau Xfce personnalis\u00e9 <p>La consommation RAM actuelle est d'environ 500 Mo.</p> <p>Pour un m\u00eame fond d'\u00e9cran sur la fen\u00eatre de login Lightdm et le bureau Xfce, proc\u00e9dez ainsi :</p> <pre><code>[srvdmz@srvdmz:~$] cd /chemin-de-votre-fond-ecran\n[srvdmz@srvdmz:~$] sudo cp fond.jpg /usr/share/backgrounds/\n[srvdmz@srvdmz:~$] cd /etc/lightdm\n[srvdmz@srvdmz:~$] sudo nano lightdm-gtk-greeter.conf\n</code></pre> <p>Remplacez la ligne #background= par celle-ci :</p> <pre><code>background=/usr/share/backgrounds/fond.jpg\n</code></pre>"},{"location":"blog/srvdmz---vboxdeb12/#contenu-partage-par-le-pc-hote","title":"Contenu partag\u00e9 par le PC h\u00f4te","text":"<p>Cr\u00e9ez le dossier qui permettra d'afficher le contenu partag\u00e9 par le PC h\u00f4te :</p> <pre><code>[srvdmz@srvdmz:~$] mkdir /home/srvdmz/Partage\n</code></pre> <p>Cr\u00e9ez le service home-srvdmz-Partage.mount :</p> <pre><code>[srvdmz@srvdmz:~$] cd /etc/systemd/system\n[srvdmz@srvdmz:~$] sudo touch home-srvdmz-Partage.mount\n</code></pre> <p>Editez celui-ci :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano home-srvdmz-Partage.mount\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription = Montage dossier partag\u00e9 fourni par VirtualBox\n\n[Mount]\nWhat = _Entrez le nom du dossier partag\u00e9 par le PC h\u00f4te_\nWhere = /home/srvdmz/Partage\nType = vboxsf\nOptions=rw,uid=srvdmz,gid=srvdmz\n\n[Install]\nWantedBy = multi-user.target\n</code></pre> <p>Exemple pour What : What=Partage-Alfred</p> <p>Int\u00e9grez le service dans la configuration de systemd :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl daemon-reload\n</code></pre> <p>et d\u00e9marrez celui-ci :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl start home-srvdmz-Partage.mount\n</code></pre> <p>V\u00e9rifiez ensuite son statut :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl status home-srvdmz-Partage.mount\n</code></pre> <p>Touche q pour quitter le r\u00e9sultat affich\u00e9.</p> <p>Si statut = active, autorisez le service au boot de la VM :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl enable home-srvdmz-Partage.mount\n</code></pre> <p>Un lien symbolique vers le service est cr\u00e9\u00e9.</p> <p>Ouvrez le gestionnaire de fichiers thunar et observez le contenu de /home/srvdmz/Partage.</p>"},{"location":"blog/srvdmz---vboxdeb12/#configuration-reseau-de-la-vm","title":"Configuration r\u00e9seau de la VM","text":"<p>Avant, v\u00e9rifiez l'IP courante avec la Cde ip address :</p> <pre><code>[srvdmz@srvdmz:~$] ip address\n</code></pre> <p>R\u00e9sultat, IP 10.0.2.15, IP fournie par VirtualBox :</p> <p> </p> R\u00e9sultat de la Cde ip address <p>La VM srvdmz \u00e9tant pr\u00e9vue en zone DMZ, il faut changer le mode d'acc\u00e8s r\u00e9seau de sa carte r\u00e9seau enp0s3.</p> <p>Pour cela, s\u00e9lectionnez la VM srvdmz dans VirtualBox : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet R\u00e9seau -&gt; Adapter 1 &gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; OK</p>"},{"location":"blog/srvdmz---vboxdeb12/#-ip-de-la-carte-reseau-enp0s3","title":"- IP de la carte r\u00e9seau enp0s3","text":"<p>Configurez \u00e0 pr\u00e9sent une IP fixe sur la carte\u00a0enp0s3\u00a0: - - Bureau Xfce, barre du haut -&gt; Clic droit sur l'ic\u00f4ne\u00a0R\u00e9seau\u00a0situ\u00e9e \u00e0 droite -&gt; S\u00e9lectionnez\u00a0Modifier les connexions...  </p> <p>Une fen\u00eatre\u00a0Connexions r\u00e9seau\u00a0s'ouvre : -&gt; S\u00e9lectionnez la connexion Wired connection 1 -&gt; Cliquez sur l'ic\u00f4ne\u00a0roue dent\u00e9e\u00a0de la fen\u00eatre  </p> <p>Une fen\u00eatre\u00a0Modification de ...\u00a0s'ouvre : -&gt; Nom de la connexion &gt; Entrez Connexion carte 1  </p> <p>- - - Onglet Ethernet -&gt; P\u00e9riph\u00e9rique &gt; S\u00e9lectionnez enp0s3  </p> <p>- - - Onglet\u00a0Param\u00e8tres IPv4 -&gt; M\u00e9thode &gt; S\u00e9lectionnez\u00a0Manuel\u00a0&gt; Bouton\u00a0Ajouter -&gt; Champ Adresse : Entrez\u00a0192.168.4.2 -&gt; Champ Masque de r\u00e9seau : Entrez\u00a0255.255.255.0 -&gt; Champ Passerelle : Entrez\u00a0192.168.4.1 -&gt; Serveurs DNS &gt; Entrez l'IP locale de votre Box Internet -&gt; Bouton\u00a0Enregistrer  </p> <p>Fermez ensuite la fen\u00eatre\u00a0Connexions r\u00e9seau. Le service r\u00e9seau red\u00e9marre automatiquement.</p> <p>V\u00e9rifiez par prudence la bonne configuration du r\u00e9seau :</p> <pre><code>[srvdmz@srvdmz:~$] ip address\n[srvdmz@srvdmz:~$] nmcli      # Cde NetworkManager\n</code></pre> <p> </p> R\u00e9sultat de la Cde nmcli <p>Les fichiers configur\u00e9s avec networkmanager sont ici : /etc/NetworkManager/system-connections/</p> <p>Nota</p> <p>La VM srvdmz acc\u00e8de \u00e0 Internet si la VM srvsec est d\u00e9marr\u00e9e.</p> <p>Le service r\u00e9seau peut \u00eatre red\u00e9marr\u00e9 avec cette Cde :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart NetworkManager\n</code></pre> <p>Par curiosit\u00e9, lisez la table de routage avec la Cde ip r :</p> <p> </p> Table de routage courante de srvdmz <p></p> <p>  Bien ! Les serveurs sont pr\u00eats. Le m\u00e9mento 4.1 vous attend pour la cr\u00e9ation des VM clientes du r\u00e9seau local virtuel.</p> <p>M\u00e9mento 4.1</p>"},{"location":"blog/srvlan---vboxdeb12/","title":"srvlan - VBox/Deb12","text":""},{"location":"blog/srvlan---vboxdeb12/#memento-11-serveur-srvlan","title":"M\u00e9mento 1.1 - Serveur srvlan","text":"<p>L'architecture du r\u00e9seau virtuel propos\u00e9e sous Debian 12 sera la m\u00eame que sous Debian 11 et le serveur srvlan supportera \u00e0 nouveau le bureau l\u00e9ger Xfce.</p> <p>Ce dernier, all\u00e9g\u00e9 de quelques applications pr\u00e9install\u00e9es par d\u00e9faut, contribuera au confort d'exploitation du serveur et facilitera notamment la r\u00e9alisation de certains tests sur le r\u00e9seau.</p> <p>Par souci d'homog\u00e9n\u00e9it\u00e9, Xfce sera l'unique bureau graphique install\u00e9 sur les VM du r\u00e9seau.</p>"},{"location":"blog/srvlan---vboxdeb12/#construction-de-la-vm","title":"Construction de la VM","text":"<p>L'utilisation de VirtualBox est consid\u00e9r\u00e9e acquise.</p> <p>A d\u00e9faut, r\u00e9f\u00e9rez-vous aux m\u00e9mentos suivants : VirtualBox - Installation VirtualBox - Mode d\u2019acc\u00e8s r\u00e9seau par pont</p>"},{"location":"blog/srvlan---vboxdeb12/#-creation-et-configuration","title":"- Cr\u00e9ation et configuration","text":"<p>Le PC h\u00f4te doit \u00eatre un PC 64 bits, courant de nos jours.</p> <p>T\u00e9l\u00e9chargez l'ISO debian-12.x.y-amd64-netinst.iso : https://cdimage.debian.org/.../current/amd64/iso-cd/</p> <p>D\u00e9marrez ensuite l'application VirtualBox, puis : - - Menu de VirtualBox &gt; Machine &gt; Nouvelle... -&gt; Nom : srvlan LAN -&gt; Folder : S\u00e9lectionnez un dossier o\u00f9 stocker vos VM -&gt; ISO Image : S\u00e9lectionnez l'ISO t\u00e9l\u00e9charg\u00e9e ci-dessus -&gt; Type : Linux -&gt; Version : Debian (64-bit) -&gt; Cochez Skip Unattended Installation (important) -&gt; Bouton Suivant</p> <p>-&gt; M\u00e9moire vive : 1024 MB -&gt; Processors : 2 CPU si possible -&gt; Bouton Suivant</p> <p>-&gt; Create a Virtual Hard Disk Now : Ajustez \u00e0 12 Go -&gt; Bouton Suivant</p> <p>-&gt; V\u00e9rifiez le R\u00e9capitulatif -&gt; Bouton Finish</p> <p>La VM est cr\u00e9\u00e9e dans le panneau gauche de VirtualBox.</p> <p>S\u00e9lectionnez maintenant la nouvelle VM, puis : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet G\u00e9n\u00e9ral -&gt; Avanc\u00e9 &gt; Presse-papier partag\u00e9 &gt; Bidirectionnel  </p> <p>- - - Onglet Syst\u00e8me -&gt; Carte m\u00e8re &gt; Ordre d'amor\u00e7age &gt; D\u00e9cochez Disquette -&gt; Processeur &gt; Cochez Activer PAE/NX  </p> <p>Facultatif, acc\u00e8s au dossier partag\u00e9 par le PC h\u00f4te : - - - Onglet Dossiers partag\u00e9s -&gt; Cliquez sur l'ic\u00f4ne + &gt; Ajouter un dossier partag\u00e9 -&gt; Chemin du dossier &gt; S\u00e9lectionnez Autre... -&gt; Acc\u00e9dez \u00e0 votre dossier &gt; Ex : C:\\Partage-Windows -&gt; S\u00e9lectionner un dossier ou Ouvrir &gt; OK &gt; OK</p> <p>Les autres param\u00e8tres peuvent rester inchang\u00e9s.</p>"},{"location":"blog/srvlan---vboxdeb12/#-installation-de-debian-12","title":"- Installation de Debian 12","text":"<p>Conseil pratique avant de d\u00e9marrer la nouvelle VM : Si le curseur de la souris dispara\u00eet lors d'un clic dans la fen\u00eatre de la VM, celui-ci peut \u00eatre r\u00e9cup\u00e9r\u00e9 par le PC h\u00f4te \u00e0 l'aide de la touche CTRL situ\u00e9e \u00e0 droite de la barre d'espace du clavier.</p> <p>- - Menu de VirtualBox &gt; Machine &gt; D\u00e9marrer -&gt; D\u00e9marrage normal (La VM s'ex\u00e9cute)</p> <p>S\u00e9lectionnez Graphical Install et appliquez ce qui suit : - Language &gt; Fran\u00e7ais - Pays (territoire ou r\u00e9gion) &gt; France - Disposition de clavier \u00e0 utiliser &gt; Fran\u00e7ais - Interface r\u00e9seau principale &gt; enp0s3 - Nom de machine &gt; srvlan - Domaine &gt; Laissez le champ vide - MDP du super utilisateur root &gt; Votre MDP root - Confirmation du MDP &gt; Votre MDP root - Nom complet du nouvel utilisateur &gt; Ex: srvlan - Identifiant pour le compte utilisateur &gt; srvlan - MDP pour le nouvel utilisateur &gt; Votre MDP srvlan - Confirmation du MDP &gt; Votre MDP srvlan - M\u00e9thode de partitionnement &gt; Assist\u00e9 - utili... entier - Disque \u00e0 partitionner &gt; Celui propos\u00e9 de 12 Go - Sch\u00e9ma de partitionnement &gt; Tout ... seule partition - Table des partitions &gt; Terminer le partitionnement .. - Faut-il appliquer les changements ... disques ? &gt; Oui</p> <p>L'installation commence : - Faut-il analyser d'autres supports ... ? &gt; Non - Pays du miroir de l'archive Debian &gt; France - Miroir de l'archive Debian &gt; deb.debian.org - Mandataire HTTP (lais...) &gt; Laissez vide</p> <p>L'installation continue : - Souhaitez-vous participer \u00e0 l'\u00e9tude statistique ... &gt; Non - Logiciels \u00e0 installer -&gt; D\u00e9cochez environnement de bureau Debian -&gt; D\u00e9cochez ... GNOME -&gt; Cochez ... Xfce -&gt; Conservez utilitaires usuels du syst\u00e8me</p> <p>L'installation se termine : - Installer ... de d\u00e9marrage GRUB sur le disque ... &gt; Oui - P\u00e9riph\u00e9rique ... programme de d\u00e9marrage &gt; /dev/sda - Installation termin\u00e9e &gt; Continuer (sans retrait du CD)</p> <p>Le syst\u00e8me reboot et une fen\u00eatre de connexion s'ouvre :</p> <p> </p> Fen\u00eatre de connexion Xfce <p>-&gt; Premier champ &gt; Entrez srvlan -&gt; Second champ &gt; Entrez Votre MDP srvlan -&gt; Bouton Se connecter</p> <p>Le bureau Xfce s'ouvre :</p> <p> </p> Bureau Xfce <p>Ouvrez le terminal de Cdes en cliquant sur son ic\u00f4ne situ\u00e9e en bas \u00e0 l'int\u00e9rieur du dock.</p> <p>Autorisez l'usage de sudo \u00e0 l'utilisateur srvlan :</p> <pre><code>[srvlan@srvlan:~$] su root\nMot de passe : Votre MDP root\n[root@srvlan:~#] sudo usermod -aG sudo srvlan\n[root@srvlan:~#] exit\n</code></pre> <p>et red\u00e9marrez le serveur : - - Menu Applications de Xfce situ\u00e9 en haut \u00e0 gauche -&gt; D\u00e9connexion (Une fen\u00eatre s'ouvre) -&gt; Bouton Red\u00e9marrer</p> <p>Reconnectez-vous ensuite en tant qu'utilisateur srvlan et rouvrez le terminal de Cdes.</p>"},{"location":"blog/srvlan---vboxdeb12/#ajout-des-utilitaires-virtualbox","title":"Ajout des utilitaires VirtualBox","text":"<p>Ils permettront entre autres le copier/coller et l'acc\u00e8s au dossier partag\u00e9 par le PC h\u00f4te.</p> <p>Notez au pr\u00e9alable la version courante du noyau linux :</p> <pre><code>[srvlan@srvlan:~$] uname -r\n</code></pre> <p>Exemple de retour :</p> <pre><code>6.1.0-10-amd64\n</code></pre> <p>Installez ensuite les 2 paquets suivants :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install dkms build-essential\n</code></pre> <p>Debian installera automatiquement la d\u00e9pendance linux-headers-6.1.0-10-amd64.</p> <p>Ouvrez le menu VirtualBox situ\u00e9 sur la fen\u00eatre de la VM : -&gt; P\u00e9riph\u00e9riques &gt; Ins\u00e9rer l'image CD des Additions inv...</p> <p>Montez l'image CD, installez les utilitaires et rebootez :</p> <pre><code>[srvlan@srvlan:~$] sudo mount /dev/cdrom /media/cdrom\n[srvlan@srvlan:~$] cd /media/cdrom\n[srvlan@srvlan:~$] sudo ./VBoxLinuxAdditions.run\n[srvlan@srvlan:~$] sudo reboot\n</code></pre> <p>Une fois fini, reconnectez-vous, la fen\u00eatre VM srvlan peut \u00e0 pr\u00e9sent \u00eatre redimensionn\u00e9e avec la souris. Sa nouvelle taille sera enregistr\u00e9e au sein de srvlan.</p> <p>Le pratique copier/coller entre le PC h\u00f4te et srvlan doit maintenant fonctionner dans les 2 sens.</p> <p>Sans fermer la VM, retirez l'image CD du lecteur virtuel : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet Stockage -&gt; Zone Unit\u00e9s de stockage &gt; S\u00e9lectionnez VBoxGuest... -&gt; Zone Attributs &gt; Cliquez sur l'ic\u00f4ne CD -&gt; Retirer le disque du lecteur virtuel &gt; OK</p>"},{"location":"blog/srvlan---vboxdeb12/#suppression-de-paquets-debian","title":"Suppression de paquets Debian","text":"<p>Supprimez ces applications non utiles sur srvlan :</p> <pre><code>[srvlan@srvlan:~$] sudo apt autoremove --purge \\\nlibreoffice-writer libreoffice-impress \\\nlibreoffice-calc libreoffice-math \\\nlibreoffice-draw libreoffice-base-core \\\nlibreoffice-core libreoffice-common\n</code></pre> <pre><code>[srvlan@srvlan:~$] sudo rm -r /etc/libreoffice\n</code></pre> <pre><code>[srvlan@srvlan:~$] sudo apt autoremove --purge \\\nexfalso quodlibet\n</code></pre> <p>La configuration de base est presque termin\u00e9e :</p> <p> </p> Debian 12 : Bureau Xfce personnalis\u00e9 <p>La consommation m\u00e9moire est d'environ 500 Mo.</p> <p>Pour un m\u00eame fond d'\u00e9cran sur la fen\u00eatre de login Lightdm et le bureau Xfce, proc\u00e9dez ainsi :</p> <pre><code>[srvlan@srvlan:~$] cd /chemin-de-votre-fond-ecran\n[srvlan@srvlan:~$] sudo cp fond.jpg /usr/share/backgrounds/\n[srvlan@srvlan:~$] cd /etc/lightdm\n[srvlan@srvlan:~$] sudo nano lightdm-gtk-greeter.conf\n</code></pre> <p>Remplacez la ligne #background= par celle-ci :</p> <pre><code>background=/usr/share/backgrounds/fond.jpg\n</code></pre>"},{"location":"blog/srvlan---vboxdeb12/#contenu-partage-par-le-pc-hote","title":"Contenu partag\u00e9 par le PC h\u00f4te","text":"<p>Cr\u00e9ez le dossier qui permettra d'afficher le contenu partag\u00e9 par le PC h\u00f4te :</p> <pre><code>[srvlan@srvlan:~$] mkdir /home/srvlan/Partage\n</code></pre> <p>Cr\u00e9ez le fichier de service home-srvlan-Partage.mount :</p> <pre><code>[srvlan@srvlan:~$] cd /etc/systemd/system\n[srvlan@srvlan:~$] sudo touch home-srvlan-Partage.mount\n</code></pre> <p>Editez celui-ci :</p> <pre><code>[srvlan@srvlan:~$] sudo nano home-srvlan-Partage.mount\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription = Montage dossier partag\u00e9 fourni par VirtualBox\n\n[Mount]\nWhat = Entrez le nom du dossier partag\u00e9 par le PC h\u00f4te\nWhere = /home/srvlan/Partage\nType = vboxsf\nOptions=rw,uid=srvlan,gid=srvlan\n\n[Install]\nWantedBy = multi-user.target\n</code></pre> <p>Exemple pour What : What=Partage-Alfred</p> <p>Int\u00e9grez le service dans la configuration de systemd :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl daemon-reload\n</code></pre> <p>et d\u00e9marrez celui-ci :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl start home-srvlan-Partage.mount\n</code></pre> <p>V\u00e9rifiez ensuite son statut :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl status home-srvlan-Partage.mount\n</code></pre> <p>Touche q pour quitter le r\u00e9sultat affich\u00e9.</p> <p>Si statut = active, autorisez le service au boot de la VM :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl enable home-srvlan-Partage.mount\n</code></pre> <p>Un lien symbolique vers le service est cr\u00e9\u00e9.</p> <p>Ouvrez enfin le gestionnaire de fichiers thunar et observez le contenu de /home/srvlan/Partage.</p>"},{"location":"blog/srvlan---vboxdeb12/#configuration-reseau-de-la-vm","title":"Configuration r\u00e9seau de la VM","text":"<p>Avant, v\u00e9rifiez l'IP courante avec la Cde ip address :</p> <pre><code>[srvlan@srvlan:~$] ip address\n</code></pre> <p>R\u00e9sultat, IP 10.0.2.15, IP fournie par VirtualBox :</p> <p> </p> R\u00e9sultat de la Cde ip address <p>Puis installez les 2 paquets suivants :</p> <pre><code>[srvlan@srvlan:~$] sudo apt install netfilter-persistent\n</code></pre> <pre><code>[srvlan@srvlan:~$] sudo apt install iptables-persistent\n</code></pre> <p>Une fen\u00eatre Config... iptables-persistent s'ouvre : -&gt; Faut-il enregistrer les r\u00e8gles IPv4 actuelles ? &gt; Oui -&gt; Faut-il enregistrer les r\u00e8gles IPv6 actuelles ? &gt; Oui</p> <p>2 fichiers rules.v4/v6 ont \u00e9t\u00e9 cr\u00e9\u00e9s dans /etc/iptables/. Ils serviront \u00e0 d\u00e9clarer persistantes des r\u00e8gles iptables.</p> <p>La VM srvlan \u00e9tant pr\u00e9vue en zone LAN, il faut changer le mode d'acc\u00e8s r\u00e9seau de sa carte r\u00e9seau enp0s3.</p> <p>Pour cela, s\u00e9lectionnez la VM srvlan dans VirtualBox : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet R\u00e9seau -&gt; Adapter 1 &gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; OK</p>"},{"location":"blog/srvlan---vboxdeb12/#-ip-de-la-carte-reseau-enp0s3","title":"- IP de la carte r\u00e9seau enp0s3","text":"<p>Configurez \u00e0 pr\u00e9sent une IP fixe sur la carte\u00a0enp0s3\u00a0: - - Bureau Xfce, barre du haut -&gt; Clic droit sur l'ic\u00f4ne\u00a0R\u00e9seau\u00a0situ\u00e9e \u00e0 droite -&gt; S\u00e9lectionnez\u00a0Modifier les connexions...  </p> <p>Une fen\u00eatre\u00a0Connexions r\u00e9seau\u00a0s'ouvre : -&gt; S\u00e9lectionnez la connexion Wired connection 1 -&gt; Cliquez sur l'ic\u00f4ne\u00a0roue dent\u00e9e\u00a0de la fen\u00eatre  </p> <p>Une fen\u00eatre\u00a0Modification de ...\u00a0s'ouvre : -&gt; Nom de la connexion &gt; Entrez Connexion carte 1  </p> <p>- - - Onglet Ethernet -&gt; P\u00e9riph\u00e9rique &gt; S\u00e9lectionnez enp0s3  </p> <p>- - - Onglet\u00a0Param\u00e8tres IPv4 -&gt; M\u00e9thode &gt; S\u00e9lectionnez\u00a0Manuel\u00a0&gt; Bouton\u00a0Ajouter -&gt; Champ Adresse : Entrez\u00a0192.168.2.2 -&gt; Champ Masque de r\u00e9seau : Entrez\u00a0255.255.255.0 -&gt; Champ Passerelle : Entrez\u00a0192.168.2.1 -&gt; Serveurs DNS &gt; Entrez l'IP locale de votre Box Internet -&gt; Bouton\u00a0Enregistrer  </p> <p>Fermez ensuite la fen\u00eatre\u00a0Connexions r\u00e9seau.  </p> <p>Pour finir, stoppez la VM srvlan : - - Menu Applications de Xfce situ\u00e9 en haut \u00e0 gauche -&gt; D\u00e9connexion &gt; Une fen\u00eatre s'ouvre -&gt; Bouton Eteindre</p>"},{"location":"blog/srvlan---vboxdeb12/#-ajout-dune-carte-enp0s8","title":"- Ajout d'une carte enp0s8","text":"<p>Le raccordement de la VM srvlan n\u00e9cessite de cr\u00e9er une seconde carte r\u00e9seau sur celle-ci.</p> <p>Pour cela, s\u00e9lectionnez la VM srvlan dans VirtualBox : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet R\u00e9seau -&gt; Adapter 2 &gt; Cochez Activer l'interface r\u00e9seau -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; S\u00e9lectionnez R\u00e9seau interne -&gt; OK</p> <p>Red\u00e9marrez la VM srvlan.</p> <p>Configurez \u00e9galement une IP fixe sur la carte\u00a0enp0s8\u00a0: - - Bureau Xfce, barre du haut -&gt; Clic droit sur l'ic\u00f4ne\u00a0R\u00e9seau\u00a0situ\u00e9e \u00e0 droite -&gt; S\u00e9lectionnez\u00a0Modifier les connexions...  </p> <p>Une fen\u00eatre\u00a0Connexions r\u00e9seau\u00a0s'ouvre : -&gt; S\u00e9lectionnez la nouvelle connexion affich\u00e9e -&gt; Cliquez sur l'ic\u00f4ne roue dent\u00e9e de la fen\u00eatre  </p> <p>Une fen\u00eatre\u00a0Modification de ...\u00a0s'ouvre : -&gt; Nom de la connexion &gt; Connexion carte 2  </p> <p>- - - Onglet Ethernet -&gt; P\u00e9riph\u00e9rique &gt; S\u00e9lectionnez enp0s8  </p> <p>- - - Onglet\u00a0Param\u00e8tres IPv4 -&gt; M\u00e9thode &gt; S\u00e9lectionnez\u00a0Manuel\u00a0&gt; Bouton\u00a0Ajouter -&gt; Champ Adresse : Entrez\u00a0192.168.3.1 -&gt; Champ Masque de r\u00e9seau : Entrez\u00a0255.255.255.0 -&gt; Bouton\u00a0Enregistrer  </p> <p>Fermez ensuite la fen\u00eatre\u00a0Connexions r\u00e9seau.</p> <p>Red\u00e9marrez srvlan et v\u00e9rifiez la configuration r\u00e9seau :</p> <pre><code>[srvlan@srvlan:~$] ip address\n[srvlan@srvlan:~$] nmcli  # Cde NetworkManager\n</code></pre> <p>Les fichiers configur\u00e9s avec NetworkManager sont ici : /etc/NetworkManager/system-connections/</p> <p>Nota</p> <p>La VM srvlan n'acc\u00e8de plus \u00e0 Internet, la VM suivante permettra de retrouver cet acc\u00e8s.</p>"},{"location":"blog/srvlan---vboxdeb12/#-activation-du-routage","title":"- Activation du routage","text":"<p>L'activation du routage avec la Cde ip_forward permet, selon les r\u00e8gles d\u00e9finies dans la table de routage du serveur, le renvoi de paquets de donn\u00e9es arriv\u00e9s par une interface r\u00e9seau vers une autre interface r\u00e9seau.</p> <p>Pour l'activez, \u00e9ditez le fichier sysctl.conf :</p> <pre><code>[srvlan@srvlan:~$] sudo nano /etc/sysctl.conf\n</code></pre> <p>et retirez le # de la ligne #net.ipv4.ip_forward=1.</p> <p>Relancez ensuite le service r\u00e9seau :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl restart NetworkManager\n</code></pre>"},{"location":"blog/srvlan---vboxdeb12/#-translation-dadresses-nat","title":"- Translation d'adresses NAT","text":"<p>-- D\u00e9finition de WIKIBOOKS -- Objectif du NAT (Network Address Translation) : Faire que les PC d'un r\u00e9seau interne n'apparaissent que sous l'identifiant d'une seule IP pour les r\u00e9seaux externes (c'est un masquage ou IP Masquerading).</p> <p>Votre box Internet (passerelle) fait du NAT entre votre r\u00e9seau priv\u00e9 et le r\u00e9seau Internet et de ce fait votre fournisseur d'acc\u00e8s (FAI) ne vous donne qu'une seule IP alors que vous pouvez tr\u00e8s bien avoir plusieurs PC connect\u00e9s \u00e0 Internet \u00e0 partir de votre r\u00e9seau local.</p> <p>Le NAT r\u00e9pond principalement au manque d'adresses IP dans le plan d'adressage ipV4 pour l'acc\u00e8s \u00e0 Internet.</p> <p>Il permet \u00e9galement de s'affranchir de la gestion des tables de routage et fonctionne avec le service iptables install\u00e9 par d\u00e9faut avec Debian.</p> <p>V\u00e9rifiez l'\u00e9tat courant du NAT ou IP Masquerading :</p> <pre><code>[srvlan@srvlan:~$] sudo iptables -L -t nat\n</code></pre> <p>R\u00e9sultat, NAT inactif, pas de target MASQUERADE :</p> <p> </p> iptables : Pas de r\u00e8gle active <p>Activez celui-ci en utilisant une r\u00e8gle iptables :</p> <pre><code>[srvlan@srvlan:~$] sudo iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE\n</code></pre> <p>et affichez de nouveau le contenu de la table NAT :</p> <pre><code>[srvlan@srvlan:~$] sudo iptables -L -t nat\n</code></pre> <p>R\u00e9sultat, le NAT est actif :</p> <p> </p> iptables : R\u00e8gle NAT (MASQUERADE) active <p>Effectuez une sauvegarde de la r\u00e8gle iptables :</p> <pre><code>[srvlan@srvlan:~$] su root\n[root@srvlan:~$] sudo iptables-save &gt; /etc/iptables/rules.v4\n[root@srvlan:~$] exit\n</code></pre> <p>et d\u00e9clarez celle-ci persistente :</p> <pre><code>[srvlan@srvlan:~$] sudo systemctl enable netfilter-persistent\n[srvlan@srvlan:~$] sudo systemctl restart netfilter-persistent\n</code></pre> <p>Elle sera ainsi activ\u00e9e \u00e0 chaque boot du syst\u00e8me.</p> <p>Par curiosit\u00e9, lisez la table de routage avec la Cde ip r :</p> <p> </p> Table de routage de srvlan <p></p> <p>  Bravo ! Le serveur srvlan est pr\u00eat. Le m\u00e9mento 2.1 vous attend pour l'ajout du serveur srvsec (IPFire).</p> <p>M\u00e9mento 2.1</p>"},{"location":"blog/srvsec---vboxipfire/","title":"srvsec - VBox/IPFire","text":""},{"location":"blog/srvsec---vboxipfire/#memento-21-serveur-srvsec","title":"M\u00e9mento 2.1 - Serveur srvsec","text":"<p>Comme pour les r\u00e9seaux pr\u00e9c\u00e9dents, vous allez cr\u00e9er et placer la VM srvsec (IPFire) en entr\u00e9e du r\u00e9seau local ou celle-ci servira entre autres de pare-feu.</p>"},{"location":"blog/srvsec---vboxipfire/#construction-de-la-vm","title":"Construction de la VM","text":"<p>L'utilisation de VirtualBox est consid\u00e9r\u00e9e acquise.</p> <p>A d\u00e9faut, r\u00e9f\u00e9rez-vous aux m\u00e9mentos suivants : VirtualBox - Installation VirtualBox - Mode d\u2019acc\u00e8s r\u00e9seau par pont</p>"},{"location":"blog/srvsec---vboxipfire/#-creation-et-configuration","title":"- Cr\u00e9ation et configuration","text":"<p>T\u00e9l\u00e9chargez l'ISO x86_64 version 2.x - Core Update y\u00a0: https://www.ipfire.org/download</p> <p>- D\u00e9marrez ensuite l'application VirtualBox 7.x, puis : - - Menu de VirtualBox &gt; Machine &gt; Nouvelle... -&gt; Nom : IPFire -&gt; Folder : S\u00e9lectionnez le dossier de stockage des VM -&gt; ISO Image : S\u00e9lectionnez l'ISO t\u00e9l\u00e9charg\u00e9e ci-dessus -&gt; Type : Other -&gt; Version : Other/Unknown (64-bit) -&gt; Bouton Suivant</p> <p>-&gt; M\u00e9moire vive : 512 MB -&gt; Processors : 2 CPU si possible -&gt; Bouton Suivant</p> <p>-&gt; Create a Virtual Hard Disk Now : Ajustez \u00e0 8 Go -&gt; Bouton Suivant</p> <p>-&gt; V\u00e9rifiez le R\u00e9capitulatif -&gt; Bouton Finish</p> <p>La VM s'affiche dans le panneau gauche de VirtualBox.</p> <p>- S\u00e9lectionnez maintenant la nouvelle VM, puis : - - Menu de VirtualBox &gt; Machine &gt; Configuration... - - - Onglet Syst\u00e8me -&gt; Carte m\u00e8re &gt; Ordre d'amor\u00e7age &gt; D\u00e9cochez Disquette -&gt; Carte m\u00e8re &gt; Fonctions avanc\u00e9es &gt; Cochez IO-APIC -&gt; Processeur &gt; Cochez PAE/NX  </p> <p>- - - Onglet R\u00e9seau -&gt; Adapter 1 &gt; Mode d'acc\u00e8s r\u00e9seau &gt; Acc\u00e8s par pont -&gt; Name &gt; Indiquez la carte r\u00e9seau active du PC h\u00f4te -&gt; Advanced &gt; Notez l'adresse MAC dans un coin</p> <p>-&gt; Adapter 2 &gt; Cochez Activer la carte r\u00e9seau -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Advanced &gt; Notez l'adresse MAC dans un coin</p> <p>-&gt; Adapter 3 &gt; Cochez Activer la carte r\u00e9seau -&gt; Mode d'acc\u00e8s r\u00e9seau &gt; R\u00e9seau interne -&gt; Advanced &gt; Notez l'adresse MAC dans un coin  </p> <p>&gt; OK</p> <p>Les autres param\u00e8tres peuvent rester inchang\u00e9s.</p>"},{"location":"blog/srvsec---vboxipfire/#-installation-dipfire","title":"- Installation d'IPFire","text":"<p>Conseil pratique avant de d\u00e9marrer la nouvelle VM : Si le curseur de la souris dispara\u00eet lors d'un clic dans la fen\u00eatre de la VM, celui-ci peut \u00eatre r\u00e9cup\u00e9r\u00e9 par le PC h\u00f4te \u00e0 l'aide de la touche CTRL situ\u00e9e \u00e0 droite de la barre d'espace du clavier.</p> <p>- - Menu de VirtualBox &gt; Machine &gt; D\u00e9marrer -&gt; D\u00e9marrage normal (La VM s'ex\u00e9cute)</p> <p> </p> Installation IPFire - Image 1 <p>Validez Install IPFire 2.x - Core y &gt; Touche Entr\u00e9e</p> <p> </p> Installation IPFire - Image 2 <p>S\u00e9lectionnez le Fran\u00e7ais &gt; OK</p> <p> </p> Installation IPFire - Image 3 <p>Validez D\u00e9marrer l'installation &gt; Touche Entr\u00e9e</p> <p> </p> Installation IPFire - Image 4 <p>Cochez J'accepte la licence &gt; OK</p> <p> </p> Installation IPFire - Image 5 <p>Validez Supprime toutes les donn\u00e9es &gt; Touche Entr\u00e9e</p> <p> </p> Installation IPFire - Image 6 <p>S\u00e9lectionnez le syst\u00e8me de fichier ext4 &gt; OK L'installation du syst\u00e8me commence ...</p> <p> </p> Installation IPFire - Image 7 <p>Validez Red\u00e9marrer &gt; Touche Entr\u00e9e</p> <p> </p> Installation IPFire - Image 8 <p>Suite au red\u00e9marrage, la fen\u00eatre ci-dessus s'affiche. S\u00e9lectionnez le type de clavier fr &gt; OK</p> <p> </p> Installation IPFire - Image 9 <p>S\u00e9lectionnez le fuseau horaire Europe/Paris &gt; OK</p> <p> </p> Installation IPFire - Image 10 <p>Entrez le nom d'h\u00f4te de la VM soit srvsec &gt; OK</p> <p> </p> Installation IPFire - Image 11 <p>Entrez le nom de domaine loupipfire.fr &gt; OK C'est le nom qui sera exploit\u00e9 plus tard sur le r\u00e9seau.</p> <p> </p> Installation IPFire - Image 12 <p>Entrez le MDP pour root (2 fois) &gt; OK</p> <p> </p> Installation IPFire - Image 13 <p>Entrez celui de l'administrateur Web admin (2 fois) &gt; OK</p> <p> </p> Installation IPFire - Image 14 <p>S\u00e9lectionnez Type de configuration r\u00e9seau &gt; OK</p> <p> </p> Installation IPFire - Image 15 <p>Choix de GREEN_(lan) + RED(wan) + ORANGE(dmz)_ &gt; OK</p> <p> </p> Installation IPFire - Image 16 <p>S\u00e9lectionnez Affectation des Pilotes et des Cartes &gt; OK</p> <p> </p> Installation IPFire - Image 17 <p>-&gt; GREEN soit la carte 3 de VirtualBox &gt; S\u00e9lectionner</p> <p> </p> Installation IPFire - Image 18 <p>Acc\u00e9dez \u00e0 l'adresse MAC de la carte 3 &gt; S\u00e9lectionner</p> <p> </p> Installation IPFire - Image 19 <p>La carte 3 est bien affect\u00e9e \u00e0 la zone GREEN.</p> <p> </p> Installation IPFire - Image 20 <p>-&gt; RED soit la carte 1 de VirtualBox &gt; S\u00e9lectionner</p> <p> </p> Installation IPFire - Image 21 <p>Acc\u00e9dez \u00e0 l'adresse MAC de la carte 1 &gt; S\u00e9lectionner</p> <p> </p> Installation IPFire - Image 22 <p>-&gt; ORANGE soit la carte 2 de VirtualBox &gt; S\u00e9lectionner</p> <p> </p> Installation IPFire - Image 23 <p>On ne peut pas se tromper &gt; S\u00e9lectionner</p> <p> </p> Installation IPFire - Image 24 <p>Les 3 cartes r\u00e9seaux sont configur\u00e9es &gt; Termin\u00e9</p> <p> </p> Installation IPFire - Image 25 <p>S\u00e9lectionnez Configuration d'adresse &gt; OK</p> <p> </p> Installation IPFire - Image 26 <p>-&gt; GREEN soit la carte r\u00e9seau 3 de VirtualBox &gt; OK</p> <p> </p> Installation IPFire - Image 27 <p>Petit avertissement &gt; OK</p> <p> </p> Installation IPFire - Image 28 <p>Entrez l'adresse IP de la carte 3 soit 192.168.2.1 &gt; OK</p> <p> </p> Installation IPFire - Image 29 <p>-&gt; ORANGE soit la carte r\u00e9seau 2 de VirtualBox &gt; OK</p> <p> </p> Installation IPFire - Image 30 <p>Entrez l'adresse IP de la carte 2 soit 192.168.4.1 &gt; OK</p> <p> </p> Installation IPFire - Image 31 <p>-&gt; RED soit la carte r\u00e9seau 1 de VirtualBox &gt; OK</p> <p> </p> Installation IPFire - Image 32 <p>- Statique : V\u00e9rifiez que la case est bien coch\u00e9e - Adresse IP : IP libre du serveur DHCP de votre Box - Gateway : IP de votre Box &gt; OK</p> <p> </p> Installation IPFire - Image 33 <p>Les 3 cartes ont maintenant une adresse IP &gt; Termin\u00e9</p> <p> </p> Installation IPFire - Image 34 <p>Quittez la Configuration d'adresse &gt; Termin\u00e9</p> <p> </p> Installation IPFire - Image 35 <p>Cette fen\u00eatre s'affiche, ne pas activer le DHCP &gt; OK</p> <p> </p> Installation IPFire - Image 36 <p>Et voil\u00e0, c'est termin\u00e9 &gt; OK</p> <p>IPFire finit son d\u00e9marrage et affiche le login de srvsec :</p> <p> </p> IPFire : Premier d\u00e9marrage <p>Vous pouvez \u00e0 pr\u00e9sent vous connecter en tant que root.</p> <p>Notez qu'IPFire peut \u00eatre reconfigur\u00e9 avec la Cde setup :</p> <pre><code>[root@srvsec:~$\\] setup\n</code></pre> <p>Arr\u00eatez maintenant la VM srvsec :</p> <pre><code>[root@srvsec:~$\\] poweroff    # ou Cde shutdown -h now\n</code></pre> <p>Retirez, si n\u00e9cessaire, l'image ISO du lecteur CD virtuel : - - Menu de VirtualBox &gt; Machine &gt; Configuration\u2026 - - - Onglet Stockage -&gt; Zone Unit\u00e9s de stockage &gt; ipfire-...iso -&gt; Zone Attributs &gt; Cliquez sur l'ic\u00f4ne CD -&gt; Retirer le disque du lecteur virtuel &gt; OK</p> <p>Red\u00e9marrez et v\u00e9rifiez que tout se passe bien.</p>"},{"location":"blog/srvsec---vboxipfire/#-acces-a-linterface-web","title":"- Acc\u00e8s \u00e0 l'interface WEB","text":"<p>Ouvrez le navigateur Web de la VM srvlan et entrez l'adresse <code>https://192.168.2.1:444</code>.</p> <p>Un message d'alerte de s\u00e9curit\u00e9 s'affiche : -&gt; Bouton Avanc\u00e9... -&gt; Bouton Accepter le risque et poursuivre</p> <p>Une fen\u00eatre de connexion s'ouvre : -&gt; Nom d'utilisateur &gt; Entrez admin -&gt; Mot de passe &gt; Entrez votre MDP cr\u00e9\u00e9 en Image 13 -&gt; Bouton Connexion</p> <p>La page d'accueil d'IPFire doit s'afficher :</p> <p> </p> IPFire : Page d'accueil Web"},{"location":"blog/srvsec---vboxipfire/#-ajout-dune-route-statique","title":"- Ajout d'une route statique","text":"<p>V\u00e9rifiez depuis srvsec qu'un ping sur l'IP 192.168.3.1 de srvlan ne fonctionne pas actuellement.</p> <p>Pour corriger cela, revenez sur srvlan : -&gt; Page d'accueil IPFire &gt; R\u00e9seau &gt; Routes statiques</p> <p>Remplissez les champs comme montr\u00e9 ci-dessous et cliquez ensuite sur le bouton Ajouter :</p> <p> </p> IPFire : Ajout d'une route statique vers 192.168.3.0 <p>Le ping doit maintenant recevoir une r\u00e9ponse positive.</p> <p></p> <p>  Voil\u00e0 ! IPFire est en place. Le m\u00e9mento 3.1 vous attend pour la cr\u00e9ation du dernier serveur soit srvdmz.</p> <p>M\u00e9mento 3.1</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/","title":"SFTP et Dotclear - VBox/Deb12","text":""},{"location":"blog/sftp-et-dotclear---vboxdeb12/#memento-91-ftp-chiffre-ssh","title":"M\u00e9mento 9.1 - FTP chiffr\u00e9 SSH","text":"<p>Le service SFTP sera activ\u00e9 sur la VM <code>srvdmz</code>.</p> <p>La configuration permettra un acc\u00e8s SFTP sur le site Dotclear ceci en respectant les droits d'acc\u00e8s et permissions exig\u00e9s par le serveur Apache sur le dossier /var/www/html/dotclear/.</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#preambule","title":"Pr\u00e9ambule","text":"<p>Pourquoi choisir le protocole SFTP plut\u00f4t que FTP ?</p> <p>FTP est de base non s\u00e9curis\u00e9, ses Cdes et donn\u00e9es ne sont pas chiffr\u00e9es, on peut donc intercepter le MDP de connexion ou le contenu des fichiers \u00e9chang\u00e9s.</p> <p>Le chiffrement FTPS est possible mais exige une configuration plus lourde.</p> <p>SFTP est plus simple \u00e0 mettre en \u0153uvre. Il est fourni avec le paquet openssh-server et permet de base le chiffrement des Cdes et donn\u00e9es transmises.</p> <p>Il v\u00e9rifie l\u2019identit\u00e9 du client et chiffre les fichiers/dossiers \u00e9chang\u00e9s une fois la connexion s\u00e9curis\u00e9e \u00e9tablie.</p> <p>Il utilise les r\u00e8gles de chiffrement SSH (Secure SHell).</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#installation-du-serveur-sftp","title":"Installation du serveur SFTP","text":"<p>Installez le paquet openssh-server :</p> <pre><code>[srvdmz@srvdmz:~$] sudo apt install openssh-server \n</code></pre> <p>La d\u00e9pendance openssh-sftp-server a \u00e9t\u00e9 ajout\u00e9e et des fichiers de configuration ont \u00e9t\u00e9 cr\u00e9\u00e9s dans /etc/ssh/.</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#dossier-miroir-pour-dotclear","title":"Dossier miroir pour Dotclear","text":""},{"location":"blog/sftp-et-dotclear---vboxdeb12/#-permissions-a-preserver","title":"- Permissions \u00e0 pr\u00e9server","text":"<p>L'utilisateur li\u00e9 \u00e0 Apache \u00e9tant <code>www-data</code> sous Debian, vous avez pr\u00e9c\u00e9demment attribu\u00e9 celui-ci et son groupe associ\u00e9 aux dossiers et fichiers de Dotclear.</p> <p>Les scripts PHP de Dotclear ont ainsi h\u00e9rit\u00e9 des droits d'acc\u00e8s en \u00e9criture leur permettant de mettre \u00e0 jour localement le contenu de /var/www/html/dotclear/.</p> <p>Rappel des permissions utilis\u00e9es par Dotclear : - Dossiers = 755 soit propri\u00e9taire u drwx, groupe g r-x, autres o r-x</p> <p>- Fichiers = 644 soit propri\u00e9taire u rw-, groupe g r--, autres o r--</p> <p>Les \u00e9critures effectu\u00e9es depuis un client SFTP ne doivent pas modifier les permissions ci-dessus, Dotclear risquant de ne plus fonctionner correctement.</p> <p>Une technique pour \u00e9viter cela consiste \u00e0 cr\u00e9er un dossier miroir du dossier Web de Dotclear.</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#-creation-du-dossier-miroir","title":"- Cr\u00e9ation du dossier miroir","text":"<p>L'outil bindfs liera le dossier /var/www/html/dotclear/ \u00e0 un dossier miroir d\u00e9di\u00e9 aux acc\u00e8s SFTP. Les \u00e9critures effectu\u00e9es \u00e0 l'int\u00e9rieur de ce dernier n'affecteront pas les droits d'acc\u00e8s et permissions du dossier Web.</p> <p>Le dossier miroir appartiendra au groupe sftp-groupe et \u00e0 l'utilisateur <code>sftpdmz</code>.</p> <p>Commencez par la cr\u00e9ation du dossier miroir :</p> <pre><code>[srvdmz@srvdmz:~$] cd /home\n\n[srvdmz@srvdmz:~$] sudo  mkdir -p sftpdmz/sites-web/dotclear \n</code></pre> <p>Cr\u00e9ez ensuite son groupe sftp-groupe :</p> <pre><code>[srvdmz@srvdmz:~$] sudo addgroup sftp-groupe \n</code></pre> <p>et son utilisateur <code>sftpdmz</code> que vous lierez \u00e0 sftp-groupe :</p> <pre><code>[srvdmz@srvdmz:~$] sudo useradd -d /home/sftpdmz/sites-web/dotclear -g sftp-groupe sftpdmz \n</code></pre> <p>Avant d'aller plus loin, effectuez les contr\u00f4les ci-apr\u00e8s :</p> <pre><code>[srvdmz@srvdmz:~$] cat /etc/group | grep sftp-groupe  \n</code></pre> <p>Retour :</p> <pre><code>sftp-groupe:x:1001:  \n</code></pre> <pre><code>[srvdmz@srvdmz:~$] cat /etc/passwd | grep sftpdmz  \n</code></pre> <p>Retour :</p> <pre><code>sftpdmz:x:1001:1001::/home/sftpd.../dotclear:/bin/sh  \n</code></pre> <pre><code>[srvdmz@srvdmz:~$] id sftpdmz   \n</code></pre> <p>Retour :</p> <pre><code>uid=1001(sftpdmz) gid=1001(sftp-groupe) groupes=1001(sftp-groupe)  \n</code></pre> <pre><code>[srvdmz@srvdmz:~$] groups sftpdmz  \n</code></pre> <p>Retour :</p> <pre><code>sftpdmz : sftp-groupe  \n</code></pre> <p>Enfin, appliquez ces permissions sur le dossier miroir :</p> <pre><code>[srvdmz@srvdmz:~$] sudo  chown sftpdmz:sftp-groupe /home/sftpdmz/sites-web/dotclear\n\n[srvdmz@srvdmz:~$] sudo  chmod 755 /home/sftpdmz/sites-web/dotclear  \n</code></pre> <p>et terminez en cr\u00e9ant un MDP pour l'utilisateur <code>sftpdmz</code> :</p> <pre><code>[srvdmz@srvdmz:~$] sudo passwd sftpdmz  \n</code></pre>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#-outil-bindfs-pour-le-remplir","title":"- Outil bindfs pour le remplir","text":"<pre><code>[srvdmz@srvdmz:~$] sudo apt install bindfs  \n</code></pre> <p>L'outil fuse3 qui sera utilis\u00e9 ci-dessous est d\u00e9j\u00e0 install\u00e9.</p> <p>Pour remplir automatiquement le miroir, \u00e9ditez fstab :</p> <pre><code>[srvdmz@srvdmz:~$] sudo nano /etc/fstab  \n</code></pre> <p>et ajoutez les 2 lignes suivantes \u00e0 la fin du fichier :</p> <pre><code># Montage automatique du dossier miroir de Dotclear \n\nbindfs#/var/www/html/dotclear /home/sftpdmz/sites-web/dotclear fuse force-user=sftpdmz,force-group=sftp-groupe,create-for-user=www-data,create-for-group=www-data,create-with-perms=ud=rwx:god=rx:uf=rw:gof=r,chgrp-ignore,chown-ignore,chmod-ignore 0 0  \n</code></pre> <p>La Cde create-with-perms suit les permissions 755/644.</p> <p>Red\u00e9marrez afin de traiter la Cde bindfs du fichier fstab :</p> <pre><code>[srvdmz@srvdmz:~$] sudo reboot  \n</code></pre> <p>et v\u00e9rifiez ensuite le contenu du dossier miroir :</p> <pre><code>[srvdmz@srvdmz:~$] sudo ls -l /home/sftpdmz/sites-web/dotclear   \n</code></pre> <p>Retour :</p> <pre><code>drwxr-xr-x  7 sftpdmz sftp-groupe  ... admin\ndrwxr-xr-x  5 sftpdmz sftp-groupe  ... cache\n-rw-r--r--  1 sftpdmz sftp-groupe  ... CHANGELOG\n-rw-r--r--  1 sftpdmz sftp-groupe  ... CONTRIBUT...\n-rw-r--r--  1 sftpdmz sftp-groupe  ... CREDITS\ndrwxr-xr-x  2 sftpdmz sftp-groupe  ... db\ndrwxr-xr-x  7 sftpdmz sftp-groupe  ... inc\n-rw-r--r--  1 sftpdmz sftp-groupe  ... index.php\n-rw-r--r--  1 sftpdmz sftp-groupe  ... LICENSE\ndrwxr-xr-x  4 sftpdmz sftp-groupe  ... locales\n...   \n</code></pre> <p>ainsi que celui du dossier /var/www/html/dotclear/ :</p> <pre><code>[srvdmz@srvdmz:~$] sudo ls -l /var/www/html/dotclear   \n</code></pre> <p>Retour :</p> <pre><code>drwxr-xr-x  7 www-data www-data  ... admin\ndrwxr-xr-x  5 www-data www-data  ... cache\n-rw-r--r--  1 www-data www-data  ... CHANGELOG\n-rw-r--r--  1 www-data www-data  ... CONTRIBUT...\n-rw-r--r--  1 www-data www-data  ... CREDITS\ndrwxr-xr-x  2 www-data www-data  ... db\ndrwxr-xr-x  7 www-data www-data  ... inc\n-rw-r--r--  1 www-data www-data  ... index.php\n-rw-r--r--  1 www-data www-data  ... LICENSE\ndrwxr-xr-x  4 www-data www-data  ... locales\n...\n</code></pre> <p>Constat : - Les permissions dossiers/fichiers sont identiques. - Les utilisateurs/groupes sont correctement affect\u00e9s.</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#reglages-sftp-et-test-local","title":"R\u00e9glages SFTP et test local","text":"<p>Editez le fichier de configuration du d\u00e9mon SSH :</p> <pre><code>[srvdmz@srvdmz:~$] sudo  nano /etc/ssh/sshd_config   \n</code></pre> <p>Commentez les 2 lignes suivantes :</p> <pre><code>X11Forwarding yes\nSubsystem    sftp    /usr/lib/openssh/sftp-server   \n</code></pre> <p>et ajoutez en fin de fichier ce groupe de lignes :</p> <pre><code># Configuration sshd de l'h\u00f4te srvdmz\nSubsystem     sftp     internal-sftp\nPort 384                                                                   \nPermitRootLogin no                                               \nMatch User sftpdmz                                              \nChrootDirectory  /home/sftpdmz/sites-web\nX11Forwarding no\nAllowTcpForwarding no\nForceCommand internal-sftp -u 022  \n</code></pre> <p>Explications : - Choix sous-syst\u00e8me internal-sftp et non sftp-serveur. - Port SSH 384 au lieu du port 22 par d\u00e9faut. - Acc\u00e8s SSH interdit en tant qu'utilisateur root. - Acc\u00e8s SSH restreint \u00e0 l'utilisateur sftpdmz. - Acc\u00e8s limit\u00e9 au dossier racine /home/.../sites-web/. - Transfert d'affichage graphique X11 d\u00e9sactiv\u00e9. - Redirection de port TCP, tunnel SSH, d\u00e9sactiv\u00e9e. - Cdes limit\u00e9es \u00e0 celles du sous-syst\u00e8me internal-sftp. - Umask 022 = 755 (dossiers) et 644 (fichiers).</p> <p>V\u00e9rifiez afin que le ChrootDirectory (dossier racine) fonctionne que le propri\u00e9taire des dossiers sftpdmz et sites-web soit bien l'utilisateur <code>root</code> :</p> <pre><code>[srvdmz@srvdmz:~$] ls -l /home\n[srvdmz@srvdmz:~$] ls -l /home/sftpdmz   \n</code></pre> <p>Retours attendus pour les 2 Cdes :</p> <pre><code>drwxr-xr-x 3 root root 4096 22 mai 15:35 sftpdmz\ndrwxr-xr-x 3 root root 4096 22 mai 15:35 sites-web   \n</code></pre> <p>Red\u00e9marrez le serveur SSH :</p> <pre><code>[srvdmz@srvdmz:~$] sudo systemctl restart ssh\n[srvdmz@srvdmz:~$] sudo systemctl status ssh    \n</code></pre> <p>Retour :</p> <pre><code>\u25cf ssh.service - OpenBSD Secure Shell server\n  Loaded: loaded (/lib/systemd/system/ssh.service...\n  Active: active (running) since Wed 2024...; 14s ago\n  Docs: man:sshd(8)\n        man:sshd_config(5)\n  Process: 1704 ExecStartPre=/usr/sbin... =0/SUCCESS)\n Main PID: 1706 (sshd)\n     Tasks: 1 (limit: 1077)\n     Memory: 1.9M\n     CPU: 35ms\n     CGroup: /system.slice/ssh.service\n             \u2514\u25001706 \"sshd: /usr/sbin/sshd -D ...\".\n\n... srvdmz systemd[1]: Starting ssh.service - OpenBSD ...\n... srvdmz sshd[1706]: ... listening on 0.0.0.0 port 384.\n... srvdmz systemd[1]: Started ssh.service - OpenBSD ...\n... srvdmz sshd[1706]: ... listening on :: port 384.   \n</code></pre> <p>Avant de continuer, ajoutez une image dans le dossier partag\u00e9 par l'h\u00f4te de VirtualBox.</p> <p>Testez ensuite une connexion locale :</p> <pre><code>[srvdmz@srvdmz:~$] sudo sftp -o Port=384 sftpdmz@loupvirtuel.fr    \n</code></pre> <p>Retour :</p> <pre><code>The authenticity ... '[loupvirtuel.fr]:384 ([192...\nECDSA key fingerprint is SHA256:Ns10UF4h...\nThis key is not known by any other names.\nAre you sure ... continue connecting (yes/...)? yes\nWarning: Permanently added '[loupvirtuel.fr]:384'...\nsftpdmz@loupvirtuel.fr's password: votre MDP sftpdmz \nConnected to loupvirtuel.fr.\nsftp&gt; ls\ndotclear  \nsftp&gt; cd dotclear/public\nsftp&gt; ls\nsftp&gt; (dossier public vide de base) \n</code></pre> <p>et d\u00e9posez l'image (Ex : image-1.jpg) dans public :</p> <pre><code>sftp&gt; put /home/srvdmz/Partage/image-1.jpg\nUploading /home.../image-1.jpg to /dotclear...\nimage-1.jpg 100%  273KB 24.1MB/s 00:00    \nsftp&gt; quit\n</code></pre> <p>V\u00e9rifiez l'attribution des droits d'acc\u00e8s et permissions :</p> <pre><code>[srvdmz@srvdmz:~$] sudo ls -l /var/www/html/dotclear/public/image-1.jpg    \n</code></pre> <p>Retour :</p> <pre><code>-rw-r--r-- 1 www-data www-data ... /.../image-1.jpg    \n</code></pre> <p>R\u00e9sultat OK : Droits d'acc\u00e8s \u00e0 www-data et permissions \u00e0 644.</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#test-depuis-debian12-vm1","title":"Test depuis debian12-vm1","text":""},{"location":"blog/sftp-et-dotclear---vboxdeb12/#-ajout-du-client-filezilla","title":"- Ajout du client FileZilla","text":"<p>Installez le client graphique sur la VM <code>debian12-vm1</code> :</p> <pre><code>[client-linux@debian12-vm1:~$] sudo apt install filezilla    \n</code></pre> <p>Ouvrez ensuite l'application graphique FTP/SFTP : - Menu Applications -&gt; Internet -&gt; Ic\u00f4ne FileZilla</p> <p>Cliquez sur l'ic\u00f4ne situ\u00e9e la plus \u00e0 gauche de la barre des ic\u00f4nes afin d'ouvrir le Gestionnaire de Sites et cliquez sur le bouton Nouveau site.</p> <p>Cr\u00e9ez le site loupvirtuel.fr comme montr\u00e9 ci-dessous : - Onglet G\u00e9n\u00e9ral</p> <p> </p> FileZilla : R\u00e9glages SFTP g\u00e9n\u00e9raux pour le site <p>- Onglet Avanc\u00e9</p> <p> </p> FileZilla : R\u00e9glages SFTP avanc\u00e9s pour le site <p>et traitez pour finir la fen\u00eatre de gestion des MDP :</p> <p> </p> FileZilla : Gestion des mots de passe"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#-test-de-connexion-distante","title":"- Test de connexion distante","text":"<p>Vous \u00eates maintenant pr\u00eat pour effectuer un test. Cliquez sur la fl\u00e8che situ\u00e9e \u00e0 droite de l'ic\u00f4ne du Gestionnaire de Sites et s\u00e9lectionnez <code>loupvirtuel.fr</code>.</p> <p>La connexion d\u00e9bute : - Une fen\u00eatre Cl\u00e9 de l'h\u00f4te inconnue s'ouvre. - Cochez Toujours faire confiance \u00e0 cet h\u00f4te... et validez.</p> <p> </p> FileZilla : SFTP - Fen\u00eatre Cl\u00e9 SSH <p>La connexion SFTP est \u00e0 pr\u00e9sent \u00e9tablie et s\u00e9curis\u00e9e :</p> <p> </p> FileZilla : Exemples de Download/Upload (2 fichiers) <p>Cliquez sur l'ic\u00f4ne cadenas situ\u00e9e en bas et \u00e0 droite pour d\u00e9couvrir les d\u00e9tails du chiffrement.</p> <p> </p> FileZilla : D\u00e9tail du chiffrement SFTP"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#controle-global-du-sftp","title":"Contr\u00f4le global du SFTP","text":"<p>- VM <code>debian12-vm1</code> a) Depuis le client FilZilla, vous devez pouvoir : - T\u00e9l\u00e9charger dans /home/client-linux/Documents/. - Envoyer un dossier/fichier dans /dotclear/. - Cr\u00e9er un nouveau dossier/fichier dans /dotclear/. - Supprimer un dossier/fichier dans /dotclear/. - Modifier un dossier/fichier dans /doctlear/.</p> <p>b) Vous ne devez pas pouvoir : - Naviguer au del\u00e0 de la racine / (Chroot).</p> <p>c) Les droits d'acc\u00e8s et permissions affich\u00e9s pour le dossier distant /dotclear doivent \u00eatre : - 755 pour les dossiers et 644 pour les fichiers. - Propri\u00e9taire sftpdmz (uid=1001). - Groupe sftp-groupe (gid=1001).</p> <p>- VM <code>srvdmz</code> Affichez les droits d'acc\u00e8s et permissions pour le dossier /var/www/html/dotclear/public/:</p> <pre><code>[srvdmz@srvdmz:~$] sudo ls -l /var/www/html/dotclear/public    \n</code></pre> <p>Exemple de retour selon le contenu courant :</p> <pre><code>total 280\n-rw-r--r-- 1 www-data www-data ... image-1.jpg\ndrwxr-xr-x 2 www-data www-data ... test-dossier\n-rw-r--r-- 1 www-data www-data ... test-sftp.txt    \n</code></pre> <p>Soit : - 755 pour les dossiers et 644 pour les fichiers. - Propri\u00e9taire www-data (uid=33). - Groupe www-data (gid=33).</p>"},{"location":"blog/sftp-et-dotclear---vboxdeb12/#-reparation-des-permissions","title":"- R\u00e9paration des permissions","text":"<p>En cas de probl\u00e8me, utilisez les Cdes ci-dessous pour r\u00e9tablir en une fois les bonnes permissions sur tous les fichiers et dossiers de Dotclear :</p> <pre><code>[srvdmz@srvdmz:~$] cd /var/www/html/dotclear \n[srvdmz@srvdmz:~$] sudo find . -type d -exec chmod 755 {} \\;\n[srvdmz@srvdmz:~$] sudo find . -type f -exec chmod 644 {} \\;    \n</code></pre> <p>Corrigez ensuite votre configuration et effectuez un nouveau contr\u00f4le de bon fonctionnement.</p> <p></p> <p>  J'esp\u00e8re que cela vous a plu. Le m\u00e9mento 9.2 vous attend pour la mise en place du protocole FTPS avec le serveur VsFTPd. A bient\u00f4t.</p> <p>M\u00e9mento 9.2</p>"},{"location":"blog/virtualbox---start-auto-des-vm/","title":"VirtualBox - Start auto des VM","text":""},{"location":"blog/virtualbox---start-auto-des-vm/#demarrage-automatique-des-vm","title":"D\u00e9marrage automatique des VM","text":"<p>Lancez vos VM automatiquement lors d'un red\u00e9marrage du syst\u00e8me Windows ou Debian.</p>"},{"location":"blog/virtualbox---start-auto-des-vm/#-sous-windows-11-","title":"- - Sous Windows 11 - -","text":"<p>VirtualBox est install\u00e9 par d\u00e9faut dans :</p> <pre><code>C:\\Program Files\\Oracle\\VirtualBox\\\n</code></pre> <p>et son fichier de configuration VirtualBox.xml est dans :</p> <pre><code>C:\\Utilisateurs\\nom-du-user\\.VirtualBox\\\n</code></pre>"},{"location":"blog/virtualbox---start-auto-des-vm/#-fichier-autostartproperties","title":"- Fichier autostart.properties","text":"<p>Cr\u00e9ez un fichier de nom autostart.properties dans le dossier \\Utilisateurs\\nom-du-user\\.VirtualBox\\ et remplissez-le avec le contenu suivant :</p> <pre><code># La politique par d\u00e9faut est de refuser \"deny\" \n# le d\u00e9marrage d'une machine virtuelle, l'autre\n# option est de l'autoriser \"allow\".\ndefault_policy = deny\n\n# L'utilisateur ci-dessous est autoris\u00e9 \u00e0\n# d\u00e9marrer les machines virtuelles mais ceci \n# apr\u00e8s un d\u00e9lai de 30 secondes\nnom-du-user = {\n     allow = true\n     startup_delay = 30\n}\n# Saut de ligne obligatoire apr\u00e8s l'acollade\n</code></pre> <p>Le service qui exploitera ce fichier s'appelle VirtualBox Autostart Service (VBoxAutostartSvc).</p>"},{"location":"blog/virtualbox---start-auto-des-vm/#-svc-vboxautostartsvc","title":"- Svc VBoxAutostartSvc","text":"<p>Cr\u00e9ez au pr\u00e9alable la variable d'environnement Windows de nom VBOXAUTOSTART_CONFIG.</p> <p>La Cde ci-dessous peut \u00eatre utilis\u00e9e depuis le Terminal(administrateur) de Windows pour cr\u00e9er temporairement celle-ci :</p> <pre><code>&gt; set VBOXAUTOSTART_CONFIG=C:\\Users\\nom-du-user\\.VirtualBox\\autostart.properties\n</code></pre> <p>Pour rendre cette variable permanente, utilisez l'application sysdm.cpl qui peut \u00eatre lanc\u00e9e depuis le champ Ex\u00e9cuter du menu Windows.</p> <p>Une fen\u00eatre Propri\u00e9t\u00e9s syst\u00e8me s'ouvre : -&gt; Onglet Param\u00e8tres syst\u00e8me avanc\u00e9s -&gt; Bouton Variables d'environnement -&gt; Zone Variables syst\u00e8me -&gt; Bouton Nouvelle... </p> <p>-&gt; Champ Nom de la variable, entrez : VBOXAUTOSTART_CONFIG.</p> <p>-&gt; Champ Valeur de la variable, entrez : C:\\Users\\nom-du-user\\.VirtualBox\\autostart.properties.</p> <p>-&gt; Bouton OK</p> <p>La cr\u00e9ation de la variable VBOXAUTOSTART_CONFIG peut \u00eatre v\u00e9rifi\u00e9e depuis l'application regedit en acc\u00e9dant \u00e0 la cl\u00e9 Environment ci-dessous :</p> <pre><code>HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\Environment\n</code></pre> <p>Ensuite, activez le service de d\u00e9marrage auto des VM depuis le Terminal(administrateur) de Windows comme ceci :</p> <pre><code>&gt; cd \"C:\\Program Files\\Oracle\\VirtualBox\"\n&gt; .\\VBoxAutostartSvc.exe install --user=nom-du-user\n</code></pre> <p>Le MDP de l'utilisateur nom-du-user sera demand\u00e9.</p> <p>Pour info, le service peut \u00eatre d\u00e9sactiv\u00e9 ainsi :</p> <pre><code>&gt; .\\VBoxAutostartSvc.exe delete --user=nom-du-user\n</code></pre> <p>Finir en autorisant le d\u00e9marrage automatique de chacune des VM (VM arr\u00eat\u00e9e) :</p> <pre><code>&gt; cd \"C:\\Program Files\\Oracle\\VirtualBox\"\n\n&gt; .\\VBoxManage.exe modifyvm \"nom-de-la-vm\" --autostart-enabled on --defaultfrontend headless --autostart-delay 30\n</code></pre> <p>L'option --defaultfrontend headless implique un mode de d\u00e9marrage sans fen\u00eatre d'affichage graphique, ceci dans le cas par exemple d'une utilisation d'un acc\u00e8s \u00e0 distance sur la VM de type RDP ou VNC.</p> <p>Ajoutez quelques secondes d'\u00e9cart entre chaque autostart-delay.</p> <p>Une VM d\u00e9clar\u00e9e en autostart voit son fichier de configuration *.vbox situ\u00e9 dans le dossier de celle-ci contenir la ligne suivante :</p> <pre><code>&lt;Autostart enabled=\"true\" delay=\"30\" autostop=\"Disabled\"/&gt;\n</code></pre>"},{"location":"blog/virtualbox---start-auto-des-vm/#-svc-vboxsvc","title":"- Svc VBoxSVC","text":"<p>VirtualBox prend en charge l'ex\u00e9cution du service VBoxSVC dans la session 0 (z\u00e9ro) de Windows.</p> <p>VBoxSVC fonctionne alors comme un service Windows normal et permet aux VM headless de continuer \u00e0 fonctionner m\u00eame si l'utilisateur nom-du-user ferme sa session Windows.</p> <p>Pour activer le service, d\u00e9marrez l'application regedit de Windows, puis :</p> <p>-&gt; HKEY_LOCAL_MACHINE\\Software\\Oracle\\VirtualBox</p> <p>Cr\u00e9ez une cl\u00e9 REG_DWORD de nom VBoxSDS avec la valeur 1 et red\u00e9marrez Windows.</p> <p>C'est termin\u00e9 pour Windows.</p>"},{"location":"blog/virtualbox---start-auto-des-vm/#-sous-debian-12-","title":"- - Sous Debian 12 - -","text":""},{"location":"blog/virtualbox---start-auto-des-vm/#-fichier-autostartvmcfg","title":"- Fichier autostartvm.cfg","text":"<p>Cr\u00e9ez le fichier /etc/default/virtualbox :</p> <pre><code>sudo nano /etc/default/virtualbox\n</code></pre> <p>et ajoutez le contenu suivant :</p> <pre><code>VBOXAUTOSTART_DB=/etc/vbox\nVBOXAUTOSTART_CONFIG=/etc/vbox/autostartvm.cfg\n</code></pre> <p>Cr\u00e9ez ensuite le fichier autostartvm.cfg :</p> <pre><code>sudo nano /etc/vbox/autostartvm.cfg\n</code></pre> <p>et entrez l'un des 2 contenus suivants :</p> <pre><code>default_policy = deny\nnom-du-user = {\nallow = true\nstartup_delay = 10\n}\n</code></pre> <pre><code>default_policy=deny\nnom-du-user={allow=true startup_delau=10}\n</code></pre> <p>Nota</p> <p>VirtualBox 7.1.x semble accepter uniquement la syntaxe du deuxi\u00e8me contenu.</p> <p>Ajoutez l'utilisateur nom-du-user au groupe vboxusers :</p> <pre><code>sudo usermod -aG vboxusers nom-du-user\n</code></pre> <p>Affectez le dossier /etc/vbox/ au groupe vboxusers :</p> <pre><code>sudo chgrp vboxusers /etc/vbox\n</code></pre> <p>et autorisez le groupe \u00e0 \u00e9crire dans le dossier :</p> <pre><code>sudo chmod g+w /etc/vbox\n</code></pre> <p>Red\u00e9marrez l'h\u00f4te Debian pour la prise en compte des permissions.</p>"},{"location":"blog/virtualbox---start-auto-des-vm/#-svc-vboxautostart-service","title":"- Svc vboxautostart-service","text":"<p>Virtualbox fournit dans le dossier /lib/systemd/system/ un service appel\u00e9 vboxautostart-service qui se chargera de lancer les VM param\u00e9tr\u00e9es en d\u00e9marrage auto.</p> <p>Commencez par autoriser le d\u00e9marrage auto des VM :</p> <pre><code>VBoxManage setproperty autostartdbpath /etc/vbox\n</code></pre> <p>Puis stoppez les VM et listez les noms de celles-ci :</p> <pre><code>VBoxManage list vms\n</code></pre> <p>Enfin, acc\u00e9dez aux dossiers des VM et entrez pour chacune de celles-ci la Cde suivante :</p> <pre><code>VBoxManage modifyvm \"nom-de-la-vm\" --autostart-enabled on --defaultfrontend headless --autostart-delay 30\n</code></pre> <p>Ajoutez quelques secondes d'\u00e9cart entre chaque autostart-delay.</p> <p>Relancez le syst\u00e8me, v\u00e9rifiez le bon d\u00e9marrage automatique des VM et l'ajout dans le dossier /etc/vbox/ du fichier nom-du-user.start.</p> <p>C'est termin\u00e9 pour Debian.</p> <p>Fin.</p>"},{"location":"blog/virtualbox---installation/","title":"VirtualBox - Installation","text":""},{"location":"blog/virtualbox---installation/#virtualbox-hyperviseur-de-type-2","title":"VirtualBox - hyperviseur de type 2","text":"<p>  VirtualBox permet de cr\u00e9er des Machines Virtuelles (VM). </p>"},{"location":"blog/virtualbox---installation/#installation","title":"Installation","text":""},{"location":"blog/virtualbox---installation/#-information-generale","title":"- Information g\u00e9n\u00e9rale","text":"<p>VirtualBox, install\u00e9 sur le syst\u00e8me d'exploitation h\u00f4te d'un ordinateur, utilisera les ressources mat\u00e9rielles de celui-ci pour cr\u00e9er des machines virtuelles (VM) pouvant fonctionner simultan\u00e9ment sous diff\u00e9rents syst\u00e8mes d'exploitation invit\u00e9s.</p> <p>Le syst\u00e8me d'exploitation h\u00f4te acc\u00e8dera seul au mat\u00e9riel physique de l'ordinateur, les syst\u00e8mes d'exploitation invit\u00e9s des machines virtuelles utiliseront du mat\u00e9riel g\u00e9n\u00e9rique simul\u00e9.</p> <p>Le tout fonctionnera de mani\u00e8re s\u00e9curis\u00e9e, les syst\u00e8mes d'exploitation invit\u00e9s n'interagiront pas directement avec le syst\u00e8me d'exploitation h\u00f4te et n'interagiront pas entre eux.</p>"},{"location":"blog/virtualbox---installation/#-telechargements","title":"- T\u00e9l\u00e9chargements","text":"<p>Le Homelab IPFire + Debian sera cr\u00e9\u00e9 avec VBox 7.x.y.</p> <p>Acc\u00e9dez au site VirtualBox et t\u00e9l\u00e9chargez ces 2 fichiers :</p> <p>- L' ex\u00e9cutable VirtualBox 7.x.y platform packages, adapt\u00e9 au PC h\u00f4te.</p> <p>- L' extension VirtualBox 7.x.y Oracle VM VirtualBox Extension Pack, toutes plateformes.</p>"},{"location":"blog/virtualbox---installation/#-installation-de-la-version-7","title":"- Installation de la version 7","text":"<p>Lancez l'ex\u00e9cutable et acceptez d'ajouter les cartes r\u00e9seau qui vous seront propos\u00e9es.</p> <p>D\u00e9marrez ensuite VirtualBox et ajoutez le pack d'extension comme suit : - - Menu Fichier -&gt; Outils -&gt; Extension Pack Manager &gt; Cliquez sur l'ic\u00f4ne + -&gt; S\u00e9lectionnez l'extension t\u00e9l\u00e9charg\u00e9e plus haut -&gt; Bouton Ouvrir &gt; Bouton Installation -&gt; Acceptez la licence</p> <p>Le pack d'extension doit s'installer normalement.</p> <p>Ce pack inclut les guest additons, ceux-ci permettant : - d'ouvrir depuis une VM un dossier partag\u00e9 par l'h\u00f4te. - d\u2019ajuster la taille des \u00e9crans des VM sur celui de l'h\u00f4te. - d'effectuer des copier/coller entre les VM. - d'effectuer des copier/coller entre les VM et l'h\u00f4te. - d'ignorer la touche CTRL droite appel\u00e9e touche H\u00f4te. - etc\u2026</p> <p>Vous pouvez \u00e0 pr\u00e9sent cr\u00e9er la premi\u00e8re VM du r\u00e9seau virtuel. Suivez pour cela la liste des m\u00e9mentos du site.</p> <p>Liste des m\u00e9mentos</p>"},{"location":"blog/virtualbox---installation/#pour-aller-plus-loin","title":"Pour aller plus loin","text":"<p>a) Lancer une VM sans ouvrir sa fen\u00eatre graphique :</p> <p>-- H\u00f4te Windows --</p> <pre><code>C:\\...&gt; cd \\\"Program Files\"\\Oracle\\Virtualbox\nC:\\...&gt;.\\VBoxManage modifyvm \"nom-vm\" --defaultfrontend headless\n</code></pre> <p>Il faut, afin que la VM en mode headless puisse rester active m\u00eame si l'utilisateur courant de Windows ferme sa session, cr\u00e9er une cl\u00e9 de registre Windows.</p> <p>Pour cela, lancer la Cde regedit.exe \u00e0 l'int\u00e9rieur du champ du menu Ex\u00e9cuter de Windows, puis : -&gt; HKEY_LOCAL_MACHINE\\Software\\Oracle\\VirtualBox</p> <p>Cr\u00e9er une cl\u00e9 REG_DWORD de nom VBoxSDS avec la valeur 1 et pour finir red\u00e9marrer Windows.</p> <p>-- H\u00f4te Linux --</p> <pre><code>VBoxManage modifyvm \"nom-vm\" --defaultfrontend headless\n</code></pre> <p>b) Lancer automatiquement une VM au boot de l'h\u00f4te :</p> <p>-- H\u00f4te Windows --</p> <pre><code>C:\\...&gt; cd \\Users\\user-x\\.VirtualBox\n</code></pre> <p>Cr\u00e9er un fichier de nom autostart.properties contenant :</p> <pre><code># La politique par d\u00e9faut est de refuser \"deny\" le d\u00e9marrage  \n# d'une VM, l'autre option est de l'autoriser \"allow\".\ndefault_policy = deny\n\n# L'utilisateur user-x ci-dessous est autoris\u00e9 \u00e0 d\u00e9marrer  \n# des VM mais ceci apr\u00e8s un d\u00e9lai de 30 secondes\nuser-x = {\nallow = true\nstartup_delay = 30\n}\n</code></pre> <p>et configurer la VM nom-vm comme ceci :</p> <pre><code>C:\\...&gt; cd \\\"Program Files\"\\Oracle\\Virtualbox\nC:\\...&gt;.\\VBoxManage modifyvm \"nom-vm\" --autostart-enabled on --autostart-delay 180\n</code></pre> <p>Lancer ensuite la Cde sysdm.cpl \u00e0 l'int\u00e9rieur du champ du menu Ex\u00e9cuter de Windows, puis : -&gt; Onglet Param\u00e8tres syst\u00e8me avanc\u00e9s -&gt; Bouton Variables d'environnement... -&gt; Variables syst\u00e8me &gt; Bouton Nouvelle...</p> <p>Entrer ce contenu pour la nouvelle variable Windows : Nom: VBOXAUTOSTART_CONFIG Valeur: C:\\Users\\user-x\\.VirtualBox\\autostart.properties</p> <p>Finir en activant le service VBoxAutostartSvc :</p> <pre><code>C:\\...&gt;.\\VBoxAutostartSvc install --user=user-x\n</code></pre> <p>-- H\u00f4te Linux --</p> <p>Editer le fichier /etc/default/virtualbox et ajouter ceci :</p> <pre><code># D\u00e9marrage auto des VM\nVBOXAUTOSTART_DB=/etc/vbox\nVBOXAUTOSTART_CONFIG=/etc/vbox/autostartvm.cfg\n</code></pre> <p>Cr\u00e9er le fichier /etc/vbox/autostartvm.cfg et entrer cela :</p> <pre><code>default_policy = deny\nuser-x = {\nallow = true\nstartup_delay = 30\n}\n# Saut de ligne apr\u00e8s la parenth\u00e8se\n</code></pre> <p>Ajouter l'utilisateur user-x au groupe vboxusers :</p> <pre><code>sudo usermod -aG vboxusers user-x\n</code></pre> <p>Affecter le dossier /etc/vbox/ au groupe vboxusers :</p> <pre><code>sudo chgrp vboxusers /etc/vbox\n</code></pre> <p>Autoriser le groupe vboxusers \u00e0 \u00e9crire dans le dossier :</p> <pre><code>sudo chmod g+w /etc/vbox\n</code></pre> <p>Pour \u00e9viter que le r\u00e9pertoire ne soit modifi\u00e9 ou supprim\u00e9 par d'autres utilisateurs, \u00e0 l'exception du propri\u00e9taire ou de l'utilisateur root, d\u00e9finir le bit collant :</p> <pre><code>sudo chmod +t /etc/vbox\n</code></pre> <p>Red\u00e9marrer l'h\u00f4te pour le traitement des permissions.</p> <p>Laisser les VM \u00e0 l'arr\u00eat et autoriser le d\u00e9marrage automatique de celles-ci :</p> <pre><code>VBoxManage setproperty autostartdbpath /etc/vbox\n</code></pre> <p>Obtenir la liste des VM :</p> <pre><code>VBoxManage list vms\n</code></pre> <p>Se rendre dans le dossier des VM et entrer :</p> <pre><code>VBoxManage modifyvm \"nom-vm\" --autostart-enabled on --autostart-delay 180\n</code></pre> <p>c) Activer la virtualisation imbriqu\u00e9e sur une VM :</p> <p>Celle-ci, autrement appel\u00e9e nested virtualization VT-x/AMD-V, fait r\u00e9f\u00e9rence \u00e0 de la virtualisation qui s'ex\u00e9cute dans un environnement d\u00e9j\u00e0 virtualis\u00e9.</p> <p>A appliquer si n\u00e9cessaire :</p> <p>-- H\u00f4te Windows --</p> <pre><code>C:\\...&gt; cd \\\"Program Files\"\\Oracle\\Virtualbox\nC:\\...&gt;.\\VBoxManage modifyvm \"nom-vm\" --nested-hw-virt on\n</code></pre> <p>-- H\u00f4te Linux --</p> <pre><code>VBoxManage modifyvm \"nom-vm\" --nested-hw-virt on\n</code></pre> ---------- Fin ----------"},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/","title":"Acc\u00e8s r\u00e9seau par pont","text":""},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#pont-reseau-entre-vm-et-pc-hote","title":"Pont r\u00e9seau entre VM et PC h\u00f4te","text":"<p>  Configuration d'un pont r\u00e9seau (bridge) </p>"},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#role","title":"R\u00f4le","text":"<p>Le mode d'acc\u00e8s r\u00e9seau par pont de VirtualBox cr\u00e9e un pont entre la carte r\u00e9seau d'une VM et celle du PC h\u00f4te. La VM peut ainsi appartenir au m\u00eame r\u00e9seau local que celui du PC h\u00f4te.</p> <p>Le serveur DHCP utilis\u00e9 par le PC h\u00f4te peut fournir une adresse IP dynamique \u00e0 la VM mais ce n'est pas obligatoire, l'adresse IP pouvant \u00eatre param\u00e9tr\u00e9e comme fixe au niveau de la VM.</p>"},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#interet","title":"Int\u00e9r\u00eat","text":"<p>Le pont offre l'avantage de pouvoir r\u00e9aliser des tests depuis le PC h\u00f4te vers le r\u00e9seau local virtuel comme celui de simuler des requ\u00eates HTTP/FTP issues d'Internet.</p>"},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#installation-du-pont-reseau","title":"Installation du pont r\u00e9seau","text":""},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#-srvlan-mode-acces-reseau","title":"- srvlan - mode acc\u00e8s r\u00e9seau","text":"<p>Arr\u00eatez la VM srvlan.</p> <p>Depuis VirtualBox, affichez la configuration de la VM : - Section R\u00e9seau -&gt; Carte 1 &gt; Mode d'acc\u00e8s r\u00e9seau &gt; Acc\u00e8s par pont -&gt; Nom &gt; S\u00e9lectionnez la carte r\u00e9seau active du PC h\u00f4te -&gt; OK</p> <p>Red\u00e9marrez la VM.</p>"},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#-srvlan-adresse-ip-fixe","title":"- srvlan - adresse IP fixe","text":"<p>Editez le fichier r\u00e9seau interfaces :</p> <pre><code>[root@srvlan:~#\\] nano /etc/network/interfaces\n</code></pre> <p>et modifiez les lignes ci-dessous comme suit :</p> <pre><code>auto eth\niface eth0 inet static\naddress 192.168.x.w          \\# IP libre du r\u00e9seau local PC h\u00f4te\nnetmask 255.255.255.0\nnetwork 192.168.x.0          \\# R\u00e9seau local du PC h\u00f4te\nbroadcast 192.168.x.255\ngateway 192.168.x.z          \\# IP de la box Internet, Freebox, etc...\n</code></pre> <p>Relancez le service r\u00e9seau sur la carte eth0 :</p> <pre><code>[root@srvlan:~#\\] service network-interface restart INTERFACE=eth0\n</code></pre>"},{"location":"blog/acc%C3%A8s-r%C3%A9seau-par-pont/#-test-du-pont","title":"- Test du pont","text":"<p>Effectuez un ping depuis le PC h\u00f4te vers srvlan et inversement.</p> ---------- Fin ----------"},{"location":"informatique/","title":"Les derniers articles","text":""},{"location":"informatique/#les-derniers-articles","title":"Les derniers articles","text":""},{"location":"informatique/alpine---installation/","title":"Alpine - Installation","text":""},{"location":"informatique/alpine---installation/#vm-alpine-sous-xfce4","title":"VM Alpine sous Xfce4","text":"<p>Mai 2024.</p> <p>Alpine Linux est une distribution l\u00e9g\u00e8re qui est essentiellement utilis\u00e9e sur les syst\u00e8mes embarqu\u00e9s, les conteneurs et les machines virtuelles.</p> <p>Elle utilise apk comme gestionnaire de paquets et OpenRC comme gestionnaire de services.</p> <p>R\u00e9f\u00e9rences exploit\u00e9es pour la cr\u00e9ation de la VM : Site Linuxtricks.fr et Site Alpine.org</p>"},{"location":"informatique/alpine---installation/#telechargement-iso","title":"T\u00e9l\u00e9chargement ISO","text":"<p>L'image ISO Alpine-Extended est t\u00e9l\u00e9chargeable ici : https://www.alpinelinux.org/downloads/</p>"},{"location":"informatique/alpine---installation/#installation-sur-disque","title":"Installation sur disque","text":"<p>Selon l'hyperviseur utilis\u00e9, cr\u00e9er une VM Alpine et d\u00e9marrer celle-ci depuis l'ISO t\u00e9l\u00e9charg\u00e9e ci-dessus.</p> <p>Une demande de login s'affiche apr\u00e8s quelques secondes, entrer l'utilisateur root.</p> <p>Lancer ensuite la configuration g\u00e9n\u00e9rale :</p> <pre><code>setup-alpine\n</code></pre> <p>Le setup comprend les \u00e9tapes suivantes : - Configuration du clavier - Cr\u00e9ation du nom d'h\u00f4te de la VM - Configuration du r\u00e9seau - Cr\u00e9ation du MDP root - Configuration du fuseau horaire - Configuration \u00e9ventuel d'un proxy - Choix du miroir pour les paquets (entrer f) - Cr\u00e9ation d'un nouvel utilisateur - Choix du serveur SSH \u00e0 utiliser - Choix du disque \u00e0 partitionner (entrer sda) - Type de partitionnement (entrer sys)</p> <p>L'installation sur le disque sda commence, une fois celle-ci termin\u00e9e, il est demand\u00e9 de rebooter.</p> <p>La VM est alors pr\u00eate \u00e0 \u00eatre utilis\u00e9e, l'installation de l'OS Alpine est donc plut\u00f4t simple.</p>"},{"location":"informatique/alpine---installation/#gestion-des-paquets","title":"Gestion des paquets","text":"<p>La liste des d\u00e9p\u00f4ts configur\u00e9s de base se trouve dans le fichier /etc/apk/repositories.</p> <p>MAJ de la liste des paquets en tant que root :</p> <pre><code>apk update\n</code></pre> <p>MAJ des paquets install\u00e9s :</p> <pre><code>apk upgrade\n</code></pre> <p>Installation d'un paquet :</p> <pre><code>apk add nom-du-paquet\n</code></pre> <p>D\u00e9sinstallation d'un paquet :</p> <pre><code>apk del nom-du-paquet\n</code></pre> <p>Rechercher si un paquet est install\u00e9 :</p> <pre><code>apk list nom-du-paquet\n</code></pre> <p>Afficher la version d'un paquet install\u00e9 :</p> <pre><code>apk version nom-du-paquet\n</code></pre> <p>Rechercher un paquet disponible dans les d\u00e9p\u00f4ts :</p> <pre><code>apk search nom-du-paquet\n</code></pre> <p>Lire les informations concernant un paquet :</p> <pre><code>apk info nom-du-paquet\n</code></pre>"},{"location":"informatique/alpine---installation/#bureau-xfce4-de-base","title":"Bureau Xfce4 de base","text":"<p>Il est possible d'installer Xfce4 qui est un environnement de bureau graphique l\u00e9ger.</p> <p>Pour cela, commencer par \u00e9diter le fichier des d\u00e9p\u00f4ts :</p> <pre><code>vi /etc/apk/repositories \n</code></pre> <p>et activer le d\u00e9p\u00f4t Community en d\u00e9commantant la ligne concern\u00e9e.</p> <p>Ensuite, mettre \u00e0 jour le syst\u00e8me :</p> <pre><code>apk update\napk upgrade\n</code></pre> <p>Installer les locales de base incluant le fran\u00e7ais :</p> <pre><code>apk add musl-locales\n</code></pre> <p>Installer le serveur graphique Xorg :</p> <pre><code>setup-xorg-base\n</code></pre> <p>Lister et installer le pilote vid\u00e9o appropri\u00e9 pour la carte graphique :</p> <pre><code>apk search xf86-video\napk add xf86-video-vmware\n</code></pre> <p>Ex : Le pilote vmware fonctionne correctement sous VirtualBox.</p> <p>Lister et installer le pilote appropri\u00e9 pour les p\u00e9riph\u00e9riques d'entr\u00e9e :</p> <pre><code>apk search xf86-input\napk add xf86-input-libinput\n</code></pre> <p>Ex : Le pilote libinput g\u00e8re les claviers/souris sous Xorg/Wayland.</p> <p>Installer enfin le bureau graphique Xfce4 :</p> <pre><code>apk add xfce4 xfce4-terminal\n</code></pre> <p>Installer le th\u00e8me et les ic\u00f4nes du bureau :</p> <pre><code>apk add adw-gtk3 adwaita-icon-theme adwaita-xfce-icon-theme\n</code></pre> <p>Ajouter le verrouillage de l'\u00e9cran graphique :</p> <pre><code>apk add xfce4-screensaver\n</code></pre> <p>Ajouter le montage des disques et cl\u00e9s USB :</p> <pre><code>apk add udisks-2 gvfs\n</code></pre> <p>Lister les plugins gvfs et installer le support de Samba :</p> <pre><code>apk search gvfs-\napk add gvfs-smb gvfs-lang\n</code></pre> <p>Installer le gestionnaire de connexion graphique LightDM :</p> <pre><code>apk add lightdm-gtk-greeter\n</code></pre> <p>Ajouter les services lightdm et dbus au boot du syst\u00e8me :</p> <pre><code>rc-update add lightdm\nrc-update add dbus\n</code></pre> <p>Param\u00e9trer le gestionnaire de p\u00e9riph\u00e9riques udev :</p> <pre><code>setup-devd udev\n</code></pre> <p>Installer la gestion du reboot du syst\u00e8me depuis Xfce4 :</p> <pre><code>apk add elogind polkit-elogind\nrc-update add elogind\n</code></pre> <p>Installer le son et ses utilitaires :</p> <pre><code>apk add pulseaudio pavucontrol alsa-utils\n</code></pre> <p>Puis ajouter le service alsa au boot du syst\u00e8me :</p> <pre><code>rc-update add alsa\n</code></pre> <p>Installer pour Xfce4 le plugin Pulseaudio :</p> <pre><code>apk add xfce4-pulseaudio-plugin\n</code></pre> <p>Ajouter les locales disponibles pour les paquets install\u00e9s :</p> <pre><code>apk add lang\n</code></pre> <p>G\u00e9rer la locale par d\u00e9faut en cr\u00e9ant le fichier 99-fr.sh :</p> <pre><code>vi /etc/profile.d/99-fr.sh\n</code></pre> <p>et en y ins\u00e9rant le contenu suivant :</p> <pre><code>LANG=fr_FR.UTF-8\nLC_CTYPE=fr_FR.UTF-8\nLC_NUMERIC=fr_FR.UTF-8\nLC_TIME=fr_FR.UTF-8\nLC_COLLATE=fr_FR.UTF-8\nLC_MONETARY=fr_FR.UTF-8\nLC_MESSAGES=fr_FR.UTF-8\nLC_ALL=\n</code></pre> <p>G\u00e9rer le clavier fran\u00e7ais pour l'interface graphique :</p> <pre><code>mkdir /etc/X11/xorg.conf.d\nvi /etc/X11/xorg.conf.d/99-keyboard.conf\n</code></pre> <p>Ins\u00e9rer le contenu suivant :</p> <pre><code>Section \"InputClass\"\n    Identifier \"keyboard\"\n    Option \"XkbLayout\" \"fr\"\n    Option \"XkbVariant\" \"oss\"\n    Option \"XkbOptions\" \"compose:menu\"\n    MatchIsKeyboard \"on\"\nEndSection\n</code></pre> <p>C'est fini, rebooter le syst\u00e8me et v\u00e9rifier le bon fonctionnement sous Xfce4.</p>"},{"location":"informatique/alpine---installation/#serveur-xrdp","title":"Serveur XRDP","text":"<p>Installer le serveur :</p> <pre><code>apk add xrdp xorgxrdp\n</code></pre> <p>D\u00e9marrer les services associ\u00e9s au serveur :</p> <pre><code>rc-service xrdp start\nrc-service xrdp-sesman start\n</code></pre> <p>Pour finir, g\u00e9rer le d\u00e9marrage automatique du serveur :</p> <pre><code>apk rc-update add xrdp\napk rc-update add xrdp-sesman\n</code></pre>"},{"location":"informatique/alpine---installation/#applications-ajoutees","title":"Applications ajout\u00e9es","text":"<p>firefox (navigateur Web) qutebrowser (navigateur Web l\u00e9ger) mousepad (\u00e9diteur de textes) nano (\u00e9diteur de textes en console) claws-mail (e-mail graphique) btop (moniteur syst\u00e8me)</p>"},{"location":"informatique/alpine---installation/#bilan","title":"Bilan","text":"<p>Positif, car moins de 2 Go de disque occup\u00e9 ainsi que moins de 500 Mo de m\u00e9moire utilis\u00e9e avec qutebrowser ouvert.</p> <p>Fin.</p>"},{"location":"informatique/centreon---addendum/","title":"Centreon - Addendum","text":""},{"location":"informatique/centreon---addendum/#centreon-it-100-addendum","title":"Centreon IT-100 - Addendum","text":""},{"location":"informatique/centreon---addendum/#desinstallation-complete","title":"D\u00e9sinstallation compl\u00e8te","text":"<p>Tout sera supprim\u00e9, y compris la configuration des h\u00f4tes et des services, le but \u00e9tant de tout reconstruire suite \u00e0 un incident bloquant sur Centreon tel un probl\u00e8me de mise \u00e0 jour, etc...</p> <p>Si impossibilit\u00e9 de dissocier la licence comme indiqu\u00e9 en Etape 1, importer dans ce cas une sauvegarde de la VM Centreon et effectuer les op\u00e9rations d\u00e9crites ci-dessous sur celle-ci.</p> <p>Avantages d'une sauvegarde</p> <p>1 - Elle peut aider \u00e0 ne pas avoir \u00e0 contacter le support de Centreon pour r\u00e9gler un probl\u00e8me de licence. 2 - Elle peut aussi, selon le cas de figure, \u00e9viter d'avoir \u00e0 tout d\u00e9sinstaller et reconstruire.</p>"},{"location":"informatique/centreon---addendum/#-etape-1","title":"- Etape 1","text":"<p>Alerte</p> <p>Commencer par dissocier la licence IT-100 afin de pouvoir associer celle-ci sur une nouvelle installation.</p> <p>Dissocier la licence : -&gt; Administration -&gt; Extensions -&gt; Gestionnaire -&gt; Bouton Voir la licence -&gt; Bouton Dissocier votre plate-forme</p> <p>Ensuite, arr\u00eater et d\u00e9sactiver le service centreon :</p> <pre><code>sudo systemctl stop centreon\nsudo systemctl disable centreon\n</code></pre> <p>Puis, supprimer avec Adminer ou phpMyAdmin les Bdd centreon et centreon_storage.</p>"},{"location":"informatique/centreon---addendum/#-etape-2","title":"- Etape 2","text":"<p>Supprimer l'ensemble des paquets :</p> <pre><code>sudo apt remove centreon*\n</code></pre>"},{"location":"informatique/centreon---addendum/#-etape-3","title":"- Etape 3","text":"<p>Supprimer les fichiers du dossier /etc :</p> <pre><code>sudo rm -r /etc/centreon\nsudo rm -r /etc/centreon-broker\nsudo rm -r /etc/centreon-engine\nsudo rm -r /etc/centreon-gorgone\n</code></pre>"},{"location":"informatique/centreon---addendum/#-etape-4","title":"- Etape 4","text":"<p>Supprimer les fichiers du dossier /var/lib :</p> <pre><code>sudo rm -r /var/lib/centreon\nsudo rm -r /var/lib/centreon-broker\nsudo rm -r /var/lib/centreon-engine\nsudo rm -r /var/lib/centreon-gorgone\n</code></pre>"},{"location":"informatique/centreon---addendum/#-etape-5","title":"- Etape 5","text":"<p>Supprimer les fichiers du dossier /usr :</p> <pre><code>sudo rm -r /usr/share/centreon\nsudo rm -r /usr/share/centreon-broker\nsudo rm -r /usr/share/centreon-packs\nsudo rm -r /usr/lib/centreon\n</code></pre>"},{"location":"informatique/centreon---addendum/#-etape-6","title":"- Etape 6","text":"<p>Supprimer les fichiers du dossier /var/log :</p> <pre><code>sudo rm -r /var/log/centreon\nsudo rm -r /var/log/centreon-broker\nsudo rm -r /var/log/centreon-engine\nsudo rm -r /var/log/centreon-gorgone\n</code></pre>"},{"location":"informatique/centreon---addendum/#-etape-finale","title":"- Etape finale","text":"<p>Supprimer les fichiers du dossier /var/cache :</p> <pre><code>sudo rm -r /var/cache/centreon\nsudo rm -r /var/cache/centreon-gorgone\n</code></pre> <p>Il est maintenant possible de r\u00e9installer compl\u00e8tement Centreon IT-100.</p> <p>Fin.</p>"},{"location":"informatique/centreon---vboxdeb12-16/","title":"Centreon - VBox/Deb12 1/6","text":""},{"location":"informatique/centreon---vboxdeb12-16/#centreon-it-100-partie-1","title":"Centreon IT 100 - Partie 1","text":""},{"location":"informatique/centreon---vboxdeb12-16/#installation-de-centreon","title":"Installation de Centreon","text":"<p>Centreon peut superviser les PC d'un r\u00e9seau local ainsi que les VM d'un r\u00e9seau virtuel.</p> <p>Son installation, \u00e0 r\u00e9aliser de pr\u00e9f\u00e9rence sur l'un des serveurs du r\u00e9seau local disposant de VirtualBox, se fera \u00e0 l'int\u00e9rieur d'une VM Debian 12.</p>"},{"location":"informatique/centreon---vboxdeb12-16/#-creation-de-la-vm-debian-12","title":"- Cr\u00e9ation de la VM Debian 12","text":"<p>S'aider du m\u00e9mento srvlan \u2013 VirtualBox / Debian 12 pour cr\u00e9er la VM avec un bureau Xfce4.</p> <p>Affecter ces valeurs lors de la cr\u00e9ation de la VM :</p> <ul> <li>Nom -&gt; vm-centreon</li> <li>Taille de la m\u00e9moire -&gt; 2048 Mo</li> <li>Emplacement du fichier et taille -&gt; 20 Go</li> <li>Processeur -&gt; 2 CPU</li> <li>Mode d'acc\u00e8s r\u00e9seau -&gt; Acc\u00e8s par pont (carte 1)</li> </ul> <p>Affecter celles-ci lors de l'installation de l'OS Debian :</p> <ul> <li>Nom de machine -&gt; <code>centreon</code></li> <li>Identifiant ... compte utilisateur -&gt; <code>user1</code></li> <li>Cocher ... Xfce (comme environnement de bureau)</li> </ul> <p>Une fois Debian 12 install\u00e9, la VM reboot.</p> <p>Se connecter et, comme pour la VM <code>srvlan</code>, autoriser l'usage de sudo \u00e0 l'utilisateur <code>user1</code>.</p> <p>Red\u00e9marrer la VM, se connecter et ajouter, comme pour <code>srvlan</code>, les utilitaires de VirtualBox.</p> <p>Puis, s'aider du m\u00e9mento Contr\u00f4le \u00e0 distance / Debian 12 pour installer un serveur xrdp.</p> <p>Relever l'IP locale de la VM, elle sera utilis\u00e9e pour configurer l'outil de connexion \u00e0 distance.</p> <p>Enfin, s'aider du m\u00e9mento LAMP HTTPS CMS / Debian 12 : 1/2 pour installer un serveur Apache, PHP, MySQL ainsi que le gestionnaire de Bdd Adminer.</p> <p>Stopper \u00e0 pr\u00e9sent la VM et la red\u00e9marrer sous VirtualBox en mode D\u00e9marrage sans affichage.</p> <p>Celle-ci doit maintenant \u00eatre accessible \u00e0 distance depuis divers clients RDP :</p> <p> </p> Centreon : Acc\u00e8s RDP depuis mRemoteNG <p>Si tout est OK, il est possible d'installer Centreon IT.</p>"},{"location":"informatique/centreon---vboxdeb12-16/#-ajout-de-centreon-sur-la-vm","title":"- Ajout de Centreon sur la VM","text":"<p>La proc\u00e9dure pr\u00e9sent\u00e9e ci-dessous s'inspire de la docs.centreon.com.</p> <p>Mettre \u00e0 jour la Debian 12 :</p> <pre><code>sudo apt update \nsudo apt upgrade\n</code></pre> <p>et installer les d\u00e9pendances concernant Centreon :</p> <pre><code>sudo apt install lsb-release ca-certificates apt-transport-https software-properties-common wget gnupg2 curl\n</code></pre> <p>Ajouter le d\u00e9p\u00f4t de PHP 8.1, Debian utilisant PHP 8.2 :</p> <pre><code>su root\n\necho \"deb https://packages.sury.org/php/ $(lsb_release -sc) main\" | tee /etc/apt/sources.list.d/sury-php.list\n\nwget -O- https://packages.sury.org/php/apt.gpg | gpg --dearmor | tee /etc/apt/trusted.gpg.d/php.gpg  &gt; /dev/null 2&gt;&amp;1\n\napt update\n</code></pre> <p>Ne rien faire pour MySQL (MariaDB) qui est d\u00e9j\u00e0 install\u00e9.</p> <p>Ajouter le d\u00e9p\u00f4t de Centreon :</p> <pre><code>echo \"deb https://packages.centreon.com/apt-standard-24.04-stable/ $(lsb_release -sc) main\" | tee /etc/apt/sources.list.d/centreon.list\n\necho \"deb https://packages.centreon.com/apt-plugins-stable/ $(lsb_release -sc) main\" | tee /etc/apt/sources.list.d/centreon-plugins.list\n\nwget -O- https://apt-key.centreon.com | gpg --dearmor | tee /etc/apt/trusted.gpg.d/centreon.gpg &gt; /dev/null 2&gt;&amp;1\n\napt update\n</code></pre> <p>et installer enfin le serveur Centreon :</p> <pre><code>apt install -y --no-install-recommends centreon-mariadb centreon\n\nsystemctl daemon-reload\nsystemctl restart mariadb\n</code></pre> <p>Configurer le serveur Apache comme suit :</p> <pre><code>sudo a2enmod proxy_fcgi setenvif\nsudo a2enconf php8.1-fpm\nsudo systemctl daemon-reload\nsudo systemctl status apache2\n</code></pre> <p>V\u00e9rifiez le statut de MariaDB :</p> <pre><code>sudo systemctl status mariadb\n</code></pre> <p>Modifier le fuseau horaire comme suit :</p> <pre><code>echo \"date.timezone = Europe/Paris\" &gt;&gt; /etc/php/8.1/mods-available/centreon.ini\n</code></pre> <p>Editer ensuite le fichier /etc/php/8.1/fpm/php.ini, d\u00e9commenter la ligne date.timezone et lui affecter la m\u00eame valeur que ci-dessus.</p> <p>Red\u00e9marrer le service PHP-FPM</p> <pre><code>systemctl restart php8.1-fpm\n</code></pre> <p>Activer le d\u00e9marrage automatique des services suivants au boot du syst\u00e8me :</p> <pre><code>systemctl enable php8.1-fpm apache2 centreon cbd centengine gorgoned centreontrapd snmpd snmptrapd\n</code></pre> <p>Idem pour le service MariaDB :</p> <pre><code>systemctl enable mariadb\nsystemctl restart mariadb\n</code></pre> <p>S\u00e9curiser l'acc\u00e8s aux Bdd du serveur MariaDB :</p> <pre><code>mysql_secure_installation\n</code></pre> <p>en r\u00e9pondant aux questions pos\u00e9es comme suit :</p> <p>Enter ... password for root ... : Appuyer sur Entr\u00e9e Switch to unix_socket authentication [Y/n] n</p> <p>Change the root password? [Y/n] y New password: Le MDP root pour MySQL</p> <p>Remove anonymous users? [Y/n] y Disallow root login remotely? [Y/n] n Remove test database and access to it? [Y/n] y Reload privilege tables now? [Y/n] y</p> <p>Le syst\u00e8me est maintenant pr\u00eat pour l'\u00e9tape suivante.</p>"},{"location":"informatique/centreon---vboxdeb12-16/#-ajout-de-linterface-web","title":"- Ajout de l'interface Web","text":"<p>Ouvrir depuis le navigateur Web de la VM Debian 12 l'URL <code>http://localhost</code> :</p> <p>Puis, suivre cette page de la docs.centreon.com jusqu'\u00e0 la partie Initialisation de la supervision.</p> <p>Deux minutes plus tard, il sera possible d'acc\u00e9der au tableau de bord de Centreon :</p> <p> </p> Centreon : Tableau de bord <p>Cliquer sur l'ic\u00f4ne situ\u00e9e en haut et \u00e0 droite du tableau de bord et s\u00e9lectionner \"Edit profile\".</p> <p>Modifier la langue \u00e0 \"fr_FR\" et sauvegarder.</p>"},{"location":"informatique/centreon---vboxdeb12-16/#-initialisation-supervision","title":"- Initialisation supervision","text":"<p>Puis, suivre la partie Initialisation de la supervision du m\u00eame document que ci-dessus.</p> <p>Si tout est OK, la page Collecteurs montrera ceci :</p> <p> </p> Centreon : Page Collecteurs"},{"location":"informatique/centreon---vboxdeb12-16/#-licence-centreon-it-100","title":"- Licence Centreon IT-100","text":"<p>Suivre cette page de la docs.centreon.com pour obtenir la licence, la d\u00e9marche est simple.</p> <p>Il est possible ansi, depuis le serveur central Centreon, de superviser jusqu'\u00e0 100 h\u00f4tes, un h\u00f4te \u00e9tant un PC ou une VM disposant d'une adresse IP/DNS.</p> <p></p> <p>  Centreon est install\u00e9, la partie 2 traite de la supervision de serveurs NAS Synology et Qnap.</p> <p>Partie 2</p>"},{"location":"informatique/centreon---vboxdeb12-26/","title":"Centreon - VBox/Deb12 2/6","text":""},{"location":"informatique/centreon---vboxdeb12-26/#centreon-it-100-partie-2","title":"Centreon IT 100 - Partie 2","text":""},{"location":"informatique/centreon---vboxdeb12-26/#supervision-de-serveurs-nas","title":"Supervision de serveurs NAS","text":"<p>D\u00e9couvrir d'abord l'interface Web de Centreon ainsi que les \u00e9l\u00e9ments supervis\u00e9s par celle-ci.</p>"},{"location":"informatique/centreon---vboxdeb12-26/#-interface-web-de-centreon","title":"- Interface Web de Centreon","text":"<p>Menu de gauche : Accueil = Vues personnalis\u00e9es (aucune de base) Supervision = Etats/Journaux des \u00e9l\u00e9ments supervis\u00e9s Rapports = Diagrammes de vue sur des temps donn\u00e9s Configuration = Param\u00e8tres des \u00e9l\u00e9ments supervis\u00e9s Administration = Gestion de Centreon, des plugins, etc...</p> <p>Bandeau sup\u00e9rieur - Zone Collecteurs : Vert = Le collecteur envoie ses donn\u00e9es au central</p> <p>Bandeau sup\u00e9rieur - Zone Services : 4 couleurs = Etat Critique/Alerte/Inconnu/OK</p> <p>Bandeau sup\u00e9rieur - Zone H\u00f4tes : 3 couleurs = Etat Indisponible/Injoignable/OK</p>"},{"location":"informatique/centreon---vboxdeb12-26/#-elements-supervises","title":"- El\u00e9ments supervis\u00e9s","text":"<p>H\u00f4te = El\u00e9ment avec une adresse IP/DNS (Ex: Serveur) Service = El\u00e9ment supervis\u00e9 sur un h\u00f4te (Ex: Cpu)</p> <p>Les valeurs de chaque \u00e9l\u00e9ment sont r\u00e9cup\u00e9r\u00e9es par des sondes (plugins) ex\u00e9cut\u00e9es p\u00e9riodiquement par le collecteur (Centreon Engine).</p> <p>Le statut des h\u00f4tes/services est accessible depuis le menu Supervision -&gt; Statut des ressources.</p> <p>Des outils appel\u00e9s mod\u00e8les d'h\u00f4tes et de services ou Connecteurs de supervision facilitent la configuration des h\u00f4tes et services \u00e0 superviser.</p> <p>La licence Centreon IT-100 permet la d\u00e9couverte automatique d'h\u00f4tes et de services.</p>"},{"location":"informatique/centreon---vboxdeb12-26/#-supervision-dun-synology","title":"- Supervision d'un Synology","text":"<p>Au pr\u00e9alable, installer le paquet Centreon suivant :</p> <pre><code>sudo apt install centreon-plugin-hardware-storage-synology-snmp\n</code></pre> <p>Ensuite : -- C\u00f4t\u00e9 serveur NAS -- Activer le serveur SNMP. Activer les protocoles SNMPv1 SNMPv2c. Nommer la communaut\u00e9 SNMP (Ex: snmp14).</p> <p>-- C\u00f4t\u00e9 Plateforme Centreon IT-100 -- -&gt; Menu Configuration -&gt; Monitoring Connector Manager -&gt; Champ Mots cl\u00e9s -&gt; Entrer Synology -&gt; Bouton Recherche</p> <p>-&gt; Cliquer sur le + du connecteur trouv\u00e9 pour l'installer -&gt; Bouton Appliquer</p> <p> </p> Centreon : Connecteur Synology install\u00e9 <p>Une fois le connecteur install\u00e9, cr\u00e9er l'h\u00f4te NAS : -&gt; Menu Configuration -&gt; H\u00f4tes -&gt; H\u00f4tes -&gt; Bouton Ajouter</p> <p>Remplir l'onglet Configuration de l'h\u00f4te comme ceci :</p> <p> </p> Centreon : Informations de base sur l'h\u00f4te <p> </p> Centreon : Options contr\u00f4le h\u00f4te/ordonnancement <p>Remplir ensuite l'onglet Notification comme ceci :</p> <p> </p> Centreon : Notification par email d\u00e9sactiv\u00e9e <p>Ensuite, configurer les services associ\u00e9s \u00e0 l'h\u00f4te : -&gt; Menu Configuration -&gt; Services -&gt; Services par l'h\u00f4te -&gt; Cliquer sur la roue dent\u00e9e de chaque service</p> <p>-&gt; Onglet Informations g\u00e9n\u00e9rales Configurer une p\u00e9riode de contr\u00f4le</p> <p>Exemple pour le service Cpu :</p> <p> </p> Centreon : P\u00e9riode de contr\u00f4le du Cpu configur\u00e9e <p>-&gt; Onglet Notifications Configurer la notification par email \u00e0 Non :</p> <p> </p> Centreon : Notification du service Cpu d\u00e9sactiv\u00e9e <p>sauf pour le service Ping qui sera coch\u00e9 \u00e0 Oui :</p> <p> </p> Centreon : Notification du service Ping activ\u00e9e <p>Pour finir, d\u00e9ployer la nouvelle configuration : -&gt; Menu Configuration -&gt; Collecteurs -&gt; Collecteurs -&gt; Cocher le collecteur Central -&gt; Bouton Exporter la configuration</p> <p>Zone Actions : -&gt; Cocher D\u00e9placer les fichiers g\u00e9n\u00e9r\u00e9s -&gt; Cocher Red\u00e9marrer l'ordonnanceur -&gt; Bouton Exporter</p> <p> </p> Centreon : D\u00e9ploiement de la nouvelle configuration"},{"location":"informatique/centreon---vboxdeb12-26/#-supervision-dun-qnap","title":"- Supervision d'un Qnap","text":"<p>Au pr\u00e9alable, installer le paquet Centreon suivant :</p> <pre><code>sudo apt install centreon-plugin-hardware-storage-qnap-snmp\n</code></pre> <p>Installer ensuite, depuis l'interface Web de Centreon, le connecteur de supervision Qnap et proc\u00e9der \u00e0 la configuration du serveur NAS comme ci-dessus.</p> <p>Le tout fini et fonctionnel, on peut observer sur certains services les retours suivants :</p> <pre><code>UNKNOWN: SNMP Get Request: Timeout\n</code></pre> <pre><code>UNKNOWN: SNMP Table Request: Timeout\n</code></pre> <p>Pour le premier cas, modifier le timeout du service concern\u00e9 peut suffire, exemple pour le Cpu :</p> <p> </p> Centreon : Timeout du service Cpu modifi\u00e9 \u00e0 10s <p>Pour info, Centreon obtient les informations du service Cpu \u00e0 l'aide de la Cde suivante :</p> <pre><code>/usr/lib/centreon/plugins//centreon_qnap.pl --plugin=storage::qnap::snmp::plugin --mode=cpu --hostname=192.168.9.1 --snmp-version='2c' --snmp-community='snmp14'  --warning-average='80' --critical-average='90' --snmp-timeout='10'\n</code></pre> <p>Les services Hardware-Global et Volumes ont, dans mon cas, n\u00e9cessit\u00e9 l'ajout d'options dans les Cdes du plugin de Centreon pour fonctionner.</p> <p>Options --filter pour le service Hardware-Global :</p> <pre><code>/usr/lib/centreon/plugins//centreon_qnap.pl --plugin=storage::qnap::snmp::plugin --mode=hardware --hostname=192.168.9.1 --snmp-version='2c' --snmp-community='snmp14'  --component='.*' --verbose --snmp-timeout='10' --filter='disk,3' --filter='raid'\n</code></pre> <p>La premi\u00e8re option exclut le contr\u00f4le du disque d'instance 3, la seconde exclut celui du raid.</p> <p>Option --force-counters-legacy pour le service Volumes :</p> <pre><code>/usr/lib/centreon/plugins//centreon_qnap.pl --plugin=storage::qnap::snmp::plugin --mode=volumes --hostname='192.168.9.1' --snmp-version='2c' --snmp-community='snmp14'  --filter-name='' --warning-space-usage='' --critical-space-usage='' --warning-space-usage-free='' --critical-space-usage-free='' --warning-space-usage-prct='' --critical-space-usage-prct='' --warning-volume-status='%{status} =~ /degraded|warning/i' --critical-volume-status='%{status} =~ /critical/i' --verbose --snmp-timeout='10'  --force-counters-legacy\n</code></pre> <p>L'option impose l'usage d'anciens compteurs, \u00e0 utiliser lorsque ceux du Qnap ne r\u00e9pondent pas.</p> <p>L'ajout d'options plac\u00e9es les unes apr\u00e8s les autres au niveau de l'interface Web de Centreon se fait dans le champ Valeur de EXTRAOPTIONS :</p> <p> </p> Centreon : Ajout d'options pour un service <p>Autre point important, le SNMP du Qnap dispose d'un limiteur de d\u00e9bit et d'une protection DDoS.</p> <p>Les valeurs par d\u00e9faut de ces param\u00e8tres sont :</p> <pre><code>MaxPacketPerSecond 300\nEnableDetectDDoS TRUE\n</code></pre> <p>En cas d'alerte sur le Qnap, se connecter en SSH sur celui-ci et entrer les Cdes suivantes :</p> <pre><code>sudo setcfg SNMP MaxPacketPerSecond 1000\nsudo setcfg SNMP EnableDetectDDoS FALSE\nsudo /etc/init.d/snmp restart\n</code></pre> <p>On peut contr\u00f4ler la modification dans ce fichier :</p> <pre><code>cat /etc/config/uLinux.conf\n</code></pre> <p></p> <p>  Voil\u00e0 pour les serveurs NAS. La partie 3 traite cette fois de la supervision des OS Debian et Windows.</p> <p>Partie 3</p>"},{"location":"informatique/centreon---vboxdeb12-36/","title":"Centreon - VBox/Deb12 3/6","text":""},{"location":"informatique/centreon---vboxdeb12-36/#centreon-it-100-partie-3","title":"Centreon IT 100 - Partie 3","text":""},{"location":"informatique/centreon---vboxdeb12-36/#supervision-dun-os-debian","title":"Supervision d'un OS Debian","text":""},{"location":"informatique/centreon---vboxdeb12-36/#-notes-sur-le-protocole-snmp","title":"- Notes sur le protocole SNMP","text":"<p>SNMP = Simple Network Management Protocol MIB = Management Information Base OID = Object IDentifier</p> <p>Le protocole SNMP s\u2019appuie sur un manager et des agents, ces derniers permettant de r\u00e9cup\u00e9rer des informations (valeurs) sur diff\u00e9rents objets.</p> <p>Les MIBs sont exploit\u00e9es par le SNMP pour acc\u00e9der aux informations. Chaque objet SNMP (p\u00e9riph\u00e9rique ou \u00e9l\u00e9ment d'OS) dispose d\u2019une MIB.</p> <p>Les OIDs de forme num\u00e9rique 1.3.6.1.2... d\u00e9signent l\u2019emplacement des informations (valeurs) \u00e0 consulter dans une MIB.</p> <p>Cdes SNMP de base \u00e9mises par le manager : GET = demande d'une valeur \u00e0 un agent. GET-NEXT = demande de la valeur suivante. GET-BULK = demande group\u00e9e de valeurs. SET = modifie une valeur contenue dans un OID.</p> <p>Cdes SNMP de base \u00e9mises par l'agent : GET-RESPONSE = r\u00e9pond \u00e0 GET ou SET. TRAP = envoi d'une notification au manager.</p> <p>Debian utilise les applications suivantes pour lancer les Cdes ci-dessus :</p> <ul> <li>snmpget</li> <li>snmpwalk</li> <li>snmpbulkget</li> <li>snmpset</li> <li>snmptrap</li> </ul>"},{"location":"informatique/centreon---vboxdeb12-36/#-installation-et-reglage-snmp","title":"- Installation et r\u00e9glage SNMP","text":"<p>Commencer par ajouter le d\u00e9p\u00f4t non-free dans le fichier /etc/apt/sources.list.</p> <p>Exemple pour Debian 12 :</p> <pre><code>deb http://deb.debian.org/debian/ bookworm main non-free-firmware non-free\n\ndeb http://security.debian.org/debian-security bookworm-security main non-free-firmware\n\ndeb http://deb.debian.org/debian/ bookworm-updates main non-free-firmware\n</code></pre> <p>Installer ensuite le paquet qui sera exploit\u00e9 pour observer les OIDs depuis la Cde snmpwalk :</p> <pre><code>sudo apt update &amp;&amp; upgrade\nsudo apt install snmp-mibs-downloader\n</code></pre> <p>La partie ci-dessous s'inspire de la docs.centreon.com.</p> <p>Param\u00e8tres utilis\u00e9s pour l'exemple : Nom de la communaut\u00e9 SNMP = snmp14 IP de l'OS Debian = 192.168.9.3</p> <p>Installer les paquets SNMP suivants :</p> <pre><code>sudo apt install snmp snmpd libsnmp-perl\n</code></pre> <p>Puis, \u00e9diter le fichier de configuration snmpd.conf :</p> <pre><code>sudo nano /etc/snmp/snmpd.conf\n</code></pre> <p>et modifier son contenu comme suit :</p> <pre><code>agentaddress udp:161\nview centreon included .1.3.6.1\nview    systemonly    included   .1.3.6.1.2.1.1\nview    systemonly    included   .1.3.6.1.2.1.25.1\n#rocommunity public ...\n#rocommunity6 public ...\nrocommunity snmp14 default # ou snmp14 192.168.9.0/24\n</code></pre> <p>Par prudence, garder une seule ligne d'instruction rocommunity, commenter les autres.</p> <p>D\u00e9marrer enfin le service et v\u00e9rifier son statut :</p> <pre><code>sudo systemctl start snmpd\nsudo systemctl status snmpd\n</code></pre> <p>Si statut Ok, activer le service au boot du syst\u00e8me :</p> <pre><code>sudo systemctl enable snmpd\n</code></pre> <p>V\u00e9rifier par curiosit\u00e9 l'ouverture du port SNMP 161 :</p> <pre><code>ss -ulnp | grep 161\n</code></pre> <p>Retour Debian 11 :</p> <pre><code>UNCONN   0   0   0.0.0.0:161   0.0.0.0:*\n</code></pre> <p>Retour Debian 12 :</p> <pre><code>UNCONN 0   0  127.0.0.1:161   0.0.0.0:*          \nUNCONN 0   0      [::1]:161      [::]:*\n</code></pre> <p>Pour finir, v\u00e9rifier le bon fonctionnement de SNMP :</p> <pre><code>snmpwalk -c snmp14 -v 2c 192.168.9.3\n</code></pre> <p>La liste des OIDs de l'agent SNMP doit s'afficher.</p>"},{"location":"informatique/centreon---vboxdeb12-36/#-reglage-cote-vm-centreon","title":"- R\u00e9glage c\u00f4t\u00e9 VM Centreon","text":"<p>V\u00e9rifier l'installation du paquet centreon-plugin-operatingsystems-linux.snmp, \u00e0 d\u00e9faut r\u00e9aliser celle-ci.</p> <p>Installer le connecteur de supervision Linux SNMP et configurer l'h\u00f4te Debian et les services associ\u00e9s en utilisant cette fois le mod\u00e8le OS-Linux-SNMP-custom.</p> <p>S'aider de l'exemple du NAS Synology pour y arriver (r\u00e9f : Centreon - Partie 2).</p> <p>Ne pas oublier ensuite de d\u00e9ployer la nouvelle configuration.</p>"},{"location":"informatique/centreon---vboxdeb12-36/#supervision-dun-os-windows","title":"Supervision d'un OS Windows","text":"<p>Comme pour Debian, il est n\u00e9cessaire d'installer un agent SNMP sur Windows.</p> <p>La partie ci-dessous s'inspire de la docs.centreon.com.</p>"},{"location":"informatique/centreon---vboxdeb12-36/#-installation-de-lagent-snmp","title":"- Installation de l'agent SNMP","text":"<p>-&gt; Touches Windows + I pour ouvrir les param\u00e8tres -&gt; Syst\u00e8me -&gt; Fonctionnalit\u00e9s facultatives -&gt; Bouton Afficher les fonctionnalit\u00e9s</p> <p>Une fen\u00eatre Ajouter une fonctionnalit\u00e9 ... s'ouvre : -&gt; Champ Recherche -&gt; Entrer snmp -&gt; Cocher Protocole SNMP (Simple Network ...) -&gt; Bouton Suivant -&gt; Bouton Installer</p> <p>L'installation peut durer de 2 \u00e0 4 minutes.</p>"},{"location":"informatique/centreon---vboxdeb12-36/#-reglage-du-service-snmp","title":"- R\u00e9glage du service SNMP","text":"<p>-&gt; Touches Windows + R pour ouvrir la fen\u00eatre Ex\u00e9cuter -&gt; Entrer services.msc -&gt; OK</p> <p>Une fen\u00eatre Services s'ouvre : Double-cliquer sur le service Service SNMP</p> <p>Une fen\u00eatre Propri\u00e9t\u00e9s de Service SNMP s'ouvre : -- Onglet S\u00e9curit\u00e9 -- -&gt; Ajouter la communaut\u00e9 snmp14 -&gt; Ajouter l'IP du manager Centreon</p> <p>-- Onglet Agent -- -&gt; Rubrique Service -&gt; Cocher les donn\u00e9es que collectera Centreon</p> <p>-&gt; Bouton Appliquer -&gt; OK -&gt; Red\u00e9marrer le service -&gt; Fermer la fen\u00eatre Services</p>"},{"location":"informatique/centreon---vboxdeb12-36/#-reglage-cote-vm-centreon_1","title":"- R\u00e9glage c\u00f4t\u00e9 VM Centreon","text":"<p>V\u00e9rifier l'installation du paquet centreon-plugin-operatingsystems-windows.snmp, \u00e0 d\u00e9faut r\u00e9aliser celle-ci.</p> <p>Installer le connecteur de supervision Windows SNMP et configurer l'h\u00f4te Windows et les services associ\u00e9s en utilisant cette fois le mod\u00e8le OS-Windows-SNMP-custom.</p> <p>S'aider de l'exemple du NAS Synology pour y arriver (r\u00e9f : Centreon - Partie 2).</p> <p>Ne pas oublier ensuite de d\u00e9ployer la nouvelle configuration.</p> <p>V\u00e9rifier apr\u00e8s quelques minutes le statut de l'h\u00f4te et des services associ\u00e9s, personnellement, un seul statut Alerte concernant la ressource Memory.</p> <p>Alerte normale apr\u00e8s v\u00e9rification de la taille m\u00e9moire utilis\u00e9e par le PC Windows.</p> <p>Pour contourner l'alerte, il a fallu modifier le seuil de celle-ci et red\u00e9ployer la configuration :</p> <p> </p> Centreon : R\u00e9glage du seuil d'alerte du service Memory"},{"location":"informatique/centreon---vboxdeb12-36/#-decouverte-de-services","title":"- D\u00e9couverte de services","text":"<p>Le connecteur de supervision Windows SNMP a permis, lors de la cr\u00e9ation de l'h\u00f4te, d'activer automatiquement les services suivants : Cpu, Memory, Ping et Swap.</p> <p>Les connecteurs peuvent inclure des mod\u00e8les de services autres que ceux configur\u00e9s de base.</p> <p>Pour d\u00e9couvrir ceux du connecteur de supervision Windows SNMP, proc\u00e9der comme suit :</p> <p> </p> Centreon : Ajout du service disponible Disk-C <p>Les services s\u00e9lectionn\u00e9s sont alors automatiquement ajout\u00e9s \u00e0 l'h\u00f4te Windows.</p> <p>Configurer ensuite chacun d'eux et red\u00e9ployer la nouvelle configuration.</p> <p></p> <p>  Les choses avancent. La partie 4 exploitera le module de d\u00e9couverte automatique d'h\u00f4tes et de services.</p> <p>Partie 4</p>"},{"location":"informatique/centreon---vboxdeb12-46/","title":"Centreon - VBox/Deb12 4/6","text":""},{"location":"informatique/centreon---vboxdeb12-46/#centreon-it-100-partie-4","title":"Centreon IT 100 - Partie 4","text":""},{"location":"informatique/centreon---vboxdeb12-46/#centreon-auto-discovery","title":"Centreon Auto Discovery","text":"<p>Le module de d\u00e9couverte automatique inclus dans la licence Centreon IT-100 permet de d\u00e9tecter de nouveaux h\u00f4tes ou services via le protocole SNMP.</p> <p>Attention, les h\u00f4tes ne sont d\u00e9couverts que si un agent snmp est install\u00e9 sur chacun d'eux.</p> <p>L'auto d\u00e9couverte sera test\u00e9e sur 1 serveur, 3 VM et 1 conteneur LXD, tous sous Debian et d\u00e9clar\u00e9s dans la communaut\u00e9 snmp14.</p> <p>Commencer par installer les agents en se r\u00e9f\u00e9rant \u00e0 la Partie 3.</p> <p>V\u00e9rifier ensuite que le module Auto Discovery fourni avec la licence IT-100 est bien install\u00e9.</p> <p>A d\u00e9faut, ajouter le module comme suit :</p> <pre><code>sudo apt install centreon-auto-discovery-server\n</code></pre> <p>Puis ouvrir l'interface Web de Centreon : -&gt; Menu Administration -&gt; Extensions -&gt; Gestionnaire -&gt; Installer le module Auto Discovery</p>"},{"location":"informatique/centreon---vboxdeb12-46/#-connecteur-generic-snmp","title":"- Connecteur Generic SNMP","text":"<p>Utiliser, pour d\u00e9tecter les nouveaux h\u00f4tes, le connecteur de supervision Generic SNMP qui fait partie des connecteurs permettant l'auto-d\u00e9couverte, voir la docs.centreon.com.</p> <p>Pour cela, commencer par installer ce paquet :</p> <pre><code>sudo apt install centreon-plugin-applications-protocol-snmp\n</code></pre> <p>puis le connecteur de supervision en se r\u00e9f\u00e9rant au \u00a7 2.3 de la Partie 2.</p> <p>Relancer par pr\u00e9caution les services de Centreon :</p> <pre><code>sudo systemctl restart cbd centengine gorgoned\n</code></pre>"},{"location":"informatique/centreon---vboxdeb12-46/#-tache-dauto-decouverte","title":"- T\u00e2che d'auto-d\u00e9couverte","text":"<p>Cr\u00e9er \u00e0 pr\u00e9sent une t\u00e2che d'auto-d\u00e9couverte depuis l'interface Web comme ci-dessous : -&gt; Configuration -&gt; H\u00f4tes -&gt; D\u00e9couverte -&gt; Bouton + AJOUTER</p> <p>Remplir la partie 1 comme suit :</p> <p> </p> Centreon : Auto-d\u00e9couverte - Partie 1/6 <p>Laisser la partie 2 comme telle :</p> <p> </p> Centreon : Auto-d\u00e9couverte - Partie 2/6 <p>Remplir la partie 3 comme suit :</p> <p> </p> Centreon : Auto-d\u00e9couverte - Partie 3/6 <p>Laisser la partie 4 comme telle :</p> <p> </p> Centreon : Auto-d\u00e9couverte - Partie 4/6 <p>Remplir la partie 5 comme suit :</p> <p> </p> Centreon : Auto-d\u00e9couverte - Partie 5/6 <p>Remplir la partie 6 comme suit :</p> <p> </p> Centreon : Auto-d\u00e9couverte - Partie 6/6 <p>La t\u00e2che est ex\u00e9cut\u00e9e et son statut appara\u00eet dans : -&gt; Configuration -&gt; H\u00f4tes -&gt; D\u00e9couverte</p> <p> </p> Centreon : T\u00e2che Auto d\u00e9couverte SNMP termin\u00e9e"},{"location":"informatique/centreon---vboxdeb12-46/#-exploitation-de-la-tache","title":"- Exploitation de la t\u00e2che","text":"<p>Lorsque le statut indique termin\u00e9, cliquer sur la fl\u00e8che situ\u00e9e \u00e0 droite de celui-ci pour voir le d\u00e9tail du r\u00e9sultat de l'analyse manuelle.</p> <p>S\u00e9lectionner ensuite les h\u00f4tes que l'on souhaite ajouter ou mettre \u00e0 jour dans la configuration de Centreon, puis cliquer sur l'ic\u00f4ne Sauvegarder.</p> <p>Le serveur, les 3 VM et le conteneur LXD ont bien \u00e9t\u00e9 d\u00e9couverts.</p> <p>G\u00e9rer enfin les p\u00e9riodes d'ordonnancement ainsi que les notifications des h\u00f4tes d\u00e9couverts et leurs services associ\u00e9s en s'aidant de ce chapitre de la Partie 2.</p> <p>Une fois fait, d\u00e9ployer la nouvelle configuration : -&gt; Menu Configuration -&gt; Collecteurs -&gt; Collecteurs -&gt; Cocher le collecteur Central -&gt; Bouton Exporter la configuration</p> <p>Zone Actions, cocher : G\u00e9n\u00e9rer les fichiers de configuration Lancer le d\u00e9bogage du moteur de supervision (-v) D\u00e9placer les fichiers g\u00e9n\u00e9r\u00e9s Red\u00e9marrer l'ordonnanceur</p> <p>Cliquer ensuite sur le bouton Exporter.</p>"},{"location":"informatique/centreon---vboxdeb12-46/#-desactivation-dun-service","title":"- D\u00e9sactivation d'un service","text":"<p>V\u00e9rifier apr\u00e8s quelques minutes les statuts des h\u00f4tes et des services.</p> <p>L'un d'eux montre un \u00e9tat Critique concernant la ressource Swap d'une des 3 VM.</p> <p>Statut correct car la VM en question ne dispose pas d'une partition Swap.</p> <p>Pour supprimer un service inutile, d\u00e9sactiver celui-ci comme suit et red\u00e9ployer la configuration :</p> <p> </p> Centreon : D\u00e9sactivation du service swap <p></p> <p>  Belle \u00e9tape. La partie 5 vous attend pour d\u00e9couvrir comment superviser un site Web en utilisant le connecteur HTTP Server.</p> <p>Partie 5</p>"},{"location":"informatique/centreon---vboxdeb12-56/","title":"Centreon - VBox/Deb12 5/6","text":""},{"location":"informatique/centreon---vboxdeb12-56/#centreon-it-100-partie-5","title":"Centreon IT 100 - Partie 5","text":"<p>Le m\u00e9mento concerne Centreon 23.10 sous Debian \u2265 11.11 et 24.04 sous Debian \u2265 12.7.</p>"},{"location":"informatique/centreon---vboxdeb12-56/#supervision-dun-site-web","title":"Supervision d'un site Web","text":"<p>La supervision d\u2019un site Web r\u00e9alis\u00e9e avec les Cdes Curl et Ping permettra de v\u00e9rifier la disponibilit\u00e9 et les performances de celui-ci.</p> <p>Les graphiques de Centreon afficheront les temps de r\u00e9ponse HTTP issus de la Cde curl et les temps de r\u00e9ponse et paquets perdus issus de la Cde ping.</p> <p>La Cde curl permet de se connecter sur diff\u00e9rents types de serveurs et de communiquer avec ceux-ci via diff\u00e9rents types de protocoles dont le HTTPS, FTP, etc\u2026</p> <p>La partie ci-dessous s'inspire de la docs.centreon.com.</p>"},{"location":"informatique/centreon---vboxdeb12-56/#-outils-http-de-centreon","title":"- Outils HTTP de Centreon","text":"<p>Pour surveiller l\u2019URL d'un site, proc\u00e9dez comme suit : -- C\u00f4t\u00e9 VM centreon -- Installez le paquet ci-dessous si manquant :</p> <pre><code>sudo apt install centreon-plugin-applications-protocol-http\n</code></pre> <p>-- C\u00f4t\u00e9 Plateforme Centreon IT-100 -- Menu Configuration -&gt; Monitoring Connector Manager -&gt; Champ Mots cl\u00e9s -&gt; Entrez HTTP -&gt; Bouton Recherche</p> <p>-&gt; Trouvez dans le r\u00e9sultat le connecteur HTTP Server -&gt; Cliquez sur son ic\u00f4ne + pour lancer son installation</p> <p>Celui-ci appara\u00eetra install\u00e9 apr\u00e8s quelques secondes.</p>"},{"location":"informatique/centreon---vboxdeb12-56/#-configuration-de-lhote-web","title":"- Configuration de l'h\u00f4te Web","text":"<p>Cr\u00e9ez un nouvel h\u00f4te Web comme suit : Menu Configuration -&gt; H\u00f4tes -&gt; H\u00f4tes -&gt; Bouton Ajouter</p> <p>Remplissez l'onglet Configuration de l'h\u00f4te :</p> <p> </p> Centreon : Information de base sur l'h\u00f4te Web <p>Choisissez un site dont vous connaissez l'URL (Adresse IPv4 / FQDN) et le port HTTPS utilis\u00e9s.</p> <p>Pour \u00e9viter d'\u00e9ventuels soucis de DNS, ajoutez ces 2 lignes dans le fichier /etc/hosts de la VM centreon seulement si le central de Centreon et le site Web se trouvent sur le m\u00eame LAN :</p> <pre><code>Ex: IP locale du site Web       Ex: URL du site\n192.168.7.42                    monblog.fr\n</code></pre> <p>Remplissez ensuite l'onglet Notification :</p> <p> </p> Centreon : Notification par e-mail pour l'h\u00f4te \u00e0 Non <p>Puis, configurez les 2 services associ\u00e9s \u00e0 l'h\u00f4te Web : Menu Configuration -&gt; Services -&gt; Services par l'h\u00f4te</p> <p>Affichez le service HTTP-Response-Time de l'h\u00f4te Web : -&gt; Onglet Informations g\u00e9n\u00e9rales</p> <p>Modifiez la valeur URLPATH dans le cas d'une URL de type <code>https://domaine/sous-dossier/</code> :</p> <p> </p> Centreon : URL type https://domaine/sous-dossier/ <p>-&gt; Onglet Notifications</p> <p>Configurez la notification par e-mail \u00e0 Non :</p> <p> </p> Centreon : Notification HTTP-Response-Time \u00e0 Non <p>Affichez ensuite le service Ping de l'h\u00f4te Web : -&gt; Onglet Notifications</p> <p>Configurez la notification par e-mail \u00e0 Oui :</p> <p> </p> Centreon : Notification Ping \u00e0 Oui"},{"location":"informatique/centreon---vboxdeb12-56/#-activation-de-lhote-web","title":"- Activation de l'h\u00f4te Web","text":"<p>Pour activer l'h\u00f4te Web, d\u00e9ployez la configuration : Menu Configuration -&gt; Collecteurs -&gt; Collecteurs -&gt; Cochez le collecteur Central -&gt; Bouton Exporter la configuration</p> <p>Zone Actions : -&gt; Cochez D\u00e9placer les fichiers g\u00e9n\u00e9r\u00e9s -&gt; Cochez Red\u00e9marrer l'ordonnanceur -&gt; Bouton Exporter</p> <p>Retour normal :</p> <p> </p> Centreon : Configuration de l'h\u00f4te Web d\u00e9ploy\u00e9e"},{"location":"informatique/centreon---vboxdeb12-56/#-statistiques-du-site","title":"- Statistiques du site","text":"<p>Pour afficher les graphiques du site, proc\u00e9dez ainsi : Menu Statut des ressources -&gt; Champ de recherche -&gt; Entrez le filtre : parent_name:Monblog type:host -&gt; Colonne G (Graphique) -&gt; Cliquez sur l'ic\u00f4ne Service graphs de l'h\u00f4te Web</p> <p> </p> Centreon : Statistiques de l'h\u00f4te Web sur 1 jour"},{"location":"informatique/centreon---vboxdeb12-56/#-duplication-dhote","title":"- Duplication d'h\u00f4te","text":"<p>-- Duplication d'h\u00f4te -- Pour cr\u00e9er un nouvel h\u00f4te Web, utilisez la duplication : Menu Configuration -&gt; H\u00f4tes -&gt; H\u00f4tes -&gt; Cochez le nom de l'h\u00f4te \u00e0 dupliquer -&gt; Champ Plus d'actions... -&gt; S\u00e9lectionnez Dupliquer -&gt; Confirmez la duplication.</p> <p>Modifiez ensuite uniquement les param\u00e8tres h\u00f4te et services propres au nouveau site Web.</p>"},{"location":"informatique/centreon---vboxdeb12-56/#-test-de-la-cde-http-server","title":"- Test de la Cde HTTP Server","text":"<p>-- Test de la Cde HTTP Server -- Testez par curiosit\u00e9, depuis la VM centreon, la Cde HTTP Server pour le site google.fr :</p> <pre><code>sudo /usr/lib/centreon/plugins/centreon_protocol_http.pl \\\n    --plugin=apps::protocols::http::plugin \\\n    --mode=response \\\n    --hostname=google.fr \\\n    --proto='https' \\\n    --port='443' \\\n    --urlpath='/' \\\n    --warning=' ' \\\n    --critical=' '\n</code></pre> <p></p> <p>  Plut\u00f4t facile. La partie 6 vous attend pour superviser une base de donn\u00e9es MySQL et cr\u00e9er une vue personnalis\u00e9e Centreon.</p> <p>Partie 6</p>"},{"location":"informatique/centreon---vboxdeb12-66/","title":"Centreon - VBox/Deb12 6/6","text":""},{"location":"informatique/centreon---vboxdeb12-66/#centreon-it-100-partie-6","title":"Centreon IT 100 - Partie 6","text":"<p>Le m\u00e9mento concerne Centreon 23.10 sous Debian \u2265 11.11 et 24.04 sous Debian \u2265 12.7.</p>"},{"location":"informatique/centreon---vboxdeb12-66/#supervision-dune-bdd-mysql","title":"Supervision d'une Bdd MySQL","text":"<p>L'exemple ci-dessous concerne une Bdd MySQL/MariaDB situ\u00e9e sur un serveur Debian :</p> <ul> <li>Nom de la Bdd = cmswordpress </li> <li>IP du collecteur Centreon = 192.168.8.32</li> </ul> <p>La supervision n\u00e9cessite d'ajouter au sein de la Bdd cmswordpress un utilisateur MySQL d\u00e9di\u00e9 au collecteur de Centreon IT-100.</p> <p>La partie ci-dessous s'inspire de la docs.centreon.com.</p>"},{"location":"informatique/centreon---vboxdeb12-66/#-utilisateur-dedie-a-centreon","title":"- Utilisateur d\u00e9di\u00e9 \u00e0 Centreon","text":"<p>Connectez-vous sur le serveur supportant la Bdd :</p> <pre><code>sudo mysql -u root -p\n[sudo] Mot de passe de ... :  \nEnter password : Votre MDP root pour MySQL/MariaDB \nMariaDB [(none)]&gt;\n</code></pre> <p>Listez les Bdd existantes :</p> <pre><code>MariaDB [(none)]&gt; SHOW DATABASES;\n</code></pre> <p>La liste des Bdd pr\u00e9sentes sur le serveur s'affiche. S\u00e9lectionnez celle portant le nom cmswordpress :</p> <pre><code>MariaDB [(none)]&gt; USE cmswordpress;   \nDatabase changed\n\nMariaDB [cmswordpress]&gt;\n</code></pre> <p>et cr\u00e9ez l'utilisateur MySQL d\u00e9di\u00e9 Centreon comme suit :</p> <pre><code>MariaDB [cmswordpress]&gt; CREATE USER 'centreon'@'192.168.8.32' IDENTIFIED BY 'votre-mdp';  \nQuery OK, 0 rows affected (0,006 sec)\n\nMariaDB [cmswordpress]&gt;\n</code></pre> <p>Affectez lui ses droits (privil\u00e8ges) :</p> <pre><code>MariaDB [cmswordpress]&gt; GRANT SELECT ON cmswordpress.* TO 'centreon'@'192.168.8.32';\nQuery OK, 0 rows affected (0,004 sec)\n\nMariaDB [cmswordpress]&gt;\n</code></pre> <p>Terminez en fermant la connexion MySQL :</p> <pre><code>MariaDB [cmswordpress]&gt; quit\nBye\n</code></pre> <p>Ci-apr\u00e8s, l'utilisateur MySQL de nom centreon vu par un gestionnaire de Bdd tel phpMyAdmin :</p> <p> </p> phpMyAdmin : Edition de l'utilisateur centreon"},{"location":"informatique/centreon---vboxdeb12-66/#-outils-mysql-de-centreon","title":"- Outils MySQL de Centreon","text":"<p>Pour surveiller une Bdd, proc\u00e9dez comme suit : -- C\u00f4t\u00e9 VM centreon -- -&gt; Installez ce paquet Debian si manquant</p> <pre><code>sudo apt install centreon-plugin-applications-databases-mysql\n</code></pre> <p>-- C\u00f4t\u00e9 Plateforme Centreon IT-100 -- -&gt; Menu Configuration -&gt; Monitoring Connector Manager -&gt; Champ Mots cl\u00e9s -&gt; Entrez mysql -&gt; Bouton Recherche</p> <p>-&gt; S\u00e9lectionnez le connecteur titr\u00e9 MySQL/MariaDB -&gt; Cliquez sur son ic\u00f4ne + pour lancer son installation</p> <p>Celui-ci appara\u00eet install\u00e9 apr\u00e8s quelques secondes.</p>"},{"location":"informatique/centreon---vboxdeb12-66/#-configuration-de-lhote-bdd","title":"- Configuration de l'h\u00f4te Bdd","text":"<p>Cr\u00e9ez un nouvel h\u00f4te Bdd comme suit : -&gt; Menu Configuration -&gt; H\u00f4tes -&gt; H\u00f4tes -&gt; Bouton Ajouter</p> <p>Remplissez l'onglet Configuration de l'h\u00f4te :</p> <p> </p> Centreon : Configuration Bdd cmswordpress <p>Ensuite, comme pour l'h\u00f4te Web de Centreon IT 100 - Partie 5, d\u00e9sactivez la notification par e-mail depuis l'onglet Notification.</p> <p>Concernant les 8 services associ\u00e9s \u00e0 l'h\u00f4te Bdd, r\u00e9f\u00e9rez-vous de nouveau \u00e0 la Partie 5 pour configurer la notification par e-mail \u00e0 Non sauf pour le service Ping.</p>"},{"location":"informatique/centreon---vboxdeb12-66/#-activation-de-lhote-bdd","title":"- Activation de l'h\u00f4te Bdd","text":"<p>Pour activer l'h\u00f4te Bdd, d\u00e9ployez la configuration : -&gt; Menu Configuration -&gt; Collecteurs -&gt; Collecteurs -&gt; Cochez le collecteur Central -&gt; Bouton Exporter la configuration</p> <p>Zone Actions : -&gt; Cochez D\u00e9placer les fichiers g\u00e9n\u00e9r\u00e9s -&gt; Cochez Red\u00e9marrer l'ordonnanceur -&gt; Bouton Exporter</p> <p>Retour normal :</p> <p> </p> Centreon : Configuration de l'h\u00f4te Bdd d\u00e9ploy\u00e9e"},{"location":"informatique/centreon---vboxdeb12-66/#-statistiques-de-la-bdd","title":"- Statistiques de la Bdd","text":"<p>Exemple de graphique issu du service Queries :</p> <p> </p> Centreon : H\u00f4te Bdd, service Queries (Requ\u00eates)"},{"location":"informatique/centreon---vboxdeb12-66/#vue-personnalisee-liee-a-la-bdd","title":"Vue personnalis\u00e9e li\u00e9e \u00e0 la Bdd","text":"<p>Les widgets fournis avec Centreon permettent de cr\u00e9er des vues graphiques personnalis\u00e9es.</p> <p>Pour cr\u00e9ez une premi\u00e8re vue, proc\u00e9dez ainsi : -&gt; Menu Accueil -&gt; Vues personnalis\u00e9es -&gt; Cliquez sur l'ic\u00f4ne d'\u00e9dition situ\u00e9e en haut et \u00e0 droite Une barre de boutons s'affiche.</p> <p>-&gt; Bouton Ajouter une vue Une fen\u00eatre Cr\u00e9er une vue s'ouvre.</p> <p>-&gt; Champ Nom -&gt; Entrez Bdd cmswordpress -&gt; Cochez une mise en page sur 2 Colonnes -&gt; Cochez Public pour partager la vue -&gt; Bouton Soumettre  </p> <p>La vue titr\u00e9e en onglet cmswordpress s'ouvre vide.</p>"},{"location":"informatique/centreon---vboxdeb12-66/#-widget-service-queries","title":"- Widget Service Queries","text":"<p>-&gt; Bouton Ajouter un widget Une fen\u00eatre Ajouter widget s'ouvre.</p> <p>-&gt; Champ Titre -&gt; Entrez Service Queries -&gt; Champ Widget -&gt; S\u00e9lectionnez Graph Monitoring -&gt; Bouton Soumettre Le widget titr\u00e9 Service Queries s'ouvre.</p> <p>-&gt; Cliquez sur l'ic\u00f4ne cl\u00e9 \u00e0 molette du widget Une fen\u00eatre Widget ... [graph-monitoring] s'ouvre.</p> <p>-&gt; Champ Service -&gt; a) S\u00e9lectionnez l'h\u00f4te Debian_Bdd_cmswordpress -&gt; b) S\u00e9lectionnez le service Queries -&gt; Champ Graph period -&gt; S\u00e9lectionnez Last 7 days -&gt; Bouton Apply</p> <p>Le graphique du widget s'affiche sur la page.</p>"},{"location":"informatique/centreon---vboxdeb12-66/#-widgets-supplementaires","title":"- Widgets suppl\u00e9mentaires","text":"<p>Ajoutez maintenant dans la vue personnalis\u00e9e de nom Bdd cmswordpress, ceci en vous aidant de la proc\u00e9dure ci-dessus, les widgets d\u00e9di\u00e9s aux services suivants :</p> <ul> <li>Myisam-Keycache (Cache du moteur MyISAM) </li> <li>Database-Size (Taille de la Bdd cmswordpress) </li> <li>Open-Files (Nombre de fichiers ouverts)</li> </ul> <p>R\u00e9sultat :</p> <p> </p> Centreon : Vue personnalis\u00e9e d'une Bdd MySQL <p></p> <p>  Voil\u00e0, la pr\u00e9sentation de Centreon IT-100 s'ach\u00e8ve ici. Vous devriez \u00e0 pr\u00e9sent pouvoir d\u00e9couvrir par vous m\u00eame toutes les possibilit\u00e9s du produit.</p>"},{"location":"informatique/debian---exim4-et-smarthost/","title":"Debian - Exim4 et Smarthost","text":""},{"location":"informatique/debian---exim4-et-smarthost/#exim4-smarthost","title":"Exim4 - Smarthost","text":"<p>Janvier 2023.</p>"},{"location":"informatique/debian---exim4-et-smarthost/#prealable","title":"Pr\u00e9alable","text":"<p>Debian 11 et 12 : Paquets exim4-base, exim4-config, exim4-daemon-light, bsd-mailx  install\u00e9s.</p> <p>La configuration ci-dessous permet l'envoi de courriers au travers du serveur SMTP de Orange.</p>"},{"location":"informatique/debian---exim4-et-smarthost/#configuration-de-exim4","title":"Configuration de Exim4","text":"<p>Pour configurer Exim, il faut commencer par lancer la Cde suivante :</p> <pre><code>sudo dpkg-reconfigure exim4-config\n</code></pre> <p>et r\u00e9pondre aux questions comme suit :</p> <pre><code>Choississez \u00ab\u00a0Envoi par relais (\u00ab smarthost \u00bb) \u2014 pas de courrier local\u00a0\u00bb\n\u00ab\u00a0Nom de courrier du syst\u00e8me\u00a0\u00bb : saisir \u00ab\u00a0le nom d'h\u00f4te Debian \u00bb\n\u00ab\u00a0Liste d\u2019adresses IP o\u00f9 Exim sera en attente de connexions SMTP\u00a0entrantes\u00a0\u00bb : saisir \u00ab\u00a0127.0.0.1 \u00bb\n\u00ab\u00a0Autres destinations dont le courrier doit \u00eatre accept\u00e9\u00a0\u00bb : laisser vide\n\u00ab\u00a0Nom de domaine visible pour les utilisateurs locaux\u00a0\u00bb :\u00a0saisir \u00ab\u00a0localhost\u00a0\u00bb\n\u00ab\u00a0Nom r\u00e9seau ou adresse IP du syst\u00e8me \u00ab smarthost \u00bb\u00a0\u00bb : saisir \u00ab\u00a0smtp.orange.fr::587\u00a0\u00bb\n\u00ab\u00a0Faut-il cacher le nom local de courrier dans les courriers sortants ?\u00a0\u00bb : choisir \u00ab\u00a0Non\u00a0\u00bb\n\u00ab\u00a0Faut-il minimiser les requ\u00eates DNS (connexions \u00e0 la demande) ?\u00a0\u00bb : choisir \u00ab\u00a0Non\u00a0\u00bb\n\u00ab\u00a0Faut-il s\u00e9parer la configuration dans plusieurs fichiers ?\u00a0\u00bb : choisir \u00ab\u00a0Oui\u00a0\u00bb\n\u00ab Destinataire des courriers de \u00ab\u00a0root\u00a0\u00bb et \u00ab\u00a0postmaster\u00a0\u00bb\u00a0: \u00ab choisir l'utilisateur principal de Debian \u00bb\n</code></pre> <p>Le fichier modifi\u00e9 update-exim4.conf.conf se situe dans /etc/exim4/.</p> <p>Le contenu configur\u00e9 doit montrer ceci :</p> <pre><code>dc_eximconfig_configtype='satellite'\ndc_other_hostnames=''\ndc_local_interfaces='127.0.0.1'\ndc_readhost='localhost'\ndc_relay_domains=''\ndc_minimaldns='false'\ndc_relay_nets=''\ndc_smarthost='smtp.orange.fr::587'\nCFILEMODE='644'\ndc_use_split_config='false'\ndc_hide_mailname='true'\ndc_mailname_in_oh='true'\ndc_localdelivery='mail_spool'\n</code></pre> <p>\u00c9diter ensuite le fichier /etc/exim4/passwd.client et ajouter cette ligne :</p> <pre><code>smtp.orange.fr:&lt;nom-du-compte&gt;@orange.fr:mot-de-passe\n</code></pre> <p>\u00c9diter \u00e9galement le fichier /etc/email-addresses et ajoutez ces lignes :</p> <pre><code>root: &lt;nom-du-compte&gt;@orange.fr\nUSER: &lt;nom-du-compte&gt;@orange.fr\nUSER@localhost: &lt;nom-du-compte&gt;@orange.fr\nUSER@HOSTNAME: &lt;nom-du-compte&gt;@orange.fr\nUSER@HOSTNAME.localdomain: &lt;nom-du-compte&gt;@orange.fr\n</code></pre> <p>Remplacer USER et HOSTNAME par le nom de l'utilisateur Debian et le nom d'h\u00f4te Debian du PC. L'adresse e-mail doit \u00eatre celle d'un compte connu d'Orange, pas celle du destinataire.</p> <p>\u00c9diter le fichier /etc/aliases et ajouter ces lignes :</p> <pre><code>root: &lt;nom de l'utilisateur Debian&gt;\n&lt;nom de l'utilisateur Debian&gt;: &lt;nom-du-compte&gt;@gmail.com\n</code></pre> <p>L'adresse e-mail doit \u00eatre celle du destinataire, pas celle connue de Orange.</p> <p>Enregistrer la modification du fichier aliases :</p> <pre><code>newaliases\n</code></pre>"},{"location":"informatique/debian---exim4-et-smarthost/#configuration-tls-starttls","title":"Configuration TLS (STARTTLS)","text":"<p>Pour acc\u00e9der au smarthost d'Orange, cr\u00e9er le fichier /etc/exim4/exim4.conf.localmacros :</p> <pre><code>sudo nano /etc/exim4/exim4.conf.localmacros\n</code></pre> <p>et entrer le contenu suivant :</p> <pre><code>MAIN_TLS_ENABLE = 1\nREMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS = *\nTLS_ON_CONNECT_PORTS = 587\nREMOTE_SMTP_SMARTHOST_TLS_VERIFY_HOSTS = !*\n</code></pre> <p>Ajouter ce contenu dans /etc/exim4/exim4.conf.template juste apr\u00e8s .ifdef REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS ... .endif :</p> <pre><code>.ifdef REQUIRE_PROTOCOL\n    protocol = REQUIRE_PROTOCOL\n.endif\n</code></pre> <p>Puis le contenu suivant juste apr\u00e8s .ifdef MAIN_TLS_ENABLE :</p> <pre><code>.ifdef TLS_ON_CONNECT_PORTS\n    tls_on_connect_ports = TLS_ON_CONNECT_PORTS\n.endif\n</code></pre>"},{"location":"informatique/debian---exim4-et-smarthost/#configuration-utilisateur-sasl","title":"Configuration utilisateur (SASL)","text":"<p>Pour l'authentification utilisateur SASL exig\u00e9e par Orange, installer le paquet sasl2-bin :</p> <pre><code>sudo apt install sasl2-bin\n</code></pre> <p>D\u00e9marrer le d\u00e9mon saslauthd et l'activer au boot :</p> <pre><code>sudo systemctl start saslauthd  \nsudo systemctl status saslauthd  \nsudo systemctl enable saslauthd\n</code></pre> <p>Editer ensuite le fichier /etc/exim4/exim4.conf.template et d\u00e9commenter les lignes suivantes :</p> <pre><code>plain_saslauthd_server:\n    driver = plaintext\n    public_name = PLAIN\n    server_condition = ${if saslauthd{{$auth2}{$auth3}}{1}{0}}\n    server_set_id = $auth2\n    server_prompts = :\n    .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS\n    server_advertise_condition = ${if eq{$tls_cipher}{}{}{*}}\n    .endif\n</code></pre> <p>Ajouter l'utilisateur Debian-exim au groupe sasl :</p> <pre><code>sudo adduser Debian-exim sasl\n</code></pre>"},{"location":"informatique/debian---exim4-et-smarthost/#mise-a-jour-de-la-configuration","title":"Mise \u00e0 jour de la configuration","text":"<p>Pour finir, mettre \u00e0 jour la configuration :</p> <pre><code>sudo update-exim4.conf\nsudo systemctl restart exim4\nsudo systemctl status exim4\n</code></pre> <p>La Cde update-exim4.conf met \u00e0 jour le fichier /var/lib/exim4/config.autogenerated</p>"},{"location":"informatique/debian---exim4-et-smarthost/#cas-distribution-kaisen-debian","title":"Cas distribution Kaisen Debian","text":"<p>Editer le fichier automysqlbackup :</p> <pre><code>sudo nano /etc/default/automysqlbackup\n</code></pre> <p>et modifier cette ligne comme suit :</p> <pre><code>MAILADDR=\"&lt;nom-du-compte&gt;@gmail.com\"\n</code></pre> <p>Puis, \u00e9diter le fichier autopostgresqlbackup :</p> <pre><code>sudo nano /etc/default/autopostgresqlbackup\n</code></pre> <p>et modifier cette ligne comme suit :</p> <pre><code>MAILADDR=\"\"\n</code></pre> <p>Supprimer ce fichier pour \u00e9viter un warning g\u00e9n\u00e9r\u00e9 par le script cron chkrootkit :</p> <pre><code>/etc/chkrootkit.conf\n</code></pre> <p>Envoyer les mails \u00e9mis par toutes les t\u00e2ches cron.daily sur <code>nom-du-compte@gmail.com</code> au lieu de root comme suit :</p> <pre><code>sudo crontab -e\n</code></pre> <p>Ajoutez :</p> <pre><code>MAILTO=&lt;nom-du-compte&gt;@gmail.com\n</code></pre> <p>ou</p> <pre><code>sudo nano /etc/crontab\n</code></pre> <p>Ajouter sous la ligne PATH=...  :</p> <pre><code>MAILTO=\"&lt;nom-du-compte&gt;@gmail.com\"\n</code></pre> <p>et red\u00e9marrer le service cron :</p> <pre><code>sudo systemctl restart cron\n</code></pre> <p>Editer la t\u00e2che cron zz-backup2l :</p> <pre><code>sudo nano /etc/cron.daily/zz-backup2l\n</code></pre> <p>et commenter la Cde cron suivante :</p> <pre><code># ! command -v backup2l &gt; /dev/null || nice -n 19 backup2l -b\n</code></pre> <p>Enfin, \u00e9diter le fichier /etc/rsbackup/defaults :</p> <pre><code>sudo nano /etc/rsbackup/defaults\n</code></pre> <p>et modifier cette ligne comme suit :</p> <pre><code>email=&lt;nom-du-compte&gt;@gmail.com\n</code></pre>"},{"location":"informatique/debian---exim4-et-smarthost/#verification-du-fonctionnement","title":"V\u00e9rification du fonctionnement","text":"<p>Tester l\u2019envoi d\u2019un e-mail :</p> <pre><code>sudo mail &lt;nom-du-compte&gt;@gmail.com\n</code></pre> <p>en proc\u00e9dant comme suit :</p> <pre><code> Subject: -&gt; Saisir le sujet puis Touche \u00ab\u00a0Entr\u00e9e\u00a0\u00bb\n Saisir le corps du mail puis Touche \u00ab\u00a0Entr\u00e9e \u00bb suivi de Touches \u00ab\u00a0Ctrl+D\u00a0\u00bb\n CC: -&gt; Touche \u00ab\u00a0Entr\u00e9e\u00a0\u00bb\n</code></pre> <p>L\u2019e-mail est envoy\u00e9.</p> <p>La Cde mail utilise le paquet bsd-mailx.</p> <p>V\u00e9rifier dans le fichier /var/log/exim4/mainlog que tout s'est bien pass\u00e9.</p>"},{"location":"informatique/debian---exim4-et-smarthost/#cdes-utiles","title":"Cdes utiles","text":"<p>Lister les messages en file d'attente :</p> <pre><code>sudo exim -bp\n</code></pre> <p>Vider un message de la file d'attente :</p> <pre><code>sudo exim -Mrm &lt;id du message&gt;\n</code></pre> <p>Fin.</p>"},{"location":"informatique/debian---glances/","title":"Debian - Glances","text":""},{"location":"informatique/debian---glances/#supervision-avec-glances","title":"Supervision avec Glances","text":"<p>Glances peut afficher en temps r\u00e9el le % d'utilisation des CPU et GPU, le % d'utilisation des m\u00e9moires syst\u00e8me et GPU ainsi que les temp\u00e9ratures des diff\u00e9rents p\u00e9riph\u00e9riques, le tout sur une page accessible depuis un navigateur Web.</p> <p>Avant de l'installer, v\u00e9rifier la pr\u00e9sence sur l'h\u00f4te Debian des paquets psutils et lm-sensors, \u00e0 d\u00e9faut les ajouter.</p> <p>Puis, mettre \u00e0 jour le syst\u00e8me Debian :</p> <pre><code>sudo apt update\nsudo apt upgrade\n</code></pre>"},{"location":"informatique/debian---glances/#environnement-python","title":"Environnement Python","text":"<p>Installer les paquets suivants :</p> <pre><code>sudo apt install python3-pip python3-dev\nsudo apt install python3-full\n</code></pre> <p>Le paquet python3-venv sera ajout\u00e9 comme d\u00e9pendance.</p> <p>Cr\u00e9er ensuite un dossier pour l'environnement Python :</p> <pre><code>cd /home/user-x/\nmkdir -p Documents/glances/python\n</code></pre> <p>et g\u00e9n\u00e9rer l'environnement dans celui-ci :</p> <pre><code>cd Documents/glances/\npython3 -m venv python\n</code></pre>"},{"location":"informatique/debian---glances/#installation-de-glances","title":"Installation de Glances","text":"<p>Installer Glances comme ceci :</p> <pre><code>cd python\nsource ./bin/activate\n</code></pre> <p>Le prompt du terminal change :</p> <pre><code>(python).../python$ python3 -m pip install --upgrade pip\n(python).../python$ pip3 install --upgrade glances[web]\n(python).../python$ pip3 install netifaces\n</code></pre> <p>V\u00e9rifier la version de Glances et activer son serveur Web :</p> <pre><code>(python).../python$ glances -V\n(python).../python$ glances -w\n</code></pre> <p>Ouvrir si n\u00e9cessaire le port 61208 sur Debian et tester l'URL <code>http://localhost:61208</code>.</p>"},{"location":"informatique/debian---glances/#service-systemd","title":"Service systemd","text":"<p>Cr\u00e9er un fichier de service systemd afin de d\u00e9marrer le serveur Web de Glances au boot du syst\u00e8me Debian :</p> <pre><code>sudo nano /etc/systemd/system/glances.service\n</code></pre> <p>et entrer le contenu suivant :</p> <pre><code>[Unit]\nDescription=Glances - An eye on your system\nAfter=network.target\n\n[Service]\nType=simple\nUser=user-x\nWorkingDirectory=/home/user-x/Documents/glances/python/\nExecStart=/home/user-x/Documents/glances/python/bin/python -m glances -w\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>Recharger la configuration systemd et red\u00e9marrer glances :</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl restart glances\nsudo systemctl status glances\nsudo systemctl enable glances\n</code></pre>"},{"location":"informatique/debian---glances/#fichier-glancesconf","title":"Fichier glances.conf","text":"<p>Un fichier de configuration glances.conf se trouve dans : /home/user-x/Documents/glances/python/share/doc/glances/</p> <p>L'utilit\u00e9 de la configuration ci-dessous est \u00e0 contr\u00f4ler.</p> <pre><code>sudo mkdir /etc/glances\ncd /home/user-x/Documents/glances/python/share/doc/glances/\nsudo cp glances.conf /etc/glances/\n</code></pre> <p>Editer le fichier glances.conf :</p> <pre><code>sudo nano /etc/glances/glances.conf\n</code></pre> <p>et modifier la ligne suivante :</p> <pre><code> # Available stats are: cpu,mem,load,swap\n list=cpu,mem,load\n</code></pre> <p>comme suit :</p> <pre><code> # Available stats are: cpu,mem,load,swap\n list=cpu,mem,load,swap\n</code></pre> <p>Red\u00e9marrer le service glances et observer le r\u00e9sulat dans la page Web de Glances.</p> <pre><code>sudo systemctl restart glances\n</code></pre>"},{"location":"informatique/debian---glances/#tableau-de-bord","title":"Tableau de bord","text":"<p>Quelques remarques concernant le tableau de bord affich\u00e9 :</p> <p>- Composite, Sensor 1,2 = Temp\u00e9ratures du dique nvme-pci - Tctl = Temp\u00e9rature du CPU Ryzen (k10temp-pci-00c3) - edge = temperature du GPU</p>"},{"location":"informatique/debian---outil-hardinfo/","title":"Debian - Outil Hardinfo","text":""},{"location":"informatique/debian---outil-hardinfo/#installation","title":"Installation","text":"<pre><code>sudo apt install hardinfo -2c-tools\nsudo modeprobe eeprom\n</code></pre> <p>Les informations sur le mat\u00e9riel (Ex: Barettes m\u00e9moire) seront ainsi affich\u00e9es.</p> <p>Fin.</p>"},{"location":"informatique/debian---serveur-redis/","title":"Debian - Serveur Redis","text":""},{"location":"informatique/debian---serveur-redis/#installation-de-redis","title":"Installation de Redis","text":"<p>Pr\u00e9ambule : Redis est un syst\u00e8me de mise en cache qui permet d'importants gains de performance en diminuant le temps de chargement d'une page web.</p> <p>Memcached est un \u00e9quivalent de Redis.</p> <p>Installer le serveur :</p> <pre><code>sudo apt install redis-server phpx.y-redis\n</code></pre> <p>V\u00e9rifier son statut :</p> <pre><code>sudo systemctl status redis-server\n</code></pre> <p>V\u00e9rifier les ports utilis\u00e9s par celui-ci :</p> <pre><code>sudo ss -antpl | grep redis\n</code></pre> <p>Retour :</p> <pre><code>LISTEN  0  511   127.0.0.1:6379  0.0.0.0:*  users:((\"redis-server\",pid=1872,fd=6))\n\nLISTEN  0  511       [::1]:6379     [::]:*  users:((\"redis-server\",pid=1872,fd=7))\n</code></pre> <p>Editer ensuite son fichier de configuration :</p> <pre><code>sudo nano /etc/redis/redis.conf\n</code></pre> <p>et v\u00e9rifier ou modifier ces 3 lignes :</p> <pre><code>bind 127.0.0.1 -::1\nmaxmemory 256mb \nmaxmemory-policy allkeys-lru\n</code></pre> <p>Si modification, red\u00e9marrer le serveur :</p> <pre><code>sudo systemctl restart redis-server\n</code></pre> <p>Redis sera ainsi utilis\u00e9 en tant que cache.</p> <p>Pour finir, ouvrir la console Redis :</p> <pre><code>redis-cli\n</code></pre> <p>et lancer la Cde ping.</p> <p>Retour normal :</p> <pre><code>PONG\n</code></pre> <p>Utiliser la Cde exit pour quitter la console Redis.</p> <p>Commandes \u00e0 connaitre :</p> <pre><code>redis-cli monitor (pour oberver le trafic)\nredis-cli flushall (pour vider le cache)\n</code></pre> <p>Fin.</p>"},{"location":"informatique/wake-on-lan/","title":"Wake On LAN","text":""},{"location":"informatique/wake-on-lan/#reveilarret-a-distance","title":"R\u00e9veil/Arr\u00eat \u00e0 distance","text":""},{"location":"informatique/wake-on-lan/#debian","title":"Debian","text":"<p>Au pr\u00e9alable, autoriser le Wake On LAN dans le BIOS du PC.</p> <p>Installer ensuite le paquet ethtool :</p> <pre><code>sudo apt install ethtool\n</code></pre> <p>Puis, trouver le nom de la carte r\u00e9seau cible comme suit :</p> <pre><code>sudo ip a\n</code></pre> <p>Le retour montrera eth0, enp2s0, etc...  </p> <p>Si enp2s0, v\u00e9rifier l'activation ou non du Wake On LAN :</p> <pre><code>sudo ethtool enp2s0 | grep \"Wake-on\"\n</code></pre> <p>Exemple de retour :</p> <pre><code>Supports Wake-on: pumbg\nWake-on: d\n</code></pre> <p>Le retour Wake-on: d signifie que la carte r\u00e9seau prend en charge le Wake On LAN mais que celui-ci est d\u00e9sactiv\u00e9.</p> <p>Pour l'activer, cr\u00e9er un fichier de service de nom wol :</p> <pre><code>sudo nano /etc/systemd/system/wol.service\n</code></pre> <p>et entrer ce contenu :</p> <pre><code>[Unit]\nDescription=Activation du Wake On LAN\n\n[Service]\nType=oneshot\nExecStart=/sbin/ethtool -s enp2s0 wol g\n\n[Install]\nWantedBy=basic.target\n</code></pre> <p>Puis, d\u00e9marrer le service :</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl start wol\n</code></pre> <p>V\u00e9rifier le r\u00e9sultat comme suit :</p> <pre><code>sudo ethtool enp2s0 | grep \"Wake-on\"\n</code></pre> <p>Le retour doit montrer ceci :</p> <pre><code>Supports Wake-on: pumbg\nWake-on: g\n</code></pre> <p>Le Wake-on: d initial est remplac\u00e9 par Wake-on: g.</p> <p>Finir en activant le d\u00e9marrage automatique du service :</p> <pre><code>sudo systemctl enable wol\n</code></pre>"},{"location":"informatique/wake-on-lan/#windows-11","title":"Windows 11","text":"<p>Au pr\u00e9alable, autoriser le Wake On LAN dans le BIOS du PC.</p> <p>Ensuite activer le Wake On LAN comme ceci : a) Clic sur le bouton D\u00e9marrer de Windows  </p> <p>Rechercher Gestionnaire de p\u00e9riph\u00e9riques -&gt; Ouvrir -&gt; Cartes r\u00e9seau  </p> <p>S\u00e9lectionner la bonne carte r\u00e9seau, puis : -&gt; Propri\u00e9t\u00e9s -&gt; Gestion de l'alimentation</p> <p>Cocher les 3 autorisations concernant le Wake On LAN.</p> <p>b) Clic sur le bouton D\u00e9marrer de Windows</p> <p>Rechercher Services -&gt; Ouvrir</p> <p>Mettre le service Registre \u00e0 distance sur d\u00e9marrage automatique.</p> <p>c) Clic droit sur le bouton D\u00e9marrer de Windows -&gt; Ex\u00e9cuter -&gt; Entrer regedit -&gt; OK</p> <p>Aller ensuite dans le dossier : HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Windows/CurrentVersion/Policies/System</p> <p>Puis, cr\u00e9er dans celui-ci une cl\u00e9 DWORD appel\u00e9e LocalAccountTokenFilterPolicy et lui attribuer la valeur 1.</p>"},{"location":"informatique/wake-on-lan/#outil-upsnap","title":"Outil UPSNAP","text":"<p>- Exemple de Cde d'arr\u00eat \u00e0 utiliser pour Debian 12 :</p> <pre><code>sshpass -p \"mot-de-passe\" ssh -o \"StrictHostKeyChecking=no\" -p numero-de-port user@192.168.x.y \"systemctl poweroff\"\n</code></pre> <p>Nota</p> <p>La Cde ci-dessus ne fonctionne pas sous Debian 13.</p> <p>-- Solution 1 --</p> <p>Rendre la Cde sshpass active en cr\u00e9ant sur le PC cible la r\u00e8gle PolKit suivante :</p> <pre><code>sudo nano /etc/polkit-1/rules.d/50-org.freedesktop.login1.poweroff.rules\n</code></pre> <p>incluant le contenu ci-dessous :</p> <pre><code>polkit.addRule(function(action, subject) {\n    if (action.id == \"org.freedesktop.login1.power-off\" &amp;&amp;\n        subject.user == \"nom-utilisateur-normal\") {\n        return polkit.Result.YES;\n    }\n});\n</code></pre> <p>Red\u00e9marrer le service polkit :</p> <pre><code>sudo systemctl restart polkit\n</code></pre> <p>La Cde sshpass doit maintenant fonctionner normalement.</p> <p>-- Solution 2 --</p> <p>Ne pas utiliser la Cde sshpass mais cr\u00e9er sur le PC cible une t\u00e2che cron qui sera ex\u00e9cut\u00e9e en tant que root :</p> <pre><code>su root\ncrontab -e\n</code></pre> <p>Entrer le contenu suivant dans la crontab :</p> <pre><code># Arr\u00eat du serveur tous les jours \u00e0 21H10\n10 21 * * * /usr/bin/sudo -n /usr/bin/systemctl poweroff\n</code></pre> <p>Debian 13 s'arr\u00eatera automatiquement \u00e0 21H10.</p> <p>- Exemple de Cde d'arr\u00eat \u00e0 utiliser pour Windows :</p> <pre><code>net rpc shutdown -I 192.168.x.y -U \"user%mot-de-passe\"\n</code></pre> <p>Si besoin, installer le paquet samba-common qui permet l'envoi de la Cde de shutdown vers un PC Windows :</p> <pre><code>apk update\napk -e info samba-common\napk add samba-common\napk -e info samba-common\n</code></pre> <p>Retour de la derni\u00e8re Cde :</p> <pre><code>samba-common\n</code></pre>"},{"location":"informatique/wake-on-lan/#outils-prtg-et-uptime-kuma","title":"Outils PRTG et Uptime Kuma","text":"<p>Penser \u00e0 g\u00e9rer une plage horaire afin de ne pas surveiller des appareils arr\u00eat\u00e9s.</p>"},{"location":"informatique/wake-on-lan/#prtg-plannings","title":"PRTG (Plannings)","text":"<p>Voir menu Configuration -&gt; Param\u00e8tres de compte -&gt; Onglet Plannings</p>"},{"location":"informatique/wake-on-lan/#uptime-kuma-maintenance","title":"Uptime Kuma (Maintenance)","text":"<p>Voir ic\u00f4ne utilisateur connect\u00e9 -&gt; Maintenance</p> <p>Fin.</p>"},{"location":"informatique/eve-ng---labo-virtuel/","title":"EVE-NG - Labo virtuel","text":""},{"location":"informatique/eve-ng---labo-virtuel/#maquette-avec-des-virtual-pc","title":"Maquette avec des Virtual PC","text":""},{"location":"informatique/eve-ng---labo-virtuel/#creation-du-labo","title":"Cr\u00e9ation du labo","text":"<p>Ce labo tr\u00e8s simple a pour but de faire d\u00e9couvrir les bases de l'exploitation d'EVE-NG.</p> <p>Acc\u00e9dez \u00e0 l'interface web d'EVE-NG et connectez-vous.</p> <p>Une fois sur la page d'accueil, cliquez sur l'ic\u00f4ne en forme de page (Add new lab) et donnez un nom au labo tel Lab-Loup :</p> <p> </p> EVE-NG : Cr\u00e9ation du Labo Lab-Loup <p> </p> EVE-NG : Param\u00e8tres du labo Lab-Loup <p>Cliquez sur le bouton Save, une zone de travail vierge d\u00e9di\u00e9e au nouveau labo s'affichera.</p> <p>De base, il est seulement possible d'ajouter des Virtual PC.</p> <p>Cliquez sur Add an object, s\u00e9lectionnez Node et cherchez Virtual PC dans la liste propos\u00e9e.</p> <p>Entrez dans le champ Number of nodes to add la valeur 6 et cliquez sur le bouton Save.</p> <p>Les Virtual PC (VPCS) cr\u00e9\u00e9s apparaitront group\u00e9s en haut et \u00e0 gauche de la zone de travail.</p> <p>Les d\u00e9placer comme sur l'image ci-dessous :</p> <p> </p> EVE-NG : Cr\u00e9ation de 6 Virtual PC <p>Un clic droit sur chacun des Virtual PC permet d'acc\u00e9der \u00e0 un menu contextuel, s\u00e9lectionner Edit et renommer les Virtual PC comme suit :</p> <p> </p> EVE-NG : Virtual PC renomm\u00e9s <p>D\u00e9marrez un Virtual PC en s\u00e9lectionnant Start depuis son menu contextuel ou en cliquant directement sur son ic\u00f4ne.</p> <p>Une fois celui-ci d\u00e9marr\u00e9, son ic\u00f4ne gris\u00e9e deviendra bleue.</p>"},{"location":"informatique/eve-ng---labo-virtuel/#connexion-sur-un-virtual-pc","title":"Connexion sur un Virtual PC","text":"<p>Nota</p> <p>Selon l'OS utilis\u00e9, la suite implique d'installer le pack client appropri\u00e9, t\u00e9l\u00e9chargeable sur le site d'EVE-NG .</p> <p>Le pack pour le syst\u00e8me Windows cr\u00e9era un dossier EVE-NG dans C:\\Program Files et installera Wireshark et UltraVNC.</p> <p>Putty sera install\u00e9 dans le dossier EVE-NG.</p> <p>Si une version plus r\u00e9cente de Wireshark est d\u00e9j\u00e0 install\u00e9e dans son dossier par d\u00e9faut, il n'est pas n\u00e9cessaire d'installer la version fournie par le pack client (d\u00e9cochez l'option).</p> <p>Il est possible d'utiliser SuperPutty en compl\u00e9ment de Putty en s'aidant de ce document, l'avantage r\u00e9sidant dans l'utilisation d'une seule fen\u00eatre et d'un onglet par connexion.</p> <p>Le curseur de la souris positionn\u00e9 sur l'ic\u00f4ne bleue d'un Virtual PC fera appara\u00eetre son adresse telnet en bas et \u00e0 gauche de la zone de travail.</p> <p>Un clic sur l'ic\u00f4ne bleue g\u00e9n\u00e8rera une fen\u00eatre, cliquez sur le bouton Choisir une application.</p> <p>Une seconde fen\u00eatre s'ouvrira, choisir putty.exe ou SuperPutty.exe et finir en cliquant sur le bouton Ouvrir le lien.</p> <p>Exemple de connexion avec Putty sur le VPC2 :</p> <p> </p> EVE-NG : Putty connect\u00e9 sur srvdmz"},{"location":"informatique/eve-ng---labo-virtuel/#adresses-ip-fixe-et-ping","title":"Adresses IP fixe et Ping","text":"<p>Pour affecter une adresse IP fixe, proc\u00e9dez ainsi sur srvlan :</p> <p> </p> EVE-NG : IP 192.168.53.1 sur srvlan <p>Affectez ensuite l'IP 192.168.53.15 sur openvswitch.</p> <p>Pour connecter les 2 VPC entre eux, il faut d'abord les stopper, survoler le VPC de d\u00e9part et relier le symbole en forme de prise de couleur orange sur le VPC de destination.</p> <p>Une fen\u00eatre s'ouvrira, d\u00e9finissez les interfaces de r\u00e9seau \u00e0 utiliser (eth0 par d\u00e9faut) et sauvegardez :</p> <p> </p> EVE-NG : Cr\u00e9ation d'une liaison IP <p>Ensuite, red\u00e9marrez les 2 VPC et testez la commande ping entre srvlan et openvswitch.</p>"},{"location":"informatique/eve-ng---labo-virtuel/#textes-cadres-icones","title":"Textes / Cadres / Ic\u00f4nes","text":"<p>a) Pour ajouter un texte/\u00e9tiquette sur le labo, proc\u00e9dez ainsi :</p> <p>Cliquez sur Add an object, s\u00e9lectionnez Text et entrez par exemple l'IP du VPC3 dans le champ Text de la fen\u00eatre affich\u00e9e, sauvegardez et d\u00e9placez le texte \u00e0 l'endroit souhait\u00e9.</p> <p>b) Pour ajouter un cadre, proc\u00e9dez ainsi : Cliquez sur Add an object, s\u00e9lectionnez Custom Shape puis entrez LAN dans le champ Name de la fen\u00eatre affich\u00e9e, choisissez une couleur dans le champ Background-color et sauvegardez.</p> <p>Enfin, d\u00e9placez le cadre et redimensionnez le avec la souris afin d'entourer le groupe VPC3 \u00e0 6.</p> <p>c) Pour modifier l'ic\u00f4ne d'un noeud VPC, proc\u00e9dez ainsi :</p> <p>Clic droit sur le VPC concern\u00e9, s\u00e9lectionnez Edit, choisissez l'ic\u00f4ne souhait\u00e9e dans le champ Icon et sauvegardez.</p> <p>Exemple :</p> <p> </p> EVE-NG : Textes Cadres Ic\u00f4nes"},{"location":"informatique/eve-ng---labo-virtuel/#connexion-a-internet","title":"Connexion \u00e0 Internet","text":"<p>Pour l'acc\u00e8s \u00e0 Internet, il faut normalement proc\u00e9der ainsi :</p> <p>Cliquez sur Add an object, s\u00e9lectionnez Network puis entrez Internet-pnet0 dans le champ Name/Prefix de la fen\u00eatre affich\u00e9e, s\u00e9lectionnez ensuite Management(Cloud0) dans le champ Type et sauvegardez.</p> <p>L'interface de nom pnet0 est reli\u00e9e directement sur l'interface eth0 d'EVE-NG, ce qui permet d'acc\u00e9der au monde ext\u00e9rieur.</p> <p>Alerte</p> <p>L'exploitation d'un lien direct sur le noeud r\u00e9seau pnet0 (Cloud0) pour acc\u00e9der \u00e0 Internet ne fonctionne pas sous Proxmox et VirtualBox.</p> <p>La solution, utiliser l'interface pnet1 (Cloud1) \u00e0 la place de pnet0 (Cloud0) mais ceci n\u00e9cessite de configurer EVE-NG.</p> <p>Activez si besoin le routage interne en \u00e9ditant ce fichier :</p> <pre><code># nano /etc/sysctl.conf\n</code></pre> <p>et en d\u00e9commentant la ligne suivante :</p> <pre><code>#net.ipv4.ip_forward=1\n</code></pre> <p>Installez si manquant ces 2 paquets :</p> <pre><code>sudo apt install iptables-persistent netfilter-persistent\n</code></pre> <p>et cr\u00e9ez par exemple la r\u00e8gle iptables suivante :</p> <pre><code>sudo iptables -t nat -A POSTROUTING -o pnet0 -s 10.126.126.0/24 -j MASQUERADE\n</code></pre> <p>Sauvegardez la nouvelle r\u00e8gle iptables :</p> <pre><code>su root\nsudo iptables-save &gt; /etc/iptables/rules.v4\nexit\n</code></pre> <p>et v\u00e9rifiez la bonne cr\u00e9ation de celle-ci :</p> <pre><code>sudo iptables -t nat -L\n</code></pre> <p>Finissez en \u00e9ditant le fichier r\u00e9seau interfaces :</p> <pre><code>sudo nano /etc/network/interfaces\n</code></pre> <p>et en modifiant la section # Cloud device comme suit :</p> <pre><code># Cloud devices\niface eth1 inet manual\nauto pnet1\niface pnet1 inet manual\n    bridge_ports eth1\n    bridge_stp off\n    address 10.126.126.1\n    netmask 255.255.255.0\n</code></pre> <p>L'IP de pnet1 est dans le r\u00e9seau 10.126.126.0/24.</p> <p>Red\u00e9marrez EVE-NG et contr\u00f4lez la configuration r\u00e9seau :</p> <pre><code>sudo ip a\n</code></pre> <p>Retour normal :</p> <pre><code>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdi...\n    link/loopback 00:00:00:00:00:00 brd 00:...\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; ...\n    link/ether bc:25:11:e8:03:bc brd ff:ff:...\n    altname enp0s18\n    altname ens18\n3: pnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;...\n    link/ether bc:25:11:e8:03:bc brd ff:ff:...\n    inet 192.168.1.x/24 brd 192.168.1.255 s...\n       valid_lft forever preferred_lft forever\n    inet6 2a01:cb18:43a:4f00:991d:... \n       valid_lft 86391sec preferred_lft 591sec\n    inet6 2a01:cb18:43a:4f00:be24:... \n       valid_lft 86391sec preferred_lft 591sec\n    inet6 fe80::be24:11ff:...\n       valid_lft forever preferred_lft forever\n4: pnet1: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;.\n    link/ether ce:bd:7f:14:cf:8g brd ff:ff:...\n    inet 10.126.126.1/24 brd 10.126.126.255...\n       valid_lft forever preferred_lft forever\n</code></pre> <p>Cliquez sur Add an object, s\u00e9lectionnez Network puis entrez Internet-pnet1 dans le champ Name/Prefix de la fen\u00eatre affich\u00e9e, s\u00e9lectionnez ensuite Cloud1 dans le champ Type et sauvegardez.</p> <p> </p> EVE-NG : Noeud d'acc\u00e8s \u00e0 Internet <p>D\u00e9marrez maintenant VPC1, connectez vous dessus et configurez les \u00e9l\u00e9ments suivants :</p> <pre><code>VPCS&gt; ip 10.126.126.2/10.126.126.1\nVPCS&gt; ip dns 192.168.x.y\nVPCS&gt; save\n</code></pre> <p>Adaptez l'IP du serveur DNS selon votre configuration locale.</p> <p>R\u00e9sultat :</p> <p> </p> EVE-NG : VPC1 (ip, gateway,dns) <p>Arr\u00eatez VPC1 et reliez celui-ci sur le noeud r\u00e9seau Internet-pnet1, puis red\u00e9marrez VPC1 et testez la Cde ping sur google.fr.</p> <p> </p> EVE-NG : VPC1 acc\u00e8s \u00e0 Internet"},{"location":"informatique/eve-ng---labo-virtuel/#bridge","title":"Bridge","text":"<p>Le Bridge est un commutateur virtuel non g\u00e9r\u00e9 qui permet l\u2019interconnexion des n\u0153uds du labo.</p> <p>Supprimez le VPC4 et remplacez celui-ci par un bridge comme suit :</p> <p>Cliquez sur Add an object, s\u00e9lectionnez Network puis entrez Switch L2 dans le champ Name/Prefix de la fen\u00eatre affich\u00e9e, s\u00e9lectionnez ensuite Switch-2D-L2-Generic-S.svg dans le champ Icon et sauvegardez.</p> <p> </p> EVE-NG : VPC4 remplac\u00e9 par un bridge <p>Puis, affectez les IP 192.168.53.20 et 22 aux VPC5 et VPC6.</p> <p>Reliez ensuite les VPC3, 5 et 6 sur le nouveau switch.</p> <p>La Cde ping doit \u00e0 pr\u00e9sent fonctionner entre les 3 VPC.</p> <p>Fin.</p>"},{"location":"informatique/eve-ng---proxmox/","title":"EVE-NG - Proxmox","text":""},{"location":"informatique/eve-ng---proxmox/#installation-eve-ng-sur-proxmox","title":"Installation EVE-NG sur Proxmox","text":"<p>Le serveur Proxmox 8.x est consid\u00e9r\u00e9 op\u00e9rationnel.</p> <p>Ressources \u00e0 r\u00e9server pour une VM supportant EVE-NG : - 8 ou 16 coeurs logiques vCPU - 8 ou 16 Go de RAM - Un espace de stockage sur SSD d'au moins 100 Go</p> <p>Ceci permettra une exploitation confortable.</p>"},{"location":"informatique/eve-ng---proxmox/#doc-image-iso-pack-client","title":"Doc / Image ISO / Pack client","text":"<p>a) Doc Ouvrez la page suivante :  Virtual Machine EVE-NG.</p> <p>Cliquez sur le lien de la version EVE Community Cookbook.</p> <p>La documentation retourn\u00e9e est compl\u00e8te et t\u00e9l\u00e9chargeable.</p> <p>Fichier PDF.</p> <p>b) Image ISO T\u00e9l\u00e9chargez l'ISO d'EVE-NG \u00e0 l'aide du lien suivant : Free EVE Community Edition Version 6...</p> <p>c) Pack client T\u00e9l\u00e9chargez le pack client pour Windows.</p> <p>Le pack client est n\u00e9cessaire pour pouvoir interagir avec les machines sous EVE-NG, il permet d'utiliser des outils comme wireshark, ultravnc, putty, etc...</p> <p>Il existe \u00e9galement des packs pour Apple OSX et Linux.</p>"},{"location":"informatique/eve-ng---proxmox/#virtualisation-imbriquee","title":"Virtualisation imbriqu\u00e9e","text":"<p>La VM EVE-NG g\u00e9rera des VM ce qui n\u00e9cessite une virtualisation imbriqu\u00e9e (VMs dans VM EVE-NG).</p> <p>Vous devez v\u00e9rifier que la virtualisation imbriqu\u00e9e est activ\u00e9e sur le serveur Proxmox.</p> <p>Proc\u00e9dez ainsi pour les processeurs Intel :</p> <pre><code>cat /sys/module/kvm_intel/parameters/nested\n</code></pre> <p>et ainsi pour les processeurs AMD :</p> <pre><code>cat /sys/module/kvm_amd/parameters/nested\n</code></pre> <p>Si le retour = Y ou 1, la virtualisation imbriqu\u00e9e est activ\u00e9e.</p> <p>Sinon, l'activer comme ceci pour un processeur Intel :</p> <pre><code>echo \"options kvm-intel nested=Y\" &gt; /etc/modprobe.d/kvm-intel.conf\n</code></pre> <p>ou comme ceci pour un processeur AMD :</p> <pre><code>echo \"options kvm-amd nested=1\" &gt; /etc/modprobe.d/kvm-amd.conf\n</code></pre> <p>Ensuite, red\u00e9marrez le serveur Proxmox ou rechargez le module du noyau.</p> <p>Exemple de rechargement du module pour un processeur Intel :</p> <pre><code>modprobe -r kvm_intel\nmodprobe kvm_intel\n</code></pre>"},{"location":"informatique/eve-ng---proxmox/#creation-de-la-vm-eve-ng","title":"Cr\u00e9ation de la VM EVE-NG","text":"<p>Transf\u00e9rez l'image ISO t\u00e9l\u00e9charg\u00e9e ci-dessus dans le dossier local du serveur Proxmox via son interface web.</p> <p>Ensuite, depuis Proxmox, cr\u00e9ez une VM comme ceci : - Onglet Syst\u00e8me d'exploitation Stockage = local Image ISO = S\u00e9lectionnez l'ISO t\u00e9l\u00e9charg\u00e9e Type = Linux Version = 6.x - 2.6 Kernel</p> <p>- Onglet Syst\u00e8me Carte graphique = Par d\u00e9faut Machine = Par d\u00e9faut (i440fx) BIOS = Par d\u00e9faut (SeaBIOS) Contr\u00f4leur SCSI = VirtlO SCSI single</p> <p>- Onglet Disques Bus/p\u00e9riph\u00e9rique = VirtlO Block Stockage = local-lvm Taille du disque (Gio) = 128 Cache = Par d\u00e9faut (Aucun cache)</p> <p>- Onglet Processeur Supports de processeur = 1 Coeurs = 8 Type = host</p> <p>- Onglet M\u00e9moire M\u00e9moire (MiB) = 16384</p> <p>- Onglet R\u00e9seau Pont (bridge) = vmbr0 Mod\u00e8le = VirtiO (paravirtualis\u00e9)</p> <p>- Onglet Confirmation V\u00e9rifiez la configuration et modifiez la si n\u00e9cessaire.</p> <p>Cliquez ensuite sur le bouton Terminer pour cr\u00e9er la VM.</p>"},{"location":"informatique/eve-ng---proxmox/#installation-deve-ng-sur-la-vm","title":"Installation d'EVE-NG sur la VM","text":"<p>Depuis l'interface web de Proxmox, d\u00e9marrez la VM et suivez les instructions d'installation.</p> <p>Des tutoriels, nombreux sur Internet, peuvent vous aider si vous rencontrez un probl\u00e8me.</p> <p>Une fois termin\u00e9, effectuez une mise \u00e0 jour du syst\u00e8me :</p> <pre><code># apt update\n# apt upgrade\n</code></pre> <p>Rebootez et v\u00e9rifiez que le syst\u00e8me est bien \u00e0 jour.</p> <pre><code># apt update\n</code></pre> <p>Pour info, EVE-NG utilise le service systemd-resolved pour g\u00e9rer la r\u00e9solution DNS. Vous pouvez v\u00e9rifier l'IP du serveur DNS dans le fichier /etc/systemd/resolved.conf.</p> <p>Ensuite si vous le souhaitez (Optionnel) : Cr\u00e9ez un utilisateur, ajoutez le au groupe sudo et rebootez. Installez le bureau xfce4, le gestionnaire de connexion lightdm et un serveur xrdp pour les connexions distantes.</p> <p>Un serveur ssh est normalement d\u00e9j\u00e0 activ\u00e9 sur le port 3389.</p> <p>L'acc\u00e8s \u00e0 l'interface web d'EVE-NG se fait ainsi : <code>http://ip-vm-eve-ng</code></p> <p>Les identifiants par d\u00e9faut pour se connecter sont :</p> <ul> <li>Nom d'utilisateur : admin</li> <li>Mot de passe : eve</li> </ul> <p>Une fois l'interface web ouverte, allez dans : -&gt; Management -&gt; User management</p> <p>Cr\u00e9ez un nouveau compte utilisateur d\u00e9clar\u00e9 avec le r\u00f4le Administrator et supprimez le compte admin.</p> <p></p> <p>  Si OK, on peut passer \u00e0 la suite. La partie 2 traite de la cr\u00e9ation d'un labo basique permettant de d\u00e9couvrir l'exploitation d'EVE-NG.</p> <p>Partie 2</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/","title":"EVE-NG - Homelab R\u00e9seau","text":""},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#ajout-dune-vm-debian","title":"Ajout d'une VM Debian","text":"<p>EVE-NG est une VM install\u00e9e sur une base Proxmox 8.x.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#preparation-deve-ng","title":"Pr\u00e9paration d'EVE-NG","text":"<p>Se rendre dans le dossier suivant :  </p> <pre><code>cd /opt/unetlab/addons/qemu/\n</code></pre> <p>et cr\u00e9er celui qui recevra l'image de la VM Debian :</p> <pre><code>sudo mkdir linux-nom\n</code></pre> <p>Transf\u00e9rer ensuite dans ce dossier l'image ISO de Debian \u00e0 l'aide par exemple de FileZilla en protocole SFTP.</p> <p>Pour l'authentification SFTP, choisir l'utilisateur root d'EVE-NG + le MDP de root.</p> <p>Une fois l'image ISO transf\u00e9r\u00e9e, la renommer comme suit :</p> <pre><code>sudo mv nom-iso cdrom.iso\n</code></pre> <p>et la convertir en image QEMU (Ext .qcow2) comme suit :</p> <pre><code>sudo /opt/qemu/bin/qemu-img create -f qcow2 virtioa.qcow2 12G\n</code></pre> <p>12G = Taille souhait\u00e9e du disque dur.</p> <p>Trouver le type de processeur supportant EVE-NG :</p> <pre><code>lsmod | grep ^kvm_\n</code></pre> <p>Retour = amd ou intel.</p> <p>Puis ouvrir, selon le retour, le template associ\u00e9 linux.yml :</p> <pre><code>sudo nano /opt/unetlab/html/templates/amd ou intel/linux.yml\n</code></pre> <p>et compl\u00e9ter la ligne qemu_options avec le param\u00e8tre :</p> <pre><code>-k fr\n</code></pre> <p>La VM disposera ainsi au d\u00e9marrage d'un clavier fran\u00e7ais.</p> <p>Une autre solution est d'ajouter directement le param\u00e8tre -k fr dans le champ QEMU custom options lors de la cr\u00e9ation de la VM Debian sous l'interface Web d'EVE-NG.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#gestion-de-lacces-a-internet","title":"Gestion de l'acc\u00e8s \u00e0 Internet","text":"<p>L'exploitation du noeud R\u00e9seau pnet0 (Cloud0) pour acc\u00e9der \u00e0 Internet ne fonctionne pas sous Proxmox et VirtualBox.</p> <p>Utiliser pnet1 \u00e0 la place de pnet0 est possible mais cela n\u00e9cessite d'activer le routage interne en \u00e9ditant le fichier de configuration sysctl.conf :</p> <pre><code>sudo nano /etc/sysctl.conf\n</code></pre> <p>et en d\u00e9commentant la ligne suivante :</p> <pre><code>#net.ipv4.ip_forward = 1\n</code></pre> <p>Installer ensuite ces 2 paquets :</p> <pre><code>sudo apt install iptables-persistent netfilter-persistent\n</code></pre> <p>et cr\u00e9er la r\u00e8gle iptables suivante :</p> <pre><code>sudo iptables -t nat -A POSTROUTING -o pnet0 -s 15.128.128.0/24 -j MASQUERADE\n</code></pre> <p>L'IP de pnet1 devra faire partie du r\u00e9seau 15.128.128.0.</p> <p>Sauvegarder la nouvelle r\u00e8gle iptables :</p> <pre><code>su root\nsudo iptables-save &gt; /etc/iptables/rules.v4\nexit\n</code></pre> <p>et v\u00e9rifier la bonne cr\u00e9ation de celle-ci :</p> <pre><code>sudo iptables -t nat -L\n</code></pre> <p>Finir en \u00e9ditant le fichier r\u00e9seau interfaces :</p> <pre><code>sudo nano /etc/network/interfaces\n</code></pre> <p>et en modifiant la section #Cloud device comme suit :</p> <pre><code># Cloud devices\niface eth1 inet manual\nauto pnet1\niface pnet1 inet static\n    bridge_ports eth1\n    bridge_stp off\n    address 15.128.128.1\n    netmask 255.255.255.0\n</code></pre>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#ajout-de-la-vm-dans-un-labo","title":"Ajout de la VM dans un labo","text":"<p>Ajouter le VM Debian commme suit :</p> <p>Menu Add an object -&gt; Node - S\u00e9lectionner le template Linux - S\u00e9lectionner l'image nomm\u00e9e linux-nom - Entrer un nom-de-vm dans le champ Name/prefix - Configurer les param\u00e8tres CPU RAM et Ethernets - Ajouter -k fr dans le champ QEMU custom options - Laisser Console \u00e0 VNC - Cliquer sur le bouton Save</p> <p>Relier la VM au noeud R\u00e9seau pnet1 (Cloud1).</p> <p>Il suffit ensuite d'un clic droit sur l'ic\u00f4ne du noeud + Start pour d\u00e9marrer la VM et proc\u00e9der \u00e0 son installation.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#installation-de-debian-sur-la-vm","title":"Installation de Debian sur la VM","text":"<p>Faire une installation de base avec une configuration manuelle du r\u00e9seau et la mise en place des paquets  serveur ssh et utilitaires usuels seulement.</p> <p>Apr\u00e8s le premier reboot :</p> <pre><code>su root\napt update\napt upgrade\napt install sudo\nsudo usermod -aG sudo user\n/sbin/reboot\n</code></pre> <p>V\u00e9rifier ensuite que la carte r\u00e9seau ens3 a bien \u00e9t\u00e9 d\u00e9clar\u00e9e dans le fichier /etc/network/interfaces.</p> <p>V\u00e9rifier en compl\u00e9ment le retour de la Cde ip a.</p> <p>Puis installer un environnement graphique xfce4 minimal :</p> <pre><code>sudo apt install xfce4\nsudo reboot\n</code></pre> <p>Le syst\u00e8me doit red\u00e9marrer sous xfce4.</p> <p>V\u00e9rifier l'activation du serveur SSH :</p> <pre><code>sudo systemctl status sshd\n</code></pre> <p>Puis installer les applications suivantes :</p> <pre><code>sudo apt install xrdp\nsudo adduser xrdp ssl-cert\nsudo apt install network-manager\nsudo apt install network-manager-gnome\nsudo apt install xfce4-terminal mousepad\nsudo apt install synaptic ristretto\nsudo apt install xfce4-taskmanager\nsudo apt install firefox-esr\nsudo apt install firefox-esr-l10n-fr\nsudo apt install gparted mtpaint\nsudo poweroff\n</code></pre>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#commit-de-linstallation-debian","title":"Commit de l'installation Debian","text":"<p>Relever l'ID du labo courant (Menu de gauche -&gt; Lab details) et l'ID du noeud cr\u00e9\u00e9  (Menu de l'ic\u00f4ne -&gt; Edit).</p> <p>Se rendre ensuite dans le dossier ID-du-labo/ID-du-noeud/, exemple :</p> <pre><code>cd /opt/unetlab/tmp/0/02d314a2-8ab2-43...../2/\n</code></pre> <p>0 est l'identifiant du cr\u00e9ateur du labo courant soit l'utilisateur admin par d\u00e9faut.</p> <p>L'identifiant aura une valeur diff\u00e9rente si la cr\u00e9ation du labo se fait depuis un utilisateur autre que admin.</p> <p>Puis, lancer la Cde suivante :</p> <pre><code>sudo /opt/qemu/bin/qemu-img commit virtioa.qcow2\n</code></pre> <p>L'image QEMU du dossier linux-nom est alors remplac\u00e9e par celle de la VM Debian install\u00e9e et configur\u00e9e.</p> <p>Le fichier ISO initial peut maintenant \u00eatre supprim\u00e9 :</p> <pre><code>rm -f /opt/unetlab/addons/qemu/linux-nom/cdrom.iso\n</code></pre> <p>On dispose maintenant d'une Debian de base pr\u00eate \u00e0 l'emploi (install\u00e9e et configur\u00e9e) pour la cr\u00e9ation future d'un noeud (VM) Debian sous EVE-NG.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#configuration-ssh-et-telnet","title":"Configuration SSH et Telnet","text":"<p>Installer et activer le service ssh :</p> <pre><code>sudo apt install openssh-server\n</code></pre> <p>Une VM d'IP 15.128.128.x et reli\u00e9e au noeud R\u00e9seau pnet1 pourra ainsi \u00eatre configur\u00e9e directement depuis EVE-NG :</p> <pre><code>sudo ssh utilisateur-vm@ip-vm\n</code></pre> <p>Cela peut d\u00e9panner dans certains cas de figure.</p> <p>Installer \u00e9galement le service telnet dans le cas d'un serveur Debian :</p> <pre><code>sudo apt-get install xinetd telnetd\n</code></pre> <p>Cr\u00e9ez pour cela un fichier de configuration telnet :</p> <pre><code>sudo nano /etc/xinetd.d/telnet\n</code></pre> <p>et y entrer le contenu suivant :</p> <pre><code>service telnet\n{\ndisable = no\nflags = REUSE\nsocket_type = stream\nwait = no\nuser = root\nserver = /usr/sbin/telnetd\nlog_on_failure += USERID\n}\n</code></pre> <p>Red\u00e9marrer le service telnet :</p> <pre><code>sudo systemctl restart xinetd\n</code></pre> <p>Pour finir, activer une connexion s\u00e9rie ttyS0 :</p> <pre><code>sudo systemctl enable serial-getty@ttyS0.service\n</code></pre> <p>EVE-NG pourra ainsi se connecter en Telnet sur le serveur Debian.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#configuration-reseau","title":"Configuration r\u00e9seau","text":"<p>Red\u00e9marrer la VM Debian depuis depuis l'interface Web d'EVE-NG, console VNC.</p> <p>Ouvrir l'applet de network-manager et cr\u00e9er ou modifier la carte r\u00e9seau ens3</p> <p>Puis :</p> <pre><code>sudo systemctl restart NetworkManager\n</code></pre> <p>Commenter les lignes du fichier /etc/network/interfaces.</p> <p>Puis :</p> <pre><code>sudo systemctl restart networking\nsudo reboot\n</code></pre> <p>V\u00e9rifier que tout est OK.</p> <p>Si la VM comprend plusieurs interfaces r\u00e9seau, affecter depuis network-manager une IP \u00e0 chacune des interfaces.</p> <p>- Remarques sur LXQT \u00e0 la place de XFCE -</p> <p>Le param\u00e9trage r\u00e9seau d'une VM sous LXQT s'effectue \u00e0 l'aide de l'outil graphique Connman (Service connman).</p> <p>Les fichiers de configuration des interfaces r\u00e9seau se trouvent dans le dossier /var/lib/connman/.</p> <p>- Acc\u00e8s SSH</p> <p>Penser \u00e0 ajouter une route IP statique sur le PC local afin de pouvoir joindre le r\u00e9seau pnet1.</p> <p>Exemple pour Windows :</p> <pre><code>route add -p 15.128.128.0 mask 255.255.255.0 192.168.x.y\n</code></pre> <p>- Acc\u00e8s RDP</p> <p>En console RDP, EVE-NG ajoute une carte r\u00e9seau d\u00e9di\u00e9e \u00e0 la connexion RDP, ceci sans cons\u00e9quence sur le bon fonctionnement de l'ensemble.</p> <p>Penser \u00e0 g\u00e9rer les Astuces XRDP permettant la modifications des interfaces r\u00e9seau et l'arr\u00eat de la VM Debian.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#noms-dhotes-et-utilisateurs","title":"Noms d'h\u00f4tes et utilisateurs","text":"<p>Si l'on cr\u00e9e un nouveau noeud \u00e0 partir d'une image issue d'un commit comme ci-dessus, celui-ci h\u00e9ritera des param\u00e8tres comme le nom d'h\u00f4te et le nom de l'utilisateur principal.</p> <p>Sur une Debian, proc\u00e9der comme suit pour modifier ces 2 param\u00e8tres :</p> <p>- H\u00f4te</p> <pre><code>sudo hostnamectl set-hostname new-host\nsudo nano /etc/hosts\n</code></pre> <p>Remplacer dans hosts l'ancienne valeur par new-host.</p> <p>Pour finir, red\u00e9marrer la VM et relancer la Cde hostnamectl pour v\u00e9rifier la prise en compte de la modification.</p> <p>- Utilisateur principal</p> <p>Se d\u00e9connecter du bureau graphique XFCE ou LXQT puis ouvrir une console root avec la combinaison de touches CTRL+ALT+F2 et entrer les 2 Cdes suivantes :</p> <pre><code>usermod -d /home/new-user -m -l new-user old-user\n\npasswd new-user\n\ngroupmod -n new-group old-group\n\nchown -R new-user:new-group /home/new-user\n</code></pre> <p>Supprimer les dossiers xfce4 dans /home/new-user/.config et sessions dans /home/new-user/.cache.</p> <pre><code>rm -R /home/new-user/.config/xfce4\nrm -R /home/new-user/.cache/sessions\nreboot\n</code></pre> <p>Se connecter \u00e0 pr\u00e9sent sur la VM \u00e0 l'aide du nouvel utilisateur new-user et de son MDP.</p> <p>Retirer le floppy disque et le cdrom du bureau xfce4 : - Param\u00e8tres du bureau -&gt; Ic\u00f4nes -&gt; Ic\u00f4nes par d\u00e9faut -&gt; P\u00e9riph\u00e9riques amovibles -&gt; d\u00e9cocher Disques durs et lecteurs</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#fond-decran-et-cdrom","title":"Fond d'\u00e9cran et CDROM","text":"<p>- Fond d'\u00e9cran Pour un m\u00eame fond d'\u00e9cran sur la fen\u00eatre de login Lightdm et le bureau Xfce, proc\u00e9der ainsi :</p> <pre><code>cd /chemin-fond-ecran-xfce4\nsudo cp fond-ecran.jpg /usr/share/backgrounds/\n\ncd /etc/lightdm\nsudo nano lightdm-gtk-greeter.conf\n</code></pre> <p>Remplacer la ligne #background= par celle-ci :</p> <pre><code>background=/usr/share/backgrounds/fond-ecran.jpg\n</code></pre> <pre><code>sudo reboot\n</code></pre> <p>- CDROM D\u00e9monter le contenu du cdrom0 utilis\u00e9 pour la cr\u00e9ation de la VM.</p> <p>Commenter la ligne faisant r\u00e9f\u00e9rence au montage du CDROM dans le fichier /etc/fstab.</p> <p>Puis :</p> <pre><code>sudo systemctl daemon-reload\nsudo systemctl restart remote-fs.target\n</code></pre>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#taille-du-disque-virtuel","title":"Taille du disque virtuel","text":"<p>Il est possible de redimensionner la taille du disque virtuel de la VM \u00e0 l'aide de la Cde suivante, ceci VM stopp\u00e9e :</p> <pre><code>cd /opt/unetlab/tmp/0/02d314a2-8ab2-43...../2/\nsudo qemu-img resize virtioa.qcow2 +4G\n</code></pre> <p>+4G signifie que l'on demande une extension de 4 Go.</p> <p>Red\u00e9marrer la VM et utiliser l'outil graphique gparted pour redimensionner la partition du disque virtuel afin d'exploiter pleinement la nouvelle taille.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#cas-de-lutilisateur-adminid-0","title":"Cas de l'utilisateur admin/ID 0","text":"<p>Si des VM ont \u00e9t\u00e9 pr\u00e9alablement cr\u00e9\u00e9es depuis l'utilisateur admin mais que celui-ci n'existe plus, il est possible de supprimer ses fichiers temporaires devenus inutiles.</p> <p>V\u00e9rifier par pr\u00e9caution s'il reste des fichiers r\u00e9cents ou s'il y a des processus en cours :</p> <pre><code>ls -lh /opt/unetlab/tmp/0/\nps aux | grep qemu\n</code></pre> <p>Si OK, proc\u00e9der ainsi pour les supprimer :</p> <pre><code>sudo rm -rf /opt/unetlab/tmp/0/*\nsudo find /opt/unetlab/tmp/0/ -mindepth 1 -delete\n</code></pre> <p>ATTENTION : Ne pas supprimer le dossier 0.</p>"},{"location":"informatique/eve-ng---homelab-r%C3%A9seau/#console-html5","title":"Console HTML5","text":"<p>La connexion s'\u00e9tablie au travers d'un serveur Guacamole install\u00e9 par d\u00e9faut sur EVE-NG.</p> <p>Fin.</p>"},{"location":"informatique/nextcloud---sur-debian/","title":"Nextcloud - Sur Debian","text":""},{"location":"informatique/nextcloud---sur-debian/#nextcloud","title":"Nextcloud","text":""},{"location":"informatique/nextcloud---sur-debian/#ajout-optionnel-de-redis","title":"Ajout optionnel de Redis","text":"<p>Installer les paquets suivants :</p> <pre><code>apt update\napt install redis-server redis-tools\n</code></pre> <p>Le serveur est lanc\u00e9 depuis le dossier /etc/init.d.</p> <p>Compl\u00e9ter le fichier config.php de Nextcloud comme suit :</p> <pre><code>'filelocking.enabled' =&gt; true,\n  'memcache.locking' =&gt; '\\OC\\Memcache\\Redis',\n  'redis' =&gt; \n  array (\n    'host' =&gt; '/var/run/redis/redis-server.sock',\n    'port' =&gt; 0,\n  ),\n</code></pre> <p>Modifier ensuite le fichier /etc/redis/redis.conf comme suit :</p> <pre><code>port 0\nunixsocket /run/redis/redis-server.sock\nunixsocketperm 770\n</code></pre> <p>Int\u00e9grer l'utilisateur www-data dans le groupe redis :</p> <pre><code>usermod -a -G redis www-data\n</code></pre> <p>Relancer Redis et Apache :</p> <pre><code>/etc/init.d/redis-server restart\n/etc/init.d/apache2 restart\n</code></pre> <p>Utiliser la Cde systemctl si systemd est utilis\u00e9.</p>"},{"location":"informatique/nextcloud---sur-debian/#module-php-bz2","title":"Module PHP bz2","text":"<p>Si remarque concernant le module PHP bz2 manquant, entrer les Cdes suivantes :</p> <pre><code>apt install -y libbz2-dev\napt install phpx.y-bz2\n</code></pre> <p>Red\u00e9marrer ensuite apache.</p>"},{"location":"informatique/nextcloud---sur-debian/#fenetre-de-maintenance","title":"Fen\u00eatre de maintenance","text":"<p>Si remarque concernant l'heure de d\u00e9but de la fen\u00eatre de maintenance :</p> <pre><code>sudo nano /var/www/html/nextcloud/config/config.php\n</code></pre> <p>Ajouter la ligne suivante :</p> <pre><code>'maintenance_window_start' =&gt; 1,\n</code></pre>"},{"location":"informatique/nextcloud---sur-debian/#fichiers-interface-web","title":"Fichiers - Interface Web","text":"<p>Cas sur une Debian : Le contenu du dossier Tous les fichiers est mis \u00e0 jour manuellement par synchronisation (FreeFileSync) sur un dossier SFTP de la Debian.</p> <p>Pour actualiser le nouveau contenu dans l'interface Web, proc\u00e9der comme suit :</p> <pre><code>sudo cd /var/www/html/nextcloud/\nsudo -u www-data php /var/www/html/nextcloud/occ files:scan --all\n</code></pre>"},{"location":"informatique/nextcloud---sur-debian/#probleme-updatersecret","title":"Probl\u00e8me updater.secret","text":"<p>En cas de probl\u00e8me, il est pr\u00e9f\u00e9rable de cr\u00e9er une nouvelle cl\u00e9 en utilisant la Cde php suivante :</p> <pre><code>cd /var/www/html/nextcloud/config/\n\nphp -r '$password = trim(shell_exec(\"openssl rand -base64 48\"));if(strlen($password) === 64) {$hash = password_hash($password, PASSWORD_DEFAULT) . \"\\n\"; echo \"Insert as \\\"updater.secret\\\": \".$hash; echo \"The plaintext value is: \".$password.\"\\n\";}else{echo \"Could not execute OpenSSL.\\n\";};'\n</code></pre> <p>Exemple de retour :</p> <pre><code>Insert as \"updater.secret\": $2y$10$3eAg84tEeAtUVALFYpnvy.f6qDBOzgunN6uIFCZuma3oDWQLQfLCm\n\nThe plaintext value is: HQHlPRqnJ5Ehr9Kqwr29R+EKetH4OniPaIKatEo5mkMFGNzRtsT9zVojOfGrVxmL\n</code></pre> <p>Garder la valeur plaintext de c\u00f4t\u00e9 pour une \u00e9ventuelle r\u00e9clamation par Nextcloud et entrer la valeur updater.secret dans le fichier config.php comme suit :</p> <pre><code>'secret' =&gt; '$2y$10$3eAg84tEeAtUVALFYpnvy.f6qDBOzgunN6uIFCZuma3oDWQLQfLCm',\n</code></pre>"},{"location":"informatique/nextcloud---sur-debian/#fichier-nextcloudlog","title":"Fichier nextcloud.log","text":"<p>Pour vider le fichier, proc\u00e9der comme suit :</p> <pre><code>cd /var/www/html/nextcloud/\nsudo -u www-data truncate data/nextcloud.log --size 0\n</code></pre> <p>Fin.</p>"},{"location":"informatique/nextcloud---sur-synology/","title":"Nextcloud - Sur Synology","text":""},{"location":"informatique/nextcloud---sur-synology/#conteneur-nextcloud","title":"Conteneur Nextcloud","text":""},{"location":"informatique/nextcloud---sur-synology/#maj-de-nextcloud-2023","title":"MAJ de Nextcloud (2023)","text":"<p>Ouvrir l'application Docker du Synology.</p> <p>Par pr\u00e9caution, v\u00e9rifier auparavant sur le hub de Docker que c'est bien la derni\u00e8re version de Nextcloud qui est propos\u00e9e.</p> <p>Chercher ensuite sur le Synology l'application nextcloud dans l'onglet Registre de Docker et t\u00e9l\u00e9charger la derni\u00e8re version (Latest).</p> <p>Une fois termin\u00e9, aller dans l'onglet Conteneur et stopper nextcloud depuis le menu Action.</p> <p>Depuis ce m\u00eame menu, R\u00e9initialier le conteneur nextcloud.</p> <p>Le conteneur sera supprim\u00e9 et recr\u00e9\u00e9 \u00e0 partir de la nouvelle image.</p> <p>Red\u00e9marrer ensuite le conteneur qui ira chercher sa configuration dans : /volume1/docker/nextcloud/config.</p>"},{"location":"informatique/nextcloud---sur-synology/#maj-de-nextcloud-2024","title":"MAJ de Nextcloud (2024)","text":"<p>C'est \u00e0 pr\u00e9sent plus simple, l'application DSM7 Container Manager pr\u00e9venant au niveau de son onglet Image si une mises \u00e0 jour est disponible.</p> <p>Il suffit de lancer la MAJ pour reconstruire le conteneur Nextcloud.</p>"},{"location":"informatique/nextcloud---sur-synology/#applications-a-reinstaller","title":"Applications \u00e0 r\u00e9installer","text":"<p>Cdes \u00e0 lancer depuis le terminal associ\u00e9 au conteneur :</p> <pre><code>apt update\napt install nano  # Utile pour modifier les fichiers du conteneur\napt install smbclient\n</code></pre>"},{"location":"informatique/nextcloud---sur-synology/#module-php-bz2","title":"Module PHP bz2","text":"<p>Si remarque concernant le module PHP bz2 manquant, entrer la Cde suivante :</p> <pre><code>apt install -y libbz2-dev &amp;&amp; docker-php-ext-install bz2\n</code></pre> <p>Red\u00e9marrer ensuite le conteneur Nextcloud.</p>"},{"location":"informatique/nextcloud---sur-synology/#fenetre-de-maintenance","title":"Fen\u00eatre de maintenance","text":"<p>Si remarque concernant l'heure de d\u00e9but de la fen\u00eatre de maintenance, ajouter ce qui suit dans le fichier config.php  de Nextcloud :</p> <pre><code>'maintenance_window_start' =&gt; 1,\n</code></pre> <p>Fin.</p>"},{"location":"informatique/proxmox---divers/","title":"Proxmox - Divers","text":""},{"location":"informatique/proxmox---divers/#exploitation-generale","title":"Exploitation g\u00e9n\u00e9rale","text":""},{"location":"informatique/proxmox---divers/#ajout-dun-utilisateur","title":"Ajout d'un utilisateur","text":"<p>Se connecter en SSH sur le serveur, puis :</p> <pre><code># pveum user add user-x@pve\n# pveum passwd user-x@pve\n</code></pre> <p>Cr\u00e9er ensuite un groupe de nom admin :</p> <pre><code># pveum group add admin\n# pveum acl modify / -group admin -role Administrator\n</code></pre> <p>La 2\u00e8me ligne g\u00e8re les permissions du groupe admin.</p> <p>Ajouter l'utilisateur user-x au groupe admin :</p> <pre><code># pveum user modify user-x@pve -group admin\n</code></pre> <p>Le fichier modifi\u00e9 user.cfg se siue dans /etc/pve/.</p> <p>Enfin, ouvrir une session Web comme suit : Nom d'utilisateur : user-x Mot de passe : mdp-user-x Royaume : Proxmox VE authentication server</p> <p>Nota</p> <p>La cr\u00e9ation de l'utilisateur peut \u00e9galement \u00eatre g\u00e9r\u00e9e depuis l'interface Web de Proxmox.</p>"},{"location":"informatique/proxmox---divers/#interface-web-en-francais","title":"Interface Web en fran\u00e7ais","text":"<p>Ouvrir le fichier /etc/pve/datacenter.cfg et ajouter ceci :</p> <pre><code>language: fr\n</code></pre>"},{"location":"informatique/proxmox---divers/#vnc-acces-externe-et-clavier-fr","title":"VNC Acc\u00e8s externe et clavier fr","text":"<p>Editer le fichier de configuration de la VM concern\u00e9e :</p> <pre><code># nano /etc/pve/qemu-server/ID-vm.conf\n</code></pre> <p>et ajouter la ligne suivante en fin de fichier :</p> <pre><code>args: -vnc 0.0.0.0:95 -k fr\n</code></pre> <p>95 correspond au num\u00e9ro d'\u00e9cran, choisir de pr\u00e9f\u00e9rence un nombre entre 70 et 100, Proxmox utilisant des valeurs inf\u00e9rieures pour les acc\u00e8s NoVNC.</p> <p>Pour se connecter depuis un client tel TightVNC, entrer :  </p> <pre><code>adresse-ip-hote-de-proxmox:95\n</code></pre>"},{"location":"informatique/proxmox---divers/#vnc-resolution-decran","title":"VNC R\u00e9solution d'\u00e9cran","text":"<p>L'acc\u00e8s au BIOS (ou UEFI) d'une VM se fait en appuyant plusieurs fois sur la touche Esc lors du d\u00e9marrage de celle-ci.</p> <p>La r\u00e9solution d'\u00e9cran fournie de base aux clients VNC est 1280x800.</p> <p>Pour la changer en 1360x768, se rendre dans le BIOS de la VM, puis : -&gt; Device Manager &gt; OVMF Platform Configuration -&gt; Changer la valeur de la r\u00e9solution</p>"},{"location":"informatique/proxmox---divers/#message-de-subscription","title":"Message de subscription","text":"<p>Pour supprimer le message, ouvrir le fichier proxmoxlib.js :</p> <pre><code># cd /usr/share/javascript\n# cd proxmox-widget-toolkit\n# cp proxmoxlib.js proxmoxlib.js.bak\n# nano proxmoxlib.js\n</code></pre> <p>et chercher (CTRL+W) la chaine No valid subscription.</p> <p>Retour :</p> <pre><code>Ext.Msg.show({\n  title: gettext('No valid subscription'),\n</code></pre> <p>Modifier Ext.Msg.show comme suit :</p> <pre><code>void({ //Ext.Msg.show({\n  title: gettext('No valid subscription'),\n</code></pre> <p>Pour finir, red\u00e9marrer le service pveproxy :</p> <pre><code># systemctl restart pveproxy.service\n</code></pre>"},{"location":"informatique/proxmox---divers/#tache-cron-startstop-des-vm","title":"T\u00e2che cron - Start/Stop des VM","text":"<p>Depuis l'interface Web, s\u00e9lectionner le nom du noeud proxmox et ouvrir la console Xterm.</p> <p>Lister les VM :</p> <pre><code># qm list\n</code></pre> <p>Rep\u00e9rer l'ID de la VM qui sera exploit\u00e9e par la t\u00e2che cron.</p> <p>Editer enfin la table cron :</p> <pre><code># crontab -e\n</code></pre> <p>et entrer le contenu suivant en fin de fichier :</p> <pre><code>MAILTO=\"adresse-mail-destination\"\n0 23 1 * * /usr/sbin/qm start ID-VM\nMAILTO=\"adresse-mail-destination\"\n0 23 3 * * /usr/sbin/qm shutdown ID-VM\n</code></pre> <p>La VM sera ainsi d\u00e9marr\u00e9e \u00e0 23H le premier jour de chaque mois et arr\u00eat\u00e9e \u00e0 23H le trois\u00e8me jour de chaque mois.</p> <p>Une notification sera envoy\u00e9e simultan\u00e9ment \u00e0 l'adresse-mail-destination .</p>"},{"location":"informatique/proxmox---divers/#documentation-utile","title":"Documentation utile","text":"<p>proxmox-securisation-basique.pdf</p> <p>proxmox8-debian12-securisation.pdf</p> <p>Fin.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/","title":"IA - ComfyUI sur Proxmox","text":""},{"location":"informatique/ia---comfyui-sur-proxmox/#intelligence-artificielle","title":"Intelligence Artificielle","text":"<p>ComfyUI offre une interface utilisateur servant \u00e0 g\u00e9n\u00e9rer des images \u00e0 partir d'un texte.</p> <p>Les utilisateurs peuvent cr\u00e9er des flux de travail complexes en utilisant diff\u00e9rents n\u0153uds personnalis\u00e9s et mod\u00e8les d'IA.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#base-de-travail","title":"Base de travail","text":"<p>Un CPU AMD Ryzen 7500U, 32 Go de RAM et une puce graphique int\u00e9gr\u00e9e (iGPU) AMD Radeon Vega 8.</p> <p>L'Architecture de M\u00e9moire Unifi\u00e9e est activ\u00e9e dans le BIOS, l'iGPU et le CPU partagent ainsi le m\u00eame espace RAM ce qui augmente l'efficacit\u00e9 de traitement des grandes quantit\u00e9s de donn\u00e9es exig\u00e9e par l'utilisation de l'Intelligence Artificielle.</p> <p>Syst\u00e8me d'exploitation Proxmox 8.3.3 incluant un noyau linux 6.8.12.8-pve.</p> <p>Ci-dessous, quelques Cdes utiles pour appr\u00e9hender la suite :</p> <p>- Cdes pour obtenir les informations d'un iGPU AMD :</p> <pre><code>proxmox:~# apt install rocminfo\nproxmox:~# rocminfo\n</code></pre> <p>Retour :</p> <pre><code>...\nAgent 2\n*******\n  Name:                    gfx90c\n  Uuid:                    GPU-XX\n  Marketing Name:          AMD Radeon Graphics\n  Vendor Name:             AMD\n...\n</code></pre> <p>L'\u00e9tiquette gfx90c d\u00e9signe l'iGPU AMD Radeon Vega 8.</p> <p>- Cdes pour observer l'activit\u00e9 en temps r\u00e9el d'un iGPU AMD :</p> <pre><code>proxmox:~# apt install radeontop\nproxmox:~# radeontop\n</code></pre> <p>Touches CTRL+C pour quitter.</p> <p>- Cdes pour obtenir des informations sur la m\u00e9moire vid\u00e9o :</p> <pre><code>proxmox:~# cat /sys/class/drm/card1/device/mem_info_vram_total\nproxmox:~# cat /sys/class/drm/card1/device/mem_info_vram_used\n</code></pre> <p>Retours :</p> <pre><code>3221225472  # 3 Go de VRAM allou\u00e9\n154243072   # 150 Mo de VRAM utilis\u00e9\n</code></pre> <p>- Cde pour obtenir le nom du pilote graphique exploit\u00e9 :</p> <pre><code>proxmox:~# lspci -k | grep -A 3 \"VGA\"\n</code></pre> <p>Retour :</p> <pre><code>04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Lucienne (rev c1)\n  Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Lucienne\n  Kernel driver in use: amdgpu\n  Kernel modules: amdgpu\n</code></pre> <p>Les firmwares des GPU de marque AMD sont stock\u00e9s dans le dossier /lib/firmware/amdgpu/.</p> <p>- Cdes pour obtenir les ID des groupes video et render :</p> <pre><code>proxmox:~# cat /etc/group | grep video\nproxmox:~# cat /etc/group | grep render\n</code></pre> <p>Retours :</p> <pre><code>44\n104\n</code></pre> <p>- Cde pour obtenir la version courante de Python :</p> <pre><code>proxmox:~# python3 --version\n</code></pre> <p>Retour :</p> <pre><code>Python 3.11.2\n</code></pre>"},{"location":"informatique/ia---comfyui-sur-proxmox/#conteneur-lxc-ubuntu-comfyui","title":"Conteneur LXC ubuntu-comfyui","text":"<p>Attention aux tailles des disques</p> <p>Pr\u00e9voir une taille de disque dur sup\u00e9rieure de 20 Go par rapport \u00e0 celle du conteneur Ollama soit 140 Go.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-creation","title":"- Cr\u00e9ation","text":"<p>Acc\u00e9dez \u00e0 l'interface Web de Proxmox et cr\u00e9ez le conteneur en ex\u00e9cutant le script tteck suivant depuis la console du noeud Proxmox :</p> <pre><code>bash -c \"$(wget -qLO - https://github.com/tteck/Proxmox/raw/main/ct/ubuntu.sh)\"\n</code></pre> <p>Un menu d\u00e9di\u00e9 au script s'ouvre, acc\u00e9dez au mode avanc\u00e9 puis S\u00e9lectionnez ou Entrez : - L'OS Ubuntu 22.04 Jammy - Un conteneur LXC privil\u00e9gi\u00e9 - Le MDP de l'utilisateur root - L'ID du conteneur Ex: 113 - Le nom d'h\u00f4te Ex: ubuntu-comfyui - La taille du disque dur Ex: 140 Go - Le nombre de coeurs allou\u00e9 au conteneur Ex: 6 - La taille de la RAM Ex: 10000 Mo - Le bridge r\u00e9seau vmbr0 - Une adresse IP statique de la forme 192.168.x.y/24 - L'IP de la gateway Ex: 192.168.x.z - La d\u00e9sactivation de l'IPV6 - L'IP de votre serveur DNS local Ex: 192.168.x.z - La validation d'un acc\u00e8s SSH en tant que root - Le mode verbeux pour suivre la cr\u00e9ation du conteneur</p> <p>Si tout se passe bien :</p> <pre><code>...\nLecture des informations d'\u00e9tat... Fait      \n \u2713 Cleaned\n \u2713 Completed Successfully!\n</code></pre> <p>Lancez ensuite une connexion SSH sur le conteneur et mettez \u00e0 jour le syst\u00e8me Ubuntu :</p> <pre><code>root@ubuntu-comfyui:~# apt update\nroot@ubuntu-comfyui:~# apt upgrade\n</code></pre> <p>V\u00e9rifiez la version du noyau linux de l'h\u00f4te Proxmox :</p> <pre><code>root@ubuntu-comfyui:~# uname -r\n</code></pre> <p>Retour :</p> <pre><code>6.8.12-8-pve\n</code></pre> <p>Contr\u00f4lez la version courante de Python :</p> <pre><code>root@ubuntu-comfyui:~# python3 --version\n</code></pre> <p>Retour possible :</p> <pre><code>Python 3.12.8\n</code></pre> <p>V\u00e9rifiez pour finir les ID des groupes video et render :</p> <pre><code>root@ubuntu-comfyui:~# cat /etc/group | grep -w 'render\\|\\video'\n</code></pre> <p>retour :</p> <pre><code>video:x:44\nrender:x:108\n</code></pre>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-comfyui-et-python","title":"- ComfyUI et Python","text":"<p>Python est essentiel pour ComfyUI en raison de sa capacit\u00e9 \u00e0 automatiser, \u00e9tendre et simplifier l'ex\u00e9cution des flux de travail.</p> <p>Site de r\u00e9f\u00e9rence : Anaconda</p> <p>Installez Miniconda, outil qui permettra de cr\u00e9er l'environnement virtuel Python d\u00e9di\u00e9 \u00e0 ComfyUI :</p> <pre><code>root@ubuntu-comfyui:~# cd /root\n~# mkdir miniconda3\n~# cd miniconda3\n\n~# wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh\n\n~# mv Miniconda3-latest-Linux-x86_64.sh miniconda.sh\n~# bash miniconda.sh -b -u -p /root/miniconda3\n~# rm miniconda.sh\n</code></pre> <p>Editez ensuite le fichier .bashrc de l'utilisateur root :</p> <pre><code>root@ubuntu-comfyui:~# cd /root\nroot@ubuntu-comfyui:~# nano .bashrc\n</code></pre> <p>et ajoutez en fin de celui-ci le chemin vers la Cde conda :</p> <pre><code># Ajout du chemin d'acc\u00e8s au programme conda\nexport PATH=/root/miniconda3/bin:$PATH\n</code></pre> <p>Fermez la connexion SSH courante afin de tester la modification, ouvrez en une autre, puis :</p> <pre><code>root@ubuntu-comfyui:~# conda --version\n</code></pre> <p>Retour :</p> <pre><code>conda 25.1.1\n</code></pre> <p>Enfin, cr\u00e9ez l'environnement dans une version Python compatible avec ComfyUI telle la 3.12 :</p> <pre><code>root@ubuntu-comfyui:~# cd /root/miniconda3/bin\nroot@ubuntu-comfyui:~# conda create --prefix /root/miniconda3/envs/comfyenv python=3.12\nroot@ubuntu-comfyui:~# conda init --all\n</code></pre> <p>La derni\u00e8re Cde modifie automatiquement le fichier .bashrc et il est possible de retirer les 2 lignes ajout\u00e9es pr\u00e9c\u00e9demment.</p> <p>Fermez de nouveau la connexion SSH courante, ouvrez en une autre, puis activez le nouvel environnement :</p> <pre><code>root@ubuntu-comfyui:~# cd /root\nroot@ubuntu-comfyui:~# conda activate comfyenv\n(comfyenv) root@ubuntu-comfyui:~#\n</code></pre> <p>Le prompt change, gardez l'environnement Python ouvert.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-rocmtm","title":"- ROCm\u2122","text":"<p>1) ROCm\u2122 (Radeon Open Compute) est n\u00e9cessaire pour tirer parti des capacit\u00e9s de calcul du GPU AMD et doit \u00eatre install\u00e9 dans le conteneur.</p> <p>Site de r\u00e9f\u00e9rence : ROCm</p> <p>Installez celui-ci \u00e0 l'aide du script amdgpu-install :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# cd /root\n(comfyenv) root@ubuntu-comfyui:~# wget https://repo.radeon.com/amdgpu-install/6.3.2/ubuntu/jammy/amdgpu-install_6.3.60302-1_all.deb\n\n(comfyenv) root@ubuntu-comfyui:~# dpkg -i amdgpu-install_6.3.60302-1_all.deb\n(comfyenv) root@ubuntu-comfyui:~# amdgpu-install --no-dkms --usecase=graphics,rocm,opencl -y\n(comfyenv) root@ubuntu-comfyui:~# rm amdgpu-install_6.3.60302-1_all.deb\n</code></pre> <p>L'installation de ROCm 6.3.2 doit se d\u00e9rouler sans \u00e9chec.</p> <p>Le flag --no-dkms \u00e9vite d'installer les pilotes du noyau linux, car ceux-ci sont d\u00e9j\u00e0 install\u00e9s sur l'h\u00f4te Proxmox.</p> <p>2) Le bon fonctionnement de ROCm n\u00e9cessite de d\u00e9finir une variable d'environnement.</p> <p>Pour cela, \u00e9ditez le fichier .bashrc :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# nano /root/.bashrc\n</code></pre> <p>et ajoutez ce contenu en fin de fichier :</p> <pre><code># Gestion du GPU gfx90c\nexport HSA_OVERRIDE_GFX_VERSION=9.0.0\n</code></pre> <p>3) L'acc\u00e8s direct aux ressources du GPU physique de l'h\u00f4te Proxmox n\u00e9cessite de g\u00e9rer le GPU Passthrough.</p> <p>Depuis Proxmox, \u00e9ditez la configuration du conteneur :</p> <pre><code>proxmox:~# nano /etc/pve/lxc/id-du-conteneur.conf\n</code></pre> <p>et ajoutez sous la ligne cores: 10 le contenu suivant :</p> <pre><code>...\ncores: 10\ndev0: /dev/kfd,gid=44,uid=0\ndev1: /dev/dri/renderD128,gid=108,uid=0\n...\n</code></pre> <p>Sur l'interface graphique de Proxmox, les nouveaux param\u00e8tres apparaissent dans les Ressources du conteneur.</p> <p>Pour finir, red\u00e9marrez le conteneur <code>ubuntu-comfyui</code>.</p> <p>4) Contr\u00f4les</p> <p>Ouvrez une connexion SSH et testez les Cdes suivantes :</p> <pre><code>(base) root@ubuntu-comfyui:~# conda activate comfyenv\n(comfyenv) root@ubuntu-comfyui:~# python3 --version\n(comfyenv) root@ubuntu-comfyui:~# rocminfo\n(comfyenv) root@ubuntu-comfyui:~# rocm-smi\n(comfyenv) root@ubuntu-comfyui:~# clinfo\n</code></pre> <p>Installez le paquet radeontop et testez son fonctionnement :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# apt install radeontop\n(comfyenv) root@ubuntu-comfyui:~# radeontop\n</code></pre> <p>Touches CTRL+C pour quitter.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-pytorch","title":"- PyTorch","text":"<p>PyTorch permet entres autres d'ex\u00e9cuter des calculs intensifs sur les GPU, ce qui est crucial pour des t\u00e2ches comme la g\u00e9n\u00e9ration d'images \u00e0 partir de mod\u00e8les de diffusion.</p> <p>Sans PyTorch, ces calculs seraient bien plus lents, car ils se feraient uniquement sur le CPU.</p> <p>Site de r\u00e9f\u00e9rence : PyTorch</p> <p>Le bon fonctionnement de Pytorch n\u00e9cessite de d\u00e9finir une variable d'environnement.</p> <p>Pour cela, \u00e9ditez le fichier .bashrc :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# nano /root/.bashrc\n</code></pre> <p>et ajoutez ceci sous export ..._GFX_VERSION=9.0.0 :</p> <pre><code># Gestion du GPU gfx90c\nexport HSA_OVERRIDE_GFX_VERSION=9.0.0\nexport PYTORCH_ROCM_ARCH=gfx900 \n</code></pre> <p>Fermez la connexion SSH courante, ouvrez en une autre, puis installez PyTorch comme suit :</p> <pre><code>(base) root@ubuntu-comfyui:~# cd /root\n(base) root@ubuntu-comfyui:~# conda activate comfyenv\n\n(comfyenv) root@ubuntu-comfyui:~# wget https://repo.radeon.com/rocm/manylinux/rocm-rel-6.3.2/torch-2.4.0%2Brocm6.3.2-cp312-cp312-linux_x86_64.whl\n\n(comfyenv) root@ubuntu-comfyui:~# wget https://repo.radeon.com/rocm/manylinux/rocm-rel-6.3.2/torchvision-0.19.0%2Brocm6.3.2-cp312-cp312-linux_x86_64.whl\n\n(comfyenv) root@ubuntu-comfyui:~# wget https://repo.radeon.com/rocm/manylinux/rocm-rel-6.3.2/pytorch_triton_rocm-3.0.0%2Brocm6.3.2.75cc27c26a-cp312-cp312-linux_x86_64.whl\n\n(comfyenv) root@ubuntu-comfyui:~# wget https://repo.radeon.com/rocm/manylinux/rocm-rel-6.3.2/torchaudio-2.4.0%2Brocm6.3.2-cp312-cp312-linux_x86_64.whl\n\n(comfyenv) root@ubuntu-comfyui:~# pip3 uninstall torch torchvision torchaudio pytorch-triton-rocm\n\n(comfyenv) root@ubuntu-comfyui:~# pip3 install torch-2.4.0+rocm6.3.2-cp312-cp312-linux_x86_64.whl torchvision-0.19.0+rocm6.3.2-cp312-cp312-linux_x86_64.whl torchaudio-2.4.0+rocm6.3.2-cp312-cp312-linux_x86_64.whl pytorch_triton_rocm-3.0.0+rocm6.3.2.75cc27c26a-cp312-cp312-linux_x86_64.whl\n\n(comfyenv) root@ubuntu-comfyui:~# rm *.whl\n</code></pre> <p>L'installation doit se d\u00e9rouler sans \u00e9chec.</p> <p>Testez l'installation de PyTorch \u00e0 l'aide du script ci-dessous :</p> <pre><code>(comfyenv) root@debian-comfyui:~# python3\n&gt;&gt;&gt; import torch\n&gt;&gt;&gt; print(torch.cuda.is_available())\n&gt;&gt;&gt; print(torch.cuda.get_device_name(torch.cuda.current_device()))\n</code></pre> <p>Les print renvoient True et le nom du GPU situ\u00e9 sur l'h\u00f4te. CTRL+D pour quitter Python.  </p> <p>Tests compl\u00e9mentaires :</p> <pre><code>(comfyenv) root@debian-comfyui:~# cd /root\n(comfyenv) root@debian-comfyui:~# python3 -c 'import torch' 2&gt; /dev/null &amp;&amp; echo 'Success' || echo 'Failure'\n</code></pre> <p>Retour :</p> <pre><code>Success\n</code></pre> <pre><code>(comfyenv) root@debian-comfyui:~# pip show torch\n</code></pre> <p>Retour :</p> <pre><code>Name: torch\nVersion: 2.4.0+rocm6.3.2\nSummary: Tensors and Dynamic neural networks in Python with strong GPU acceleration\nHome-page: https://pytorch.org/\nAuthor: PyTorch Team\nAuthor-email: packages@pytorch.org\nLicense: BSD-3\nLocation: /root/miniconda3/envs/comfyenv/lib/python3.12/site-packages\nRequires: filelock, fsspec, jinja2, networkx, pytorch-triton-rocm, setuptools, sympy, typing-extensions\nRequired-by: torchaudio, torchvision\n</code></pre>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-installation-de-comfyui","title":"- Installation de ComfyUI","text":"<p>Installez si besoin le paquet git et clonez le d\u00e9pot suivant :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# cd /root\n(comfyenv) root@ubuntu-comfyui:~# git clone https://github.com/comfyanonymous/ComfyUIls\n</code></pre> <p>Puis, installez ComfyUI comme suit :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# cd /root/ComfyUI\n(comfyenv) root@ubuntu-comfyui:~# pip3 install -r requirements.txt\n</code></pre> <p>Ajoutez ensuite l'utilisateur root aux groupes video et render.</p> <pre><code>root@ubuntu-comfyui:~# usermod -aG video root\nroot@ubuntu-comfyui:~# usermod -aG render root\n</code></pre> <p>Lancez enfin le serveur ComfyUI comme suit :</p> <pre><code>(comfyenv) root@ubuntu-comfyui:~# cd /root/ComfyUI\n(comfyenv) root@ubuntu-comfyui:~# HSA_OVERRIDE_GFX_VERSION=9.0.0 python main.py --listen 0.0.0.0\n</code></pre> <p>et ouvrez depuis un navigateur Web local l'URL <code>http://ip-ubuntu-comfyui:8188</code>.</p> <p>Red\u00e9marrez le conteneur depuis Proxmox et cr\u00e9ez le fichier suivant qui sera utilis\u00e9 par la suite pour d\u00e9marrer automatiquement le serveur de ComfyUI :</p> <pre><code>(base) root@ubuntu-comfyui:~# cd /root\n(base) root@ubuntu-comfyui:~# nano start_comfyui.sh\n</code></pre> <p>Entrez le contenu suivant :</p> <pre><code>#!/bin/bash\n\n# Activation de l'environnement conda de nom comfyenv\nsource /root/miniconda3/etc/profile.d/conda.sh\nconda activate /root/miniconda3/envs/comfyenv\n\n# D\u00e9marrage du serveur ComfyUI\nexport GIT_PYTHON_GIT_EXECUTABLE=/usr/bin/git\ncd /root/ComfyUI\nHSA_OVERRIDE_GFX_VERSION=9.0.0 python main.py --listen 0.0.0.0\n</code></pre> <p>Puis, rendez le fichier ex\u00e9cutable :</p> <pre><code>(base) root@ubuntu-comfyui:~# chmod +x start_comfyui.sh\n</code></pre> <p>Cr\u00e9ez un fichier de service Systemd pour ComfyUI :</p> <pre><code>(base) root@ubuntu-comfyui:~# nano /etc/systemd/system/comfyui.service\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription=ComfyUI Service\nAfter=network.target\n\n[Service]\nEnvironment=PATH=/root/miniconda3/bin\nExecStart=/root/start_comfyui.sh\nWorkingDirectory=/root/ComfyUI\nStandardOutput=inherit\nStandardError=inherit\nRestart=always\nUser=root\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>D\u00e9marrez le service :</p> <pre><code>(base) root@ubuntu-comfyui:~# systemctl daemon-reload\n(base) root@ubuntu-comfyui:~# systemctl start comfyui\n(base) root@ubuntu-comfyui:~# systemctl status comfyui\n</code></pre> <p>Si le statut est bon, validez le d\u00e9marrage automatique :</p> <pre><code>(base) root@ubuntu-comfyui:~# systemctl enable comfyui\n</code></pre> <p>Pour finir, red\u00e9marrez le conteneur et testez de nouveau l'URL <code>http://ip-ubuntu-comfyui:8188</code>.</p> <p>L'interface graphique affiche alors un flux de travail par d\u00e9faut nomm\u00e9 Unsave Workflow.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-comfyui-manager","title":"- ComfyUI Manager","text":"<p>ComfyUI Manager offre une interface conviviale pour g\u00e9rer les n\u0153uds personnalis\u00e9s, les mod\u00e8les, les MAJ, etc...</p> <p>Installez ce noeud personnalis\u00e9 comme suit :</p> <pre><code>(base) root@ubuntu-comfyui:~# cd ComfyUI/custom_nodes\n(base) root@ubuntu-comfyui:~# git clone https://github.com/ltdrdata/ComfyUI-Manager comfyui-manager\n</code></pre> <p>Puis, red\u00e9marrez le conteneur et v\u00e9rifiez la pr\u00e9sence de ComfyUI Manager dans la barre de menus de l'interface Web de ComfyUI.</p> <p>Pour info, l'un de mes flux de travail a n\u00e9cessit\u00e9 pour interagir avec les mod\u00e8les d'Ollama d'installer depuis le ComfyUI Manager les \u00e9l\u00e9ments suivants :</p> <p>Noeuds personnalis\u00e9s : - ComfyUI-Easy-Use - ComfyUI-IF_AI_tools - comfyui-ollama</p> <p>Mod\u00e8le : - v1-5-pruned-emaonly.ckpt</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#-mise-a-jour-de-comfyui","title":"- Mise \u00e0 jour de ComfyUI","text":"<p>La mise \u00e0 jour peut s'effectuer en cliquant directement sur le bouton Update ComfyUI du ComfyUI Manager.</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#glances-sur-proxmox","title":"Glances sur Proxmox","text":"<p>Glances peut afficher en temps r\u00e9el l'utilisation des CPU et GPU, l'utilisation des m\u00e9moires syst\u00e8me et GPU ainsi que les temp\u00e9ratures des uns et des autres, le tout sur une seule page accessible depuis un navigateur Web.</p> <p>Avant de l'installer, v\u00e9rifiez la pr\u00e9sence sur l'h\u00f4te Proxmox des paquets psutils et lm-sensors, \u00e0 d\u00e9faut ajoutez les.</p> <p>Puis, proc\u00e9dez ainsi pour installer Glances :</p> <pre><code>proxmox:~# bash -c \"$(wget -qLO - https://github.com/community-scripts/ProxmoxVE/raw/main/misc/glances.sh)\"\n</code></pre> <p>Le m\u00eame script peut-\u00eatre lanc\u00e9 pour d\u00e9sinstaller Glances par la suite.</p> <p>Une fois install\u00e9, ouvrez le port 61208 sur Proxmox et testez l'URL <code>http://ip-proxmox:61208</code>.</p> <p>Testez la Cde suivante :</p> <pre><code>proxmox:~# glances -V\n</code></pre> <p>Celle-ci doit retourner le chemin du fichier glances.log.</p> <p>Copiez le fichier /usr/local/share/doc/glances/glances.conf dans /etc/glances :</p> <pre><code>proxmox:~# mkdir /etc/glances\nproxmox:~# cp /usr/local/share/doc/glances/glances.conf /etc/glances/\n</code></pre> <p>Editez ensuite la configuration :</p> <pre><code>proxmox:~# nano /etc/glances/glances.conf\n</code></pre> <p>et modifiez la ligne suivante :</p> <pre><code> # Available stats are: cpu,mem,load,swap\n list=cpu,mem,load\n</code></pre> <p>comme suit :</p> <pre><code> # Available stats are: cpu,mem,load,swap\n list=cpu,mem,load,swap\n</code></pre> <p>Red\u00e9marrez le service glances et observez le r\u00e9sulat dans la page Web de Glances.</p> <pre><code>proxmox:~# systemctl restart glances\n</code></pre> <p>Quelques remarques concernant le tableau de bord affich\u00e9 :</p> <p>- Composite, Sensor 1,2 et 8 = Temp\u00e9ratures du dique nvme-pci - Tctl = Temp\u00e9rature du CPU Ryzen (k10temp-pci-00c3) - edge = temperature du GPU</p>"},{"location":"informatique/ia---comfyui-sur-proxmox/#remarques-diverses","title":"Remarques diverses","text":"<p>ComfyUI peut se connecter sur des mod\u00e8les LLM d'Ollama comme Gemma, Llama et LLaVa en exploitant le noeud personnalis\u00e9 ComfyUI-IF_AI_tools.</p> <p>Ci-dessous, chemins du menu contextuel pour ajouter des noeuds personnalis\u00e9s dans l'espace workflow de ComfyUI :</p> <p>- Ajout du noeud IF Prompt Maker : =&gt; Add Node =&gt; ImpactFrames =&gt; IF_tools =&gt; IF Prompt Maker (Remplace le IF Prompt to Prompt)</p> <p>Le noeud IF Prompt Maker est un outil de g\u00e9n\u00e9ration de prompts pour Stable Diffusion, permettant d'am\u00e9liorer la composition et l'exactitude des prompts.</p> <p>- Ajout du noeud Point de contr\u00f4le : =&gt; Add Node =&gt; Chargeurs =&gt; Charger Point de Contr\u00f4le</p> <p>Le noeud Point de contr\u00f4le est un mod\u00e8le essentiel utilis\u00e9 par Stable Diffusion pour g\u00e9n\u00e9rer des images.</p> <p>- Ajout du noeud Charger VAE : =&gt; Add Node =&gt; Chargeurs =&gt; Charger VAE</p> <p>Le noeud VAE (Variational AutoEncoder) encode les images en repr\u00e9sentations latentes, permettant une compression efficace des caract\u00e9ristiques visuelles.</p> <p>- Ajout du noeud IF Save Text : =&gt; Add Node =&gt; ImpactFrames =&gt; IF_tools =&gt; IF Save Text</p> <p>Le noeud IF Save Text permet de sauvegarder du texte dans diff\u00e9rents formats (CSV, TXT, JSON) selon le mode de sauvegarde choisi.</p> <p>- Ajout du noeud KSampler : =&gt; Add Node =&gt; \u00e9chantillonage =&gt; KSampler</p> <p>Le noeud KSampler est essentiel pour l'\u00e9chantillonnage dans la g\u00e9n\u00e9ration d'images, permettant d'affiner progressivement la qualit\u00e9 des images \u00e0 travers plusieurs \u00e9tapes.</p> <p>- Ajout du noeud CLIP Text Encode : =&gt; Add Node =&gt; conditionnement =&gt; CLIP Text Encode</p> <p>Le n\u0153ud CLIPTextEncode encode les entr\u00e9es textuelles en utilisant un mod\u00e8le CLIP, facilitant la transformation du texte en vecteurs pour le conditionnement des mod\u00e8les g\u00e9n\u00e9ratifs.</p> <p>Options Clic droit sur le noeud : =&gt; menu contextuel =&gt; Colors =&gt; Convert Widget to Input =&gt; Convert text to input</p> <p>- Ajout du noeud Image Latente Vide : =&gt; Add Node =&gt; latent =&gt; Image Latente Vide</p> <p>Le noeud Image Latente Vide sert de point de d\u00e9part pour la g\u00e9n\u00e9ration et la manipulation d'images dans l'espace latent.</p> <p>- Ajout du noeud VAE Decode : =&gt; Add Node =&gt; latent =&gt; VAE Decode</p> <p>Le n\u0153ud VAE Decode transforme les repr\u00e9sentations latentes en images, permettant ainsi de visualiser les donn\u00e9es encod\u00e9es.</p> <p>- Ajout du noeud Enregistrer Image : =&gt; Add Node =&gt; image =&gt; Enregistrer Image</p> <p>Le n\u0153ud Enregistrer Image permet d'enregistrer des images g\u00e9n\u00e9r\u00e9es dans le dossier ComfyUI/output/.</p> <p>D'autres noeuds peuvent \u00eatre ajout\u00e9s dans le flux de travail permettant ainsi d'obtenir le r\u00e9sultat souhait\u00e9 en mati\u00e8re de g\u00e9n\u00e9ration d'images depuis un texte.</p> <p>Fin.</p>"},{"location":"informatique/ia---ollama-sur-proxmox/","title":"IA - Ollama sur Proxmox","text":""},{"location":"informatique/ia---ollama-sur-proxmox/#intelligence-artificielle","title":"Intelligence Artificielle","text":"<p>L'outil Ollama d\u00e9mocratise l'acc\u00e8s aux mod\u00e8les de langage de grande taille (LLMs) en permettant aux utilisateurs de les ex\u00e9cuter localement.</p> <p>Les mod\u00e8les t\u00e9l\u00e9charg\u00e9s peuvent \u00eatre personnalis\u00e9s et affin\u00e9s afin de r\u00e9pondre \u00e0 des objectifs pr\u00e9cis.</p>"},{"location":"informatique/ia---ollama-sur-proxmox/#base-de-travail","title":"Base de travail","text":"<p>Un CPU AMD Ryzen 7500U, 32 Go de RAM et une puce graphique int\u00e9gr\u00e9e (iGPU) AMD Radeon Vega 8.</p> <p>L'Architecture de M\u00e9moire Unifi\u00e9e est activ\u00e9e dans le BIOS, l'iGPU et le CPU partagent ainsi le m\u00eame espace RAM ce qui augmente l'efficacit\u00e9 de traitement des grandes quantit\u00e9s de donn\u00e9es exig\u00e9e par l'utilisation de l'Intelligence Artificielle.</p> <p>Syst\u00e8me d'exploitation Proxmox 8.3.3 incluant un noyau linux 6.8.12.8-pve.</p> <p>Ci-dessous, quelques Cdes utiles pour appr\u00e9hender la suite :</p> <p>- Cdes pour obtenir les informations d'un iGPU AMD :</p> <pre><code>proxmox:~# apt install rocminfo\nproxmox:~# rocminfo\n</code></pre> <p>Retour :</p> <pre><code>...\nAgent 2\n*******\n  Name:                    gfx90c\n  Uuid:                    GPU-XX\n  Marketing Name:          AMD Radeon Graphics\n  Vendor Name:             AMD\n...\n</code></pre> <p>L'\u00e9tiquette gfx90c d\u00e9signe l'iGPU AMD Radeon Vega 8.</p> <p>- Cdes pour observer l'activit\u00e9 en temps r\u00e9el d'un iGPU AMD :</p> <pre><code>proxmox:~# apt install radeontop\nproxmox:~# radeontop\n</code></pre> <p>Touches CTRL+C pour quitter.</p> <p>- Cdes pour obtenir des informations sur la m\u00e9moire vid\u00e9o :</p> <pre><code>proxmox:~# cat /sys/class/drm/card1/device/mem_info_vram_total\nproxmox:~# cat /sys/class/drm/card1/device/mem_info_vram_used\n</code></pre> <p>Retours :</p> <pre><code>3221225472  # 3 Go de VRAM allou\u00e9\n154243072   # 150 Mo de VRAM utilis\u00e9\n</code></pre> <p>- Cde pour obtenir le nom du pilote graphique exploit\u00e9 :</p> <pre><code>proxmox:~# lspci -k | grep -A 3 \"VGA\"\n</code></pre> <p>Retour :</p> <pre><code>04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Lucienne (rev c1)\n  Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Lucienne\n  Kernel driver in use: amdgpu\n  Kernel modules: amdgpu\n</code></pre> <p>Les firmwares des GPU de marque AMD sont stock\u00e9s dans le dossier /lib/firmware/amdgpu/.</p> <p>- Cdes pour obtenir les ID des groupes video et render :</p> <pre><code>proxmox:~# cat /etc/group | grep video\nproxmox:~# cat /etc/group | grep render\n</code></pre> <p>Retours :</p> <pre><code>44\n104\n</code></pre> <p>- Cde pour obtenir la version courante de Python :</p> <pre><code>proxmox:~# python3 --version\n</code></pre> <p>Retour :</p> <pre><code>Python 3.11.2\n</code></pre>"},{"location":"informatique/ia---ollama-sur-proxmox/#conteneur-lxc-ubuntu-ollama","title":"Conteneur LXC ubuntu-ollama","text":""},{"location":"informatique/ia---ollama-sur-proxmox/#-creation","title":"- Cr\u00e9ation","text":"<p>Acc\u00e9dez \u00e0 l'interface Web de Proxmox et cr\u00e9ez le conteneur en ex\u00e9cutant le script tteck suivant depuis la console du noeud Proxmox :</p> <pre><code>bash -c \"$(wget -qLO - https://github.com/tteck/Proxmox/raw/main/ct/ubuntu.sh)\"\n</code></pre> <p>Un menu d\u00e9di\u00e9 au script s'ouvre, acc\u00e9dez au mode avanc\u00e9 puis S\u00e9lectionnez ou Entrez : - L'OS Ubuntu 22.04 Jammy - Un conteneur LXC privil\u00e9gi\u00e9 - Le MDP de l'utilisateur root - L'ID du conteneur Ex: 112 - Le nom d'h\u00f4te Ex: ubuntu-ollama - La taille du disque dur Ex: 120 Go - Le nombre de coeurs allou\u00e9 au conteneur Ex: 10 - La taille de la RAM Ex: 6000 Mo - Le bridge r\u00e9seau vmbr0 - Une adresse IP statique de la forme 192.168.x.y/24 - L'IP de la gateway  Ex: 192.168.x.z - La d\u00e9sactivation de l'IPV6 - L'IP de votre serveur DNS local Ex: 192.168.x.z - La validation d'un acc\u00e8s SSH en tant que root - Le mode verbeux pour suivre la cr\u00e9ation du conteneur</p> <p>Si tout se passe bien :</p> <pre><code>...\nLecture des informations d'\u00e9tat... Fait      \n \u2713 Cleaned\n \u2713 Completed Successfully!\n</code></pre> <p>Lancez ensuite une connexion SSH sur le conteneur et mettez \u00e0 jour le syst\u00e8me Ubuntu :</p> <pre><code>root@ubuntu-ollama:~# apt update\nroot@ubuntu-ollama:~# apt upgrade\n</code></pre> <p>V\u00e9rifiez la version du noyau linux de l'h\u00f4te Proxmox :</p> <pre><code>root@ubuntu-ollama:~# uname -r\n</code></pre> <p>Retour :</p> <pre><code>6.8.12-8-pve\n</code></pre> <p>Contr\u00f4lez la version courante de Python :</p> <pre><code>root@ubuntu-ollama:~# python3 --version\n</code></pre> <p>Retour possible :</p> <pre><code>Python 3.12.9\n</code></pre> <p>V\u00e9rifiez pour finir les ID des groupes video et render :</p> <pre><code>root@ubuntu-ollama:~# cat /etc/group | grep -w 'render\\|\\video'\n</code></pre> <p>retour :</p> <pre><code>video:x:44\nrender:x:108\n</code></pre>"},{"location":"informatique/ia---ollama-sur-proxmox/#-ollama-et-python","title":"- Ollama et Python","text":"<p>Ollama offre une suite d\u2019outils compatibles avec Python et une API \u00e9tendue, ce qui permet de cr\u00e9er, g\u00e9rer et d\u00e9ployer des mod\u00e8les d\u2019IA.</p> <p>Site de r\u00e9f\u00e9rence : Anaconda</p> <p>Installez Miniconda, outil qui permettra de cr\u00e9er l'environnement virtuel Python d\u00e9di\u00e9 \u00e0 Ollama :</p> <pre><code>root@ubuntu-ollama:~# cd /root\n~# mkdir miniconda3\n~# cd miniconda3\n\n~# wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh\n\n~# mv Miniconda3-latest-Linux-x86_64.sh miniconda.sh\n~# bash miniconda.sh -b -u -p /root/miniconda3\n~# rm miniconda.sh\n</code></pre> <p>Editez ensuite le fichier .bashrc de l'utilisateur root :</p> <pre><code>root@ubuntu-ollama:~# cd /root\nroot@ubuntu-ollama:~# nano .bashrc\n</code></pre> <p>et ajoutez en fin de celui-ci le chemin vers la Cde conda :</p> <pre><code># Ajout du chemin d'acc\u00e8s au programme conda\nexport PATH=/root/miniconda3/bin:$PATH\n</code></pre> <p>Fermez la connexion SSH courante afin de tester la modification, ouvrez en une autre, puis :</p> <pre><code>root@ubuntu-ollama:~# conda --version\n</code></pre> <p>Retour :</p> <pre><code>conda 25.1.1\n</code></pre> <p>Enfin, cr\u00e9ez l'environnement dans une version Python compatible avec Ollama telle la 3.11.2 :</p> <pre><code>root@ubuntu-ollama:~# cd /root/miniconda3/bin\nroot@ubuntu-ollama:~# conda create --prefix /root/miniconda3/envs/ollamaenv python=3.11.2\nroot@ubuntu-ollama:~# conda init --all\n</code></pre> <p>La derni\u00e8re Cde modifie automatiquement le fichier .bashrc et il est possible de retirer les 2 lignes ajout\u00e9es pr\u00e9c\u00e9demment.</p> <p>Fermez de nouveau la connexion SSH courante, ouvrez en une autre, puis activez le nouvel environnement :</p> <pre><code>root@ubuntu-ollama:~# conda activate ollamaenv\n(ollamaenv) root@ubuntu-ollama:~#\n</code></pre> <p>Le prompt change, gardez l'environnement Python ouvert.</p>"},{"location":"informatique/ia---ollama-sur-proxmox/#-rocmtm","title":"- ROCm\u2122","text":"<p>1) ROCm\u2122 (Radeon Open Compute) est n\u00e9cessaire pour tirer parti des capacit\u00e9s de calcul du GPU AMD et doit \u00eatre install\u00e9 dans le conteneur.</p> <p>Site de r\u00e9f\u00e9rence : ROCm</p> <p>Installez celui-ci \u00e0 l'aide du script amdgpu-install :</p> <pre><code>(ollamaenv) root@ubuntu-ollama:~# cd /root\n(ollamaenv) root@ubuntu-collama:~# wget https://repo.radeon.com/amdgpu-install/6.3.2/ubuntu/jammy/amdgpu-install_6.3.60302-1_all.deb\n\n(ollamaenv) root@ubuntu-ollama:~# dpkg -i amdgpu-install_6.3.60302-1_all.deb\n(ollamaenv) root@ubuntu-ollama:~# amdgpu-install --no-dkms --usecase=graphics,rocm,opencl -y\n(ollamaenv) root@ubuntu-ollama:~# rm amdgpu-install_6.3.60302-1_all.deb\n</code></pre> <p>L'installation de ROCm 6.3.2 doit se d\u00e9rouler sans \u00e9chec.</p> <p>Le flag --no-dkms \u00e9vite d'installer les pilotes du noyau linux, car ceux-ci sont d\u00e9j\u00e0 g\u00e9r\u00e9s par l'h\u00f4te Proxmox.</p> <p>2) Le bon fonctionnement de ROCm n\u00e9cessite de d\u00e9finir une variable d'environnement.</p> <p>Pour cela, \u00e9ditez le fichier .bashrc :</p> <pre><code>(ollamaenv) root@ubuntu-ollama:~# nano /root/.bashrc\n</code></pre> <p>et ajoutez ce contenu en fin de fichier :</p> <pre><code># Gestion du GPU AMD Radeon gfx90c\nexport HSA_OVERRIDE_GFX_VERSION=9.0.0\n</code></pre> <p>3) L'acc\u00e8s direct aux ressources du GPU physique de l'h\u00f4te Proxmox n\u00e9cessite de g\u00e9rer le GPU Passthrough.</p> <p>Depuis Proxmox, \u00e9ditez la configuration du conteneur :</p> <pre><code>proxmox:~# nano /etc/pve/lxc/id-du-conteneur.conf\n</code></pre> <p>et ajoutez sous la ligne cores: 10 le contenu suivant :</p> <pre><code>...\ncores: 10\ndev0: /dev/kfd,gid=44,uid=0\ndev1: /dev/dri/renderD128,gid=108,uid=0\n...\n</code></pre> <p>Sur l'interface graphique de Proxmox, les nouveaux param\u00e8tres apparaissent dans les Ressources du conteneur.</p> <p>Pour finir, red\u00e9marrez le conteneur <code>ubuntu-ollama</code>.</p> <p>4) Contr\u00f4les</p> <p>Ouvrez une connexion SSH et testez les Cdes suivantes :</p> <pre><code>(base) root@ubuntu-ollama:~# conda activate ollamaenv\n(ollamaenv) root@ubuntu-ollama:~# python3 --version\n(ollamaenv) root@ubuntu-ollama:~# rocminfo\n(ollamaenv) root@ubuntu-ollama:~# rocm-smi\n(ollamaenv) root@ubuntu-ollama:~# clinfo\n</code></pre> <p>Installez le paquet radeontop et testez son fonctionnement :</p> <pre><code>(ollamaenv) root@ubuntu-ollama:~# apt install radeontop\n(ollamaenv) root@ubuntu-ollama:~# radeontop\n</code></pre> <p>Touches CTRL+C pour quitter.</p>"},{"location":"informatique/ia---ollama-sur-proxmox/#-installation-dollama","title":"- Installation d'Ollama","text":"<p>Site de r\u00e9f\u00e9rence : Ollama</p> <p>Installation manuelle :</p> <pre><code>(ollamaenv) root@ubuntu-ollama:~# cd /root\n(ollamaenv) root@ubuntu-ollama:~# curl -L https://ollama.com/download/ollama-linux-amd64.tgz -o ollama-linux-amd64.tgz\n(ollamaenv) root@ubuntu-ollama:~# tar -C /usr -xzf ollama-linux-amd64.tgz\n</code></pre> <p>D\u00e9marrez le serveur Ollama :</p> <pre><code>(ollamaenv) root@ubuntu-ollama:~# ollama serve\n</code></pre> <p>Ouvrez une seconde connexion SSH et v\u00e9rifiez la version :</p> <pre><code>(base) root@ubuntu-ollama:~# ollama -v\n</code></pre> <p>retour :</p> <pre><code>ollama version is 0.5.12\n</code></pre> <p>Cr\u00e9ez un utilisateur et un groupe pour Ollama :</p> <pre><code>(base) root@ubuntu-ollama:~# useradd -r -s /bin/false -U -m -d /usr/share/ollama ollama\n(base) root@ubuntu-ollama:~# usermod -a -G ollama $(whoami)\n</code></pre> <p>L'utilisateur root a \u00e9t\u00e9 ajout\u00e9 au groupe ollama.</p> <p>Ajoutez enfin l'utilisateur ollama aux groupes video et render :</p> <pre><code>(base) root@ubuntu-ollama:~# usermod -a -G video ollama\n(base) root@ubuntu-ollama:~# usermod -a -G render ollama\n</code></pre> <p>Cr\u00e9ez un fichier de service Systemd pour Ollama :</p> <pre><code>(base) root@ubuntu-ollama:~# nano /etc/systemd/system/ollama.service\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription=Ollama Service\nAfter=network-online.target\n\n[Service]\nExecStart=/usr/bin/ollama serve\nUser=ollama\nGroup=ollama\nRestart=always\nRestartSec=3\nEnvironment=\"PATH=/root/miniconda3/envs/ollamaenv/bin:/root/miniconda3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:\"\nEnvironment=\"OLLAMA_HOST=0.0.0.0\"\nEnvironment=\"HSA_OVERRIDE_GFX_VERSION=9.0.0\"\nEnvironment=\"ROCM_PATH=/opt/rocm\"\n\n[Install]\nWantedBy=default.target\n</code></pre> <p>Validez le d\u00e9marrage automatique du service :</p> <pre><code>(base) root@ubuntu-ollama:~# systemctl daemon-reload\n(base) root@ubuntu-ollama:~# systemctl enable ollama\n</code></pre> <p>Puis, red\u00e9marrez le conteneur et v\u00e9rifiez le statut d'Ollama :</p> <pre><code>(base) root@ubuntu-ollama:~# systemctl status ollama\n</code></pre> <p>R\u00e9sultat OK si appara\u00eet le nom du GPU soit gfx90c.</p> <p>Cdes Ollama utiles :</p> <ul> <li>ollama serve (d\u00e9marrage du serveur Ollama)</li> <li>ollama --version  </li> <li>ollama pull <code>nom-du-modele</code> (t\u00e9l\u00e9chargement)</li> <li>ollama list (liste des mod\u00e8les install\u00e9s)</li> <li>ollama run <code>nom-du-modele</code> (d\u00e9marrage) </li> <li>ollama stop <code>nom-du-modele</code> (arr\u00eat)</li> <li>ollama rm <code>nom-du-modele</code> (suppression)</li> </ul>"},{"location":"informatique/ia---ollama-sur-proxmox/#-mise-a-jour-dollama","title":"- Mise \u00e0 jour d'Ollama","text":"<p>Proc\u00e9dez ainsi :</p> <pre><code>(ollamaenv) root@ubuntu-ollama:~# cd /root\n(ollamaenv) root@ubuntu-ollama:~# curl -L https://ollama.com/download/ollama-linux-amd64.tgz -o ollama-linux-amd64.tgz\n(ollamaenv) root@ubuntu-ollama:~# tar -C /usr -xzf ollama-linux-amd64.tgz\n</code></pre>"},{"location":"informatique/ia---ollama-sur-proxmox/#-installation-dopen-webui","title":"- Installation d'Open WebUI","text":"<p>Open WebUI est une interface graphique pour Ollama.</p> <p>Site de r\u00e9f\u00e9rence : Open WebUI</p> <p>Pr\u00e9parez l'installation d'Open WebUI comme suit :</p> <pre><code>(base) root@ubuntu-ollama:~# cd /root\n(base) root@ubuntu-ollama:~# conda create -n openwebuienv python=3.11.2\n(base) root@ubuntu-ollama:~# conda activate openwebuienv\n(openwebuienv) root@ubuntu-ollama:~#\n</code></pre> <p>Installez Open WebUI :</p> <pre><code>(openwebuienv) root@ubuntu-ollama:~# pip install open-webui\n</code></pre> <p>L'installation doit se d\u00e9rouler sans \u00e9chec.</p> <p>D\u00e9marrez ensuite le serveur d'Open WebUI :</p> <pre><code>(openwebuienv) root@ubuntu-ollama:~# open-webui serve\n</code></pre> <p>Le premier d\u00e9marrage peut \u00eatre assez long car il semble impliquer par d\u00e9faut le t\u00e9l\u00e9chargement d'un certain nombre de mod\u00e8les, Ex: model.safetensorrs, model_03.onnx, etc...</p> <p>Une fois termin\u00e9, ouvrez depuis un navigateur Web local l'URL <code>http://ip-ubuntu-ollama:8080</code> et cr\u00e9ez le compte administrateur comme demand\u00e9.</p> <p>Red\u00e9marrez le conteneur depuis Proxmox et cr\u00e9ez le fichier suivant qui sera utilis\u00e9 par la suite pour lancer automatiquement le serveur d'Open WebUI :</p> <pre><code>(base) root@ubuntu-ollama:~# nano /root/start_open-webui.sh\n</code></pre> <p>Entrez le contenu suivant :</p> <pre><code>#!/bin/bash\n\n# Activer l'environnement Conda de nom openwebuienv\nsource /root/miniconda3/etc/profile.d/conda.sh\nconda activate /root/miniconda3/envs/openwebuienv\n\n# D\u00e9marrage du serveur Open WebUI\nopen-webui serve\n</code></pre> <p>Puis, rendez le fichier ex\u00e9cutable :</p> <pre><code>(base) root@ubuntu-ollama:~# chmod +x start_open-webui.sh\n</code></pre> <p>Cr\u00e9ez un fichier de service Systemd pour Open WebUI :</p> <pre><code>(base) root@ubuntu-ollama:~# nano /etc/systemd/system/openwebui.service\n</code></pre> <p>et entrez le contenu suivant :</p> <pre><code>[Unit]\nDescription=Open WebUI Service\nAfter=network.target\n\n[Service]\nType=simple\nExecStart=/root/start_open-webui.sh\nRestart=always\nRestartSec=3\n\n[Install]\nWantedBy=multi-user.target\n</code></pre> <p>D\u00e9marrez le service :</p> <pre><code>(base) root@ubuntu-ollama:~# systemctl daemon-reload\n(base) root@ubuntu-ollama:~# systemctl start openwebui\n(base) root@ubuntu-ollama:~# systemctl status openwebui\n</code></pre> <p>Si le statut est bon, validez le d\u00e9marrage automatique :</p> <pre><code>(base) root@ubuntu-ollama:~# systemctl enable openwebui\n</code></pre> <p>Pour finir, red\u00e9marrez le conteneur et testez de nouveau l'URL <code>http://ip-ubuntu-ollama:8080</code>.</p>"},{"location":"informatique/ia---ollama-sur-proxmox/#-ajout-de-modeles-dia","title":"- Ajout de mod\u00e8les d'IA","text":"<p>Nota</p> <p>Le site ollama.com peut \u00eatre utilis\u00e9 pour d\u00e9couvrir les Cdes de t\u00e9l\u00e9chargement des mod\u00e8les.</p> <p>T\u00e9l\u00e9chargez par exemple le mod\u00e8le Mistral 7B comme suit :</p> <pre><code>(base) root@ubuntu-ollama:~# ollama pull mistral\n(base) root@ubuntu-ollama:~# ollama list\n</code></pre> <p>Les mod\u00e8les sont install\u00e9s dans le dossier /usr/share/ollama/.ollama/models/blobs/.</p> <p>Ouvrez ensuite la pabe Web d'Open WebUI et jouez en testant le mod\u00e8le de Mistral.</p> <p>D'autres mod\u00e8les peuvent \u00eatre install\u00e9s et test\u00e9s, tels :</p> <ul> <li>falcon2 11b, quantization Q4_0, Technology Innovation Institute</li> <li>llama3 8b, quantization Q4_0, Meta </li> <li>llava-llama3 8b, quantization Q4_K_M, XTuner</li> <li>gemma2 2b, quantization Q4_0, Google </li> <li>phi3 4b, quantization Q4_0, Microsoft</li> </ul>"},{"location":"informatique/ia---ollama-sur-proxmox/#-mise-a-jour-dopen-webui","title":"- Mise \u00e0 jour d'Open WebUI","text":"<p>Proc\u00e9dez ainsi :</p> <pre><code>(base) root@ubuntu-ollama:~# cd /root/miniconda3/envs/openwebuienv\n(base) root@ubuntu-ollama:~# conda activate openwebuienv\n(openwebuienv) root@ubuntu-ollama:~# systemctl stop openwebui\n(openwebuienv) root@ubuntu-ollama:~# pip install --upgrade open-webui\n(openwebuienv) root@ubuntu-ollama:~# systemctl start openwebui\n</code></pre> <p>V\u00e9rification :</p> <pre><code>(openwebuienv) root@ubuntu-ollama:~# pip freeze | grep open-webui\n</code></pre> <p>Retour :</p> <pre><code>open-webui==0.5.x\n</code></pre> <p>Une fois termin\u00e9, pensez \u00e0 vider les caches de votre navigateur Web (Cookies et donn\u00e9es de sites) avant de vous connecter sur la page d'Open WebUI.</p> <p>Fin.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/","title":"Proxmox - Nginx Proxy Manager","text":""},{"location":"informatique/proxmox---nginx-proxy-manager/#proxmox-81","title":"Proxmox 8.1","text":""},{"location":"informatique/proxmox---nginx-proxy-manager/#rdp-copiercoller","title":"RDP Copier/Coller","text":"<p>Penser \u00e0 positionner la fonction Presse-papiers \u00e0 oui dans la configuration de mRemoteNG pour les VM tournant sous Proxmox.</p> <p>Rien \u00e0 faire de particulier du c\u00f4t\u00e9 des serveurs xrdp install\u00e9s sur les VM.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#gestion-du-pare-feu","title":"Gestion du pare-feu","text":"<p>V\u00e9rifier sur la machine Proxmox le statut du service pve-firewall :</p> <pre><code># systemctl status pve-firewall\n</code></pre> <p>Retour normal :</p> <pre><code>\u25cf pve-firewall.service - Proxmox VE firewall\n     Loaded: loaded (/lib/systemd/system/pve-firewall.service; enabled; preset: enabled)\n     Active: active (running) since Mon 2024-01-08 11:28:53 CET; 3 weeks 6 days ago\n   Main PID: 1185 (pve-firewall)\n      Tasks: 1 (limit: 34638)\n     Memory: 100.4M\n        CPU: 6h 57min 55.895s\n     CGroup: /system.slice/pve-firewall.service\n             \u2514\u25001185 pve-firewall\n\njanv. 08 11:28:51 labos5 systemd[1]: Starting pve-firewall.service - Proxmox VE firewall...\njanv. 08 11:28:53 labos5 pve-firewall[1185]: starting server\njanv. 08 11:28:53 labos5 systemd[1]: Started pve-firewall.service - Proxmox VE firewall.\n</code></pre> <p>Contr\u00f4ler ensuite l'activation du service :</p> <pre><code># pve-firewall status\n</code></pre> <p>Retour par d\u00e9faut :</p> <pre><code>Status: disabled/running\n</code></pre> <p>On peut voir que le service est par d\u00e9faut d\u00e9marr\u00e9 mais non activ\u00e9.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#niveau-centre-de-donnees","title":"Niveau Centre de donn\u00e9es","text":"<p>Onglet Pare-feu du menu Centre de donn\u00e9es : Cr\u00e9er 3 r\u00e8gles de pare-feu pour autoriser les acc\u00e8s aux ports WEB, SSH et RDP de Proxmox.</p> <p>Sous-onglet Options : Activer le pare-feu en mettant la valeur du champ Pare-feu \u00e0 oui.</p> <p>V\u00e9rifier ensuite son activation :</p> <pre><code># pve-firewall status\n</code></pre> <p>Retour :</p> <pre><code>Status: enable/running\n</code></pre> <p>Cons\u00e9quences li\u00e9es \u00e0 l'activation du pare-feu : Les pings vers l'IP du noeud Proxmox Bare Metal ne fonctionnent plus. Les pings vers les IP des VM/CTN fonctionnent toujours.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#niveau-noeud","title":"Niveau Noeud","text":"<p>Onglet Pare-feu du menu Noeud \"lab\" : Cr\u00e9er 1 r\u00e8gle pour autoriser les pings uniquement depuis une adresse IP du r\u00e9seau local.</p> <p>Sous-onglet Options : Activer le pare-feu en mettant la valeur du champ Pare-feu \u00e0 oui.</p> <p>Cons\u00e9quences li\u00e9es \u00e0 l'activation : Les pings vers l'IP du noeud fonctionnent uniquement depuis l'IP filtr\u00e9e. Idem pour les pings vers les IP des VM/CTN.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#niveau-vmctn","title":"Niveau VM/CTN","text":"<p>Cr\u00e9er, selon la m\u00eame m\u00e9thode que ci-dessus, les r\u00e8gles de pare-feu qui conviennent pour chacune des VM/CTN.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#securite-complementaire","title":"S\u00e9curit\u00e9 compl\u00e9mentaire","text":"<p>Interdire la connexion SSH en tant que root et modifier le num\u00e9ro de port utilis\u00e9 par d\u00e9faut.</p> <p>Pour cela, \u00e9diter le fichier _/etc/ssh/sshd_config et modifier ces 2 lignes comme ceci :</p> <pre><code>Port nouveau-numero-port\nPermitRootLogin no\n</code></pre> <p>Dans le cas d'une authentification SSH par cl\u00e9 publique et non par MDP, ajouter ceci :</p> <pre><code>PasswordAuthentication no\nPubkeyAuthentication yes\n</code></pre>"},{"location":"informatique/proxmox---nginx-proxy-manager/#sauvegarde-des-conteneurs","title":"Sauvegarde des conteneurs","text":"<p>Il est n\u00e9cessaire pour \u00e9viter un \u00e9chec de modifier le fichier de configuration /etc/vzdump.conf.</p> <p>Remplacer la ligne :</p> <pre><code>tmpdir: DIR\n</code></pre> <p>par :</p> <pre><code>tmpdir: /tmp\n</code></pre>"},{"location":"informatique/proxmox---nginx-proxy-manager/#nginx-proxy-manager","title":"Nginx Proxy Manager","text":"<p>Lien utile : proxmox-scripts</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#creation-du-conteneur","title":"Cr\u00e9ation du conteneur","text":"<p>Le conteneur LXC contenant l'application Nginx Proxy Manager servira de reverse proxy pour l'ensemble des VM/CTN de Proxmox.</p> <p>Se connecter en tant que root et en SSH sur le serveur Proxmox puis entrer la Cde suivante :</p> <pre><code># bash -c \"$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/ct/nginxproxymanager.sh)\"\n</code></pre> <p>Une fen\u00eatre s'ouvre, entrer dans le mode avanc\u00e9 et configurer les param\u00e8tres propos\u00e9s.</p> <p>Une fois fait, le conteneur est cr\u00e9\u00e9 automatiquement.</p> <p>La Cde ci-dessus peut \u00eatre r\u00e9utilis\u00e9e \u00e0 l'int\u00e9rieur du conteneur cr\u00e9\u00e9 pour effectuer les MAJ.</p> <p>L'interface WEB de Nginx Proxy Manager devient accessible depuis l'URL : <code>http://192.168.x.y:81</code></p> <p>Login et MDP par d\u00e9faut : Login : <code>admin@example.com</code> MDP : changeme</p> <p>Commencer par changer le Login et MDP une fois rentr\u00e9 dans l'interface WEB.</p> <p>V\u00e9rifier par curiosit\u00e9 le statut du service Nginx Proxy Manager :</p> <pre><code># systemctl status npm\n</code></pre>"},{"location":"informatique/proxmox---nginx-proxy-manager/#nom-de-domaine-et-dyndns","title":"Nom de domaine et DynDNS","text":"<p>Enregistrer un nom de domaine sur le site Duck DNS, Ex : <code>wxyz.duckdns.org</code>.</p> <p>V\u00e9rifier ensuite sur Proxmox la pr\u00e9sence des paquets cron et curl :</p> <pre><code># apt list cron\n# apt list curl\n</code></pre> <p>Les installer si manquants puis cr\u00e9er les dossiers et fichiers suivants :</p> <pre><code># cd /root\n# mkdir duckdns\n# cd duckdns\n# touch duck.sh\n</code></pre> <p>Editer le script duck.sh et entrer le contenu suivant :</p> <pre><code>echo url=\"https://www.duckdns.org/update?domains=nom-du-domaine&amp;token=f30a8c59-b492-4323-...&amp;ip=\" | curl -k -o /root/duckdns/duck.log -K -\n</code></pre> <p>Modifier les permissions du script :</p> <pre><code># chmod 700 /root/duckdns/duck.sh\n</code></pre> <p>Lancer enfin la Cde ci-dessous :</p> <pre><code># crontab -e\n</code></pre> <p>et ajouter cette ligne en fin de fichier :</p> <pre><code>*/5 * * * * /root/duckdns/duck.sh &gt;/dev/null 2&gt;&amp;1\n</code></pre> <p>Le script duck.sh sera ex\u00e9cut\u00e9 toutes les 5 minutes afin que Duck DNS ait connaissance de l'adresse IP associ\u00e9e au nom de domaine <code>wxyz.duckdns.org</code>.</p> <p>Tester le fonctionnement du script comme suit :</p> <pre><code># cd /root/duckdns\n# ./duck.sh\n</code></pre> <p>Un fichier duck.log sera cr\u00e9\u00e9 et contiendra OK si tout s'est pass\u00e9 correctement.</p> <p>La m\u00eame op\u00e9ration peut par pr\u00e9caution \u00eatre r\u00e9alis\u00e9e \u00e0 l'int\u00e9rieur du conteneur.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#certificat-lets-encrypt","title":"Certificat Let's Encrypt","text":"<p>Pour remplacer le num\u00e9ro du port HTTPS 443 qu'utilise par d\u00e9faut Nginx Proxy Manager, proc\u00e9der ainsi \u00e0 l'int\u00e9rieur du conteneur :</p> <pre><code># cd /etc/nginx/conf.d\n# nano default.conf\n</code></pre> <p>Remplacer tous les 443 par le nouveau num\u00e9ro de port.</p> <p>Faire de m\u00eame avec le fichier /app/templates/_listen.conf.</p> <p>Red\u00e9marrer le conteneur et v\u00e9rifier les ports d'\u00e9coute avec la Cde suivante :</p> <pre><code># ss -tnalup\n</code></pre> <p>Installer le plugin certbot pour le fournisseur DuckDNS :</p> <pre><code># pip install certbot_dns_duckdns\n</code></pre> <p>Cr\u00e9er enfin un certificat en utilisant le DNS Challenge ce qui \u00e9vite l'obligation d'\u00eatre en \u00e9coute sur les ports HTTP 80 et HTTPS 443.</p> <p>Penser \u00e0 entrer un d\u00e9lai de 120 secondes afin d'\u00e9viter un \u00e9ventuel probl\u00e8me de timeout lors de la cr\u00e9ation.</p>"},{"location":"informatique/proxmox---nginx-proxy-manager/#en-tetes-des-proxy-hosts","title":"En-t\u00eates des Proxy Hosts","text":"<p>Certains Proxy Hosts peuvent n\u00e9cessiter d'ajouter dans leur configuration des en-t\u00eates HTTP.</p> <p>Dans ce cas, ajouter le contenu suivant dans l'onget Advanced de l'h\u00f4te en zone Custom Nginx Configuration :</p> <pre><code>location /\n{\n    proxy_pass http://IP-du-conteneur:8080;\n    proxy_set_header Host sous-domaine.domaine.duckdns.org:7230;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto https;\n    proxy_set_header REMOTE-HOST $remote_addr;\n    client_body_buffer_size 512k;\n    proxy_read_timeout 86400s;\n    client_max_body_size 0;\n    proxy_buffers 256 16k;\n    proxy_buffer_size 16k;\n    add_header X-Cache $upstream_cache_status;\n}\n</code></pre> <p>Fin.</p>"},{"location":"informatique/synology---rustdesk/","title":"Synology - RustDesk","text":"<p>Le client de contr\u00f4le \u00e0 distance RustDesk fonctionnera comme celui de TeamViewer mais en se connectant cette fois sur un serveur open source auto-h\u00e9berg\u00e9 de nom RustDesk.</p>"},{"location":"informatique/synology---rustdesk/#rustdesk-serveur","title":"RustDesk serveur","text":""},{"location":"informatique/synology---rustdesk/#prealables","title":"Pr\u00e9alables","text":"<p>Docker et Portainer install\u00e9s sur le NAS Synology. Disposer d'un nom de domaine pour l'acc\u00e8s \u00e0 RustDesk.  </p>"},{"location":"informatique/synology---rustdesk/#installation-du-serveur","title":"Installation du serveur","text":"<p>Suivre le document RustDesk-Serveur-sur-Synology.pdf.</p>"},{"location":"informatique/synology---rustdesk/#ouverture-de-ports","title":"Ouverture de ports","text":"<p>Forwarder les ports TCP/UDP 21115 \u00e0 21119 depuis la box Internet vers le NAS Synology.</p>"},{"location":"informatique/synology---rustdesk/#rustdesk-client","title":"RustDesk client","text":""},{"location":"informatique/synology---rustdesk/#installation-du-client","title":"Installation du client","text":"<p>T\u00e9l\u00e9charger le client appropri\u00e9 sur le site de RustDesk, fichier .deb pour Debian et .msi pour Windows 11.</p> <p>Installer ensuite celui-ci qui sera ex\u00e9cut\u00e9 en tant que service. Ex: /usr/lib/systemd/system/rustdesk.service pour Debian.</p>"},{"location":"informatique/synology---rustdesk/#cas-debian-avec-xfce4","title":"Cas Debian avec Xfce4","text":"<p>Ouvrir le fichier sudoers :</p> <pre><code>sudo visudo\n</code></pre> <p>et ajouter la ligne suivante pour l'utilisateur <code>lightdm</code> :</p> <pre><code>lightdm ALL=(ALL) NOPASSWD: ALL\n</code></pre> <p>Pour configurer l'autologin, \u00e9diter le fichier lightdm.conf :</p> <pre><code>sudo nano /etc/lightdm/lightdm.conf\n</code></pre> <p>puis, d\u00e9commenter et param\u00e9trer ces 3 lignes de la section [Seat:*] :</p> <pre><code>autologin-guest=false\nautologin-user=nom-du-user-local\nautologin-user-timeout=0\n</code></pre> <p>Pour exporter l'environnement de l'utilisateur local (seulement si n\u00e9cessaire), \u00e9diter .bashrc :</p> <pre><code>nano .bashrc\n</code></pre> <p>et ajouter les lignes suivantes en fin de fichier :</p> <pre><code># Ajout pour utiliser le client Rustdesk\nexport DBUS_SESSION_BUS_ADDRESS=\"unix:path=/run/user/$UID/bus\"\nexport XDG_RUNTIME_DIR=\"/run/user/$UID\"\nexport XDG_SESSION_TYPE=x11\n</code></pre>"},{"location":"informatique/synology---rustdesk/#cas-debian-avec-xrdp","title":"Cas Debian avec xrdp","text":"<p>Pour autoriser une connexion simultan\u00e9e sur Debian depuis un client xrdp et un client rustdesk, \u00e9diter le fichier suivant :</p> <pre><code>sudo nano /etc/xrdp/startwm.sh\n</code></pre> <p>et ajouter ces lignes juste avant test -x --- :</p> <pre><code># Pour connexion simultan\u00e9e xrdp et normale\nunset DBUS_SESSION_BUS_ADDRESS\nunset XDG_RUNTIME_DIR\n# Fin\n</code></pre>"},{"location":"informatique/synology---rustdesk/#cas-debian-xfce4-sans-ecran","title":"Cas Debian Xfce4 sans \u00e9cran","text":"<p>Pr\u00e9voir la mise en place d'un connecteur HDMI simulant la pr\u00e9sence d'un moniteur afin de garantir le lancement de la session locale Xfce4.</p> <p>Voir dans l'onglet G\u00e9n\u00e9ral du client RustDesk si le mode \"allow linux headless\" est utile.</p>"},{"location":"informatique/synology---rustdesk/#cde-pour-lire-lenvironnement","title":"Cde pour lire l'environnement","text":"<pre><code>systemctl --user show environment\n</code></pre>"},{"location":"informatique/synology---rustdesk/#cdes-pour-gerer-les-sessions","title":"Cdes pour g\u00e9rer les sessions","text":"<pre><code>loginctl list-sessions\nloginctl show-session ID\nloginctl show-session -p State ID\nloginctl session-status ID\n\nloginctl terminate-session ID\nloginctl activate ID\n\nloginctl list-users\nloginctl show-user ID\n</code></pre> <p>L'ID correspond au n\u00b0 de session soit 1 ou 3 ou c1, etc...</p> <p>Fin.</p>"},{"location":"mkdocs/","title":"Outil de documentation","text":""},{"location":"mkdocs/#outil-de-documentation","title":"Outil de documentation","text":"<p>MkDocs est un g\u00e9n\u00e9rateur de site Web statique \u00e9crit en langage Python.</p> <p>Son installation locale peut \u00eatre r\u00e9alis\u00e9e \u00e0 l'aide de la Cde pip.</p> <p>Th\u00e8me utilis\u00e9 sur ce site : Material for MkDocs</p> <p>L'\u00e9criture de la documentation utilise la syntaxe Markdown.</p> <p>La configuration du site repose sur le fichier YAML mkdocs.yml.</p> <p>L'int\u00e9gration de MkDocs avec Git permet de stocker la documentation sur un d\u00e9p\u00f4t Git.</p> ---------- Fin ----------"},{"location":"mkdocs/bases-mkdocs/","title":"MkDocs - Bases","text":""},{"location":"mkdocs/bases-mkdocs/#les-bases-de-mkdocs","title":"Les bases de MkDocs","text":"<p>Pour la doc compl\u00e8te, visiter mkdocs.org. Pour la doc du th\u00e8me, visiter Material for MkDocs.</p>"},{"location":"mkdocs/bases-mkdocs/#commandes","title":"Commandes","text":"<p><code>mkdocs new [dir-name]</code> - Pour cr\u00e9er un projet. <code>mkdocs serve</code> - Pour lancer le serveur de d\u00e9velop... <code>mkdocs build</code> - Pour construire la doc du site. <code>mkdocs -h</code> - Pour afficher l'aide.</p>"},{"location":"mkdocs/bases-mkdocs/#schema-dun-projet","title":"Sch\u00e9ma d'un projet","text":"<pre><code>mkdocs.yml    # Le fichier de configuration.\n  docs/\n    index.md  # Le fichier de la page d'accueil.\n    ...       # Autres pages markdown, images et autres fichiers.\n</code></pre>"},{"location":"mkdocs/bases-mkdocs/#entete-dun-fichier-markdown","title":"Ent\u00eate d'un fichier Markdown","text":"<p>Exemple \u00e0 respecter :</p> <pre><code>---    \ntitle: Titre du fichier  \nsummary: Description sommaire.  \nauthors: Nom de l'auteur  \ndate: 2023-06-01  \ncategories:   \n  - \"Open vSwitch + Conteneurs\"  \n---\n</code></pre> <p>ou</p> <pre><code>---    \ntitle: Titre du fichier  \nsummary: Description sommaire.  \nauthors: \n    - Nom de l'auteur  \ndate: 2023-06-01  \ncategories:   \n    - \"Open vSwitch + Conteneurs\"  \n---\n</code></pre> <p>si l'on veut exploiter le fichier blog/.authors.yml dont le contenu peut ressembler \u00e0 ceci :</p> <pre><code>authors:\n  Nom de l'auteur:\n    name: Pseudonyme\n    description: Divers\n    avatar: https://xxx/blog/avatar.png\n</code></pre>"},{"location":"mkdocs/bases-mkdocs/#aide-a-lecriture","title":"Aide \u00e0 l'\u00e9criture","text":""},{"location":"mkdocs/bases-mkdocs/#-titres","title":"- Titres","text":"<p>Titres : h1 &gt; h2 &gt; h3 etc...</p> <p>Titres - Liens internes :</p> <p>Ajout, par exemple, de {#titre-4} au titre 4</p> <pre><code>### 4 - Raccordement des 2 clients Debian sur OVS {#titre-4}\n</code></pre> <p>et cr\u00e9ation d'un lien au sein d'un paragraphe quelconque</p> <pre><code>d'une ... r\u00e9seau virtuelle _( [Voir le \u00a7 4](#titre-4) )_.\n</code></pre> <p>ou cr\u00e9ation d'un lien depuis une autre page Web</p> <pre><code>d'une ...  r\u00e9seau virtuelle _( [Voir le \u00a7 4](post-x.md#titre-4) )_.\n</code></pre>"},{"location":"mkdocs/bases-mkdocs/#-images","title":"- Images","text":"<p>Image - options : { loading=lazy }, { target=\"_blank\" }, { align=left }</p> <p>Image - l\u00e9gende : Paragraphe oblique et gras (Voir la feuille de style extra.css)</p> <p>Image - centrage : ../image.webp#center (Voir la feuille de style extra.css)</p> <p>Image - syntaxe :</p> <p><code>![Logo - ...](image-test1.jpg){ align=left }</code></p> <p></p> <p>  Image align\u00e9e \u00e0 gauche. \u00a0 </p> <p>ou image sans option (Alerte markdown MD033)</p> <pre><code>&lt;figure markdown&gt;\n  ![Logo de ...](../blog/images/2019/02/logo-virtualbox.jpg)\n&lt;/figure&gt;\n</code></pre> <p>ou image avec option et l\u00e9gende (Alerte markdown MD033)</p> <pre><code>&lt;figure markdown&gt;\n  ![Image - VBox : Logo...](../blog/images/2019/02/logo-virtualbox.jpg){ target=\"_blank\" }\n  &lt;figcaption&gt;VBox : Logo...&lt;/figcaption&gt;\n&lt;/figure&gt;\n</code></pre> <p>ou image avec options (Sans alerte markdown)</p> <p><code>[![centreon-accueil-deb12.webp](image-test2.webp#center){ width=\"430\" }](image-test2.webp)</code></p> <p></p>"},{"location":"mkdocs/bases-mkdocs/#-liens","title":"- Liens","text":"<p>Lien - options : { target=\"_blank\" }</p> <p>Lien - syntaxe :</p> <p><code>[VirtualBox](https://www.virtualbox.org/wiki/Downloads){ target=\"_blank\" }</code></p> <p>Exemple : VirtualBox</p> <p>Lien - URL http et https :</p> <pre><code>Exemple de lien actif : &lt;http://192.168.x.y:7160&gt;\n</code></pre> <pre><code>Exemple de lien inactif : `http://192.168.x.y:7160`\n</code></pre>"},{"location":"mkdocs/bases-mkdocs/#-cdesscripts-et-retours","title":"- Cdes/Scripts et retours","text":"<p>Cdes/Scripts ( code ```bash, yaml, json, etc... ) :</p> <pre><code>sudo nano /etc/systemd/system/networknamespace.service\n</code></pre> <p>Retours (code ```markdown hl_lines=\"2 5\" ) :</p> <pre><code>Client:       Podman Engine\nVersion:      4.3.1\nAPI Version:  4.3.1\nGo Version:   go1.19.8\nBuilt:        Thu Jan 1 01:00:00 1970\nOS/Arch:      linux/amd64\n</code></pre> <p>L'instruction : hl_lines=\"4\" permet de surligner la ligne 4. hl_lines=\"2 5\" permet de surligner les lignes 2 et 5. hl_lines=\"3-7\" permet de surligner les lignes 3 \u00e0 7.</p>"},{"location":"mkdocs/bases-mkdocs/#-divers","title":"- Divers","text":"<p>Texte - centrage : <code>&lt;center&gt;---------- Fin ----------&lt;/center&gt;</code> (Alerte markdown MD033)</p> <p>Paragraphe - surlignage : texte-surlign\u00e9  (== de chaque c\u00f4t\u00e9 du texte)</p> <p>Extraits - longueur : Inclure le s\u00e9parateur <code>&lt;!-- more --&gt;</code> dans les articles.</p>"},{"location":"mkdocs/bases-mkdocs/#-fenetres-speciales","title":"- Fen\u00eatres sp\u00e9ciales","text":"<p>Nota</p> <p>\"!!! note \"Nota\"\"</p> <p>Ceci est une note.</p> <p>Alerte</p> <p>\"!!! Warning \"Alerte\"\"</p> <p>Ceci est une alerte.</p> <p>M\u00e9mento 6.1 en cours de construction</p> <p>\"!!! Info \"M\u00e9mento 6.1 en cours de construction\"\"</p> <p>Ceci est une information.</p> <p>Indentation de 4 espaces avant le texte.</p>"},{"location":"mkdocs/bases-mkdocs/#fichier-markdownlintjson","title":"Fichier .markdownlint.json","text":"<p>Fichier cr\u00e9\u00e9 \u00e0 la racine du projet.</p> <pre><code>{\n  \"MD013\": false, (valeur par d\u00e9faut)\n  \"MD033\": {\n      \"allowed_elements\": [ \"figure\", \"figcaption\" ] (pour les blocs image)\n  },\n  \"MD046\": false (pour les blocs code)\n}\n</code></pre>"},{"location":"mkdocs/bases-mkdocs/#plugin","title":"Plugin","text":"<p>Ajout du plugin : mkdocs-glightbox (pour les blocs image)</p>"},{"location":"mkdocs/debian-mkdocs/","title":"MkDocs - Site Web sur Debian","text":""},{"location":"mkdocs/debian-mkdocs/#mkdocs-en-local-sur-debian","title":"MkDocs en local sur Debian","text":"<p>Tuto pour installer MkDocs sur une VM Debian.</p> <p>Lien utile : De Jupyter \u00e0 MkDocs</p>"},{"location":"mkdocs/debian-mkdocs/#environnement-virtuel-python","title":"Environnement virtuel Python","text":"<p>Pr\u00e9alable : Python version 3 install\u00e9 de base sur l'OS Debian.</p> <p>V\u00e9rifier la version courante de Python :</p> <pre><code>python3 --version\n</code></pre> <p>et l'installation des modules Python suivants :</p> <pre><code>sudo apt list python3-pip python3-dev python3-venv python3-full\n</code></pre> <p>A d\u00e9faut, installer les modules manquants \u00e0 l'aide de la Cde sudo apt install.</p> <p>Ensuite, cr\u00e9er un dossier qui recevra un environnement virtuel Python, ceci pour ne pas interf\u00e9rer par la suite avec la version de Python install\u00e9e sur l'OS Debian :</p> <pre><code>cd /home/user\nmkdir -p /home/user/Documents/notes-user/env\ncd /home/user/Documents/notes-user\n</code></pre> <p>et installer l'environnement Python dans le dossier env :</p> <pre><code>python3 -m venv env\n</code></pre> <p>Activer celui-ci afin de pouvoir l'exploiter :</p> <pre><code>cd env\nsource ./bin/activate\n</code></pre> <p>Le prompt du terminal se change en (env) user@deb....</p> <p>Nota</p> <p>Pour sortir de l'environnement Python, utiliser la Cde : (env) deactivate</p> <p>Rester dans l'environnement et mettre \u00e0 jour le gestionnaire de paquets Python de nom pip :</p> <pre><code>(env) user@deb...: python3 -m pip install --upgrade pip\n</code></pre>"},{"location":"mkdocs/debian-mkdocs/#installation-de-mkdocs","title":"Installation de MkDocs","text":"<p>Installer MkDocs avec la Cde suivante :</p> <pre><code>(env) user@deb...: python3 -m pip install mkdocs\n(env) user@deb...: mkdocs --version\n</code></pre> <p>Retour :</p> <pre><code>mkdocs, version 1.5.3 from /home/user.../site-packages/mkdocs (Python 3.11)\n</code></pre> <p>Les fichiers de MkDocs sont install\u00e9s dans : /home/user/Documents/notes-user/env/lib/python3.xy/site-packages/mkdocs/</p> <p>Les th\u00e8mes de base mkdocs et readthedocs sont dans : /home/user/Documents/notes-user/env/lib/python3.xy/site-packages/mkdocs/themes/</p> <p>Pour mettre \u00e0 jour MkDocs, utiliser cette Cde :</p> <pre><code>(env) user@deb...: cd /home/user/Documents/notes-user/env\n(env) user@deb...: pip install -U mkdocs\n</code></pre>"},{"location":"mkdocs/debian-mkdocs/#theme-material-for-mkdocs","title":"Th\u00e8me Material for MkDocs","text":"<p>Ajouter le th\u00e8me comme ceci :</p> <pre><code>(env) user@deb...: python3 -m pip install mkdocs-material\n</code></pre> <p>Les dossiers et fichiers du th\u00e8me sont install\u00e9s dans : /home/user/Documents/notes-user/env/lib/python3.xy/site-packages/material/</p> <p>Nota</p> <p>Lien GitHub du th\u00e8me : Material pour MkDocs</p> <p>Pour v\u00e9rifier la version du th\u00e8me, utiliser cette Cde :</p> <pre><code>(env) user@deb...: pip show mkdocs-material\n</code></pre> <p>Retour :</p> <pre><code>Name : mkdocs-material\nVersion : 9.5.5\n...\n</code></pre> <p>Pour mettre \u00e0 jour le th\u00e8me, utiliser cette Cde :</p> <pre><code>(env) user@deb...: pip install --upgrade --force-reinstall mkdocs-material\n</code></pre>"},{"location":"mkdocs/debian-mkdocs/#projetdossier-documentation","title":"Projet/Dossier documentation","text":"<p>Cr\u00e9er le Projet/Dossier (Site de d\u00e9veloppement) de la documentation \u00e0 venir :</p> <pre><code>(env) user@deb...: cd /home/user/Documents/\n(env) user@deb...: mkdocs new notes-user\n(env) user@deb...: cd notes-user\n(env) user@deb...: ls\n</code></pre> <p>Retour de la Cde ls :</p> <pre><code>docs env mkdocs.yml\n</code></pre> <p>Cr\u00e9er un fichier de nom requirements.txt :</p> <pre><code>(env) user@deb...: cd /home/user/Documents/notes-user\n(env) user@deb...: pip freeze &gt; requirements.txt\n</code></pre> <p>Ce fichier permettrait \u00e0 un d\u00e9veloppeur voulant travailler sur ce projet de connaitre les pr\u00e9requis de l'environnement Python \u00e0 utiliser, non n\u00e9cessaire dans le cadre d'un site MkDocs local.</p> <p>Activer le th\u00e8me Material for MkDocs en modifiant le fichier mkdocs.yml comme suit :</p> <pre><code>(env) user@deb...: cd /home/user/Documents/notes-user\n(env) user@deb...: nano mkdocs.yml\n</code></pre> <p>entrer le contenu suivant :</p> <pre><code>site_name: Documents du user\n\ntheme:\n  name: material\n  language: fr\n  features:\n    - navigation.footer\n\ncopyright: Copyright &amp;copy; 2024 - Cartier Jacques\n</code></pre>"},{"location":"mkdocs/debian-mkdocs/#plugins","title":"Plugins","text":"<p>Activer le plugin blog en ajoutant le contenu suivant dans le fichier mkdocs.yml :</p> <pre><code>plugins:\n  - blog:\n      blog_dir: blog\n      post_date_format: short\n      post_url_format: \"/{slug}\"\n      categories_name: Filtrage par cat\u00e9gorie\n      categories_url_format: \"{slug}\"\n      archive: false\n</code></pre> <p>Activer le plugin search en ajoutant le contenu suivant dans le fichier mkdocs.yml :</p> <pre><code>plugins:\n  - blog:\n      .....\n  - search :\n      lang: fr\n</code></pre> <p>Installer le plugin glightbox comme suit :</p> <pre><code>user@deb...: cd /home/user/Documents/notes-user/env\nuser@deb...:source ./bin/activate\n(env) user@deb...: pip install mkdocs-glightbox\n(env) user@deb...: deactivate\n</code></pre> <p>et ajouter le contenu suivant dans le fichier mkdocs.yml :</p> <pre><code>plugins:\n  - blog:\n      .....\n  - search :\n      .....\n  - glightbox:\n      touchNavigation: false\n      loop: false\n      effect: zoom\n      slide_effect: none\n      width: 100%\n      height: auto\n      zoomable: true\n      draggable: false\n      skip_classes:\n        - custom-skip-class-name\n      auto_caption: true\n      caption_position: bottom\n</code></pre>"},{"location":"mkdocs/debian-mkdocs/#serveur-de-developpement","title":"Serveur de d\u00e9veloppement","text":"<p>Pour lancer le serveur affichant le site Web de d\u00e9veloppement, proc\u00e9der ainsi :</p> <pre><code>(env) user@deb...: cd /home/user/Documents/notes-user\n(env) user@deb...: mkdocs serve\n</code></pre> <p>ou proc\u00e9der ainsi en dehors de l'environnement Python :</p> <pre><code>user@deb...: /home/user/Documents/notes-user/env/bin/mkdocs serve\n</code></pre> <p>Retour normal :</p> <pre><code>INFO     -  Building documentation...\nINFO     -  Cleaning site directory\nINFO     -  Documentation built in 1.20 seconds\nINFO     -  [12:10:49] Watching paths for changes: 'docs', 'mkdocs.yml'\nINFO     -  [12:10:49] Serving on http://127.0.0.1:8000/\n</code></pre> <p>Touches CTRL+C pour fermer le serveur.</p> <p>Tester l'URL: <code>http://127.0.0.1:8000</code></p> <p>Le serveur de d\u00e9veloppement doit montrer le site Web utilisant le th\u00e8me Material for MkDocs.</p>"},{"location":"mkdocs/debian-mkdocs/#serveur-de-production","title":"Serveur de production","text":"<p>Pour afficher le site Web sur un serveur de production, proc\u00e9der ainsi :</p> <p>Pr\u00e9alable : Un serveur WEB/PHP install\u00e9 sur l'OS Debian utilisant la racine /var/www/html/.</p> <pre><code>(env) user@deb...: cd /home/user/Documents/notes-user\n(env) user@deb...: sudo mkdir /var/www/html/mkdocs\n\n(env) user@deb...: sudo /home/user/Documents/notes-user/env/bin/mkdocs build -d /var/www/html/mkdocs/\n</code></pre> <p>Retour normal :</p> <pre><code>INFO     -  Cleaning site directory\nINFO     -  Building documentation to directory: /var/www/html/mkdocs\nINFO     -  Documentation built in 0.18 seconds\n</code></pre> <p>La Cde suivante mkdocs build :</p> <pre><code>(env) user@deb...: sudo /home/user/Documents/notes-user/env/bin/mkdocs build -d /var/www/html/mkdocs/\n</code></pre> <p>peut \u00eatre remplac\u00e9e par :</p> <pre><code>(env) user@deb...: sudo /home/user/Documents/notes-user/env/bin/mkdocs build\n</code></pre> <p>si l'instruction :</p> <pre><code>site_dir: '../../../../var/www/html/mkdocs/'\n</code></pre> <p>est pr\u00e9sente dans le fichier mkdocs.yml.</p> <p>La MAJ du serveur pourra alors s'effectuer ainsi :</p> <pre><code>(env) user@deb...: cd /home/user/Documents/notes-user\n(env) user@deb...: sudo /home/user/Documents/notes-user/env/bin/mkdocs build -c\n</code></pre> <p>ou comme ceci en dehors de l'environnement Python :</p> <pre><code>user@deb...: cd /home/user/Documents/notes-user\nuser@deb...: sudo /home/user/Documents/notes-user/env/bin/mkdocs build -c\n</code></pre> <p>Fin.</p>"},{"location":"mkdocs/github-mkdocs/","title":"MkDocs - Site Web sur GitHub","text":""},{"location":"mkdocs/github-mkdocs/#mkdocs-sur-github","title":"MkDocs sur GitHub","text":"<p>Tuto pour installer MkDocs sur GitHub.</p>"},{"location":"mkdocs/github-mkdocs/#situation-de-base","title":"Situation de base","text":"<p>MkDocs, Git et VS Code Server install\u00e9s sur une VM Debian.</p> <p>Configurer le user.name et le user.email de git ainsi :</p> <pre><code>git config --global user.name \"Jacques Cartier\"\ngit config --global user.email \"j.cartier@gmail.com\"\n</code></pre> <p>V\u00e9rifier le r\u00e9sulat de la configuration :</p> <pre><code>git config --list\n</code></pre> <p>Retour normal :</p> <pre><code>user.name=Jacques Cartier\nuser.email=j.cartier@gmail.com\n</code></pre>"},{"location":"mkdocs/github-mkdocs/#creation-du-compte-github","title":"Cr\u00e9ation du compte GitHub","text":"<p>Cr\u00e9er ensuite un compte GitHub en s'aidant du lien suivant : Bien d\u00e9marrer avec votre compte GitHub</p> <p>Se connecter ensuite sur celui-ci et cr\u00e9er un dossier en utilisant l'URL : https://github.com/new</p> <p>- Donner un nom au dossier (Ex: notes-user) - Cocher Public - Cocher Add a README file - Cliquer sur le bouton Create repository</p> <p>Le dossier/d\u00e9p\u00f4t GitHub cr\u00e9\u00e9 avec le nom notes-user inclus une branche de base appel\u00e9e main.</p> <p>Cette branche contiendra la documentation de MkDocs qui sera mise \u00e0 jour depuis le VS Code Server install\u00e9 sur la VM Debian.</p> <p>Finir en modifant le contenu du fichier README.md, ceci en utilisant le langage Markdown et terminer en cliquant sur le bouton Commit changes.</p>"},{"location":"mkdocs/github-mkdocs/#authentification-par-jeton","title":"Authentification par jeton","text":"<p>Cde \u00e0 lancer pour lire les URL d'acc\u00e8s \u00e0 GitHub :</p> <pre><code>git remote -v\n</code></pre> <p>Exemple de retour :</p> <pre><code>origin  https://git@github.com/user-git/nom-depot.git (fetch)\n\norigin  https://git@github.com/user-git/nom-depot.git (push)\n</code></pre> <p>Se procurer un jeton depuis le d\u00e9p\u00f4t GitHub, menu Settings : -&gt; Developer Settings -&gt; Personal access tokens -&gt; Tokens (classic) .</p> <p>D\u00e9clarer ensuite le jeton dans l'espace de travail de VS Code Server comme suit :</p> <pre><code>git remote set-url origin https://valeur-du-token@github.com/user-git/nom-depot-git\n</code></pre> <p>Ainsi la fonction push de VS Code Server vers GitHub fonctionnera sans demande de MDP.</p> <p>Relancer cette cde pour v\u00e9rifier la prise en compte :</p> <pre><code>git remote -v\n</code></pre> <p>Retour \u00e0 observer :</p> <pre><code>origin  https://ghp_Y3PD41f...@github.com/user-git/nom-depot-git (fetch)\n\norigin  https://ghp_Y3PD41f...@github.com/user-git/nom-depot-git (push)\n</code></pre> <p>Le jeton (token) a une dur\u00e9e de vie qui peut \u00eatre renouvel\u00e9e.</p>"},{"location":"mkdocs/github-mkdocs/#renouvellement-du-jeton","title":"Renouvellement du jeton","text":"<p>Se connecter sur le d\u00e9p\u00f4t GitHub, menu Settings : -&gt; Developer Settings -&gt; Personal access tokens -&gt; Tokens (classic) -&gt; Clic sur le lien du jeton existant -&gt; Bouton Regenerate Token.</p> <p>Enregister la valeur du nouveau token et lancer la Cde suivante depuis la VM Debian :</p> <pre><code>git remote set-url origin https://valeur-du-token@github.com/user-git/nom-depot-git\n</code></pre> <p>V\u00e9rifier le r\u00e9sultat comme suit :</p> <pre><code>git remote -v\n</code></pre>"},{"location":"mkdocs/github-mkdocs/#creation-du-site-web-mkdocs","title":"Cr\u00e9ation du site Web MkDocs","text":"<p>La cr\u00e9ation sera automatis\u00e9e en exploitant les possibilit\u00e9s de GitHub Pages qui est un service d\u2019h\u00e9bergement de site Web statique.</p> <p>Le site Web de MkDocs et le th\u00e8me Material for Mkdocs seront installl\u00e9s dans une branche appel\u00e9e gh-pages.</p> <p>GitHub Pages est con\u00e7u pour h\u00e9berger des pages personnelles ou de projet \u00e0 partir d'un d\u00e9p\u00f4t GitHub.</p> <p>Cr\u00e9ation de la branche gh-pages :</p> <p>1 - Dans GitHub, acc\u00e9der au d\u00e9p\u00f4t notes-user et cliquer sur Settings.</p> <p>2 - Section Code and automation de la barre lat\u00e9rale, cliquer sur Pages.</p> <p>La suite suppose qu'un fichier mkdocs.yml soit pr\u00e9sent dans le dossier de premier niveau du d\u00e9p\u00f4t GitHub (branche main) ainsi que la documentation Mkdocs dans le dossier docs/.</p> <p>Pour cela, ajouter ceux-ci en cliquant sur le bouton Add file et s\u00e9lectionner Upload files</p> <p>Faire glisser le contenu du dossier /home/user/Documents/notes-user/ de la VM Debian qui contient au d\u00e9part un dossier de nom docs et un fichier de nom mkdocs.yml.</p> <p>3 - Dans la zone Build and deployment, sous Source, s\u00e9lectionner Deploy from a branch.</p> <p>4 - Sous Branch, s\u00e9lectionner main.</p> <p>Un workflow GitHub (processus automatis\u00e9) sera utilis\u00e9 pour publier le site web MkDocs.</p> <p>Pour cela, cliquer sur le bouton Add file et s\u00e9lectionner Create a new file.</p> <p>Cr\u00e9er un fichier /notes-user/.github/workflows/ci.yml contenant :</p> <pre><code>name: ci \non:\n  push:\n    branches:\n      - master \n      - main\npermissions:\n  contents: write\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v3\n      - uses: actions/setup-python@v4\n        with:\n          python-version: 3.x # Ex: python-version: 3.9\n      - run: echo \"cache_id=$(date --utc '+%V')\" &gt;&gt; $GITHUB_ENV \n      - uses: actions/cache@v3\n        with:\n          key: mkdocs-material-${{ env.cache_id }}\n          path: .cache\n          restore-keys: |\n            mkdocs-material-\n      - run: pip install mkdocs-material \n      - run: mkdocs gh-deploy --force\n</code></pre> <p>R\u00e9f\u00e9rence du code ci-dessus</p> <p>-&gt; Cliquer ensuite sur le bouton Commit changes... -&gt; V\u00e9rifier le contenu de la fen\u00eatre popup -&gt; Cliquer sur le bouton Commit changes</p> <p>Le site se construit automatiquement et GitHub g\u00e9n\u00e8re une branche nomm\u00e9e gh-pages.</p>"},{"location":"mkdocs/github-mkdocs/#deploiement-du-site-web","title":"D\u00e9ploiement du site Web","text":"<p>D\u00e9ployer ou publier le site comme suit :</p> <p>1 - Dans GitHub, acc\u00e9der au d\u00e9p\u00f4t notes-user et cliquer sur Settings.</p> <p>2 - Section Code and automation de la barre lat\u00e9rale, cliquer sur Pages.</p> <p>3 - Sous Branch, s\u00e9lectionner gh-pages.</p> <p>4 - Cliquer sur le bouton Save.</p>"},{"location":"mkdocs/github-mkdocs/#cdes-git-depuis-la-vm-debian","title":"Cdes Git depuis la VM Debian","text":"<p>Se rendre au pr\u00e9alable dans le dossier /home/user/Documents/notes-user/.</p> <pre><code>git branch\n</code></pre> <p>Retour :</p> <pre><code>  gh-pages\n* main\n</code></pre> <pre><code>git status\n</code></pre> <p>Retour :</p> <pre><code>Sur la branche main\nVotre branche est \u00e0 jour avec 'origin/main'.\n\nrien \u00e0 valider, la copie de travail est propre\n</code></pre> <pre><code>git switch gh-pages\n</code></pre> <p>Retour possible :</p> <pre><code>Basculement sur la branche 'gh-pages'\nVotre branche et 'origin/gh-pages' ont diverg\u00e9,\net ont 1 et 1 commits diff\u00e9rents chacune respectivement.\n  (utilisez \"git pull\" pour fusionner la branche distante dans la v\u00f4tre)\n</code></pre> <p>Pour corriger la divergence indiqu\u00e9e ci-dessus :</p> <pre><code>git pull origin gh-pages --rebase\n</code></pre>"},{"location":"mkdocs/github-mkdocs/#copie-du-site-web-sur-le-qnap","title":"Copie du site Web sur le QNAP","text":"<p>G\u00e9n\u00e9rer une copie du site comme suit :</p> <pre><code>cd /home/user/Documents/notes-user/\nsudo mkdocs build -c -d /var/www/html/mkdocs/\n</code></pre>"},{"location":"mkdocs/github-mkdocs/#theme-material-for-mkdocs","title":"Th\u00e8me Material for MkDocs","text":"<p>Mise \u00e0 jour du th\u00e8me pour le site sur GitHub :</p> <pre><code>cd /home/user/Documents/notes-user/\npip3 install --upgrade --force-reinstall mkdocs-material \n</code></pre> <p>Mise \u00e0 jour du th\u00e8me pour le site sur le QNAP :</p> <p>Les fichiers du th\u00e8me se trouvent dans /home/user/.local/lib/python3.x/site-packages/material.</p> <pre><code>cd /home/user/.local/lib/python3.x/site-packages/material/\npip3 show mkdocs-material\npip3 install --upgrade --force-reinstall mkdocs-material\npip3 show mkdocs-material \n</code></pre> <p>Fin.</p>"},{"location":"mkdocs/vscodeserver-mkdocs/","title":"MkDocs - VS Code Server","text":""},{"location":"mkdocs/vscodeserver-mkdocs/#vs-code-server-sur-debian","title":"VS Code Server sur Debian","text":"<p>Tuto pour installer VS Code Server sur une VM Debian.</p> <p>L'outil servira notamment \u00e0 cr\u00e9er la documentation Markdown du projet MkDocs.</p>"},{"location":"mkdocs/vscodeserver-mkdocs/#installationmaj-du-serveur","title":"Installation/MAJ du serveur","text":"<p>Cr\u00e9er le dossier suivant :</p> <pre><code>cd /home/user/Documents\nmkdir code-server\n</code></pre> <p>et installer VS Code Server comme suit :</p> <pre><code>cd code-server\ncurl -fOL https://github.com/coder/code-server/releases/download/v4.x.0/code-server_4.x.0_amd64.deb\nsudo dpkg -i code-server_4.x.0_amd64.deb\nsudo systemctl enable --now code-server@user\n</code></pre> <p>Dans le cas d'une MAJ, la version pr\u00e9c\u00e9dente sera remplac\u00e9e automatiquement.</p> <p>V\u00e9rifier le statut du serveur :</p> <pre><code>sudo systemctl status code-server@user\n</code></pre> <p>Les dossiers et fichiers de VS Code Server ont \u00e9t\u00e9 install\u00e9s dans : /usr/lib/code-server/ /usr/lib/systemd/ /home/user/.config/ /home/user/.local/share/</p>"},{"location":"mkdocs/vscodeserver-mkdocs/#acces-web-au-serveur","title":"Acc\u00e8s Web au serveur","text":"<p>Le serveur est accessible depuis l'URL : <code>http://127.0.0.1:8080</code></p> <p>Le MDP du login d'acc\u00e8s au serveur se trouve dans le fichier : /home/user/.config/code-server/config.yaml</p> <p>Penser, en cas de probl\u00e8me de page blanche suite \u00e0 un login, \u00e0 red\u00e9marrer code-server.</p> <pre><code>sudo systemctl restart code-server@user\n</code></pre>"},{"location":"mkdocs/vscodeserver-mkdocs/#extensions-ajoutees","title":"Extensions ajout\u00e9es","text":"<p>French Language Pack for Visual Studio Code Jupyter  (Editeur Web Python) Markdown All in One (Utilitaire Markdown) Python  (Langage de programmation)</p>"},{"location":"mkdocs/vscodeserver-mkdocs/#acces-au-projet-mkdocs","title":"Acc\u00e8s au projet MkDocs","text":"<p>Cliquer sur l'ic\u00f4ne EXPLORATEUR du menu de VS Code Server : -&gt; Bouton Ouvrir le dossier -&gt; S\u00e9lectionner le dossier MkDocs de nom notes-user -&gt; Bouton OK -&gt; Bouton Oui, je fais confiance aux auteurs</p> <p>Il ne reste plus qu'\u00e0 cr\u00e9er la documentation.</p>"},{"location":"mkdocs/vscodeserver-mkdocs/#hachage-du-mdp-web","title":"Hachage du MDP Web","text":"<p>G\u00e9n\u00e9rer un MDP hach\u00e9 sans l'outil npx :</p> <pre><code>cd /home/user/.config/code-server/\napt install argon2\nexport SALT=\"un-contenu-au-hazard\"\necho -n \"mdp-en-clair\" | argon2 $SALT -e\n</code></pre> <p>Exemple de retour de la Cde echo :</p> <pre><code>$argon2i$v=19$m=4096,t=3,p=1$bGup8sbW45...\n</code></pre> <p>Modifier ensuite le fichier config.yaml en rempla\u00e7ant password: par :</p> <pre><code>hashed-password: \"$argon2i$v=19$m=4096,t=3,p=1$bGup8sbW45...\"\n</code></pre> <p>Pour finir, red\u00e9marrer code-server :</p> <pre><code>sudo systemctl restart code-server@user\n</code></pre>"},{"location":"mkdocs/vscodeserver-mkdocs/#suppression-du-serveur","title":"Suppression du serveur","text":"<p>Pour supprimer si n\u00e9cessaire celui-ci :</p> <pre><code>cd /home/user\nrm -rf /home/user/.local/share/code-server /home/user/.config/code-server\nsudo apt remove code-server\n</code></pre> <p>Fin.</p>"},{"location":"blog/12-serveur-de-courrier/","title":"12 Serveur de courrier","text":""},{"location":"blog/12-serveur-de-courrier/#12-serveur-de-courrier","title":"12 Serveur de courrier","text":""},{"location":"blog/13-cockpit/","title":"13 Cockpit","text":""},{"location":"blog/13-cockpit/#13-cockpit","title":"13 Cockpit","text":""},{"location":"blog/11-dns-split-et-proxy-inverse/","title":"11 DNS split et Proxy inverse","text":""},{"location":"blog/11-dns-split-et-proxy-inverse/#11-dns-split-et-proxy-inverse","title":"11 DNS split et Proxy inverse","text":""},{"location":"blog/10-sftp-acc%C3%A8s-cms---ftps/","title":"10 SFTP acc\u00e8s CMS - FTPS","text":""},{"location":"blog/10-sftp-acc%C3%A8s-cms---ftps/#10-sftp-acces-cms-ftps","title":"10 SFTP acc\u00e8s CMS - FTPS","text":""},{"location":"blog/09-lamp--https--cms/","title":"09 LAMP + HTTPS + CMS","text":""},{"location":"blog/09-lamp--https--cms/#09-lamp-https-cms","title":"09 LAMP + HTTPS + CMS","text":""},{"location":"blog/08-dns--dhcp--ddns/","title":"08 DNS + DHCP + DDNS","text":""},{"location":"blog/08-dns--dhcp--ddns/#08-dns-dhcp-ddns","title":"08 DNS + DHCP + DDNS","text":""},{"location":"blog/07-acc%C3%A8s-rdp--vnc--ssh/","title":"07 Acc\u00e8s RDP + VNC + SSH","text":""},{"location":"blog/07-acc%C3%A8s-rdp--vnc--ssh/#07-acces-rdp-vnc-ssh","title":"07 Acc\u00e8s RDP + VNC + SSH","text":""},{"location":"blog/06-ovs--conteneurs-lxc/","title":"06 OvS + Conteneurs LXC","text":""},{"location":"blog/06-ovs--conteneurs-lxc/#06-ovs-conteneurs-lxc","title":"06 OvS + Conteneurs LXC","text":""},{"location":"blog/05-clients-lan-vm1-vm2/","title":"05 Clients LAN \"vm1 vm2\"","text":""},{"location":"blog/05-clients-lan-vm1-vm2/#05-clients-lan-vm1-vm2","title":"05 Clients LAN \"vm1 vm2\"","text":""},{"location":"blog/04-serveur-dmz-srvdmz/","title":"04 Serveur DMZ \"srvdmz\"","text":""},{"location":"blog/04-serveur-dmz-srvdmz/#04-serveur-dmz-srvdmz","title":"04 Serveur DMZ \"srvdmz\"","text":""},{"location":"blog/03-serveur-wan-srvsec/","title":"03 Serveur WAN \"srvsec\"","text":""},{"location":"blog/03-serveur-wan-srvsec/#03-serveur-wan-srvsec","title":"03 Serveur WAN \"srvsec\"","text":""},{"location":"blog/02-serveur-lan-srvlan/","title":"02 Serveur LAN \"srvlan\"","text":""},{"location":"blog/02-serveur-lan-srvlan/#02-serveur-lan-srvlan","title":"02 Serveur LAN \"srvlan\"","text":""},{"location":"blog/01-hyperviseur-virtualbox/","title":"01 Hyperviseur Virtualbox","text":""},{"location":"blog/01-hyperviseur-virtualbox/#01-hyperviseur-virtualbox","title":"01 Hyperviseur Virtualbox","text":""},{"location":"blog/page/2/","title":"Index de tous les articles","text":""},{"location":"blog/page/2/#index-de-tous-les-articles","title":"Index de tous les articles","text":""},{"location":"blog/page/3/","title":"Index de tous les articles","text":""},{"location":"blog/page/3/#index-de-tous-les-articles","title":"Index de tous les articles","text":""},{"location":"informatique/debian/","title":"Debian","text":""},{"location":"informatique/debian/#debian","title":"Debian","text":""},{"location":"informatique/eve-ng/","title":"EVE-NG","text":""},{"location":"informatique/eve-ng/#eve-ng","title":"EVE-NG","text":""},{"location":"informatique/windows/","title":"Windows","text":""},{"location":"informatique/windows/#windows","title":"Windows","text":""},{"location":"informatique/intelligence-artificielle/","title":"Intelligence artificielle","text":""},{"location":"informatique/intelligence-artificielle/#intelligence-artificielle","title":"Intelligence artificielle","text":""},{"location":"informatique/centreon/","title":"Centreon","text":""},{"location":"informatique/centreon/#centreon","title":"Centreon","text":""},{"location":"informatique/synology/","title":"Synology","text":""},{"location":"informatique/synology/#synology","title":"Synology","text":""},{"location":"informatique/alpine/","title":"Alpine","text":""},{"location":"informatique/alpine/#alpine","title":"Alpine","text":""},{"location":"informatique/proxmox/","title":"Proxmox","text":""},{"location":"informatique/proxmox/#proxmox","title":"Proxmox","text":""},{"location":"informatique/nextcloud/","title":"Nextcloud","text":""},{"location":"informatique/nextcloud/#nextcloud","title":"Nextcloud","text":""},{"location":"informatique/page/2/","title":"Les derniers articles","text":""},{"location":"informatique/page/2/#les-derniers-articles","title":"Les derniers articles","text":""},{"location":"informatique/page/3/","title":"Les derniers articles","text":""},{"location":"informatique/page/3/#les-derniers-articles","title":"Les derniers articles","text":""}]}