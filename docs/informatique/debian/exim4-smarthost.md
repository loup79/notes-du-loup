---
title: Debian - Exim4 et Smarthost
summary: Envoi de courriers au travers du serveur SMTP de Orange.
author: G.Leloup
date: 2023-01-02
---

## Exim4 - Smarthost

**Janvier 2023.**

### Préalable

Debian 11 et 12 :  
Paquets *exim4-base*, *exim4-config*, *exim4-daemon-light*, *bsd-mailx*  installés.

La configuration ci-dessous permet l'envoi de courriers au travers du serveur SMTP de Orange.

### Configuration de Exim4

Pour configurer Exim, il faut commencer par lancer la Cde suivante :

```text
sudo dpkg-reconfigure exim4-config
```

et répondre aux questions comme suit :

```text
    Choississez « Envoi par relais (« smarthost ») — pas de courrier local »
    « Nom de courrier du système » : saisir « le nom d'hôte Debian »
    « Liste d’adresses IP où Exim sera en attente de connexions SMTP entrantes » : saisir « 127.0.0.1 »
    « Autres destinations dont le courrier doit être accepté » : laisser vide
    « Nom de domaine visible pour les utilisateurs locaux » : saisir « localhost »
    « Nom réseau ou adresse IP du système « smarthost » » : saisir « smtp.orange.fr::587 »
    « Faut-il cacher le nom local de courrier dans les courriers sortants ? » : choisir « Non »
    « Faut-il minimiser les requêtes DNS (connexions à la demande) ? » : choisir « Non »
    « Faut-il séparer la configuration dans plusieurs fichiers ? » : choisir « Oui »
    « Destinataire des courriers de « root » et « postmaster » : « choisir l'utilisateur principal de Debian »
```

Le fichier modifié *update-exim4.conf.conf* se situe dans */etc/exim4/*.

Le contenu configuré doit montrer ceci :

```text
dc_eximconfig_configtype='satellite'
dc_other_hostnames=''
dc_local_interfaces='127.0.0.1'
dc_readhost='localhost'
dc_relay_domains=''
dc_minimaldns='false'
dc_relay_nets=''
dc_smarthost='smtp.orange.fr::587'
CFILEMODE='644'
dc_use_split_config='false'
dc_hide_mailname='true'
dc_mailname_in_oh='true'
dc_localdelivery='mail_spool'
```

Éditer ensuite le fichier */etc/exim4/passwd.client* et ajouter cette ligne :

```text
smtp.orange.fr:<nom-du-compte>@orange.fr:mot-de-passe
```

Éditer également le fichier */etc/email-addresses* et ajoutez ces lignes :

```text
root: <nom-du-compte>@orange.fr
USER: <nom-du-compte>@orange.fr
USER@localhost: <nom-du-compte>@orange.fr
USER@HOSTNAME: <nom-du-compte>@orange.fr
USER@HOSTNAME.localdomain: <nom-du-compte>@orange.fr
```

Remplacer USER et HOSTNAME par le nom de l'utilisateur Debian et le nom d'hôte Debian du PC.  
L'adresse e-mail doit être celle d'un compte connu d'Orange, pas celle du destinataire.

Éditer le fichier */etc/aliases* et ajouter ces lignes :

```text
root: <nom de l'utilisateur Debian>
<nom de l'utilisateur Debian>: <nom-du-compte>@gmail.com
```

L'adresse e-mail doit être celle du destinataire, pas celle connue de Orange.

Enregistrer la modification du fichier *aliases* :

```text
newaliases
```

### Configuration TLS (STARTTLS)

Pour accéder au smarthost d'Orange, créer le fichier */etc/exim4/exim4.conf.localmacros* :

```text
sudo nano /etc/exim4/exim4.conf.localmacros
```

et entrer le contenu suivant :

```text
MAIN_TLS_ENABLE = 1
REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS = *
TLS_ON_CONNECT_PORTS = 587
REMOTE_SMTP_SMARTHOST_TLS_VERIFY_HOSTS = !*
```

Ajouter ce contenu dans */etc/exim4/exim4.conf.template* juste après .ifdef REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS ... .endif :

```text
.ifdef REQUIRE_PROTOCOL
    protocol = REQUIRE_PROTOCOL
.endif
```

Puis le contenu suivant juste après .ifdef MAIN_TLS_ENABLE :

```text
.ifdef TLS_ON_CONNECT_PORTS
    tls_on_connect_ports = TLS_ON_CONNECT_PORTS
.endif
```

### Configuration utilisateur (SASL)

Pour l'authentification utilisateur SASL exigée par Orange, installer le paquet *sasl2-bin* :

```text
sudo apt install sasl2-bin
```

Démarrer le démon *saslauthd* et l'activer au boot :

```text
sudo systemctl start saslauthd  
sudo systemctl status saslauthd  
sudo systemctl enable saslauthd
```

Editer ensuite le fichier */etc/exim4/exim4.conf.template* et décommenter les lignes suivantes :

```text
plain_saslauthd_server:
    driver = plaintext
    public_name = PLAIN
    server_condition = ${if saslauthd{{$auth2}{$auth3}}{1}{0}}
    server_set_id = $auth2
    server_prompts = :
    .ifndef AUTH_SERVER_ALLOW_NOTLS_PASSWORDS
    server_advertise_condition = ${if eq{$tls_cipher}{}{}{*}}
    .endif
```

Ajouter l'utilisateur *Debian-exim* au groupe *sasl* :

```text
sudo adduser Debian-exim sasl
```

### Mise à jour de la configuration

Pour finir, mettre à jour la configuration :

```text
sudo update-exim4.conf
sudo systemctl restart exim4
sudo systemctl status exim4
```

La Cde *update-exim4.conf* met à jour le fichier */var/lib/exim4/config.autogenerated*

### Cas distribution Kaisen Debian

Editer le fichier *automysqlbackup* :

```text
sudo nano /etc/default/automysqlbackup
```

et modifier cette ligne comme suit :

```text
MAILADDR="<nom-du-compte>@gmail.com"
```

Puis, éditer le fichier *autopostgresqlbackup* :

```text
sudo nano /etc/default/autopostgresqlbackup
```

et modifier cette ligne comme suit :

```text
MAILADDR=""
```

Supprimer ce fichier pour éviter un *warning* généré par le script cron *chkrootkit* :

```text
/etc/chkrootkit.conf
```

Envoyer les mails émis par toutes les tâches *cron.daily* sur `nom-du-compte@gmail.com` au lieu de *root* comme suit :

```text
sudo crontab -e
```

Ajoutez :

```text
MAILTO=<nom-du-compte>@gmail.com
```

ou

```text
sudo nano /etc/crontab
```

Ajouter sous la ligne *PATH=...*  :

```text
MAILTO="<nom-du-compte>@gmail.com"
```

et redémarrer le service *cron* :

```text
sudo systemctl restart cron
```

Editer la tâche cron *zz-backup2l* :

```text
sudo nano /etc/cron.daily/zz-backup2l
```

et commenter la Cde *cron* suivante :

```text
# ! command -v backup2l > /dev/null || nice -n 19 backup2l -b
```

Enfin, éditer le fichier */etc/rsbackup/defaults* :

```text
sudo nano /etc/rsbackup/defaults
```

et modifier cette ligne comme suit :

```text
email=<nom-du-compte>@gmail.com
```

### Vérification du fonctionnement

Tester l’envoi d’un e-mail :

```text
sudo mail <nom-du-compte>@gmail.com
```

en procédant comme suit :

```text
 Subject: -> Saisir le sujet puis Touche « Entrée »
 Saisir le corps du mail puis Touche « Entrée » suivi de Touches « Ctrl+D »
 CC: -> Touche « Entrée »
```

L’e-mail est envoyé.

La Cde *mail* utilise le paquet *bsd-mailx*.

Vérifier dans le fichier */var/log/exim4/mainlog* que tout s'est bien passé.

### Cdes utiles

Lister les messages en file d'attente :

```text
sudo exim -bp
```

Vider un message de la file d'attente :

```text
sudo exim -Mrm <id du message>
```

**Fin.**
